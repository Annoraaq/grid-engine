var GridEngine=(()=>{var Kr=Object.create;var ft=Object.defineProperty,Xr=Object.defineProperties,qr=Object.getOwnPropertyDescriptor,Zr=Object.getOwnPropertyDescriptors,Jr=Object.getOwnPropertyNames,ue=Object.getOwnPropertySymbols,Qr=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty,ti=Object.prototype.propertyIsEnumerable;var fe=(o,t,e)=>t in o?ft(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,M=(o,t)=>{for(var e in t||(t={}))me.call(t,e)&&fe(o,e,t[e]);if(ue)for(var e of ue(t))ti.call(t,e)&&fe(o,e,t[e]);return o},K=(o,t)=>Xr(o,Zr(t)),ei=o=>ft(o,"__esModule",{value:!0});var u=(o,t)=>()=>(o&&(t=o(o=0)),t);var de=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var ri=(o,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Jr(t))!me.call(o,r)&&r!=="default"&&ft(o,r,{get:()=>t[r],enumerable:!(e=qr(t,r))||e.enumerable});return o},ii=o=>ri(ei(ft(o!=null?Kr(Qr(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);var y,dt=u(()=>{y=class{static get(){return y.config}static set(t){y.config=t}}});var X,At=u(()=>{(function(i){i.DONT_BLOCK="DONT_BLOCK",i.BLOCK_TWO_TILES="BLOCK_TWO_TILES",i.BLOCK_ONE_TILE_AHEAD="BLOCK_ONE_TILE_AHEAD",i.BLOCK_ONE_TILE_BEHIND="BLOCK_ONE_TILE_BEHIND"})(X||(X={}))});function g(o){return typeof o=="function"}var w=u(()=>{});function oi(o){return g(o==null?void 0:o.lift)}function k(o){return function(t){if(oi(t))return t.lift(function(e){try{return o(e,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var it=u(()=>{w()});var Ge=de((Pi,bt)=>{var ge,ve,be,ye,xe,Te,Pe,Se,Ce,gt,Gt,_e,Ee,Oe,q,we,De,Le,Me,Fe,Re,ke,Ae,vt;(function(o){var t=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){o(e(t,e(r)))}):typeof bt=="object"&&typeof bt.exports=="object"?o(e(t,e(bt.exports))):o(e(t));function e(r,i){return r!==t&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,a){return r[n]=i?i(n,a):a}}})(function(o){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,i){r.__proto__=i}||function(r,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])};ge=function(r,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");t(r,i);function n(){this.constructor=r}r.prototype=i===null?Object.create(i):(n.prototype=i.prototype,new n)},ve=Object.assign||function(r){for(var i,n=1,a=arguments.length;n<a;n++){i=arguments[n];for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&(r[l]=i[l])}return r},be=function(r,i){var n={};for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&i.indexOf(a)<0&&(n[a]=r[a]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var l=0,a=Object.getOwnPropertySymbols(r);l<a.length;l++)i.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(r,a[l])&&(n[a[l]]=r[a[l]]);return n},ye=function(r,i,n,a){var l=arguments.length,p=l<3?i:a===null?a=Object.getOwnPropertyDescriptor(i,n):a,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")p=Reflect.decorate(r,i,n,a);else for(var f=r.length-1;f>=0;f--)(c=r[f])&&(p=(l<3?c(p):l>3?c(i,n,p):c(i,n))||p);return l>3&&p&&Object.defineProperty(i,n,p),p},xe=function(r,i){return function(n,a){i(n,a,r)}},Te=function(r,i){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,i)},Pe=function(r,i,n,a){function l(p){return p instanceof n?p:new n(function(c){c(p)})}return new(n||(n=Promise))(function(p,c){function f(v){try{m(a.next(v))}catch(R){c(R)}}function T(v){try{m(a.throw(v))}catch(R){c(R)}}function m(v){v.done?p(v.value):l(v.value).then(f,T)}m((a=a.apply(r,i||[])).next())})},Se=function(r,i){var n={label:0,sent:function(){if(p[0]&1)throw p[1];return p[1]},trys:[],ops:[]},a,l,p,c;return c={next:f(0),throw:f(1),return:f(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function f(m){return function(v){return T([m,v])}}function T(m){if(a)throw new TypeError("Generator is already executing.");for(;n;)try{if(a=1,l&&(p=m[0]&2?l.return:m[0]?l.throw||((p=l.return)&&p.call(l),0):l.next)&&!(p=p.call(l,m[1])).done)return p;switch(l=0,p&&(m=[m[0]&2,p.value]),m[0]){case 0:case 1:p=m;break;case 4:return n.label++,{value:m[1],done:!1};case 5:n.label++,l=m[1],m=[0];continue;case 7:m=n.ops.pop(),n.trys.pop();continue;default:if(p=n.trys,!(p=p.length>0&&p[p.length-1])&&(m[0]===6||m[0]===2)){n=0;continue}if(m[0]===3&&(!p||m[1]>p[0]&&m[1]<p[3])){n.label=m[1];break}if(m[0]===6&&n.label<p[1]){n.label=p[1],p=m;break}if(p&&n.label<p[2]){n.label=p[2],n.ops.push(m);break}p[2]&&n.ops.pop(),n.trys.pop();continue}m=i.call(r,n)}catch(v){m=[6,v],l=0}finally{a=p=0}if(m[0]&5)throw m[1];return{value:m[0]?m[1]:void 0,done:!0}}},Ce=function(r,i){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&vt(i,r,n)},vt=Object.create?function(r,i,n,a){a===void 0&&(a=n),Object.defineProperty(r,a,{enumerable:!0,get:function(){return i[n]}})}:function(r,i,n,a){a===void 0&&(a=n),r[a]=i[n]},gt=function(r){var i=typeof Symbol=="function"&&Symbol.iterator,n=i&&r[i],a=0;if(n)return n.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&a>=r.length&&(r=void 0),{value:r&&r[a++],done:!r}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")},Gt=function(r,i){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var a=n.call(r),l,p=[],c;try{for(;(i===void 0||i-- >0)&&!(l=a.next()).done;)p.push(l.value)}catch(f){c={error:f}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(c)throw c.error}}return p},_e=function(){for(var r=[],i=0;i<arguments.length;i++)r=r.concat(Gt(arguments[i]));return r},Ee=function(){for(var r=0,i=0,n=arguments.length;i<n;i++)r+=arguments[i].length;for(var a=Array(r),l=0,i=0;i<n;i++)for(var p=arguments[i],c=0,f=p.length;c<f;c++,l++)a[l]=p[c];return a},Oe=function(r,i){for(var n=0,a=i.length,l=r.length;n<a;n++,l++)r[l]=i[n];return r},q=function(r){return this instanceof q?(this.v=r,this):new q(r)},we=function(r,i,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=n.apply(r,i||[]),l,p=[];return l={},c("next"),c("throw"),c("return"),l[Symbol.asyncIterator]=function(){return this},l;function c(d){a[d]&&(l[d]=function(Y){return new Promise(function(kt,Yr){p.push([d,Y,kt,Yr])>1||f(d,Y)})})}function f(d,Y){try{T(a[d](Y))}catch(kt){R(p[0][3],kt)}}function T(d){d.value instanceof q?Promise.resolve(d.value.v).then(m,v):R(p[0][2],d)}function m(d){f("next",d)}function v(d){f("throw",d)}function R(d,Y){d(Y),p.shift(),p.length&&f(p[0][0],p[0][1])}},De=function(r){var i,n;return i={},a("next"),a("throw",function(l){throw l}),a("return"),i[Symbol.iterator]=function(){return this},i;function a(l,p){i[l]=r[l]?function(c){return(n=!n)?{value:q(r[l](c)),done:l==="return"}:p?p(c):c}:p}},Le=function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=r[Symbol.asyncIterator],n;return i?i.call(r):(r=typeof gt=="function"?gt(r):r[Symbol.iterator](),n={},a("next"),a("throw"),a("return"),n[Symbol.asyncIterator]=function(){return this},n);function a(p){n[p]=r[p]&&function(c){return new Promise(function(f,T){c=r[p](c),l(f,T,c.done,c.value)})}}function l(p,c,f,T){Promise.resolve(T).then(function(m){p({value:m,done:f})},c)}},Me=function(r,i){return Object.defineProperty?Object.defineProperty(r,"raw",{value:i}):r.raw=i,r};var e=Object.create?function(r,i){Object.defineProperty(r,"default",{enumerable:!0,value:i})}:function(r,i){r.default=i};Fe=function(r){if(r&&r.__esModule)return r;var i={};if(r!=null)for(var n in r)n!=="default"&&Object.prototype.hasOwnProperty.call(r,n)&&vt(i,r,n);return e(i,r),i},Re=function(r){return r&&r.__esModule?r:{default:r}},ke=function(r,i){if(!i.has(r))throw new TypeError("attempted to get private field on non-instance");return i.get(r)},Ae=function(r,i,n){if(!i.has(r))throw new TypeError("attempted to set private field on non-instance");return i.set(r,n),n},o("__extends",ge),o("__assign",ve),o("__rest",be),o("__decorate",ye),o("__param",xe),o("__metadata",Te),o("__awaiter",Pe),o("__generator",Se),o("__exportStar",Ce),o("__createBinding",vt),o("__values",gt),o("__read",Gt),o("__spread",_e),o("__spreadArrays",Ee),o("__spreadArray",Oe),o("__await",q),o("__asyncGenerator",we),o("__asyncDelegator",De),o("__asyncValues",Le),o("__makeTemplateObject",Me),o("__importStar",Fe),o("__importDefault",Re),o("__classPrivateFieldGet",ke),o("__classPrivateFieldSet",Ae)})});var Ie,A,Si,Ci,_i,Ei,Oi,Ne,yt,wi,Di,B,V,Li,Mi,H,xt,We,Fi,Ue,Ri,ki,Ai,Gi,Ii,G=u(()=>{Ie=ii(Ge()),{__extends:A,__assign:Si,__rest:Ci,__decorate:_i,__param:Ei,__metadata:Oi,__awaiter:Ne,__generator:yt,__exportStar:wi,__createBinding:Di,__values:B,__read:V,__spread:Li,__spreadArrays:Mi,__spreadArray:H,__await:xt,__asyncGenerator:We,__asyncDelegator:Fi,__asyncValues:Ue,__makeTemplateObject:Ri,__importStar:ki,__importDefault:Ai,__classPrivateFieldGet:Gi,__classPrivateFieldSet:Ii}=Ie.default});var Be,Ve=u(()=>{Be=function(o){return o&&typeof o.length=="number"&&typeof o!="function"}});function He(o){return g(o==null?void 0:o.then)}var je=u(()=>{w()});function Tt(o){var t=function(r){Error.call(r),r.stack=new Error().stack},e=o(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var It=u(()=>{});var Pt,$e=u(()=>{It();Pt=Tt(function(o){return function(e){o(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,i){return i+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}})});function ot(o,t){if(o){var e=o.indexOf(t);0<=e&&o.splice(e,1)}}var Nt=u(()=>{});function St(o){return o instanceof Z||o&&"closed"in o&&g(o.remove)&&g(o.add)&&g(o.unsubscribe)}function ze(o){g(o)?o():o.unsubscribe()}var Z,Wt,Ct=u(()=>{G();w();$e();Nt();Z=function(){function o(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._teardowns=null}return o.prototype.unsubscribe=function(){var t,e,r,i,n;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var l=B(a),p=l.next();!p.done;p=l.next()){var c=p.value;c.remove(this)}}catch(d){t={error:d}}finally{try{p&&!p.done&&(e=l.return)&&e.call(l)}finally{if(t)throw t.error}}else a.remove(this);var f=this.initialTeardown;if(g(f))try{f()}catch(d){n=d instanceof Pt?d.errors:[d]}var T=this._teardowns;if(T){this._teardowns=null;try{for(var m=B(T),v=m.next();!v.done;v=m.next()){var R=v.value;try{ze(R)}catch(d){n=n!=null?n:[],d instanceof Pt?n=H(H([],V(n),!1),V(d.errors),!1):n.push(d)}}}catch(d){r={error:d}}finally{try{v&&!v.done&&(i=m.return)&&i.call(m)}finally{if(r)throw r.error}}}if(n)throw new Pt(n)}},o.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)ze(t);else{if(t instanceof o){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=(e=this._teardowns)!==null&&e!==void 0?e:[]).push(t)}},o.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},o.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},o.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&ot(e,t)},o.prototype.remove=function(t){var e=this._teardowns;e&&ot(e,t),t instanceof o&&t._removeParent(this)},o.EMPTY=function(){var t=new o;return t.closed=!0,t}(),o}(),Wt=Z.EMPTY});var D,nt=u(()=>{D={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1}});var J,Ut=u(()=>{G();J={setTimeout:function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];var e=J.delegate;return((e==null?void 0:e.setTimeout)||setTimeout).apply(void 0,H([],V(o),!1))},clearTimeout:function(o){var t=J.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(o)},delegate:void 0}});function _t(o){J.setTimeout(function(){var t=D.onUnhandledError;if(t)t(o);else throw o})}var Bt=u(()=>{nt();Ut()});function j(){}var Vt=u(()=>{});function Ke(o){return Ht("E",void 0,o)}function Xe(o){return Ht("N",o,void 0)}function Ht(o,t,e){return{kind:o,value:t,error:e}}var Ye,qe=u(()=>{Ye=function(){return Ht("C",void 0,void 0)}()});function Q(o){if(D.useDeprecatedSynchronousErrorHandling){var t=!$;if(t&&($={errorThrown:!1,error:null}),o(),t){var e=$,r=e.errorThrown,i=e.error;if($=null,r)throw i}}else o()}function Ze(o){D.useDeprecatedSynchronousErrorHandling&&$&&($.errorThrown=!0,$.error=o)}var $,Et=u(()=>{nt();$=null});function $t(o,t){return function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];try{o.apply(void 0,H([],V(e),!1))}catch(i){D.useDeprecatedSynchronousErrorHandling?Ze(i):_t(i)}}}function Je(o){throw o}function zt(o,t){var e=D.onStoppedNotification;e&&J.setTimeout(function(){return e(o,t)})}var at,jt,ni,Yt=u(()=>{G();w();Ct();nt();Bt();Vt();qe();Ut();Et();at=function(o){A(t,o);function t(e){var r=o.call(this)||this;return r.isStopped=!1,e?(r.destination=e,St(e)&&e.add(r)):r.destination=ni,r}return t.create=function(e,r,i){return new jt(e,r,i)},t.prototype.next=function(e){this.isStopped?zt(Xe(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?zt(Ke(e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?zt(Ye,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Z),jt=function(o){A(t,o);function t(e,r,i){var n=o.call(this)||this,a;if(g(e))a=e;else if(e){a=e.next,r=e.error,i=e.complete;var l;n&&D.useDeprecatedNextContext?(l=Object.create(e),l.unsubscribe=function(){return n.unsubscribe()}):l=e,a=a==null?void 0:a.bind(l),r=r==null?void 0:r.bind(l),i=i==null?void 0:i.bind(l)}return n.destination={next:a?$t(a,n):j,error:$t(r!=null?r:Je,n),complete:i?$t(i,n):j},n}return t}(at);ni={closed:!0,next:j,error:Je,complete:j}});var tt,Ot=u(()=>{tt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function Qe(o){return o}var tr=u(()=>{});function er(o){return o.length===0?Qe:o.length===1?o[0]:function(e){return o.reduce(function(r,i){return i(r)},e)}}var rr=u(()=>{tr()});function ir(o){var t;return(t=o!=null?o:D.Promise)!==null&&t!==void 0?t:Promise}function ai(o){return o&&g(o.next)&&g(o.error)&&g(o.complete)}function si(o){return o&&o instanceof at||ai(o)&&St(o)}var E,wt=u(()=>{Yt();Ct();Ot();rr();nt();w();Et();E=function(){function o(t){t&&(this._subscribe=t)}return o.prototype.lift=function(t){var e=new o;return e.source=this,e.operator=t,e},o.prototype.subscribe=function(t,e,r){var i=this,n=si(t)?t:new jt(t,e,r);return Q(function(){var a=i,l=a.operator,p=a.source;n.add(l?l.call(n,p):p?i._subscribe(n):i._trySubscribe(n))}),n},o.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},o.prototype.forEach=function(t,e){var r=this;return e=ir(e),new e(function(i,n){var a;a=r.subscribe(function(l){try{t(l)}catch(p){n(p),a==null||a.unsubscribe()}},n,i)})},o.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},o.prototype[tt]=function(){return this},o.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return er(t)(this)},o.prototype.toPromise=function(t){var e=this;return t=ir(t),new t(function(r,i){var n;e.subscribe(function(a){return n=a},function(a){return i(a)},function(){return r(n)})})},o.create=function(t){return new o(t)},o}()});function or(o){return g(o[tt])}var nr=u(()=>{Ot();w()});function ar(o){return Symbol.asyncIterator&&g(o==null?void 0:o[Symbol.asyncIterator])}var sr=u(()=>{w()});function lr(o){return new TypeError("You provided "+(o!==null&&typeof o=="object"?"an invalid object":"'"+o+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var pr=u(()=>{});function li(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var hr,cr=u(()=>{hr=li()});function ur(o){return g(o==null?void 0:o[hr])}var mr=u(()=>{cr();w()});function fr(o){return We(this,arguments,function(){var e,r,i,n;return yt(this,function(a){switch(a.label){case 0:e=o.getReader(),a.label=1;case 1:a.trys.push([1,,9,10]),a.label=2;case 2:return[4,xt(e.read())];case 3:return r=a.sent(),i=r.value,n=r.done,n?[4,xt(void 0)]:[3,5];case 4:return[2,a.sent()];case 5:return[4,xt(i)];case 6:return[4,a.sent()];case 7:return a.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function dr(o){return g(o==null?void 0:o.getReader)}var gr=u(()=>{G();w()});function vr(o){if(o instanceof E)return o;if(o!=null){if(or(o))return pi(o);if(Be(o))return hi(o);if(He(o))return ci(o);if(ar(o))return br(o);if(ur(o))return ui(o);if(dr(o))return mi(o)}throw lr(o)}function pi(o){return new E(function(t){var e=o[tt]();if(g(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function hi(o){return new E(function(t){for(var e=0;e<o.length&&!t.closed;e++)t.next(o[e]);t.complete()})}function ci(o){return new E(function(t){o.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,_t)})}function ui(o){return new E(function(t){var e,r;try{for(var i=B(o),n=i.next();!n.done;n=i.next()){var a=n.value;if(t.next(a),t.closed)return}}catch(l){e={error:l}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}t.complete()})}function br(o){return new E(function(t){fi(o,t).catch(function(e){return t.error(e)})})}function mi(o){return br(fr(o))}function fi(o,t){var e,r,i,n;return Ne(this,void 0,void 0,function(){var a,l;return yt(this,function(p){switch(p.label){case 0:p.trys.push([0,5,6,11]),e=Ue(o),p.label=1;case 1:return[4,e.next()];case 2:if(r=p.sent(),!!r.done)return[3,4];if(a=r.value,t.next(a),t.closed)return[2];p.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=p.sent(),i={error:l},[3,11];case 6:return p.trys.push([6,,9,10]),r&&!r.done&&(n=e.return)?[4,n.call(e)]:[3,8];case 7:p.sent(),p.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}var yr=u(()=>{G();Ve();je();wt();nr();sr();pr();mr();gr();w();Bt();Ot()});var I,st=u(()=>{G();Yt();I=function(o){A(t,o);function t(e,r,i,n,a){var l=o.call(this,e)||this;return l.onFinalize=a,l._next=r?function(p){try{r(p)}catch(c){e.error(c)}}:o.prototype._next,l._error=n?function(p){try{n(p)}catch(c){e.error(c)}finally{this.unsubscribe()}}:o.prototype._error,l._complete=i?function(){try{i()}catch(p){e.error(p)}finally{this.unsubscribe()}}:o.prototype._complete,l}return t.prototype.unsubscribe=function(){var e,r=this.closed;o.prototype.unsubscribe.call(this),!r&&((e=this.onFinalize)===null||e===void 0||e.call(this))},t}(at)});function Kt(o,t){return k(function(e,r){var i=0;e.subscribe(new I(r,function(n){r.next(o.call(t,n,i++))}))})}var xr=u(()=>{it();st()});var Tr,Pr=u(()=>{It();Tr=Tt(function(o){return function(){o(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})});var b,Sr,Cr=u(()=>{G();wt();Ct();Pr();Nt();Et();b=function(o){A(t,o);function t(){var e=o.call(this)||this;return e.closed=!1,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var r=new Sr(this,this);return r.operator=e,r},t.prototype._throwIfClosed=function(){if(this.closed)throw new Tr},t.prototype.next=function(e){var r=this;Q(function(){var i,n;if(r._throwIfClosed(),!r.isStopped){var a=r.observers.slice();try{for(var l=B(a),p=l.next();!p.done;p=l.next()){var c=p.value;c.next(e)}}catch(f){i={error:f}}finally{try{p&&!p.done&&(n=l.return)&&n.call(l)}finally{if(i)throw i.error}}}})},t.prototype.error=function(e){var r=this;Q(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var i=r.observers;i.length;)i.shift().error(e)}})},t.prototype.complete=function(){var e=this;Q(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var r=e.observers;r.length;)r.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),o.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var r=this,i=r.hasError,n=r.isStopped,a=r.observers;return i||n?Wt:(a.push(e),new Z(function(){return ot(a,e)}))},t.prototype._checkFinalizedStatuses=function(e){var r=this,i=r.hasError,n=r.thrownError,a=r.isStopped;i?e.error(n):a&&e.complete()},t.prototype.asObservable=function(){var e=new E;return e.source=this,e},t.create=function(e,r){return new Sr(e,r)},t}(E),Sr=function(o){A(t,o);function t(e,r){var i=o.call(this)||this;return i.destination=e,i.source=r,i}return t.prototype.next=function(e){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.next)===null||i===void 0||i.call(r,e)},t.prototype.error=function(e){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.error)===null||i===void 0||i.call(r,e)},t.prototype.complete=function(){var e,r;(r=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||r===void 0||r.call(e)},t.prototype._subscribe=function(e){var r,i;return(i=(r=this.source)===null||r===void 0?void 0:r.subscribe(e))!==null&&i!==void 0?i:Wt},t}(b)});var _r,Er=u(()=>{wt();_r=new E(function(o){return o.complete()})});function et(o){return o<=0?function(){return _r}:k(function(t,e){var r=0;t.subscribe(new I(e,function(i){++r<=o&&(e.next(i),o<=r&&e.complete())}))})}var Xt=u(()=>{Er();it();st()});function N(o,t){return k(function(e,r){var i=0;e.subscribe(new I(r,function(n){return o.call(t,n,i++)&&r.next(n)}))})}var qt=u(()=>{it();st()});function z(o){return k(function(t,e){vr(o).subscribe(new I(e,function(){return e.complete()},j)),!e.closed&&t.subscribe(e)})}var Or=u(()=>{it();st();yr();Vt()});var Dt=u(()=>{qt();xr();Xt();Or()});var h,F=u(()=>{h=class{static get ZERO(){return new h(0,0)}static get ONE(){return new h(1,1)}static get UP(){return new h(0,-1)}static get DOWN(){return new h(0,1)}static get LEFT(){return new h(-1,0)}static get RIGHT(){return new h(1,0)}static get UP_LEFT(){return new h(-1,-1)}static get UP_RIGHT(){return new h(1,-1)}static get DOWN_RIGHT(){return new h(1,1)}static get DOWN_LEFT(){return new h(-1,1)}constructor(t,e){typeof t=="number"?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new h(this.x,this.y)}add(t){return new h(this.x+t.x,this.y+t.y)}multiply(t){return new h(this.x*t.x,this.y*t.y)}divide(t){return new h(this.x/t.x,this.y/t.y)}subtract(t){return new h(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}abs(){return new h(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}modulo(t){return new h(this.x%t.x,this.y%t.y)}scalarModulo(t){return new h(this.x%t,this.y%t)}scalarMult(t){return new h(this.x*t,this.y*t)}toString(){return`${this.x}#${this.y}`}}});function Zt(o){return[s.DOWN_LEFT,s.DOWN_RIGHT,s.UP_RIGHT,s.UP_LEFT].includes(o)}function wr(o){return{[s.LEFT]:s.DOWN_LEFT,[s.UP_LEFT]:s.LEFT,[s.UP]:s.UP_LEFT,[s.UP_RIGHT]:s.UP,[s.RIGHT]:s.UP_RIGHT,[s.DOWN_RIGHT]:s.RIGHT,[s.DOWN]:s.DOWN_RIGHT,[s.DOWN_LEFT]:s.DOWN,[s.NONE]:s.NONE}[o]}function W(o){return{[s.UP]:h.UP,[s.DOWN]:h.DOWN,[s.LEFT]:h.LEFT,[s.RIGHT]:h.RIGHT,[s.NONE]:h.ZERO,[s.UP_LEFT]:h.UP_LEFT,[s.UP_RIGHT]:h.UP_RIGHT,[s.DOWN_RIGHT]:h.DOWN_RIGHT,[s.DOWN_LEFT]:h.DOWN_LEFT}[o]}function Dr(o){return{[s.UP]:s.DOWN,[s.DOWN]:s.UP,[s.LEFT]:s.RIGHT,[s.RIGHT]:s.LEFT,[s.NONE]:s.NONE,[s.UP_LEFT]:s.DOWN_RIGHT,[s.UP_RIGHT]:s.DOWN_LEFT,[s.DOWN_RIGHT]:s.UP_LEFT,[s.DOWN_LEFT]:s.UP_RIGHT}[o]}var s,C,_=u(()=>{F();(function(c){c.NONE="none",c.LEFT="left",c.UP_LEFT="up-left",c.UP="up",c.UP_RIGHT="up-right",c.RIGHT="right",c.DOWN_RIGHT="down-right",c.DOWN="down",c.DOWN_LEFT="down-left"})(s||(s={}));(function(e){e[e.FOUR=4]="FOUR",e[e.EIGHT=8]="EIGHT"})(C||(C={}))});var P,lt=u(()=>{F();P=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return P.vec2str(t)==P.vec2str(e)}static manhattanDistance(t,e){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return r+i}static chebyshevDistance(t,e){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return Math.max(r,i)}static scalarMult(t,e){return t.clone().multiply(new h(e,e))}}});var Jt,Lr=u(()=>{lt();_();F();Jt=class{distance(t,e){return P.manhattanDistance(t,e)}direction(t,e){if(P.equal(t,e))return s.NONE;let r=t.clone().subtract(e);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?s.LEFT:s.RIGHT:r.y>0?s.UP:s.DOWN}neighbours(t){return[new h(t.x,t.y+1),new h(t.x+1,t.y),new h(t.x-1,t.y),new h(t.x,t.y-1)]}getDirections(){return[s.UP,s.RIGHT,s.DOWN,s.LEFT]}}});var Qt,Mr=u(()=>{lt();_();F();Qt=class{distance(t,e){return P.chebyshevDistance(t,e)}neighbours(t){let e=[new h(t.x,t.y+1),new h(t.x+1,t.y),new h(t.x-1,t.y),new h(t.x,t.y-1)],r=[new h(t.x+1,t.y+1),new h(t.x+1,t.y-1),new h(t.x-1,t.y+1),new h(t.x-1,t.y-1)];return[...e,...r]}direction(t,e){return e.x>t.x?e.y>t.y?s.DOWN_RIGHT:e.y<t.y?s.UP_RIGHT:s.RIGHT:e.x<t.x?e.y>t.y?s.DOWN_LEFT:e.y<t.y?s.UP_LEFT:s.LEFT:e.y<t.y?s.UP:e.y>t.y?s.DOWN:s.NONE}getDirections(){return[s.UP,s.RIGHT,s.DOWN,s.LEFT,s.DOWN_LEFT,s.DOWN_RIGHT,s.UP_RIGHT,s.UP_LEFT]}}});var pt,te=u(()=>{Lr();_();Mr();pt=class{static create(t){switch(t){case C.FOUR:return new Jt;case C.EIGHT:return new Qt}}}});var ee,Fr=u(()=>{lt();ee=class{getShortestPath(t,e,r){let i=this.shortestPathBfs(t,e,r);return{path:this.returnPath(i.previous,t,e),closestToTarget:i.closestToTarget}}distance(t,e){return P.manhattanDistance(t.position,e.position)}pos2Str(t){return`${t.position.toString()}#${t.layer}`}equal(t,e){return P.equal(t.position,e.position)?t.layer===e.layer:!1}shortestPathBfs(t,e,r){let i=new Map,n=new Set,a=[],l=t,p=this.distance(t,e);for(a.push({node:t,dist:0}),n.add(this.pos2Str(t));a.length>0;){let{node:c,dist:f}=a.shift(),T=this.distance(c,e);if(T<p&&(p=T,l=c),this.equal(c,e))return{shortestDistance:f,previous:i,closestToTarget:l};for(let m of r(c))n.has(this.pos2Str(m))||(i.set(this.pos2Str(m),c),a.push({node:m,dist:f+1}),n.add(this.pos2Str(m)))}return{shortestDistance:-1,previous:i,closestToTarget:l}}returnPath(t,e,r){let i=[],n=r;for(i.push(n);!this.equal(n,e);){if(n=t.get(this.pos2Str(n)),!n)return[];i.push(n)}return i.reverse()}}});var Lt,Rr=u(()=>{Lt=class{constructor(t,e,r){this.backoffMs=t;this.maxRetries=e;this.onFinished=r;this.retries=0;this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}}});var S,Mt=u(()=>{(function(r){r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY"})(S||(S={}))});var L,re=u(()=>{(function(r){r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP"})(L||(L={}))});var kr=u(()=>{});var Ft=u(()=>{Cr();kr();qt();Xt()});var x,ht,ie=u(()=>{te();_();Fr();Rr();Mt();re();Ft();(function(l){l.SUCCESS="SUCCESS",l.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED="NO_PATH_FOUND_MAX_RETRIES_EXCEEDED",l.PATH_BLOCKED_MAX_RETRIES_EXCEEDED="PATH_BLOCKED_MAX_RETRIES_EXCEEDED",l.PATH_BLOCKED="PATH_BLOCKED",l.NO_PATH_FOUND="NO_PATH_FOUND",l.PATH_BLOCKED_WAIT_TIMEOUT="PATH_BLOCKED_WAIT_TIMEOUT",l.MOVEMENT_TERMINATED="MOVEMENT_TERMINATED"})(x||(x={}));ht=class{constructor(t,e,r,i=C.FOUR,n=0,a){this.character=t;this.tilemap=e;this.targetPos=r;this.distance=n;this.posOnPath=0;this.stopped=!1;this.getNeighbours=t=>this.distanceUtils.neighbours(t.position).filter(i=>!this.isBlocking(i,t.layer)).map(i=>{let n=this.tilemap.getTransition(i,t.layer);return{position:i,layer:n||t.layer}});this.isBlocking=(t,e)=>{var r;return!t||!this.tilemap.isInRange(t)?!0:((r=this.character)==null?void 0:r.collidesWithTiles())?this.tilemap.isBlocking(e,t,this.character.getCollisionGroups()):this.tilemap.hasBlockingChar(t,e,this.character.getCollisionGroups())};this.noPathFoundStrategy=(a==null?void 0:a.noPathFoundStrategy)||S.STOP,this.pathBlockedStrategy=(a==null?void 0:a.pathBlockedStrategy)||L.WAIT,this.noPathFoundRetryable=new Lt((a==null?void 0:a.noPathFoundRetryBackoffMs)||200,(a==null?void 0:a.noPathFoundMaxRetries)||-1,()=>{this.stop(x.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED)}),this.pathBlockedRetryable=new Lt((a==null?void 0:a.pathBlockedRetryBackoffMs)||200,(a==null?void 0:a.pathBlockedMaxRetries)||-1,()=>{this.stop(x.PATH_BLOCKED_MAX_RETRIES_EXCEEDED)}),this.distanceUtils=pt.create(i),this.pathBlockedWaitTimeoutMs=(a==null?void 0:a.pathBlockedWaitTimeoutMs)||-1,this.finished$=new b,this.setCharacter(t)}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(et(1),N(e=>e!==this)).subscribe(()=>{this.stop(x.MOVEMENT_TERMINATED)})}update(t){var e,r,i,n;this.stopped||(this.noPathFound()&&(this.noPathFoundStrategy===S.RETRY?this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()):this.noPathFoundStrategy===S.STOP&&this.stop(x.NO_PATH_FOUND)),this.updatePosOnPath(),this.isBlocking((e=this.nextTileOnPath())==null?void 0:e.position,(r=this.character)==null?void 0:r.getNextTilePos().layer)?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop(x.SUCCESS),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking((i=this.nextTileOnPath())==null?void 0:i.position,(n=this.character)==null?void 0:n.getNextTilePos().layer)||this.moveCharOnPath())}finishedObs(){return this.finished$}resultToReason(t){switch(t){case x.SUCCESS:return"Successfully arrived.";case x.MOVEMENT_TERMINATED:return"Movement of character has been replaced before destination was reached.";case x.PATH_BLOCKED:return"PathBlockedStrategy STOP: Path blocked.";case x.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED:return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case x.NO_PATH_FOUND:return"NoPathFoundStrategy STOP: No path found.";case x.PATH_BLOCKED_MAX_RETRIES_EXCEEDED:return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case x.PATH_BLOCKED_WAIT_TIMEOUT:return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`}}applyPathBlockedStrategy(t){this.pathBlockedStrategy===L.RETRY?this.pathBlockedRetryable.retry(t,()=>this.calcShortestPath()):this.pathBlockedStrategy===L.STOP?this.stop(x.PATH_BLOCKED):this.pathBlockedStrategy===L.WAIT&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop(x.PATH_BLOCKED_WAIT_TIMEOUT))}moveCharOnPath(){let t=this.getDir(this.character.getNextTilePos().position,this.nextTileOnPath().position);this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(t){this.finished$.next({position:this.character.getTilePos().position,result:t,description:this.resultToReason(t),layer:this.character.getTilePos().layer}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos().position,t.position);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().position.x!=t.position.x||this.character.getNextTilePos().position.y!=t.position.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(){let t=this.getShortestPath();this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new ee,{path:e,closestToTarget:r}=t.getShortestPath(this.character.getNextTilePos(),this.targetPos,this.getNeighbours);if(e.length==0&&this.noPathFoundStrategy===S.CLOSEST_REACHABLE){let n=t.getShortestPath(this.character.getNextTilePos(),r,this.getNeighbours).path,a=this.distanceUtils.distance(r.position,this.targetPos.position);return{path:n,distOffset:a}}return{path:e,distOffset:0}}getDir(t,e){return this.distanceUtils.direction(t,e)}}});var oe,Ar=u(()=>{Dt();_();ie();F();Mt();oe=class{constructor(t,e,r,i=C.FOUR,n=0,a=S.STOP){this.character=t;this.gridTilemap=e;this.charToFollow=r;this.numberOfDirections=i;this.distance=n;this.noPathFoundStrategy=a;this.character=t,this.updateTarget(this.charToFollow.getTilePos().position,this.charToFollow.getTilePos().layer),this.charToFollow.positionChangeStarted().pipe(z(this.character.autoMovementSet().pipe(N(l=>l!==this)))).subscribe(({enterTile:l,enterLayer:p})=>{this.updateTarget(l,p)})}update(t){var e;(e=this.targetMovement)==null||e.update(t)}updateTarget(t,e){this.targetMovement=new ht(this.character,this.gridTilemap,{position:new h(t),layer:e},this.numberOfDirections,this.distance+1,{noPathFoundStrategy:this.noPathFoundStrategy})}}});var ct,Gr=u(()=>{ct=class{static copyOver(t,e){e.position.x=t.position.x,e.position.y=t.position.y,e.layer=t.layer}static clone(t){return{position:t.position.clone(),layer:t.layer}}}});var rt,ut,Ir=u(()=>{_();rt=class{constructor(t,e,r){this.sprite=t;this.walkingAnimationMapping=e;this.characterIndex=r;this.lastFootLeft=!1;this.directionToFrameRow={[s.DOWN]:0,[s.DOWN_LEFT]:1,[s.DOWN_RIGHT]:2,[s.LEFT]:1,[s.RIGHT]:2,[s.UP]:3,[s.UP_LEFT]:1,[s.UP_RIGHT]:2};this._isEnabled=!0}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t,this._isEnabled=this.walkingAnimationMapping!==void 0}setCharacterIndex(t){this.characterIndex=t,this._isEnabled=this.characterIndex!==-1}getWalkingAnimationMapping(){return this.walkingAnimationMapping}getCharacterIndex(){return this.characterIndex}setStandingFrameDuringWalk(t){this.isCurrentFrameStanding(t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);this.sprite.setFrame(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){this.sprite.setFrame(this.framesOfDirection(t).standing)}isCurrentFrameStanding(t){return Number(this.sprite.frame.name)==this.framesOfDirection(t).standing}framesOfDirection(t){return this.walkingAnimationMapping?this.getFramesForAnimationMapping(t):this.getFramesForCharIndex(t)}getFramesForAnimationMapping(t){return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case s.DOWN_LEFT:return s.LEFT;case s.DOWN_RIGHT:return s.RIGHT;case s.UP_LEFT:return s.LEFT;case s.UP_RIGHT:return s.RIGHT}return t}getFramesForCharIndex(t){let e=this.sprite.texture.source[0].width/this.sprite.width/rt.FRAMES_CHAR_ROW,r=Math.floor(this.characterIndex/e),i=this.characterIndex%e,n=e*rt.FRAMES_CHAR_ROW,a=rt.FRAMES_CHAR_ROW*i,l=this.directionToFrameRow[t]+r*rt.FRAMES_CHAR_COL,p=a+l*n;return{rightFoot:p,standing:p+1,leftFoot:p+2}}},ut=rt;ut.FRAMES_CHAR_ROW=3,ut.FRAMES_CHAR_COL=4});var mt,ne=u(()=>{mt=class{static shiftPad(t,e){let r=Math.floor(t),n=`${r}`.padStart(e,"0").length;return r/Math.pow(10,n)}}});var ae,Nr=u(()=>{ae=class{static copyOverImportantProperties(t,e){e.x=t.x,e.y=t.y,e.tint=t.tint,e.alpha=t.alpha,e.scale=t.scale,e.setFrame(t.frame.name),e.active=t.active,e.alphaBottomLeft=t.alphaBottomLeft,e.alphaBottomRight=t.alphaBottomRight,e.alphaTopLeft=t.alphaTopLeft,e.alphaTopRight=t.alphaTopRight,e.angle=t.angle}}});var se,Wr=u(()=>{Gr();Ir();_();_();Ft();F();ne();Nr();se=class{constructor(t,e){this.id=t;this.movementDirection=s.NONE;this.tileSizePixelsWalked=h.ZERO;this._nextTilePos={position:new h(0,0),layer:void 0};this._tilePos={position:new h(0,0),layer:void 0};this.movementStarted$=new b;this.movementStopped$=new b;this.directionChanged$=new b;this.positionChangeStarted$=new b;this.positionChangeFinished$=new b;this.tilePositionSet$=new b;this.autoMovementSet$=new b;this.lastMovementImpulse=s.NONE;this.facingDirection=s.DOWN;this.characterIndex=-1;typeof e.walkingAnimationMapping=="number"?this.characterIndex=e.walkingAnimationMapping:this.walkingAnimationMapping=e.walkingAnimationMapping,this.container=e.container,this.tilemap=e.tilemap,this.speed=e.speed,this.collidesWithTilesInternal=e.collidesWithTiles,this.customOffset=new h(e.offsetX||0,e.offsetY||0),this._tilePos.layer=e.charLayer,this.sprite=e.sprite,this.layerOverlaySprite=e.layerOverlaySprite,this.collisionGroups=new Set(e.collisionGroups||[]),this.layerOverlaySprite&&this.initLayerOverlaySprite(),this._setSprite(this.sprite)}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}getSprite(){return this.sprite}setSprite(t){this._setSprite(t)}setMovement(t){this.autoMovementSet$.next(t),this.movement=t}getMovement(){return this.movement}collidesWithTiles(){return this.collidesWithTilesInternal}setWalkingAnimationMapping(t){typeof t=="number"?this.animation.setCharacterIndex(t):this.animation.setWalkingAnimationMapping(t)}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.tilePositionSet$.next(M({},t)),this.nextTilePos=t,this.fire(this.positionChangeStarted$,this.tilePos,this.nextTilePos),this.fire(this.positionChangeFinished$,this.tilePos,this.nextTilePos),this.movementDirection=s.NONE,this.lastMovementImpulse=s.NONE,this.tilePos=t,this.setPosition(this.tilemap.tilePosToPixelPos(t.position).add(this.getOffset()).add(this.customOffset)),this.updateZindex()}getTilePos(){return this.tilePos}getNextTilePos(){return this.nextTilePos}move(t){this.lastMovementImpulse=t,t!=s.NONE&&(this.isMoving()||(this.isBlockingDirection(t)?(this.facingDirection=t,this.animation.setStandingFrame(t),this.directionChanged$.next(t)):this.startMoving(t)))}update(t){var e,r,i;(e=this.movement)==null||e.update(t),this.isMoving()&&(this.updateCharacterPosition(t),this.updateZindex()),this.lastMovementImpulse=s.NONE,this.layerOverlaySprite&&(ae.copyOverImportantProperties(this.sprite,this.layerOverlaySprite),this.layerOverlaySprite.x=this.sprite.x+(((r=this.container)==null?void 0:r.x)||0),this.layerOverlaySprite.y=this.sprite.y+(((i=this.container)==null?void 0:i.y)||0))}getMovementDirection(){return this.movementDirection}isBlockingDirection(t){if(t==s.NONE)return!1;let e=this.tilePosInDirection(t),r=this.tilemap.getTransition(e,this.nextTilePos.layer)||this.nextTilePos.layer;return this.collidesWithTilesInternal&&this.tilemap.hasBlockingTile(r,e,Dr(t))?!0:this.tilemap.hasBlockingChar(e,r,this.getCollisionGroups())}isMoving(){return this.movementDirection!=s.NONE}turnTowards(t){this.isMoving()||t!=s.NONE&&(this.facingDirection=t,this.animation.setStandingFrame(t))}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.position.add(W(this.facingDirection))}addCollisionGroup(t){this.collisionGroups.add(t)}setCollisionGroups(t){this.collisionGroups=new Set(t)}getCollisionGroups(){return Array.from(this.collisionGroups)}hasCollisionGroup(t){return this.collisionGroups.has(t)}removeCollisionGroup(t){this.collisionGroups.delete(t)}removeAllCollisionGroups(){this.collisionGroups.clear()}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}tilePositionSet(){return this.tilePositionSet$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}_setSprite(t){t.setOrigin(0,0),t.x=this.sprite.x,t.y=this.sprite.y,this.sprite=t,this.animation=new ut(this.sprite,this.walkingAnimationMapping,this.characterIndex),this.animation.setIsEnabled(this.walkingAnimationMapping!==void 0||this.characterIndex!==-1),this.animation.setStandingFrame(s.DOWN),this.updateZindex()}getOffset(){let t=this.tilemap.getTileWidth()/2-Math.floor(this.sprite.displayWidth/2),e=-this.sprite.displayHeight+this.tilemap.getTileHeight();return new h(t,e)}updateCharacterPosition(t){let e=this.getSpeedPerDelta(t),r=this.getDistToNextTile(),i=r.length()<=e.length(),n=i?r:e;this.moveCharacterSprite(n),i&&(this.shouldContinueMoving()?(this.fire(this.positionChangeFinished$,this.tilePos,this.nextTilePos),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(t*this.getProportionWalked(e,r))):this.stopMoving())}speedPixelsPerSecond(t){return W(t).abs().multiply(this.tilemap.getTileDistance(t)).scalarMult(this.speed)}get nextTilePos(){return{position:this._nextTilePos.position.clone(),layer:this._nextTilePos.layer}}set nextTilePos(t){ct.copyOver(t,this._nextTilePos)}get tilePos(){return ct.clone(this._tilePos)}set tilePos(t){ct.copyOver(t,this._tilePos)}gameObject(){return this.container||this.sprite}updateZindex(){if(this.setDepth(this.gameObject(),this.nextTilePos),this.layerOverlaySprite){let t=new h(K(M({},this.nextTilePos.position),{y:this.nextTilePos.position.y-1}));this.setDepth(this.layerOverlaySprite,{position:t,layer:this.nextTilePos.layer})}}setDepth(t,e){t.setDepth(this.tilemap.getDepthOfCharLayer(this.getTransitionLayer(e))+this.getPaddedPixelDepth())}getPaddedPixelDepth(){return mt.shiftPad(this.gameObject().y+this.gameObject().displayHeight,7)}getTransitionLayer(t){return this.tilemap.getTransition(t.position,t.layer)||t.layer}setPosition(t){this.gameObject().x=t.x,this.gameObject().y=t.y}getPosition(){return new h(this.gameObject().x,this.gameObject().y)}startMoving(t){t!==s.NONE&&(t!=this.movementDirection&&this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.updateTilePos())}updateTilePos(){this.tilePos=this.nextTilePos;let t=this.tilePosInDirection(this.movementDirection),r=this.tilemap.getTransition(t,this.tilePos.layer)||this.tilePos.layer;this.nextTilePos={position:t,layer:r},this.fire(this.positionChangeStarted$,this.tilePos,this.nextTilePos)}tilePosInDirection(t){return this.nextTilePos.position.add(W(this.tilemap.toMapDirection(t)))}getDistToNextTile(){return this.tilemap.getTileDistance(this.movementDirection).subtract(this.tileSizePixelsWalked).multiply(W(this.movementDirection))}getProportionWalked(t,e){let i=t.subtract(e).divide(t);return isNaN(i.x)&&(i.x=0),Math.max(Math.abs(i.x),Math.abs(i.y))}shouldContinueMoving(){return this.lastMovementImpulse!==s.NONE&&!this.isBlockingDirection(this.lastMovementImpulse)}getSpeedPerDelta(t){let e=t/1e3;return this.speedPixelsPerSecond(this.movementDirection).scalarMult(e).multiply(W(this.movementDirection))}moveCharacterSprite(t){let e=this.getPosition().add(t);this.setPosition(e),this.tileSizePixelsWalked=this.tileSizePixelsWalked.add(t.abs()),this.animation.updateCharacterFrame(this.movementDirection,this.hasWalkedHalfATile()),this.tileSizePixelsWalked=this.tileSizePixelsWalked.modulo(this.tilemap.getTileDistance(this.movementDirection))}stopMoving(){if(this.movementDirection===s.NONE)return;let t=this.tilePos,e=this.nextTilePos,r=this.movementDirection;this.tilePos=this.nextTilePos,this.movementDirection=s.NONE,this.movementStopped$.next(r),this.fire(this.positionChangeFinished$,t,e)}hasWalkedHalfATile(){return this.tileSizePixelsWalked.x>this.tilemap.getTileDistance(this.movementDirection).x/2||this.tileSizePixelsWalked.y>this.tilemap.getTileDistance(this.movementDirection).y/2}fire(t,{position:e,layer:r},{position:i,layer:n}){t.next({exitTile:e,enterTile:i,exitLayer:r,enterLayer:n})}initLayerOverlaySprite(){this.layerOverlaySprite.scale=this.sprite.scale;let t=this.tilemap.getTileHeight()/this.layerOverlaySprite.scale;this.layerOverlaySprite.setCrop(0,0,this.layerOverlaySprite.displayWidth,this.sprite.height-t),this.layerOverlaySprite.setOrigin(0,0)}}});var le,Ur=u(()=>{dt();At();le=class{constructor(){this.tilePosToCharacters=new Map;this.positionChangeStartedSubs=new Map;this.tilePosSetSubs=new Map;this.positionChangeFinishedSubs=new Map}isCharBlockingAt(t,e,r){let i=this.posToString(t,e);return this.tilePosToCharacters.has(i)&&this.tilePosToCharacters.get(i).size>0&&[...this.tilePosToCharacters.get(i)].some(n=>n.getCollisionGroups().some(a=>r.includes(a)))}addCharacter(t){this.add(this.posToString(t.getTilePos().position,t.getTilePos().layer),t),this.add(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer),t),this.addPositionChangeSub(t),this.addPositionChangeFinishedSub(t),this.addTilePosSetSub(t)}removeCharacter(t){let e=t.getId();this.positionChangeStartedSubs.get(e).unsubscribe(),this.positionChangeFinishedSubs.get(e).unsubscribe(),this.tilePosSetSubs.get(e).unsubscribe(),this.tilePosToCharacters.get(this.posToString(t.getTilePos().position,t.getTilePos().layer)).delete(t),this.tilePosToCharacters.get(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer)).delete(t)}add(t,e){this.tilePosToCharacters.has(t)||this.tilePosToCharacters.set(t,new Set),this.tilePosToCharacters.get(t).add(e)}addTilePosSetSub(t){let e=t.tilePositionSet().subscribe(r=>{this.tilePosToCharacters.get(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer)).delete(t)});this.tilePosSetSubs.set(t.getId(),e)}addPositionChangeSub(t){let e=t.positionChangeStarted().subscribe(r=>{y.get().characterCollisionStrategy===X.BLOCK_ONE_TILE_AHEAD&&this.tilePosToCharacters.get(this.posToString(r.exitTile,r.exitLayer)).delete(t),this.add(this.posToString(r.enterTile,r.enterLayer),t)});this.positionChangeStartedSubs.set(t.getId(),e)}addPositionChangeFinishedSub(t){let e=t.positionChangeFinished().subscribe(r=>{this.tilePosToCharacters.get(this.posToString(r.exitTile,r.exitLayer)).delete(t)});this.positionChangeFinishedSubs.set(t.getId(),e)}posToString(t,e){return`${t.x}#${t.y}#${e}`}}});var pe,Br=u(()=>{pe=class{constructor(t,e,r,i){this.x=t;this.y=e;this.width=r;this.height=i}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}isInRange(t){return t.x>=this.x&&t.x<this.x+this.width&&t.y>=this.y&&t.y<this.y+this.height}}});var O,U,Vr=u(()=>{dt();_();F();Ur();Br();lt();ne();O=class{constructor(t){this.tilemap=t;this.characters=new Map;this.charBlockCache=new le;this.charLayerDepths=new Map;this.transitions=new Map;this.setLayerDepths()}addCharacter(t){this.characters.set(t.getId(),t),t.getNextTilePos().layer===void 0&&t.setTilePosition(K(M({},t.getNextTilePos()),{layer:this.getLowestCharLayer()})),this.charBlockCache.addCharacter(t)}removeCharacter(t){this.charBlockCache.removeCharacter(this.characters.get(t)),this.characters.delete(t)}getCharacters(){return[...this.characters.values()]}isBlocking(t,e,r,i){return this.hasNoTile(e,t)||this.hasBlockingTile(t,e,i)||this.hasBlockingChar(e,t,r)}hasBlockingTile(t,e,r){return this.hasNoTile(e,t)?!0:this.getCollisionRelevantLayers(t).some(i=>this.isLayerBlockingAt(i,e,r))}getTransition(t,e){let r=this.transitions.get(t.toString());if(r)return r.get(e)}setTransition(t,e,r){this.transitions.has(t.toString())||this.transitions.set(t.toString(),new Map),this.transitions.get(t.toString()).set(e,r)}getTransitions(){return new Map([...this.transitions].map(([t,e])=>[t,new Map(e)]))}hasNoTile(t,e){return!this.getCollisionRelevantLayers(e).some(r=>this.tilemap.hasTileAt(t.x,t.y,r.name))}hasBlockingChar(t,e,r){return this.charBlockCache.isCharBlockingAt(t,e,r)}getTileWidth(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*t}getTileHeight(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*t}getDepthOfCharLayer(t){return this.charLayerDepths.get(t)||0}isInRange(t){return new pe(0,0,this.tilemap.width,this.tilemap.height).isInRange(t)}getTileSize(){return new h(this.getTileWidth(),this.getTileHeight())}tilePosToPixelPos(t){return this.isIsometric()?P.scalarMult(this.getTileSize(),.5).multiply(new h(t.x-t.y,t.x+t.y)):t.clone().multiply(this.getTileSize())}getTileDistance(t){if(this.isIsometric())switch(t){case s.DOWN_LEFT:case s.DOWN_RIGHT:case s.UP_LEFT:case s.UP_RIGHT:return P.scalarMult(this.getTileSize(),.5);default:return this.getTileSize()}return this.getTileSize()}toMapDirection(t){return this.isIsometric()?wr(t):t}isIsometric(){return this.tilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()}isLayerBlockingAt(t,e,r){let i=O.ONE_WAY_COLLIDE_PROP_PREFIX+r,n=this.tilemap.getTileAt(e.x,e.y,!1,t.name);return Boolean((n==null?void 0:n.properties)&&(n.properties[y.get().collisionTilePropertyName]||n.properties[i]))}getCharLayerIndexes(){return this.tilemap.layers.map((t,e)=>({layer:t,index:e})).filter(({layer:t})=>this.isCharLayer(t)).map(({index:t})=>t)}findPrevAndCharLayer(t){let e=this.getCharLayerIndexes(),r=e.findIndex(i=>this.getLayerProp(this.tilemap.layers[i],O.CHAR_LAYER_PROP_NAME)==t);return r==0?{prevIndex:-1,charLayerIndex:e[r]}:{prevIndex:e[r-1],charLayerIndex:e[r]}}getCollisionRelevantLayers(t){if(!t)return this.tilemap.layers;let{prevIndex:e,charLayerIndex:r}=this.findPrevAndCharLayer(t);return this.tilemap.layers.slice(e+1,r+1)}getLowestCharLayer(){let t=this.tilemap.layers.find(e=>this.hasLayerProp(e,O.CHAR_LAYER_PROP_NAME));if(t)return this.getLayerProp(t,O.CHAR_LAYER_PROP_NAME)}getLayerProp(t,e){let i=t.properties.find(n=>n.name==e);return i==null?void 0:i.value}hasLayerProp(t,e){return this.getLayerProp(t,e)!=null}isLayerAlwaysOnTop(t){return this.hasLayerProp(t,O.ALWAYS_TOP_PROP_NAME)}isCharLayer(t){return this.hasLayerProp(t,O.CHAR_LAYER_PROP_NAME)}setLayerDepths(){let t=[],e=-1,r=this.tilemap.layers.filter(n=>this.isLayerAlwaysOnTop(n)),i=this.tilemap.layers.filter(n=>!this.isLayerAlwaysOnTop(n));i.forEach(n=>{this.hasLayerProp(n,O.HEIGHT_SHIFT_PROP_NAME)?(this.createHeightShiftLayers(n,e),t.push(n.tilemapLayer)):this.setDepth(n,++e)}),i.forEach(n=>{this.isCharLayer(n)||this.charLayerDepths.set(void 0,e)}),r.forEach((n,a)=>{n.tilemapLayer.setDepth(a+1+e)}),t.forEach(n=>n.destroy())}setDepth(t,e){t.tilemapLayer.setDepth(e),this.isCharLayer(t)&&this.charLayerDepths.set(this.getLayerProp(t,O.CHAR_LAYER_PROP_NAME),e)}createHeightShiftLayers(t,e){let r=this.getLayerProp(t,O.HEIGHT_SHIFT_PROP_NAME);for(let i=0;i<t.height;i++){let n=this.copyLayer(t,i);n.scale=t.tilemapLayer.scale,n.setDepth(e+mt.shiftPad((i+r)*this.getTileHeight(),O.Z_INDEX_PADDING))}}copyLayer(t,e){let r=this.tilemap.createBlankLayer(`${t.name}#${e}`,t.tilemapLayer.tileset);for(let i=0;i<t.width;i++)r.putTileAt(t.data[e][i],i,e);return r}},U=O;U.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",U.CHAR_LAYER_PROP_NAME="ge_charLayer",U.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",U.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_",U.Z_INDEX_PADDING=7});var Rt,Hr=u(()=>{Rt=class{static getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}}});var he,jr=u(()=>{Hr();te();_();_();Dt();F();he=class{constructor(t,e=C.FOUR,r=0,i=-1){this.character=t;this.delay=r;this.radius=i;this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().position.y,this.initialCol=t.getNextTilePos().position.x,this.randomizeStepSize(),this.stepsWalked=0,this.currentMovementDirection=s.NONE,this.character.positionChangeStarted().pipe(z(this.character.autoMovementSet())).subscribe(()=>{this.stepsWalked++}),this.distanceUtils=pt.create(e)}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let e=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(e),this.currentMovementDirection=e,this.randomizeStepSize()}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!==s.NONE&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return this.distanceUtils.getDirections().filter(e=>!this.character.isBlockingDirection(e)).filter(e=>this.isWithinRadius(e))}isWithinRadius(t){return this.radius==-1?!0:this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().position.add(W(t)),new h(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return t.length==0?s.NONE:t[Rt.getRandomInt(t.length)]}randomizeStepSize(){this.stepSize=Rt.getRandomInt(this.radius)+1}}});var ce,$r=u(()=>{dt();At();Ar();ie();Wr();_();Vr();jr();Ft();Dt();F();Mt();re();ce=class{constructor(t){this.scene=t;this.isCreated=!1;this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this),this.scene.sys.events.on("destroy",this.destroy,this)}destroy(){this.scene=void 0,this.gridCharacters=void 0,this.gridTilemap=void 0,this.movementStarted$=void 0,this.movementStopped$=void 0,this.directionChanged$=void 0,this.positionChangeStarted$=void 0,this.positionChangeFinished$=void 0,this.charRemoved$=void 0}getCharLayer(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos().layer}getTransition(t,e){return this.initGuard(),this.gridTilemap.getTransition(new h(t),e)}setTransition(t,e,r){return this.initGuard(),this.gridTilemap.setTransition(new h(t),e,r)}create(t,e){this.isCreated=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(e);y.set(r),this.movementStopped$=new b,this.movementStarted$=new b,this.directionChanged$=new b,this.positionChangeStarted$=new b,this.positionChangeFinished$=new b,this.charRemoved$=new b,this.gridTilemap=new U(t),this.addCharacters()}getPosition(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos().position}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,r=-1){this.initGuard(),this.unknownCharGuard(t);let i=new he(this.gridCharacters.get(t),y.get().numberOfDirections,e,r);this.gridCharacters.get(t).setMovement(i)}moveTo(t,e,r){let i=this.assembleMoveToConfig(r);this.initGuard(),this.unknownCharGuard(t);let n=new ht(this.gridCharacters.get(t),this.gridTilemap,{position:new h(e),layer:(r==null?void 0:r.targetLayer)||this.gridCharacters.get(t).getNextTilePos().layer},y.get().numberOfDirections,0,i);return this.gridCharacters.get(t).setMovement(n),n.finishedObs().pipe(et(1),Kt(a=>({charId:t,position:a.position,result:a.result,description:a.description,layer:a.layer})))}stopMovement(t){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setMovement(void 0)}setSpeed(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setSpeed(e)}setWalkingAnimationMapping(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setWalkingAnimationMapping(e)}update(t,e){if(this.isCreated&&this.gridCharacters)for(let[r,i]of this.gridCharacters)i.update(e)}addCharacter(t){this.initGuard();let e=y.get().layerOverlay?this.scene.add.sprite(0,0,t.sprite.texture):void 0,r={sprite:t.sprite,layerOverlaySprite:e,speed:t.speed||4,tilemap:this.gridTilemap,walkingAnimationMapping:t.walkingAnimationMapping,container:t.container,offsetX:t.offsetX,offsetY:t.offsetY,collidesWithTiles:!0,collisionGroups:["geDefault"],charLayer:t.charLayer};typeof t.collides=="boolean"?t.collides===!1&&(r.collidesWithTiles=!1,r.collisionGroups=[]):t.collides!==void 0&&(t.collides.collidesWithTiles===!1&&(r.collidesWithTiles=!1),t.collides.collisionGroups&&(r.collisionGroups=t.collides.collisionGroups));let i=this.createCharacter(t.id,r);t.facingDirection&&i.turnTowards(t.facingDirection),this.gridCharacters.set(t.id,i);let n=t.startPosition?new h(t.startPosition):new h(0,0);i.setTilePosition({position:n,layer:i.getTilePos().layer}),this.gridTilemap.addCharacter(i),i.movementStopped().pipe(this.takeUntilCharRemoved(i.getId())).subscribe(a=>{this.movementStopped$.next({charId:i.getId(),direction:a})}),i.movementStarted().pipe(this.takeUntilCharRemoved(i.getId())).subscribe(a=>{this.movementStarted$.next({charId:i.getId(),direction:a})}),i.directionChanged().pipe(this.takeUntilCharRemoved(i.getId())).subscribe(a=>{this.directionChanged$.next({charId:i.getId(),direction:a})}),i.positionChangeStarted().pipe(this.takeUntilCharRemoved(i.getId())).subscribe(a=>{this.positionChangeStarted$.next(M({charId:i.getId()},a))}),i.positionChangeFinished().pipe(this.takeUntilCharRemoved(i.getId())).subscribe(a=>{this.positionChangeFinished$.next(M({charId:i.getId()},a))})}hasCharacter(t){return this.initGuard(),this.gridCharacters.has(t)}removeCharacter(t){this.initGuard(),this.unknownCharGuard(t),this.gridTilemap.removeCharacter(t),this.gridCharacters.delete(t),this.charRemoved$.next(t)}removeAllCharacters(){this.initGuard();for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(){return this.initGuard(),[...this.gridCharacters.keys()]}follow(t,e,r=0,i=!1){this.initGuard(),this.unknownCharGuard(t),this.unknownCharGuard(e);let n=new oe(this.gridCharacters.get(t),this.gridTilemap,this.gridCharacters.get(e),y.get().numberOfDirections,r,i?S.CLOSEST_REACHABLE:S.STOP);this.gridCharacters.get(t).setMovement(n)}isMoving(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).isMoving()}getFacingDirection(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getFacingDirection()}getFacingPosition(t){this.initGuard(),this.unknownCharGuard(t);let e=this.gridCharacters.get(t).getFacingPosition();return{x:e.x,y:e.y}}turnTowards(t,e){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).turnTowards(e)}setPosition(t,e,r){this.initGuard(),this.unknownCharGuard(t),r||this.gridCharacters.get(t).setTilePosition({position:new h(e),layer:this.gridCharacters.get(t).getTilePos().layer}),this.gridCharacters.get(t).setTilePosition({position:new h(e),layer:r})}getSprite(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getSprite()}setSprite(t,e){this.initGuard(),this.unknownCharGuard(t),e.setOrigin(0,0),this.gridCharacters.get(t).setSprite(e)}isBlocked(t,e,r=["geDefault"]){return this.initGuard(),this.gridTilemap.isBlocking(e,new h(t),r)}isTileBlocked(t,e){return this.initGuard(),this.gridTilemap.hasBlockingTile(e,new h(t))}getCollisionGroups(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getCollisionGroups()}setCollisionGroups(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setCollisionGroups(e)}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}setConfigDefaults(t){return M({collisionTilePropertyName:"ge_collide",numberOfDirections:C.FOUR,characterCollisionStrategy:X.BLOCK_TWO_TILES,layerOverlay:!1},t)}takeUntilCharRemoved(t){return z(this.charRemoved$.pipe(N(e=>e==t)))}initGuard(){if(!this.isCreated)throw new Error("Plugin not initialized. You need to call create() first.")}unknownCharGuard(t){if(!this.gridCharacters.has(t))throw new Error(`Character unknown: ${t}`)}createCharacter(t,e){return new se(t,e)}addCharacters(){y.get().characters.forEach(t=>this.addCharacter(t))}moveChar(t,e){if(this.initGuard(),this.unknownCharGuard(t),y.get().numberOfDirections===C.FOUR){if(!this.gridTilemap.isIsometric()&&Zt(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}else if(this.gridTilemap.isIsometric()&&!Zt(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}this.gridCharacters.get(t).move(e)}assembleMoveToConfig(t){let e=K(M({},t),{noPathFoundStrategy:S.STOP,pathBlockedStrategy:L.WAIT});return(t==null?void 0:t.noPathFoundStrategy)&&(Object.values(S).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to '${S.STOP}'`)),(t==null?void 0:t.pathBlockedStrategy)&&(Object.values(L).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to '${L.WAIT}'`)),e}}});var di=de((Os,zr)=>{$r();zr.exports=ce});return di();})();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
