var GridEngine=(()=>{var or=Object.create,Q=Object.defineProperty,nr=Object.getPrototypeOf,Gt=Object.prototype.hasOwnProperty,sr=Object.getOwnPropertyNames,ar=Object.getOwnPropertyDescriptor,At=Object.getOwnPropertySymbols,cr=Object.prototype.propertyIsEnumerable;var Vt=(i,t,e)=>t in i?Q(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,mt=(i,t)=>{for(var e in t||(t={}))Gt.call(t,e)&&Vt(i,e,t[e]);if(At)for(var e of At(t))cr.call(t,e)&&Vt(i,e,t[e]);return i},lr=i=>Q(i,"__esModule",{value:!0});var p=(i,t)=>()=>(i&&(t=i(i=0)),t),It=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var hr=(i,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of sr(t))!Gt.call(i,r)&&r!=="default"&&Q(i,r,{get:()=>t[r],enumerable:!(e=ar(t,r))||e.enumerable});return i},pr=i=>hr(lr(Q(i!=null?or(nr(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var w,ft=p(()=>{(function(i){i.WAIT="WAIT",i.RETRY="RETRY",i.STOP="STOP"})(w||(w={}))});var D,l,E=p(()=>{D=class{constructor(t,e){typeof t=="number"?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new D(this.x,this.y)}add(t){return new D(this.x+t.x,this.y+t.y)}multiply(t){return new D(this.x*t.x,this.y*t.y)}subtract(t){return new D(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}},l=D;l.ZERO=new D(0,0),l.UP=new D(0,-1),l.DOWN=new D(0,1),l.LEFT=new D(-1,0),l.RIGHT=new D(1,0)});function Nt(i){let t=[s.UP,s.RIGHT,s.DOWN,s.LEFT],e=[s.DOWN_LEFT,s.DOWN_RIGHT,s.UP_RIGHT,s.UP_LEFT];return i===S.EIGHT?[...t,...e]:t}function dt(i){return[s.DOWN_LEFT,s.DOWN_RIGHT,s.UP_RIGHT,s.UP_LEFT].includes(i)}function Wt(i){return{[s.LEFT]:s.DOWN_LEFT,[s.UP_LEFT]:s.LEFT,[s.UP]:s.UP_LEFT,[s.UP_RIGHT]:s.UP,[s.RIGHT]:s.UP_RIGHT,[s.DOWN_RIGHT]:s.RIGHT,[s.DOWN]:s.DOWN_RIGHT,[s.DOWN_LEFT]:s.DOWN,[s.NONE]:s.NONE}[i]}function F(i){return{[s.UP]:l.UP.clone(),[s.DOWN]:l.DOWN.clone(),[s.LEFT]:l.LEFT.clone(),[s.RIGHT]:l.RIGHT.clone(),[s.NONE]:l.ZERO.clone(),[s.UP_LEFT]:new l(-1,-1),[s.UP_RIGHT]:new l(1,-1),[s.DOWN_RIGHT]:new l(1,1),[s.DOWN_LEFT]:new l(-1,1)}[i]}function Lt(i){return{[s.UP]:s.DOWN,[s.DOWN]:s.UP,[s.LEFT]:s.RIGHT,[s.RIGHT]:s.LEFT,[s.NONE]:s.NONE,[s.UP_LEFT]:s.DOWN_RIGHT,[s.UP_RIGHT]:s.DOWN_LEFT,[s.DOWN_RIGHT]:s.UP_LEFT,[s.DOWN_LEFT]:s.UP_RIGHT}[i]}var s,S,P=p(()=>{E();(function(i){i.NONE="none",i.LEFT="left",i.UP_LEFT="up-left",i.UP="up",i.UP_RIGHT="up-right",i.RIGHT="right",i.DOWN_RIGHT="down-right",i.DOWN="down",i.DOWN_LEFT="down-left"})(s||(s={}));(function(i){i[i.FOUR=4]="FOUR",i[i.EIGHT=8]="EIGHT"})(S||(S={}))});var f,N=p(()=>{E();f=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return f.vec2str(t)==f.vec2str(e)}static manhattanDistance(t,e){let r=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return r+o}static chebyshevDistance(t,e){let r=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return Math.max(r,o)}static scalarMult(t,e){return t.clone().multiply(new l(e,e))}}});var W,z,jt=p(()=>{P();W=class{constructor(t,e,r){this.sprite=t;this.walkingAnimationMapping=e;this.characterIndex=r;this.lastFootLeft=!1;this.directionToFrameRow={[s.DOWN]:0,[s.DOWN_LEFT]:1,[s.DOWN_RIGHT]:2,[s.LEFT]:1,[s.RIGHT]:2,[s.UP]:3,[s.UP_LEFT]:1,[s.UP_RIGHT]:2};this._isEnabled=!0}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t}setStandingFrameDuringWalk(t){this.isCurrentFrameStanding(t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);this.sprite.setFrame(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){this.sprite.setFrame(this.framesOfDirection(t).standing)}isCurrentFrameStanding(t){return Number(this.sprite.frame.name)==this.framesOfDirection(t).standing}framesOfDirection(t){return this.walkingAnimationMapping?this.getFramesForAnimationMapping(t):this.getFramesForCharIndex(t)}getFramesForAnimationMapping(t){return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case s.DOWN_LEFT:return s.LEFT;case s.DOWN_RIGHT:return s.RIGHT;case s.UP_LEFT:return s.LEFT;case s.UP_RIGHT:return s.RIGHT}return t}getFramesForCharIndex(t){let e=this.sprite.texture.source[0].width/this.sprite.width/W.FRAMES_CHAR_ROW,r=Math.floor(this.characterIndex/e),o=this.characterIndex%e,n=e*W.FRAMES_CHAR_ROW,a=W.FRAMES_CHAR_ROW*o,c=this.directionToFrameRow[t]+r*W.FRAMES_CHAR_COL,h=a+c*n;return{rightFoot:h,standing:h+1,leftFoot:h+2}}},z=W;z.FRAMES_CHAR_ROW=3,z.FRAMES_CHAR_COL=4});var C,O,bt=p(()=>{C=class{constructor(t,e){this.tilemap=t;this.firstLayerAboveChar=e;this.characters=new Map;this.collisionTilePropertyName="ge_collide";this.setLayerDepths()}addCharacter(t){this.characters.set(t.getId(),t)}removeCharacter(t){this.characters.delete(t)}getCharacters(){return[...this.characters.values()]}isBlocking(t,e){return this.hasNoTile(t)||this.hasBlockingTile(t,e)||this.hasBlockingChar(t)}hasBlockingTile(t,e){if(this.hasNoTile(t))return!0;let r=C.ONE_WAY_COLLIDE_PROP_PREFIX+e;return this.tilemap.layers.some(o=>{let n=this.tilemap.getTileAt(t.x,t.y,!1,o.name);return(n==null?void 0:n.properties)&&(n.properties[this.collisionTilePropertyName]||n.properties[r])})}hasNoTile(t){return!this.tilemap.layers.some(e=>this.tilemap.hasTileAt(t.x,t.y,e.name))}hasBlockingChar(t){return[...this.characters.values()].some(e=>e.isBlockingTile(t))}setCollisionTilePropertyName(t){this.collisionTilePropertyName=t}getTileWidth(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*t}getTileHeight(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*t}getLayerProp(t,e){let o=t.properties.find(n=>n.name==e);return o==null?void 0:o.value}hasLayerProp(t,e){return this.getLayerProp(t,e)!=null}isLayerAlwaysOnTop(t,e){return e>=this.firstLayerAboveChar||this.hasLayerProp(t,C.ALWAYS_TOP_PROP_NAME)}setLayerDepths(){let t=[];this.tilemap.layers.forEach((e,r)=>{this.isLayerAlwaysOnTop(e,r)?e.tilemapLayer.setDepth(C.FIRST_PLAYER_LAYER+C.MAX_PLAYER_LAYERS+r):this.hasLayerProp(e,C.HEIGHT_SHIFT_PROP_NAME)?(this.createLayerForEachRow(e,r),t.push(e.tilemapLayer)):e.tilemapLayer.setDepth(r)}),t.forEach(e=>e.destroy())}createLayerForEachRow(t,e){let r=this.getLayerProp(t,C.HEIGHT_SHIFT_PROP_NAME);for(let o=0;o<t.height;o++){let n=this.tilemap.createBlankLayer(`${e}#${o}`,t.tilemapLayer.tileset);for(let c=0;c<t.width;c++)n.putTileAt(t.data[o][c],c,o);n.scale=t.tilemapLayer.scale;let a=.5;n.setDepth(C.FIRST_PLAYER_LAYER+o+r-1+a)}}},O=C;O.MAX_PLAYER_LAYERS=1e3,O.FIRST_PLAYER_LAYER=1e3,O.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",O.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",O.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_"});var le=It((Mr,tt)=>{var Bt,Ht,$t,zt,Yt,qt,Xt,Zt,Jt,et,vt,Kt,Qt,L,te,ee,re,ie,oe,ne,se,ae,ce;(function(i){var t=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){i(e(t,e(r)))}):typeof tt=="object"&&typeof tt.exports=="object"?i(e(t,e(tt.exports))):i(e(t));function e(r,o){return r!==t&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,a){return r[n]=o?o(n,a):a}}})(function(i){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var o in r)r.hasOwnProperty(o)&&(e[o]=r[o])};Bt=function(e,r){t(e,r);function o(){this.constructor=e}e.prototype=r===null?Object.create(r):(o.prototype=r.prototype,new o)},Ht=Object.assign||function(e){for(var r,o=1,n=arguments.length;o<n;o++){r=arguments[o];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},$t=function(e,r){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(o[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,n=Object.getOwnPropertySymbols(e);a<n.length;a++)r.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(o[n[a]]=e[n[a]]);return o},zt=function(e,r,o,n){var a=arguments.length,c=a<3?r:n===null?n=Object.getOwnPropertyDescriptor(r,o):n,h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")c=Reflect.decorate(e,r,o,n);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(c=(a<3?h(c):a>3?h(r,o,c):h(r,o))||c);return a>3&&c&&Object.defineProperty(r,o,c),c},Yt=function(e,r){return function(o,n){r(o,n,e)}},qt=function(e,r){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,r)},Xt=function(e,r,o,n){function a(c){return c instanceof o?c:new o(function(h){h(c)})}return new(o||(o=Promise))(function(c,h){function m(d){try{u(n.next(d))}catch(V){h(V)}}function y(d){try{u(n.throw(d))}catch(V){h(V)}}function u(d){d.done?c(d.value):a(d.value).then(m,y)}u((n=n.apply(e,r||[])).next())})},Zt=function(e,r){var o={label:0,sent:function(){if(c[0]&1)throw c[1];return c[1]},trys:[],ops:[]},n,a,c,h;return h={next:m(0),throw:m(1),return:m(2)},typeof Symbol=="function"&&(h[Symbol.iterator]=function(){return this}),h;function m(u){return function(d){return y([u,d])}}function y(u){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,a&&(c=u[0]&2?a.return:u[0]?a.throw||((c=a.return)&&c.call(a),0):a.next)&&!(c=c.call(a,u[1])).done)return c;switch(a=0,c&&(u=[u[0]&2,c.value]),u[0]){case 0:case 1:c=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,a=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(c=o.trys,!(c=c.length>0&&c[c.length-1])&&(u[0]===6||u[0]===2)){o=0;continue}if(u[0]===3&&(!c||u[1]>c[0]&&u[1]<c[3])){o.label=u[1];break}if(u[0]===6&&o.label<c[1]){o.label=c[1],c=u;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(u);break}c[2]&&o.ops.pop(),o.trys.pop();continue}u=r.call(e,o)}catch(d){u=[6,d],a=0}finally{n=c=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}},ce=function(e,r,o,n){n===void 0&&(n=o),e[n]=r[o]},Jt=function(e,r){for(var o in e)o!=="default"&&!r.hasOwnProperty(o)&&(r[o]=e[o])},et=function(e){var r=typeof Symbol=="function"&&Symbol.iterator,o=r&&e[r],n=0;if(o)return o.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},vt=function(e,r){var o=typeof Symbol=="function"&&e[Symbol.iterator];if(!o)return e;var n=o.call(e),a,c=[],h;try{for(;(r===void 0||r-- >0)&&!(a=n.next()).done;)c.push(a.value)}catch(m){h={error:m}}finally{try{a&&!a.done&&(o=n.return)&&o.call(n)}finally{if(h)throw h.error}}return c},Kt=function(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(vt(arguments[r]));return e},Qt=function(){for(var e=0,r=0,o=arguments.length;r<o;r++)e+=arguments[r].length;for(var n=Array(e),a=0,r=0;r<o;r++)for(var c=arguments[r],h=0,m=c.length;h<m;h++,a++)n[a]=c[h];return n},L=function(e){return this instanceof L?(this.v=e,this):new L(e)},te=function(e,r,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=o.apply(e,r||[]),a,c=[];return a={},h("next"),h("throw"),h("return"),a[Symbol.asyncIterator]=function(){return this},a;function h(b){n[b]&&(a[b]=function(I){return new Promise(function(ut,ir){c.push([b,I,ut,ir])>1||m(b,I)})})}function m(b,I){try{y(n[b](I))}catch(ut){V(c[0][3],ut)}}function y(b){b.value instanceof L?Promise.resolve(b.value.v).then(u,d):V(c[0][2],b)}function u(b){m("next",b)}function d(b){m("throw",b)}function V(b,I){b(I),c.shift(),c.length&&m(c[0][0],c[0][1])}},ee=function(e){var r,o;return r={},n("next"),n("throw",function(a){throw a}),n("return"),r[Symbol.iterator]=function(){return this},r;function n(a,c){r[a]=e[a]?function(h){return(o=!o)?{value:L(e[a](h)),done:a==="return"}:c?c(h):h}:c}},re=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=e[Symbol.asyncIterator],o;return r?r.call(e):(e=typeof et=="function"?et(e):e[Symbol.iterator](),o={},n("next"),n("throw"),n("return"),o[Symbol.asyncIterator]=function(){return this},o);function n(c){o[c]=e[c]&&function(h){return new Promise(function(m,y){h=e[c](h),a(m,y,h.done,h.value)})}}function a(c,h,m,y){Promise.resolve(y).then(function(u){c({value:u,done:m})},h)}},ie=function(e,r){return Object.defineProperty?Object.defineProperty(e,"raw",{value:r}):e.raw=r,e},oe=function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var o in e)Object.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r.default=e,r},ne=function(e){return e&&e.__esModule?e:{default:e}},se=function(e,r){if(!r.has(e))throw new TypeError("attempted to get private field on non-instance");return r.get(e)},ae=function(e,r,o){if(!r.has(e))throw new TypeError("attempted to set private field on non-instance");return r.set(e,o),o},i("__extends",Bt),i("__assign",Ht),i("__rest",$t),i("__decorate",zt),i("__param",Yt),i("__metadata",qt),i("__awaiter",Xt),i("__generator",Zt),i("__exportStar",Jt),i("__createBinding",ce),i("__values",et),i("__read",vt),i("__spread",Kt),i("__spreadArrays",Qt),i("__await",L),i("__asyncGenerator",te),i("__asyncDelegator",ee),i("__asyncValues",re),i("__makeTemplateObject",ie),i("__importStar",oe),i("__importDefault",ne),i("__classPrivateFieldGet",se),i("__classPrivateFieldSet",ae)})});var he,v,kr,Ur,Gr,Ar,Vr,Ir,Nr,Wr,Lr,jr,Br,Hr,$r,zr,Yr,qr,Xr,Zr,Jr,Kr,Qr,ti,k=p(()=>{he=pr(le()),{__extends:v,__assign:kr,__rest:Ur,__decorate:Gr,__param:Ar,__metadata:Vr,__awaiter:Ir,__generator:Nr,__exportStar:Wr,__createBinding:Lr,__values:jr,__read:Br,__spread:Hr,__spreadArrays:$r,__await:zr,__asyncGenerator:Yr,__asyncDelegator:qr,__asyncValues:Xr,__makeTemplateObject:Zr,__importStar:Jr,__importDefault:Kr,__classPrivateFieldGet:Qr,__classPrivateFieldSet:ti}=he.default});function Y(i){return typeof i=="function"}var gt=p(()=>{});var yt,x,rt=p(()=>{yt=!1,x={Promise:void 0,set useDeprecatedSynchronousErrorHandling(i){if(i){var t=new Error;""+t.stack}yt=i},get useDeprecatedSynchronousErrorHandling(){return yt}}});function R(i){setTimeout(function(){throw i},0)}var it=p(()=>{});var j,xt=p(()=>{rt();it();j={closed:!0,next:function(i){},error:function(i){if(x.useDeprecatedSynchronousErrorHandling)throw i;R(i)},complete:function(){}}});var pe,ue=p(()=>{pe=function(){return Array.isArray||function(i){return i&&typeof i.length=="number"}}()});function ot(i){return i!==null&&typeof i=="object"}var Tt=p(()=>{});var ur,q,me=p(()=>{ur=function(){function i(t){return Error.call(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(e,r){return r+1+") "+e.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t,this}return i.prototype=Object.create(Error.prototype),i}(),q=ur});function fe(i){return i.reduce(function(t,e){return t.concat(e instanceof q?e.errors:e)},[])}var M,nt=p(()=>{ue();Tt();gt();me();M=function(){function i(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}return i.prototype.unsubscribe=function(){var t;if(!this.closed){var e=this,r=e._parentOrParents,o=e._ctorUnsubscribe,n=e._unsubscribe,a=e._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof i)r.remove(this);else if(r!==null)for(var c=0;c<r.length;++c){var h=r[c];h.remove(this)}if(Y(n)){o&&(this._unsubscribe=void 0);try{n.call(this)}catch(u){t=u instanceof q?fe(u.errors):[u]}}if(pe(a))for(var c=-1,m=a.length;++c<m;){var y=a[c];if(ot(y))try{y.unsubscribe()}catch(d){t=t||[],d instanceof q?t=t.concat(fe(d.errors)):t.push(d)}}if(t)throw new q(t)}},i.prototype.add=function(t){var e=t;if(!t)return i.EMPTY;switch(typeof t){case"function":e=new i(t);case"object":if(e===this||e.closed||typeof e.unsubscribe!="function")return e;if(this.closed)return e.unsubscribe(),e;if(!(e instanceof i)){var r=e;e=new i,e._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var o=e._parentOrParents;if(o===null)e._parentOrParents=this;else if(o instanceof i){if(o===this)return e;e._parentOrParents=[o,this]}else if(o.indexOf(this)===-1)o.push(this);else return e;var n=this._subscriptions;return n===null?this._subscriptions=[e]:n.push(e),e},i.prototype.remove=function(t){var e=this._subscriptions;if(e){var r=e.indexOf(t);r!==-1&&e.splice(r,1)}},i.EMPTY=function(t){return t.closed=!0,t}(new i),i}()});var U,st=p(()=>{U=function(){return typeof Symbol=="function"?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}()});var T,de,B=p(()=>{k();gt();xt();nt();st();rt();it();T=function(i){v(t,i);function t(e,r,o){var n=i.call(this)||this;switch(n.syncErrorValue=null,n.syncErrorThrown=!1,n.syncErrorThrowable=!1,n.isStopped=!1,arguments.length){case 0:n.destination=j;break;case 1:if(!e){n.destination=j;break}if(typeof e=="object"){e instanceof t?(n.syncErrorThrowable=e.syncErrorThrowable,n.destination=e,e.add(n)):(n.syncErrorThrowable=!0,n.destination=new de(n,e));break}default:n.syncErrorThrowable=!0,n.destination=new de(n,e,r,o);break}return n}return t.prototype[U]=function(){return this},t.create=function(e,r,o){var n=new t(e,r,o);return n.syncErrorThrowable=!1,n},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t}(M),de=function(i){v(t,i);function t(e,r,o,n){var a=i.call(this)||this;a._parentSubscriber=e;var c,h=a;return Y(r)?c=r:r&&(c=r.next,o=r.error,n=r.complete,r!==j&&(h=Object.create(r),Y(h.unsubscribe)&&a.add(h.unsubscribe.bind(h)),h.unsubscribe=a.unsubscribe.bind(a))),a._context=h,a._next=c,a._error=o,a._complete=n,a}return t.prototype.next=function(e){if(!this.isStopped&&this._next){var r=this._parentSubscriber;!x.useDeprecatedSynchronousErrorHandling||!r.syncErrorThrowable?this.__tryOrUnsub(this._next,e):this.__tryOrSetError(r,this._next,e)&&this.unsubscribe()}},t.prototype.error=function(e){if(!this.isStopped){var r=this._parentSubscriber,o=x.useDeprecatedSynchronousErrorHandling;if(this._error)!o||!r.syncErrorThrowable?(this.__tryOrUnsub(this._error,e),this.unsubscribe()):(this.__tryOrSetError(r,this._error,e),this.unsubscribe());else if(r.syncErrorThrowable)o?(r.syncErrorValue=e,r.syncErrorThrown=!0):R(e),this.unsubscribe();else{if(this.unsubscribe(),o)throw e;R(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var r=this._parentSubscriber;if(this._complete){var o=function(){return e._complete.call(e._context)};!x.useDeprecatedSynchronousErrorHandling||!r.syncErrorThrowable?(this.__tryOrUnsub(o),this.unsubscribe()):(this.__tryOrSetError(r,o),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,r){try{e.call(this._context,r)}catch(o){if(this.unsubscribe(),x.useDeprecatedSynchronousErrorHandling)throw o;R(o)}},t.prototype.__tryOrSetError=function(e,r,o){if(!x.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{r.call(this._context,o)}catch(n){return x.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=n,e.syncErrorThrown=!0,!0):(R(n),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(T)});function be(i){for(;i;){var t=i,e=t.closed,r=t.destination,o=t.isStopped;if(e||o)return!1;r&&r instanceof T?i=r:i=null}return!0}var ve=p(()=>{B()});function ge(i,t,e){if(i){if(i instanceof T)return i;if(i[U])return i[U]()}return!i&&!t&&!e?new T(j):new T(i,t,e)}var ye=p(()=>{B();st();xt()});var H,at=p(()=>{H=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function xe(i){return i}var Te=p(()=>{});function _e(i){return i.length===0?xe:i.length===1?i[0]:function(e){return i.reduce(function(r,o){return o(r)},e)}}var Se=p(()=>{Te()});function Pe(i){if(i||(i=x.Promise||Promise),!i)throw new Error("no Promise impl found");return i}var X,_t=p(()=>{ve();ye();at();Se();rt();X=function(){function i(t){this._isScalar=!1,t&&(this._subscribe=t)}return i.prototype.lift=function(t){var e=new i;return e.source=this,e.operator=t,e},i.prototype.subscribe=function(t,e,r){var o=this.operator,n=ge(t,e,r);if(o?n.add(o.call(n,this.source)):n.add(this.source||x.useDeprecatedSynchronousErrorHandling&&!n.syncErrorThrowable?this._subscribe(n):this._trySubscribe(n)),x.useDeprecatedSynchronousErrorHandling&&n.syncErrorThrowable&&(n.syncErrorThrowable=!1,n.syncErrorThrown))throw n.syncErrorValue;return n},i.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){x.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),be(t)?t.error(e):console.warn(e)}},i.prototype.forEach=function(t,e){var r=this;return e=Pe(e),new e(function(o,n){var a;a=r.subscribe(function(c){try{t(c)}catch(h){n(h),a&&a.unsubscribe()}},n,o)})},i.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},i.prototype[H]=function(){return this},i.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.length===0?this:_e(t)(this)},i.prototype.toPromise=function(t){var e=this;return t=Pe(t),new t(function(r,o){var n;e.subscribe(function(a){return n=a},function(a){return o(a)},function(){return r(n)})})},i.create=function(t){return new i(t)},i}()});var mr,$,we=p(()=>{mr=function(){function i(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return i.prototype=Object.create(Error.prototype),i}(),$=mr});var De,Ee=p(()=>{k();nt();De=function(i){v(t,i);function t(e,r){var o=i.call(this)||this;return o.subject=e,o.subscriber=r,o.closed=!1,o}return t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,r=e.observers;if(this.subject=null,!(!r||r.length===0||e.isStopped||e.closed)){var o=r.indexOf(this.subscriber);o!==-1&&r.splice(o,1)}}},t}(M)});var fr,g,Oe,Ce=p(()=>{k();_t();B();nt();we();Ee();st();fr=function(i){v(t,i);function t(e){var r=i.call(this,e)||this;return r.destination=e,r}return t}(T),g=function(i){v(t,i);function t(){var e=i.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype[U]=function(){return new fr(this)},t.prototype.lift=function(e){var r=new Oe(this,this);return r.operator=e,r},t.prototype.next=function(e){if(this.closed)throw new $;if(!this.isStopped)for(var r=this.observers,o=r.length,n=r.slice(),a=0;a<o;a++)n[a].next(e)},t.prototype.error=function(e){if(this.closed)throw new $;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var r=this.observers,o=r.length,n=r.slice(),a=0;a<o;a++)n[a].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new $;this.isStopped=!0;for(var e=this.observers,r=e.length,o=e.slice(),n=0;n<r;n++)o[n].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(e){if(this.closed)throw new $;return i.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){if(this.closed)throw new $;return this.hasError?(e.error(this.thrownError),M.EMPTY):this.isStopped?(e.complete(),M.EMPTY):(this.observers.push(e),new De(this,e))},t.prototype.asObservable=function(){var e=new X;return e.source=this,e},t.create=function(e,r){return new Oe(e,r)},t}(X),Oe=function(i){v(t,i);function t(e,r){var o=i.call(this)||this;return o.destination=e,o.source=r,o}return t.prototype.next=function(e){var r=this.destination;r&&r.next&&r.next(e)},t.prototype.error=function(e){var r=this.destination;r&&r.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){var r=this.source;return r?this.source.subscribe(e):M.EMPTY},t}(g)});var Re,Me=p(()=>{Re=function(i){return function(t){for(var e=0,r=i.length;e<r&&!t.closed;e++)t.next(i[e]);t.complete()}}});var Fe,ke=p(()=>{it();Fe=function(i){return function(t){return i.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,R),t}}});function dr(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ct,St=p(()=>{ct=dr()});var Ue,Ge=p(()=>{St();Ue=function(i){return function(t){var e=i[ct]();do{var r=void 0;try{r=e.next()}catch(o){return t.error(o),t}if(r.done){t.complete();break}if(t.next(r.value),t.closed)break}while(!0);return typeof e.return=="function"&&t.add(function(){e.return&&e.return()}),t}}});var Ae,Ve=p(()=>{at();Ae=function(i){return function(t){var e=i[H]();if(typeof e.subscribe!="function")throw new TypeError("Provided object does not correctly implement Symbol.observable");return e.subscribe(t)}}});var Ie,Ne=p(()=>{Ie=function(i){return i&&typeof i.length=="number"&&typeof i!="function"}});function We(i){return!!i&&typeof i.subscribe!="function"&&typeof i.then=="function"}var Le=p(()=>{});var je,Be=p(()=>{Me();ke();Ge();Ve();Ne();Le();Tt();St();at();je=function(i){if(!!i&&typeof i[H]=="function")return Ae(i);if(Ie(i))return Re(i);if(We(i))return Fe(i);if(!!i&&typeof i[ct]=="function")return Ue(i);var t=ot(i)?"an invalid object":"'"+i+"'",e="You provided "+t+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.";throw new TypeError(e)}});function ze(i,t){if(!t.closed)return i instanceof X?i.subscribe(t):je(i)(t)}var He,$e,Ye=p(()=>{k();B();_t();Be();He=function(i){v(t,i);function t(e){var r=i.call(this)||this;return r.parent=e,r}return t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t}(T),$e=function(i){v(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(T)});function Pt(i,t){return function(r){return r.lift(new br(i,t))}}var br,vr,qe=p(()=>{k();B();br=function(){function i(t,e){this.predicate=t,this.thisArg=e}return i.prototype.call=function(t,e){return e.subscribe(new vr(t,this.predicate,this.thisArg))},i}(),vr=function(i){v(t,i);function t(e,r,o){var n=i.call(this,e)||this;return n.predicate=r,n.thisArg=o,n.count=0,n}return t.prototype._next=function(e){var r;try{r=this.predicate.call(this.thisArg,e,this.count++)}catch(o){this.destination.error(o);return}r&&this.destination.next(e)},t}(T)});var wt=p(()=>{Ce()});var Z,Dt=p(()=>{jt();N();P();P();bt();wt();E();Z=class{constructor(t,e){this.id=t;this.movementDirection=s.NONE;this.tileSizePixelsWalked=l.ZERO.clone();this._nextTilePos=new l(0,0);this._tilePos=new l(0,0);this.movementStarted$=new g;this.movementStopped$=new g;this.directionChanged$=new g;this.positionChanged$=new g;this.positionChangeFinished$=new g;this.autoMovementSet$=new g;this.lastMovementImpulse=s.NONE;this.facingDirection=s.DOWN;let r=0,o;typeof e.walkingAnimationMapping=="number"?r=e.walkingAnimationMapping:o=e.walkingAnimationMapping,this.sprite=e.sprite,this.sprite.setOrigin(0,0),this.container=e.container,this.tilemap=e.tilemap,this.speed=e.speed,this.customOffset=new l(e.offsetX||0,e.offsetY||0),this.tileSize=e.tileSize.clone(),this.animation=new z(this.sprite,o,r),this.animation.setIsEnabled(e.walkingAnimationMapping!==void 0),this.animation.setStandingFrame(s.DOWN),this.updateZindex()}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}setMovement(t){var e;this.autoMovementSet$.next(),this.movement=t,(e=this.movement)==null||e.setCharacter(this)}getMovement(){return this.movement}setWalkingAnimationMapping(t){this.animation.setWalkingAnimationMapping(t)}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.positionChanged$.next({exitTile:this.tilePos,enterTile:t}),this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:t}),this.movementDirection=s.NONE,this.nextTilePos=t,this.tilePos=t,this.updateZindex(),this.setPosition(this.tilePosToPixelPos(t).add(this.getOffset()).add(this.customOffset))}getTilePos(){return this.tilePos}getNextTilePos(){return this.nextTilePos}move(t){this.lastMovementImpulse=t,t!=s.NONE&&(this.isMoving()||(this.isBlockingDirection(t)?(this.facingDirection=t,this.animation.setStandingFrame(t),this.directionChanged$.next(t)):this.startMoving(t)))}update(t){var e;(e=this.movement)==null||e.update(t),this.isMoving()&&(this.updateCharacterPosition(t),this.updateZindex()),this.lastMovementImpulse=s.NONE}getMovementDirection(){return this.movementDirection}isBlockingTile(t){return this.nextTilePos.equals(t)||this.tilePos.equals(t)}isBlockingDirection(t){return t==s.NONE?!1:this.tilemap.hasBlockingTile(this.tilePosInDirection(t),Lt(this.toMapDirection(t)))||this.tilemap.hasBlockingChar(this.tilePosInDirection(t))}isMoving(){return this.movementDirection!=s.NONE}turnTowards(t){this.isMoving()||t!=s.NONE&&(this.facingDirection=t,this.animation.setStandingFrame(t))}getFacingDirection(){return this.facingDirection}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChanged(){return this.positionChanged$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}tilePosToPixelPos(t){return t.clone().multiply(this.tileSize)}getTileDistance(t){return t===s.NONE?l.ZERO.clone():this.tileSize.clone()}toMapDirection(t){return t}getOffset(){let t=this.tileSize.x/2-Math.floor(this.sprite.width*this.sprite.scale/2),e=-(this.sprite.height*this.sprite.scale)+this.tileSize.y;return new l(t,e)}createSpeedPixelsPerSecond(){let t={[s.LEFT]:new l(this.tileSize.x,0),[s.RIGHT]:new l(this.tileSize.x,0),[s.UP]:new l(0,this.tileSize.y),[s.DOWN]:new l(0,this.tileSize.y),[s.UP_LEFT]:this.getTileDistance(s.UP_LEFT),[s.UP_RIGHT]:this.getTileDistance(s.UP_RIGHT),[s.DOWN_LEFT]:this.getTileDistance(s.DOWN_LEFT),[s.DOWN_RIGHT]:this.getTileDistance(s.DOWN_RIGHT),[s.NONE]:l.ZERO.clone()};return Object.entries(t).forEach(([e,r])=>{t[e]=f.scalarMult(r,this.speed)}),t}get nextTilePos(){return this._nextTilePos.clone()}set nextTilePos(t){this._nextTilePos.x=t.x,this._nextTilePos.y=t.y}get tilePos(){return this._tilePos.clone()}set tilePos(t){this._tilePos.x=t.x,this._tilePos.y=t.y}updateZindex(){(this.container||this.sprite).setDepth(O.FIRST_PLAYER_LAYER+this.mapDepth(this.nextTilePos))}mapDepth(t){return t.y}setPosition(t){let e=this.container||this.sprite;e.x=t.x,e.y=t.y}getPosition(){let t=this.container||this.sprite;return new l(t.x,t.y)}startMoving(t){this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.updateTilePos()}updateTilePos(){this.tilePos=this.nextTilePos;let t=this.nextTilePos.add(F(this.toMapDirection(this.movementDirection)));this.positionChanged$.next({exitTile:this.nextTilePos,enterTile:t}),this.nextTilePos=t}tilePosInDirection(t){return this.nextTilePos.add(F(this.toMapDirection(t)))}updateCharacterPosition(t){let e=this.getSpeedPerDelta(t);this.willCrossTileBorderThisUpdate(e)?this.shouldContinueMoving()?(this.moveCharacterSprite(e),this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:this.nextTilePos}),this.updateTilePos()):(this.moveCharacterSpriteRestOfTile(),this.stopMoving()):this.moveCharacterSprite(e)}shouldContinueMoving(){return this.movementDirection==this.lastMovementImpulse&&!this.isBlockingDirection(this.lastMovementImpulse)}getSpeedPerDelta(t){let e=t/1e3;return this.createSpeedPixelsPerSecond()[this.movementDirection].clone().multiply(new l(e,e)).multiply(F(this.movementDirection))}willCrossTileBorderThisUpdate(t){return this.tileSizePixelsWalked.x+Math.abs(t.x)>=this.getTileDistance(this.movementDirection).x||this.tileSizePixelsWalked.y+Math.abs(t.y)>=this.getTileDistance(this.movementDirection).y}moveCharacterSpriteRestOfTile(){this.moveCharacterSprite(this.getTileDistance(this.movementDirection).clone().subtract(this.tileSizePixelsWalked).multiply(F(this.movementDirection)))}moveCharacterSprite(t){let e=this.getPosition().add(t);this.setPosition(e),this.tileSizePixelsWalked.x+=Math.abs(t.x),this.tileSizePixelsWalked.y+=Math.abs(t.y),this.animation.updateCharacterFrame(this.movementDirection,this.hasWalkedHalfATile()),this.tileSizePixelsWalked.x%=this.getTileDistance(this.movementDirection).x,this.tileSizePixelsWalked.y%=this.getTileDistance(this.movementDirection).y}stopMoving(){this.movementStopped$.next(this.movementDirection),this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:this.nextTilePos}),this.movementDirection=s.NONE,this.tilePos=this.nextTilePos}hasWalkedHalfATile(){return this.tileSizePixelsWalked.x>this.getTileDistance(this.movementDirection).x/2||this.tileSizePixelsWalked.y>this.getTileDistance(this.movementDirection).y/2}}});var Et,Xe=p(()=>{P();E();N();Dt();Et=class extends Z{tilePosToPixelPos(t){return this.getTileDistance(s.UP_LEFT).multiply(new l(t.x-t.y,t.x+t.y))}getTileDistance(t){switch(t){case s.DOWN_LEFT:case s.DOWN_RIGHT:case s.UP_LEFT:case s.UP_RIGHT:return f.scalarMult(this.tileSize,.5);default:return super.getTileDistance(t)}}toMapDirection(t){return Wt(t)}mapDepth(t){return t.x+t.y}}});function G(i){return function(t){return t.lift(new gr(i))}}var gr,yr,Ze=p(()=>{k();Ye();gr=function(){function i(t){this.notifier=t}return i.prototype.call=function(t,e){var r=new yr(t),o=ze(this.notifier,new He(r));return o&&!r.seenValue?(r.add(o),e.subscribe(r)):r},i}(),yr=function(i){v(t,i);function t(e){var r=i.call(this,e)||this;return r.seenValue=!1,r}return t.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},t.prototype.notifyComplete=function(){},t}($e)});var lt=p(()=>{qe();Ze()});var _,ht=p(()=>{(function(i){i.STOP="STOP",i.CLOSEST_REACHABLE="CLOSEST_REACHABLE",i.RETRY="RETRY"})(_||(_={}))});var Ot,Je=p(()=>{N();Ot=class{getShortestPath(t,e,r){let o=this.shortestPathBfs(t,e,r);return{path:this.returnPath(o.previous,t,e),closestToTarget:o.closestToTarget}}shortestPathBfs(t,e,r){let o=new Map,n=new Set,a=[],c=t,h=f.manhattanDistance(t,e);for(a.push({node:t,dist:0}),n.add(f.vec2str(t));a.length>0;){let{node:m,dist:y}=a.shift(),u=f.manhattanDistance(m,e);if(u<h&&(h=u,c=m),f.equal(m,e))return{shortestDistance:y,previous:o,closestToTarget:c};for(let d of r(m))n.has(f.vec2str(d))||(o.set(f.vec2str(d),m),a.push({node:d,dist:y+1}),n.add(f.vec2str(d)))}return{shortestDistance:-1,previous:o,closestToTarget:c}}returnPath(t,e,r){let o=[],n=r;for(o.push(n);!f.equal(n,e);){if(n=t.get(f.vec2str(n)),!n)return[];o.push(n)}return o.reverse()}}});var pt,Ke=p(()=>{pt=class{constructor(t,e,r){this.backoffMs=t;this.maxRetries=e;this.onFinished=r;this.retries=0;this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}reset(){this.retries=0,this.elapsed=0}}});var J,Ct=p(()=>{N();P();E();J=class{distance(t,e){return f.chebyshevDistance(t,e)}neighbours(t){let e=[new l(t.x,t.y+1),new l(t.x+1,t.y),new l(t.x-1,t.y),new l(t.x,t.y-1)],r=[new l(t.x+1,t.y+1),new l(t.x+1,t.y-1),new l(t.x-1,t.y+1),new l(t.x-1,t.y-1)];return[...e,...r]}direction(t,e){return e.x>t.x?e.y>t.y?s.DOWN_RIGHT:e.y<t.y?s.UP_RIGHT:s.RIGHT:e.x<t.x?e.y>t.y?s.DOWN_LEFT:e.y<t.y?s.UP_LEFT:s.LEFT:e.y<t.y?s.UP:e.y>t.y?s.DOWN:s.NONE}}});var A,Rt=p(()=>{N();P();E();A=class{distance(t,e){return f.manhattanDistance(t,e)}direction(t,e){if(f.equal(t,e))return s.NONE;let r=t.clone().subtract(e);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?s.LEFT:s.RIGHT:r.y>0?s.UP:s.DOWN}neighbours(t){return[new l(t.x,t.y+1),new l(t.x+1,t.y),new l(t.x-1,t.y),new l(t.x,t.y-1)]}}});var K,Mt=p(()=>{ht();ft();P();Je();Ke();Ct();Rt();K=class{constructor(t,e,r=0,o){this.tilemap=t;this.targetPos=e;this.distance=r;this.posOnPath=0;this.stopped=!1;this.distanceUtils=new A;this.getNeighbours=t=>this.distanceUtils.neighbours(t).filter(r=>!this.isBlocking(r));this.isBlocking=t=>!t||this.tilemap.isBlocking(t);this.noPathFoundStrategy=(o==null?void 0:o.noPathFoundStrategy)||_.STOP,this.pathBlockedStrategy=(o==null?void 0:o.pathBlockedStrategy)||w.WAIT,this.noPathFoundRetryable=new pt((o==null?void 0:o.noPathFoundRetryBackoffMs)||200,(o==null?void 0:o.noPathFoundMaxRetries)||-1,()=>this.stop()),this.pathBlockedRetryable=new pt((o==null?void 0:o.pathBlockedRetryBackoffMs)||200,(o==null?void 0:o.pathBlockedMaxRetries)||-1,()=>this.stop()),this.pathBlockedWaitTimeoutMs=(o==null?void 0:o.pathBlockedWaitTimeoutMs)||-1}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setNumberOfDirections(t){t===S.EIGHT?this.distanceUtils=new J:this.distanceUtils=new A}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath()}update(t){this.stopped||(this.noPathFound()&&this.noPathFoundStrategy===_.RETRY&&this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()),this.isBlocking(this.nextTileOnPath())?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.updatePosOnPath(),this.hasArrived()?this.existsDistToTarget()&&this.turnTowardsTarget():this.isBlocking(this.nextTileOnPath())||this.moveCharOnPath())}applyPathBlockedStrategy(t){this.pathBlockedStrategy===w.RETRY?this.pathBlockedRetryable.retry(t,()=>this.calcShortestPath()):this.pathBlockedStrategy===w.STOP?this.stop():this.pathBlockedStrategy===w.WAIT&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop())}moveCharOnPath(){let t=this.getDir(this.character.getNextTilePos(),this.nextTileOnPath());this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(){this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos(),t);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().x!=t.x||this.character.getNextTilePos().y!=t.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(){let t=this.getShortestPath();this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new Ot,{path:e,closestToTarget:r}=t.getShortestPath(this.character.getNextTilePos(),this.targetPos,this.getNeighbours);if(e.length==0&&this.noPathFoundStrategy===_.CLOSEST_REACHABLE){let n=t.getShortestPath(this.character.getNextTilePos(),r,this.getNeighbours).path,a=this.distanceUtils.distance(r,this.targetPos);return{path:n,distOffset:a}}return{path:e,distOffset:0}}getDir(t,e){return this.distanceUtils.direction(t,e)}}});var Ft,Qe=p(()=>{lt();P();Mt();ht();E();Ft=class{constructor(t,e,r=0,o=_.STOP){this.gridTilemap=t;this.charToFollow=e;this.distance=r;this.noPathFoundStrategy=o;this.numberOfDirections=S.FOUR}setNumberOfDirections(t){this.numberOfDirections=t}setCharacter(t){this.character=t,this.updateTarget(this.charToFollow.getTilePos()),this.charToFollow.positionChanged().pipe(G(this.character.autoMovementSet())).subscribe(({enterTile:e})=>{this.updateTarget(e)})}update(t){var e;(e=this.targetMovement)==null||e.update(t)}updateTarget(t){this.targetMovement=new K(this.gridTilemap,new l(t),this.distance+1,{noPathFoundStrategy:this.noPathFoundStrategy}),this.targetMovement.setNumberOfDirections(this.numberOfDirections),this.targetMovement.setCharacter(this.character)}}});var kt,tr=p(()=>{P();P();lt();E();Ct();Rt();kt=class{constructor(t=0,e=-1){this.delay=t;this.radius=e;this.numberOfDirections=S.FOUR;this.distanceUtils=new A}setNumberOfDirections(t){this.numberOfDirections=t,t===S.EIGHT?this.distanceUtils=new J:this.distanceUtils=new A}setCharacter(t){this.character=t,this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().y,this.initialCol=t.getNextTilePos().x,this.stepSize=this.getRandomInt(this.radius)+1,this.stepsWalked=0,this.currentMovementDirection=s.NONE,this.character.positionChanged().pipe(G(this.character.autoMovementSet())).subscribe(()=>{this.stepsWalked++})}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let e=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(e),this.currentMovementDirection=e,this.stepSize=this.getRandomInt(this.radius)+1}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!==s.NONE&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return Nt(this.numberOfDirections).filter(e=>!this.character.isBlockingDirection(e)).filter(e=>this.isWithinRadius(e))}isWithinRadius(t){return this.radius==-1?!0:this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().add(F(t)),new l(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return t.length==0?s.NONE:t[this.getRandomInt(t.length)]}getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}}});var Ut,er=p(()=>{ft();Xe();Qe();Mt();Dt();P();bt();tr();wt();lt();ht();E();Ut=class{constructor(t){this.scene=t;this.isCreated=!1;this.numberOfDirections=S.FOUR;this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this),this.scene.sys.events.on("destroy",this.destroy,this)}destroy(){this.scene=void 0,this.tilemap=void 0,this.gridCharacters=void 0,this.gridTilemap=void 0,this.movementStarted$=void 0,this.movementStopped$=void 0,this.directionChanged$=void 0,this.positionChangeStarted$=void 0,this.positionChangeFinished$=void 0,this.charRemoved$=void 0}create(t,e){this.isCreated=!0,this.gridCharacters=new Map,this.tilemap=t,this.movementStopped$=new g,this.movementStarted$=new g,this.directionChanged$=new g,this.positionChangeStarted$=new g,this.positionChangeFinished$=new g,this.charRemoved$=new g,this.gridTilemap=new O(t),e.collisionTilePropertyName&&this.gridTilemap.setCollisionTilePropertyName(e.collisionTilePropertyName),this.numberOfDirections=e.numberOfDirections||this.numberOfDirections,this.addCharacters(e)}getPosition(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos()}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,r=-1){this.initGuard(),this.unknownCharGuard(t);let o=new kt(e,r);o.setNumberOfDirections(this.numberOfDirections),this.gridCharacters.get(t).setMovement(o)}moveTo(t,e,r){let o=this.assembleMoveToConfig(r);this.initGuard(),this.unknownCharGuard(t);let n=new K(this.gridTilemap,new l(e),0,o);n.setNumberOfDirections(this.numberOfDirections),this.gridCharacters.get(t).setMovement(n)}stopMovement(t){this._stopMovement(t)}setSpeed(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setSpeed(e)}setWalkingAnimationMapping(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setWalkingAnimationMapping(e)}update(t,e){if(this.isCreated&&this.gridCharacters)for(let[r,o]of this.gridCharacters)o.update(e)}addCharacter(t){this.initGuard();let e={sprite:t.sprite,speed:t.speed||4,tilemap:this.gridTilemap,tileSize:new l(this.gridTilemap.getTileWidth(),this.gridTilemap.getTileHeight()),walkingAnimationMapping:t.walkingAnimationMapping,container:t.container,offsetX:t.offsetX,offsetY:t.offsetY},r=this.createCharacter(t.id,e);t.facingDirection&&r.turnTowards(t.facingDirection),this.gridCharacters.set(t.id,r);let o=t.startPosition?new l(t.startPosition):new l(0,0);r.setTilePosition(o),this.gridTilemap.addCharacter(r),r.movementStopped().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.movementStopped$.next({charId:r.getId(),direction:n})}),r.movementStarted().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.movementStarted$.next({charId:r.getId(),direction:n})}),r.directionChanged().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.directionChanged$.next({charId:r.getId(),direction:n})}),r.positionChanged().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(({exitTile:n,enterTile:a})=>{this.positionChangeStarted$.next({charId:r.getId(),exitTile:n,enterTile:a})}),r.positionChangeFinished().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(({exitTile:n,enterTile:a})=>{this.positionChangeFinished$.next({charId:r.getId(),exitTile:n,enterTile:a})})}hasCharacter(t){return this.initGuard(),this.gridCharacters.has(t)}removeCharacter(t){this.initGuard(),this.unknownCharGuard(t),this.gridTilemap.removeCharacter(t),this.gridCharacters.delete(t),this.charRemoved$.next(t)}removeAllCharacters(){this.initGuard();for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(){return this.initGuard(),[...this.gridCharacters.keys()]}follow(t,e,r=0,o=!1){this.initGuard(),this.unknownCharGuard(t),this.unknownCharGuard(e);let n=new Ft(this.gridTilemap,this.gridCharacters.get(e),r,o?_.CLOSEST_REACHABLE:_.STOP);n.setNumberOfDirections(this.numberOfDirections),this.gridCharacters.get(t).setMovement(n)}isMoving(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).isMoving()}getFacingDirection(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getFacingDirection()}turnTowards(t,e){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).turnTowards(e)}setPosition(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setTilePosition(new l(e))}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}takeUntilCharRemoved(t){return G(this.charRemoved$.pipe(Pt(e=>e==t)))}initGuard(){if(!this.isCreated)throw new Error("Plugin not initialized. You need to call create() first.")}unknownCharGuard(t){if(!this.gridCharacters.has(t))throw new Error(`Character unknown: ${t}`)}createCharacter(t,e){return this._isIsometric()?new Et(t,e):new Z(t,e)}addCharacters(t){t.characters.forEach(e=>this.addCharacter(e))}moveChar(t,e){if(this.initGuard(),this.unknownCharGuard(t),this.numberOfDirections===S.FOUR){if(!this._isIsometric()&&dt(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}else if(this._isIsometric()&&!dt(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}this.gridCharacters.get(t).move(e)}_stopMovement(t){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setMovement(void 0)}_isIsometric(){return this.tilemap.orientation==`${Phaser.Tilemaps.Orientation.ISOMETRIC}`}assembleMoveToConfig(t){let e=mt(mt({},t),{noPathFoundStrategy:_.STOP,pathBlockedStrategy:w.WAIT});return(t==null?void 0:t.noPathFoundStrategy)&&(Object.values(_).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to '${_.STOP}'`)),(t==null?void 0:t.pathBlockedStrategy)&&(Object.values(w).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to '${w.WAIT}'`)),e}}});var xr=It((Zn,rr)=>{er();rr.exports=Ut});return xr();})();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
