var De=Object.create;var Z=Object.defineProperty,we=Object.defineProperties,Ee=Object.getOwnPropertyDescriptor,Oe=Object.getOwnPropertyDescriptors,Fe=Object.getOwnPropertyNames,Dt=Object.getOwnPropertySymbols,Re=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty,Me=Object.prototype.propertyIsEnumerable;var Et=(o,t,e)=>t in o?Z(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,pt=(o,t)=>{for(var e in t||(t={}))wt.call(t,e)&&Et(o,e,t[e]);if(Dt)for(var e of Dt(t))Me.call(t,e)&&Et(o,e,t[e]);return o},Ot=(o,t)=>we(o,Oe(t)),ke=o=>Z(o,"__esModule",{value:!0});var Ie=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var Ge=(o,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Fe(t))!wt.call(o,r)&&r!=="default"&&Z(o,r,{get:()=>t[r],enumerable:!(e=Ee(t,r))||e.enumerable});return o},Ae=o=>Ge(ke(Z(o!=null?De(Re(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);var Qt=Ie((hr,tt)=>{var kt,It,Gt,At,Nt,Ut,Lt,Vt,Wt,J,ft,Bt,jt,Ht,W,$t,zt,Yt,qt,Kt,Xt,Zt,Jt,Q;(function(o){var t=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){o(e(t,e(r)))}):typeof tt=="object"&&typeof tt.exports=="object"?o(e(t,e(tt.exports))):o(e(t));function e(r,i){return r!==t&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,s){return r[n]=i?i(n,s):s}}})(function(o){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,i){r.__proto__=i}||function(r,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])};kt=function(r,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");t(r,i);function n(){this.constructor=r}r.prototype=i===null?Object.create(i):(n.prototype=i.prototype,new n)},It=Object.assign||function(r){for(var i,n=1,s=arguments.length;n<s;n++){i=arguments[n];for(var c in i)Object.prototype.hasOwnProperty.call(i,c)&&(r[c]=i[c])}return r},Gt=function(r,i){var n={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&i.indexOf(s)<0&&(n[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,s=Object.getOwnPropertySymbols(r);c<s.length;c++)i.indexOf(s[c])<0&&Object.prototype.propertyIsEnumerable.call(r,s[c])&&(n[s[c]]=r[s[c]]);return n},At=function(r,i,n,s){var c=arguments.length,l=c<3?i:s===null?s=Object.getOwnPropertyDescriptor(i,n):s,h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")l=Reflect.decorate(r,i,n,s);else for(var m=r.length-1;m>=0;m--)(h=r[m])&&(l=(c<3?h(l):c>3?h(i,n,l):h(i,n))||l);return c>3&&l&&Object.defineProperty(i,n,l),l},Nt=function(r,i){return function(n,s){i(n,s,r)}},Ut=function(r,i){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,i)},Lt=function(r,i,n,s){function c(l){return l instanceof n?l:new n(function(h){h(l)})}return new(n||(n=Promise))(function(l,h){function m(b){try{u(s.next(b))}catch(O){h(O)}}function y(b){try{u(s.throw(b))}catch(O){h(O)}}function u(b){b.done?l(b.value):c(b.value).then(m,y)}u((s=s.apply(r,i||[])).next())})},Vt=function(r,i){var n={label:0,sent:function(){if(l[0]&1)throw l[1];return l[1]},trys:[],ops:[]},s,c,l,h;return h={next:m(0),throw:m(1),return:m(2)},typeof Symbol=="function"&&(h[Symbol.iterator]=function(){return this}),h;function m(u){return function(b){return y([u,b])}}function y(u){if(s)throw new TypeError("Generator is already executing.");for(;n;)try{if(s=1,c&&(l=u[0]&2?c.return:u[0]?c.throw||((l=c.return)&&l.call(c),0):c.next)&&!(l=l.call(c,u[1])).done)return l;switch(c=0,l&&(u=[u[0]&2,l.value]),u[0]){case 0:case 1:l=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,c=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(l=n.trys,!(l=l.length>0&&l[l.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!l||u[1]>l[0]&&u[1]<l[3])){n.label=u[1];break}if(u[0]===6&&n.label<l[1]){n.label=l[1],l=u;break}if(l&&n.label<l[2]){n.label=l[2],n.ops.push(u);break}l[2]&&n.ops.pop(),n.trys.pop();continue}u=i.call(r,n)}catch(b){u=[6,b],c=0}finally{s=l=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}},Wt=function(r,i){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&Q(i,r,n)},Q=Object.create?function(r,i,n,s){s===void 0&&(s=n),Object.defineProperty(r,s,{enumerable:!0,get:function(){return i[n]}})}:function(r,i,n,s){s===void 0&&(s=n),r[s]=i[n]},J=function(r){var i=typeof Symbol=="function"&&Symbol.iterator,n=i&&r[i],s=0;if(n)return n.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")},ft=function(r,i){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var s=n.call(r),c,l=[],h;try{for(;(i===void 0||i-- >0)&&!(c=s.next()).done;)l.push(c.value)}catch(m){h={error:m}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(h)throw h.error}}return l},Bt=function(){for(var r=[],i=0;i<arguments.length;i++)r=r.concat(ft(arguments[i]));return r},jt=function(){for(var r=0,i=0,n=arguments.length;i<n;i++)r+=arguments[i].length;for(var s=Array(r),c=0,i=0;i<n;i++)for(var l=arguments[i],h=0,m=l.length;h<m;h++,c++)s[c]=l[h];return s},Ht=function(r,i){for(var n=0,s=i.length,c=r.length;n<s;n++,c++)r[c]=i[n];return r},W=function(r){return this instanceof W?(this.v=r,this):new W(r)},$t=function(r,i,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=n.apply(r,i||[]),c,l=[];return c={},h("next"),h("throw"),h("return"),c[Symbol.asyncIterator]=function(){return this},c;function h(f){s[f]&&(c[f]=function(N){return new Promise(function(ht,_e){l.push([f,N,ht,_e])>1||m(f,N)})})}function m(f,N){try{y(s[f](N))}catch(ht){O(l[0][3],ht)}}function y(f){f.value instanceof W?Promise.resolve(f.value.v).then(u,b):O(l[0][2],f)}function u(f){m("next",f)}function b(f){m("throw",f)}function O(f,N){f(N),l.shift(),l.length&&m(l[0][0],l[0][1])}},zt=function(r){var i,n;return i={},s("next"),s("throw",function(c){throw c}),s("return"),i[Symbol.iterator]=function(){return this},i;function s(c,l){i[c]=r[c]?function(h){return(n=!n)?{value:W(r[c](h)),done:c==="return"}:l?l(h):h}:l}},Yt=function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=r[Symbol.asyncIterator],n;return i?i.call(r):(r=typeof J=="function"?J(r):r[Symbol.iterator](),n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n);function s(l){n[l]=r[l]&&function(h){return new Promise(function(m,y){h=r[l](h),c(m,y,h.done,h.value)})}}function c(l,h,m,y){Promise.resolve(y).then(function(u){l({value:u,done:m})},h)}},qt=function(r,i){return Object.defineProperty?Object.defineProperty(r,"raw",{value:i}):r.raw=i,r};var e=Object.create?function(r,i){Object.defineProperty(r,"default",{enumerable:!0,value:i})}:function(r,i){r.default=i};Kt=function(r){if(r&&r.__esModule)return r;var i={};if(r!=null)for(var n in r)n!=="default"&&Object.prototype.hasOwnProperty.call(r,n)&&Q(i,r,n);return e(i,r),i},Xt=function(r){return r&&r.__esModule?r:{default:r}},Zt=function(r,i){if(!i.has(r))throw new TypeError("attempted to get private field on non-instance");return i.get(r)},Jt=function(r,i,n){if(!i.has(r))throw new TypeError("attempted to set private field on non-instance");return i.set(r,n),n},o("__extends",kt),o("__assign",It),o("__rest",Gt),o("__decorate",At),o("__param",Nt),o("__metadata",Ut),o("__awaiter",Lt),o("__generator",Vt),o("__exportStar",Wt),o("__createBinding",Q),o("__values",J),o("__read",ft),o("__spread",Bt),o("__spreadArrays",jt),o("__spreadArray",Ht),o("__await",W),o("__asyncGenerator",$t),o("__asyncDelegator",zt),o("__asyncValues",Yt),o("__makeTemplateObject",qt),o("__importStar",Kt),o("__importDefault",Xt),o("__classPrivateFieldGet",Zt),o("__classPrivateFieldSet",Jt)})});var x=class{static get(){return x.config}static set(t){x.config=t}};var U;(function(i){i.DONT_BLOCK="DONT_BLOCK",i.BLOCK_TWO_TILES="BLOCK_TWO_TILES",i.BLOCK_ONE_TILE_AHEAD="BLOCK_ONE_TILE_AHEAD",i.BLOCK_ONE_TILE_BEHIND="BLOCK_ONE_TILE_BEHIND"})(U||(U={}));var P=class{constructor(t,e){typeof t=="number"?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new P(this.x,this.y)}add(t){return new P(this.x+t.x,this.y+t.y)}multiply(t){return new P(this.x*t.x,this.y*t.y)}divide(t){return new P(this.x/t.x,this.y/t.y)}subtract(t){return new P(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}abs(){return new P(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}},p=P;p.ZERO=new P(0,0),p.UP=new P(0,-1),p.DOWN=new P(0,1),p.LEFT=new P(-1,0),p.RIGHT=new P(1,0);var a;(function(h){h.NONE="none",h.LEFT="left",h.UP_LEFT="up-left",h.UP="up",h.UP_RIGHT="up-right",h.RIGHT="right",h.DOWN_RIGHT="down-right",h.DOWN="down",h.DOWN_LEFT="down-left"})(a||(a={}));function Ft(o){let t=[a.UP,a.RIGHT,a.DOWN,a.LEFT],e=[a.DOWN_LEFT,a.DOWN_RIGHT,a.UP_RIGHT,a.UP_LEFT];return o===S.EIGHT?[...t,...e]:t}function ut(o){return[a.DOWN_LEFT,a.DOWN_RIGHT,a.UP_RIGHT,a.UP_LEFT].includes(o)}function Rt(o){return{[a.LEFT]:a.DOWN_LEFT,[a.UP_LEFT]:a.LEFT,[a.UP]:a.UP_LEFT,[a.UP_RIGHT]:a.UP,[a.RIGHT]:a.UP_RIGHT,[a.DOWN_RIGHT]:a.RIGHT,[a.DOWN]:a.DOWN_RIGHT,[a.DOWN_LEFT]:a.DOWN,[a.NONE]:a.NONE}[o]}function L(o){return{[a.UP]:p.UP.clone(),[a.DOWN]:p.DOWN.clone(),[a.LEFT]:p.LEFT.clone(),[a.RIGHT]:p.RIGHT.clone(),[a.NONE]:p.ZERO.clone(),[a.UP_LEFT]:new p(-1,-1),[a.UP_RIGHT]:new p(1,-1),[a.DOWN_RIGHT]:new p(1,1),[a.DOWN_LEFT]:new p(-1,1)}[o]}function Mt(o){return{[a.UP]:a.DOWN,[a.DOWN]:a.UP,[a.LEFT]:a.RIGHT,[a.RIGHT]:a.LEFT,[a.NONE]:a.NONE,[a.UP_LEFT]:a.DOWN_RIGHT,[a.UP_RIGHT]:a.DOWN_LEFT,[a.DOWN_RIGHT]:a.UP_LEFT,[a.DOWN_LEFT]:a.UP_RIGHT}[o]}var S;(function(e){e[e.FOUR=4]="FOUR",e[e.EIGHT=8]="EIGHT"})(S||(S={}));var v=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return v.vec2str(t)==v.vec2str(e)}static manhattanDistance(t,e){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return r+i}static chebyshevDistance(t,e){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return Math.max(r,i)}static scalarMult(t,e){return t.clone().multiply(new p(e,e))}};var V=class{constructor(t,e,r){this.sprite=t;this.walkingAnimationMapping=e;this.characterIndex=r;this.lastFootLeft=!1;this.directionToFrameRow={[a.DOWN]:0,[a.DOWN_LEFT]:1,[a.DOWN_RIGHT]:2,[a.LEFT]:1,[a.RIGHT]:2,[a.UP]:3,[a.UP_LEFT]:1,[a.UP_RIGHT]:2};this._isEnabled=!0}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t}setStandingFrameDuringWalk(t){this.isCurrentFrameStanding(t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);this.sprite.setFrame(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){this.sprite.setFrame(this.framesOfDirection(t).standing)}isCurrentFrameStanding(t){return Number(this.sprite.frame.name)==this.framesOfDirection(t).standing}framesOfDirection(t){return this.walkingAnimationMapping?this.getFramesForAnimationMapping(t):this.getFramesForCharIndex(t)}getFramesForAnimationMapping(t){return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case a.DOWN_LEFT:return a.LEFT;case a.DOWN_RIGHT:return a.RIGHT;case a.UP_LEFT:return a.LEFT;case a.UP_RIGHT:return a.RIGHT}return t}getFramesForCharIndex(t){let e=this.sprite.texture.source[0].width/this.sprite.width/V.FRAMES_CHAR_ROW,r=Math.floor(this.characterIndex/e),i=this.characterIndex%e,n=e*V.FRAMES_CHAR_ROW,s=V.FRAMES_CHAR_ROW*i,c=this.directionToFrameRow[t]+r*V.FRAMES_CHAR_COL,l=s+c*n;return{rightFoot:l,standing:l+1,leftFoot:l+2}}},$=V;$.FRAMES_CHAR_ROW=3,$.FRAMES_CHAR_COL=4;var mt=class{constructor(){this.tilePosToCharacters=new Map;this.positionChangedSubs=new Map;this.positionChangeFinishedSubs=new Map}isCharBlockingAt(t){let e=this.posToString(t);return this.tilePosToCharacters.has(e)&&this.tilePosToCharacters.get(e).size>0}addCharacter(t){this.add(this.posToString(t.getTilePos()),t),this.add(this.posToString(t.getNextTilePos()),t),this.addPositionChangeSub(t),this.addPositionChangeFinishedSub(t)}removeCharacter(t){let e=t.getId();this.positionChangedSubs.get(e).unsubscribe(),this.positionChangeFinishedSubs.get(e).unsubscribe(),this.tilePosToCharacters.get(this.posToString(t.getTilePos())).delete(t),this.tilePosToCharacters.get(this.posToString(t.getNextTilePos())).delete(t)}add(t,e){this.tilePosToCharacters.has(t)||this.tilePosToCharacters.set(t,new Set),this.tilePosToCharacters.get(t).add(e)}addPositionChangeSub(t){let e=t.positionChanged().subscribe(r=>{x.get().characterCollisionStrategy===U.BLOCK_ONE_TILE_AHEAD&&this.tilePosToCharacters.get(this.posToString(r.exitTile)).delete(t),this.add(this.posToString(r.enterTile),t)});this.positionChangedSubs.set(t.getId(),e)}addPositionChangeFinishedSub(t){let e=t.positionChangeFinished().subscribe(r=>{this.tilePosToCharacters.get(this.posToString(r.exitTile)).delete(t)});this.positionChangeFinishedSubs.set(t.getId(),e)}posToString(t){return`${t.x}#${t.y}`}};var w=class{constructor(t,e){this.tilemap=t;this.firstLayerAboveChar=e;this.characters=new Map;this.charBlockCache=new mt;this.setLayerDepths()}addCharacter(t){this.characters.set(t.getId(),t),this.charBlockCache.addCharacter(t)}removeCharacter(t){this.charBlockCache.removeCharacter(this.characters.get(t)),this.characters.delete(t)}getCharacters(){return[...this.characters.values()]}isBlocking(t,e){return this.hasNoTile(t)||this.hasBlockingTile(t,e)||this.hasBlockingChar(t)}hasBlockingTile(t,e){if(this.hasNoTile(t))return!0;let r=w.ONE_WAY_COLLIDE_PROP_PREFIX+e;return this.tilemap.layers.some(i=>{let n=this.tilemap.getTileAt(t.x,t.y,!1,i.name);return(n==null?void 0:n.properties)&&(n.properties[x.get().collisionTilePropertyName]||n.properties[r])})}hasNoTile(t){return!this.tilemap.layers.some(e=>this.tilemap.hasTileAt(t.x,t.y,e.name))}hasBlockingChar(t){return this.charBlockCache.isCharBlockingAt(t)}getTileWidth(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*t}getTileHeight(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*t}getLayerProp(t,e){let i=t.properties.find(n=>n.name==e);return i==null?void 0:i.value}hasLayerProp(t,e){return this.getLayerProp(t,e)!=null}isLayerAlwaysOnTop(t,e){return e>=this.firstLayerAboveChar||this.hasLayerProp(t,w.ALWAYS_TOP_PROP_NAME)}setLayerDepths(){let t=[];this.tilemap.layers.forEach((e,r)=>{this.isLayerAlwaysOnTop(e,r)?e.tilemapLayer.setDepth(w.FIRST_PLAYER_LAYER+w.MAX_PLAYER_LAYERS+r):this.hasLayerProp(e,w.HEIGHT_SHIFT_PROP_NAME)?(this.createLayerForEachRow(e,r),t.push(e.tilemapLayer)):e.tilemapLayer.setDepth(r)}),t.forEach(e=>e.destroy())}createLayerForEachRow(t,e){let r=this.getLayerProp(t,w.HEIGHT_SHIFT_PROP_NAME);for(let i=0;i<t.height;i++){let n=this.tilemap.createBlankLayer(`${e}#${i}`,t.tilemapLayer.tileset);for(let c=0;c<t.width;c++)n.putTileAt(t.data[i][c],c,i);n.scale=t.tilemapLayer.scale;let s=.5;n.setDepth(w.FIRST_PLAYER_LAYER+i+r-1+s)}}},_=w;_.MAX_PLAYER_LAYERS=1e3,_.FIRST_PLAYER_LAYER=1e3,_.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",_.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",_.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_";var te=Ae(Qt()),{__extends:F,__assign:pr,__rest:ur,__decorate:mr,__param:fr,__metadata:dr,__awaiter:ee,__generator:et,__exportStar:vr,__createBinding:br,__values:R,__read:M,__spread:gr,__spreadArrays:yr,__spreadArray:k,__await:rt,__asyncGenerator:re,__asyncDelegator:xr,__asyncValues:ie,__makeTemplateObject:Tr,__importStar:Pr,__importDefault:Sr,__classPrivateFieldGet:Cr,__classPrivateFieldSet:_r}=te.default;function d(o){return typeof o=="function"}function it(o){var t=function(r){Error.call(r),r.stack=new Error().stack},e=o(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var ot=it(function(o){return function(e){o(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,i){return i+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function z(o,t){if(o){var e=o.indexOf(t);0<=e&&o.splice(e,1)}}var B=function(){function o(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._teardowns=null}return o.prototype.unsubscribe=function(){var t,e,r,i,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var c=R(s),l=c.next();!l.done;l=c.next()){var h=l.value;h.remove(this)}}catch(f){t={error:f}}finally{try{l&&!l.done&&(e=c.return)&&e.call(c)}finally{if(t)throw t.error}}else s.remove(this);var m=this.initialTeardown;if(d(m))try{m()}catch(f){n=f instanceof ot?f.errors:[f]}var y=this._teardowns;if(y){this._teardowns=null;try{for(var u=R(y),b=u.next();!b.done;b=u.next()){var O=b.value;try{oe(O)}catch(f){n=n!=null?n:[],f instanceof ot?n=k(k([],M(n)),M(f.errors)):n.push(f)}}}catch(f){r={error:f}}finally{try{b&&!b.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}}if(n)throw new ot(n)}},o.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)oe(t);else{if(t instanceof o){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=(e=this._teardowns)!==null&&e!==void 0?e:[]).push(t)}},o.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},o.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},o.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&z(e,t)},o.prototype.remove=function(t){var e=this._teardowns;e&&z(e,t),t instanceof o&&t._removeParent(this)},o.EMPTY=function(){var t=new o;return t.closed=!0,t}(),o}();var dt=B.EMPTY;function nt(o){return o instanceof B||o&&"closed"in o&&d(o.remove)&&d(o.add)&&d(o.unsubscribe)}function oe(o){d(o)?o():o.unsubscribe()}var E={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var j={setTimeout:function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];var e=j.delegate;return((e==null?void 0:e.setTimeout)||setTimeout).apply(void 0,k([],M(o)))},clearTimeout:function(o){var t=j.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(o)},delegate:void 0};function at(o){j.setTimeout(function(){var t=E.onUnhandledError;if(t)t(o);else throw o})}function I(){}var ne=function(){return vt("C",void 0,void 0)}();function ae(o){return vt("E",void 0,o)}function se(o){return vt("N",o,void 0)}function vt(o,t,e){return{kind:o,value:t,error:e}}var Y=function(o){F(t,o);function t(e){var r=o.call(this)||this;return r.isStopped=!1,e?(r.destination=e,nt(e)&&e.add(r)):r.destination=Ne,r}return t.create=function(e,r,i){return new bt(e,r,i)},t.prototype.next=function(e){this.isStopped?yt(se(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?yt(ae(e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?yt(ne,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(B);var bt=function(o){F(t,o);function t(e,r,i){var n=o.call(this)||this,s;if(d(e))s=e;else if(e){s=e.next,r=e.error,i=e.complete;var c;n&&E.useDeprecatedNextContext?(c=Object.create(e),c.unsubscribe=function(){return n.unsubscribe()}):c=e,s=s==null?void 0:s.bind(c),r=r==null?void 0:r.bind(c),i=i==null?void 0:i.bind(c)}return n.destination={next:s?gt(s,n):I,error:gt(r!=null?r:le,n),complete:i?gt(i,n):I},n}return t}(Y);function gt(o,t){return function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];try{o.apply(void 0,k([],M(e)))}catch(i){if(E.useDeprecatedSynchronousErrorHandling)if(t._syncErrorHack_isSubscribing)t.__syncError=i;else throw i;else at(i)}}}function le(o){throw o}function yt(o,t){var e=E.onStoppedNotification;e&&j.setTimeout(function(){return e(o,t)})}var Ne={closed:!0,next:I,error:le,complete:I};var H=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function ce(o){return o}function he(o){return o.length===0?ce:o.length===1?o[0]:function(e){return o.reduce(function(r,i){return i(r)},e)}}var D=function(){function o(t){t&&(this._subscribe=t)}return o.prototype.lift=function(t){var e=new o;return e.source=this,e.operator=t,e},o.prototype.subscribe=function(t,e,r){var i=Le(t)?t:new bt(t,e,r);if(E.useDeprecatedSynchronousErrorHandling)this._deprecatedSyncErrorSubscribe(i);else{var n=this,s=n.operator,c=n.source;i.add(s?s.call(i,c):c?this._subscribe(i):this._trySubscribe(i))}return i},o.prototype._deprecatedSyncErrorSubscribe=function(t){var e=t;e._syncErrorHack_isSubscribing=!0;var r=this.operator;if(r)t.add(r.call(t,this.source));else try{t.add(this._subscribe(t))}catch(n){e.__syncError=n}for(var i=e;i;){if("__syncError"in i)try{throw i.__syncError}finally{t.unsubscribe()}i=i.destination}e._syncErrorHack_isSubscribing=!1},o.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},o.prototype.forEach=function(t,e){var r=this;return e=pe(e),new e(function(i,n){var s;s=r.subscribe(function(c){try{t(c)}catch(l){n(l),s==null||s.unsubscribe()}},n,i)})},o.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},o.prototype[H]=function(){return this},o.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.length?he(t)(this):this},o.prototype.toPromise=function(t){var e=this;return t=pe(t),new t(function(r,i){var n;e.subscribe(function(s){return n=s},function(s){return i(s)},function(){return r(n)})})},o.create=function(t){return new o(t)},o}();function pe(o){var t;return(t=o!=null?o:E.Promise)!==null&&t!==void 0?t:Promise}function Ue(o){return o&&d(o.next)&&d(o.error)&&d(o.complete)}function Le(o){return o&&o instanceof Y||Ue(o)&&nt(o)}function Ve(o){return d(o==null?void 0:o.lift)}function st(o){return function(t){if(Ve(t))return t.lift(function(e){try{return o(e,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var lt=function(o){F(t,o);function t(e,r,i,n,s){var c=o.call(this,e)||this;return c.onFinalize=s,c._next=r?function(l){try{r(l)}catch(h){e.error(h)}}:o.prototype._next,c._error=n?function(l){try{n(l)}catch(h){e.error(h)}finally{this.unsubscribe()}}:o.prototype._error,c._complete=i?function(){try{i()}catch(l){e.error(l)}finally{this.unsubscribe()}}:o.prototype._complete,c}return t.prototype.unsubscribe=function(){var e,r=this.closed;o.prototype.unsubscribe.call(this),!r&&((e=this.onFinalize)===null||e===void 0||e.call(this))},t}(Y);var ue=it(function(o){return function(){o(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}});var g=function(o){F(t,o);function t(){var e=o.call(this)||this;return e.closed=!1,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var r=new me(this,this);return r.operator=e,r},t.prototype._throwIfClosed=function(){if(this.closed)throw new ue},t.prototype.next=function(e){var r,i;if(this._throwIfClosed(),!this.isStopped){var n=this.observers.slice();try{for(var s=R(n),c=s.next();!c.done;c=s.next()){var l=c.value;l.next(e)}}catch(h){r={error:h}}finally{try{c&&!c.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}}},t.prototype.error=function(e){if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=e;for(var r=this.observers;r.length;)r.shift().error(e)}},t.prototype.complete=function(){if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;for(var e=this.observers;e.length;)e.shift().complete()}},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),o.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var r=this,i=r.hasError,n=r.isStopped,s=r.observers;return i||n?dt:(s.push(e),new B(function(){return z(s,e)}))},t.prototype._checkFinalizedStatuses=function(e){var r=this,i=r.hasError,n=r.thrownError,s=r.isStopped;i?e.error(n):s&&e.complete()},t.prototype.asObservable=function(){var e=new D;return e.source=this,e},t.create=function(e,r){return new me(e,r)},t}(D);var me=function(o){F(t,o);function t(e,r){var i=o.call(this)||this;return i.destination=e,i.source=r,i}return t.prototype.next=function(e){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.next)===null||i===void 0||i.call(r,e)},t.prototype.error=function(e){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.error)===null||i===void 0||i.call(r,e)},t.prototype.complete=function(){var e,r;(r=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||r===void 0||r.call(e)},t.prototype._subscribe=function(e){var r,i;return(i=(r=this.source)===null||r===void 0?void 0:r.subscribe(e))!==null&&i!==void 0?i:dt},t}(g);var fe=function(o){return o&&typeof o.length=="number"&&typeof o!="function"};function de(o){return d(o==null?void 0:o.then)}function We(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ve=We();function be(o){return d(o[H])}function ge(o){return d(o==null?void 0:o[ve])}function ye(o){return Symbol.asyncIterator&&d(o==null?void 0:o[Symbol.asyncIterator])}function xe(o){return new TypeError("You provided "+(o!==null&&typeof o=="object"?"an invalid object":"'"+o+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Te(o){return re(this,arguments,function(){var e,r,i,n;return et(this,function(s){switch(s.label){case 0:e=o.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,rt(e.read())];case 3:return r=s.sent(),i=r.value,n=r.done,n?[4,rt(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,rt(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Pe(o){return d(o==null?void 0:o.getReader)}function Se(o){if(o instanceof D)return o;if(o!=null){if(be(o))return Be(o);if(fe(o))return je(o);if(de(o))return He(o);if(ye(o))return Ce(o);if(ge(o))return $e(o);if(Pe(o))return ze(o)}throw xe(o)}function Be(o){return new D(function(t){var e=o[H]();if(d(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function je(o){return new D(function(t){for(var e=0;e<o.length&&!t.closed;e++)t.next(o[e]);t.complete()})}function He(o){return new D(function(t){o.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,at)})}function $e(o){return new D(function(t){var e,r;try{for(var i=R(o),n=i.next();!n.done;n=i.next()){var s=n.value;if(t.next(s),t.closed)return}}catch(c){e={error:c}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}t.complete()})}function Ce(o){return new D(function(t){Ye(o,t).catch(function(e){return t.error(e)})})}function ze(o){return Ce(Te(o))}function Ye(o,t){var e,r,i,n;return ee(this,void 0,void 0,function(){var s,c;return et(this,function(l){switch(l.label){case 0:l.trys.push([0,5,6,11]),e=ie(o),l.label=1;case 1:return[4,e.next()];case 2:if(r=l.sent(),!!r.done)return[3,4];if(s=r.value,t.next(s),t.closed)return[2];l.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return c=l.sent(),i={error:c},[3,11];case 6:return l.trys.push([6,,9,10]),r&&!r.done&&(n=e.return)?[4,n.call(e)]:[3,8];case 7:l.sent(),l.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function xt(o,t){return st(function(e,r){var i=0;e.subscribe(new lt(r,function(n){return o.call(t,n,i++)&&r.next(n)}))})}var q=class{constructor(t,e){this.id=t;this.movementDirection=a.NONE;this.tileSizePixelsWalked=p.ZERO.clone();this._nextTilePos=new p(0,0);this._tilePos=new p(0,0);this.movementStarted$=new g;this.movementStopped$=new g;this.directionChanged$=new g;this.positionChanged$=new g;this.positionChangeFinished$=new g;this.autoMovementSet$=new g;this.lastMovementImpulse=a.NONE;this.facingDirection=a.DOWN;let r=0,i;typeof e.walkingAnimationMapping=="number"?r=e.walkingAnimationMapping:i=e.walkingAnimationMapping,this.sprite=e.sprite,this.sprite.setOrigin(0,0),this.container=e.container,this.tilemap=e.tilemap,this.speed=e.speed,this.customOffset=new p(e.offsetX||0,e.offsetY||0),this.tileSize=e.tileSize.clone(),this.animation=new $(this.sprite,i,r),this.animation.setIsEnabled(e.walkingAnimationMapping!==void 0),this.animation.setStandingFrame(a.DOWN),this.updateZindex()}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}setMovement(t){var e;this.autoMovementSet$.next(),this.movement=t,(e=this.movement)==null||e.setCharacter(this)}getMovement(){return this.movement}setWalkingAnimationMapping(t){this.animation.setWalkingAnimationMapping(t)}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.positionChanged$.next({exitTile:this.tilePos,enterTile:t}),this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:t}),this.movementDirection=a.NONE,this.nextTilePos=t,this.tilePos=t,this.updateZindex(),this.setPosition(this.tilePosToPixelPos(t).add(this.getOffset()).add(this.customOffset))}getTilePos(){return this.tilePos}getNextTilePos(){return this.nextTilePos}move(t){this.lastMovementImpulse=t,t!=a.NONE&&(this.isMoving()||(this.isBlockingDirection(t)?(this.facingDirection=t,this.animation.setStandingFrame(t),this.directionChanged$.next(t)):this.startMoving(t)))}update(t){var e;(e=this.movement)==null||e.update(t),this.isMoving()&&(this.updateCharacterPosition(t),this.updateZindex()),this.lastMovementImpulse=a.NONE}getMovementDirection(){return this.movementDirection}isBlockingTile(t){return this.nextTilePos.equals(t)||this.tilePos.equals(t)}isBlockingDirection(t){if(t==a.NONE)return!1;let e=this.tilePosInDirection(t),r=this.tilemap.hasBlockingTile(e,Mt(this.toMapDirection(t))),i=this.tilemap.hasBlockingChar(e)&&!this.tilePos.equals(e);return r||i}isMoving(){return this.movementDirection!=a.NONE}turnTowards(t){this.isMoving()||t!=a.NONE&&(this.facingDirection=t,this.animation.setStandingFrame(t))}getFacingDirection(){return this.facingDirection}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChanged(){return this.positionChanged$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}tilePosToPixelPos(t){return t.clone().multiply(this.tileSize)}getTileDistance(t){return this.tileSize.clone()}toMapDirection(t){return t}getOffset(){let t=this.tileSize.x/2-Math.floor(this.sprite.width*this.sprite.scale/2),e=-(this.sprite.height*this.sprite.scale)+this.tileSize.y;return new p(t,e)}createSpeedPixelsPerSecond(){let t={[a.LEFT]:new p(this.tileSize.x,0),[a.RIGHT]:new p(this.tileSize.x,0),[a.UP]:new p(0,this.tileSize.y),[a.DOWN]:new p(0,this.tileSize.y),[a.UP_LEFT]:this.getTileDistance(a.UP_LEFT),[a.UP_RIGHT]:this.getTileDistance(a.UP_RIGHT),[a.DOWN_LEFT]:this.getTileDistance(a.DOWN_LEFT),[a.DOWN_RIGHT]:this.getTileDistance(a.DOWN_RIGHT),[a.NONE]:p.ZERO.clone()};return Object.entries(t).forEach(([e,r])=>{t[e]=v.scalarMult(r,this.speed)}),t}get nextTilePos(){return this._nextTilePos.clone()}set nextTilePos(t){this._nextTilePos.x=t.x,this._nextTilePos.y=t.y}get tilePos(){return this._tilePos.clone()}set tilePos(t){this._tilePos.x=t.x,this._tilePos.y=t.y}updateZindex(){(this.container||this.sprite).setDepth(_.FIRST_PLAYER_LAYER+this.mapDepth(this.nextTilePos))}mapDepth(t){return t.y}setPosition(t){let e=this.container||this.sprite;e.x=t.x,e.y=t.y}getPosition(){let t=this.container||this.sprite;return new p(t.x,t.y)}startMoving(t){t!=this.movementDirection&&this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.updateTilePos()}updateTilePos(){this.tilePos=this.nextTilePos;let t=this.tilePosInDirection(this.movementDirection);this.nextTilePos=t,this.positionChanged$.next({exitTile:this.tilePos,enterTile:t})}tilePosInDirection(t){return this.nextTilePos.add(L(this.toMapDirection(t)))}getDistToNextTile(){return this.getTileDistance(this.movementDirection).clone().subtract(this.tileSizePixelsWalked).multiply(L(this.movementDirection))}updateCharacterPosition(t){let e=this.getSpeedPerDelta(t),r=this.getDistToNextTile(),i=r.length()<=e.length(),n=i?r:e;this.moveCharacterSprite(n),i&&(this.shouldContinueMoving()?(this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:this.nextTilePos}),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(t*this.getProportionWalked(e,r))):this.stopMoving())}getProportionWalked(t,e){let i=t.subtract(e).divide(t);return isNaN(i.x)&&(i.x=0),Math.max(Math.abs(i.x),Math.abs(i.y))}shouldContinueMoving(){return this.lastMovementImpulse!==a.NONE&&!this.isBlockingDirection(this.lastMovementImpulse)}getSpeedPerDelta(t){let e=t/1e3;return this.createSpeedPixelsPerSecond()[this.movementDirection].clone().multiply(new p(e,e)).multiply(L(this.movementDirection))}moveCharacterSprite(t){let e=this.getPosition().add(t);this.setPosition(e),this.tileSizePixelsWalked.x+=Math.abs(t.x),this.tileSizePixelsWalked.y+=Math.abs(t.y),this.animation.updateCharacterFrame(this.movementDirection,this.hasWalkedHalfATile()),this.tileSizePixelsWalked.x%=this.getTileDistance(this.movementDirection).x,this.tileSizePixelsWalked.y%=this.getTileDistance(this.movementDirection).y}stopMoving(){let t=this.tilePos,e=this.nextTilePos,r=this.movementDirection;this.tilePos=this.nextTilePos,this.movementDirection=a.NONE,this.movementStopped$.next(r),this.positionChangeFinished$.next({exitTile:t,enterTile:e})}hasWalkedHalfATile(){return this.tileSizePixelsWalked.x>this.getTileDistance(this.movementDirection).x/2||this.tileSizePixelsWalked.y>this.getTileDistance(this.movementDirection).y/2}};var Tt=class extends q{tilePosToPixelPos(t){return this.getTileDistance(a.UP_LEFT).multiply(new p(t.x-t.y,t.x+t.y))}getTileDistance(t){switch(t){case a.DOWN_LEFT:case a.DOWN_RIGHT:case a.UP_LEFT:case a.UP_RIGHT:return v.scalarMult(this.tileSize,.5);default:return super.getTileDistance(t)}}toMapDirection(t){return Rt(t)}mapDepth(t){return t.x+t.y}};function G(o){return st(function(t,e){Se(o).subscribe(new lt(e,function(){return e.complete()},I)),!e.closed&&t.subscribe(e)})}var Pt=class{getShortestPath(t,e,r){let i=this.shortestPathBfs(t,e,r);return{path:this.returnPath(i.previous,t,e),closestToTarget:i.closestToTarget}}shortestPathBfs(t,e,r){let i=new Map,n=new Set,s=[],c=t,l=v.manhattanDistance(t,e);for(s.push({node:t,dist:0}),n.add(v.vec2str(t));s.length>0;){let{node:h,dist:m}=s.shift(),y=v.manhattanDistance(h,e);if(y<l&&(l=y,c=h),v.equal(h,e))return{shortestDistance:m,previous:i,closestToTarget:c};for(let u of r(h))n.has(v.vec2str(u))||(i.set(v.vec2str(u),h),s.push({node:u,dist:m+1}),n.add(v.vec2str(u)))}return{shortestDistance:-1,previous:i,closestToTarget:c}}returnPath(t,e,r){let i=[],n=r;for(i.push(n);!v.equal(n,e);){if(n=t.get(v.vec2str(n)),!n)return[];i.push(n)}return i.reverse()}};var ct=class{constructor(t,e,r){this.backoffMs=t;this.maxRetries=e;this.onFinished=r;this.retries=0;this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}reset(){this.retries=0,this.elapsed=0}};var K=class{distance(t,e){return v.chebyshevDistance(t,e)}neighbours(t){let e=[new p(t.x,t.y+1),new p(t.x+1,t.y),new p(t.x-1,t.y),new p(t.x,t.y-1)],r=[new p(t.x+1,t.y+1),new p(t.x+1,t.y-1),new p(t.x-1,t.y+1),new p(t.x-1,t.y-1)];return[...e,...r]}direction(t,e){return e.x>t.x?e.y>t.y?a.DOWN_RIGHT:e.y<t.y?a.UP_RIGHT:a.RIGHT:e.x<t.x?e.y>t.y?a.DOWN_LEFT:e.y<t.y?a.UP_LEFT:a.LEFT:e.y<t.y?a.UP:e.y>t.y?a.DOWN:a.NONE}};var A=class{distance(t,e){return v.manhattanDistance(t,e)}direction(t,e){if(v.equal(t,e))return a.NONE;let r=t.clone().subtract(e);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?a.LEFT:a.RIGHT:r.y>0?a.UP:a.DOWN}neighbours(t){return[new p(t.x,t.y+1),new p(t.x+1,t.y),new p(t.x-1,t.y),new p(t.x,t.y-1)]}};var T;(function(r){r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY"})(T||(T={}));var C;(function(r){r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP"})(C||(C={}));var X=class{constructor(t,e,r=0,i){this.tilemap=t;this.targetPos=e;this.distance=r;this.posOnPath=0;this.stopped=!1;this.distanceUtils=new A;this.getNeighbours=t=>this.distanceUtils.neighbours(t).filter(r=>!this.isBlocking(r));this.isBlocking=t=>!t||this.tilemap.isBlocking(t);this.noPathFoundStrategy=(i==null?void 0:i.noPathFoundStrategy)||T.STOP,this.pathBlockedStrategy=(i==null?void 0:i.pathBlockedStrategy)||C.WAIT,this.noPathFoundRetryable=new ct((i==null?void 0:i.noPathFoundRetryBackoffMs)||200,(i==null?void 0:i.noPathFoundMaxRetries)||-1,()=>this.stop()),this.pathBlockedRetryable=new ct((i==null?void 0:i.pathBlockedRetryBackoffMs)||200,(i==null?void 0:i.pathBlockedMaxRetries)||-1,()=>this.stop()),this.pathBlockedWaitTimeoutMs=(i==null?void 0:i.pathBlockedWaitTimeoutMs)||-1}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setNumberOfDirections(t){t===S.EIGHT?this.distanceUtils=new K:this.distanceUtils=new A}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath()}update(t){this.stopped||(this.noPathFound()&&this.noPathFoundStrategy===T.RETRY&&this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()),this.isBlocking(this.nextTileOnPath())?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.updatePosOnPath(),this.hasArrived()?this.existsDistToTarget()&&this.turnTowardsTarget():this.isBlocking(this.nextTileOnPath())||this.moveCharOnPath())}applyPathBlockedStrategy(t){this.pathBlockedStrategy===C.RETRY?this.pathBlockedRetryable.retry(t,()=>this.calcShortestPath()):this.pathBlockedStrategy===C.STOP?this.stop():this.pathBlockedStrategy===C.WAIT&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop())}moveCharOnPath(){let t=this.getDir(this.character.getNextTilePos(),this.nextTileOnPath());this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(){this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos(),t);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().x!=t.x||this.character.getNextTilePos().y!=t.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(){let t=this.getShortestPath();this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new Pt,{path:e,closestToTarget:r}=t.getShortestPath(this.character.getNextTilePos(),this.targetPos,this.getNeighbours);if(e.length==0&&this.noPathFoundStrategy===T.CLOSEST_REACHABLE){let n=t.getShortestPath(this.character.getNextTilePos(),r,this.getNeighbours).path,s=this.distanceUtils.distance(r,this.targetPos);return{path:n,distOffset:s}}return{path:e,distOffset:0}}getDir(t,e){return this.distanceUtils.direction(t,e)}};var St=class{constructor(t,e,r=0,i=T.STOP){this.gridTilemap=t;this.charToFollow=e;this.distance=r;this.noPathFoundStrategy=i;this.numberOfDirections=S.FOUR}setNumberOfDirections(t){this.numberOfDirections=t}setCharacter(t){this.character=t,this.updateTarget(this.charToFollow.getTilePos()),this.charToFollow.positionChanged().pipe(G(this.character.autoMovementSet())).subscribe(({enterTile:e})=>{this.updateTarget(e)})}update(t){var e;(e=this.targetMovement)==null||e.update(t)}updateTarget(t){this.targetMovement=new X(this.gridTilemap,new p(t),this.distance+1,{noPathFoundStrategy:this.noPathFoundStrategy}),this.targetMovement.setNumberOfDirections(this.numberOfDirections),this.targetMovement.setCharacter(this.character)}};var Ct=class{constructor(t=0,e=-1){this.delay=t;this.radius=e;this.numberOfDirections=S.FOUR;this.distanceUtils=new A}setNumberOfDirections(t){this.numberOfDirections=t,t===S.EIGHT?this.distanceUtils=new K:this.distanceUtils=new A}setCharacter(t){this.character=t,this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().y,this.initialCol=t.getNextTilePos().x,this.stepSize=this.getRandomInt(this.radius)+1,this.stepsWalked=0,this.currentMovementDirection=a.NONE,this.character.positionChanged().pipe(G(this.character.autoMovementSet())).subscribe(()=>{this.stepsWalked++})}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let e=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(e),this.currentMovementDirection=e,this.stepSize=this.getRandomInt(this.radius)+1}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!==a.NONE&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return Ft(this.numberOfDirections).filter(e=>!this.character.isBlockingDirection(e)).filter(e=>this.isWithinRadius(e))}isWithinRadius(t){return this.radius==-1?!0:this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().add(L(t)),new p(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return t.length==0?a.NONE:t[this.getRandomInt(t.length)]}getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}};var _t=class{constructor(t){this.scene=t;this.isCreated=!1;this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this),this.scene.sys.events.on("destroy",this.destroy,this)}destroy(){this.scene=void 0,this.tilemap=void 0,this.gridCharacters=void 0,this.gridTilemap=void 0,this.movementStarted$=void 0,this.movementStopped$=void 0,this.directionChanged$=void 0,this.positionChangeStarted$=void 0,this.positionChangeFinished$=void 0,this.charRemoved$=void 0}setConfigDefaults(t){return pt({collisionTilePropertyName:"ge_collide",numberOfDirections:S.FOUR,characterCollisionStrategy:U.BLOCK_TWO_TILES},t)}create(t,e){this.isCreated=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(e);x.set(r),this.tilemap=t,this.movementStopped$=new g,this.movementStarted$=new g,this.directionChanged$=new g,this.positionChangeStarted$=new g,this.positionChangeFinished$=new g,this.charRemoved$=new g,this.gridTilemap=new _(t),this.addCharacters()}getPosition(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos()}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,r=-1){this.initGuard(),this.unknownCharGuard(t);let i=new Ct(e,r);i.setNumberOfDirections(x.get().numberOfDirections),this.gridCharacters.get(t).setMovement(i)}moveTo(t,e,r){let i=this.assembleMoveToConfig(r);this.initGuard(),this.unknownCharGuard(t);let n=new X(this.gridTilemap,new p(e),0,i);n.setNumberOfDirections(x.get().numberOfDirections),this.gridCharacters.get(t).setMovement(n)}stopMovement(t){this._stopMovement(t)}setSpeed(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setSpeed(e)}setWalkingAnimationMapping(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setWalkingAnimationMapping(e)}update(t,e){if(this.isCreated&&this.gridCharacters)for(let[r,i]of this.gridCharacters)i.update(e)}addCharacter(t){this.initGuard();let e={sprite:t.sprite,speed:t.speed||4,tilemap:this.gridTilemap,tileSize:new p(this.gridTilemap.getTileWidth(),this.gridTilemap.getTileHeight()),walkingAnimationMapping:t.walkingAnimationMapping,container:t.container,offsetX:t.offsetX,offsetY:t.offsetY},r=this.createCharacter(t.id,e);t.facingDirection&&r.turnTowards(t.facingDirection),this.gridCharacters.set(t.id,r);let i=t.startPosition?new p(t.startPosition):new p(0,0);r.setTilePosition(i),this.gridTilemap.addCharacter(r),r.movementStopped().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.movementStopped$.next({charId:r.getId(),direction:n})}),r.movementStarted().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.movementStarted$.next({charId:r.getId(),direction:n})}),r.directionChanged().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.directionChanged$.next({charId:r.getId(),direction:n})}),r.positionChanged().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(({exitTile:n,enterTile:s})=>{this.positionChangeStarted$.next({charId:r.getId(),exitTile:n,enterTile:s})}),r.positionChangeFinished().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(({exitTile:n,enterTile:s})=>{this.positionChangeFinished$.next({charId:r.getId(),exitTile:n,enterTile:s})})}hasCharacter(t){return this.initGuard(),this.gridCharacters.has(t)}removeCharacter(t){this.initGuard(),this.unknownCharGuard(t),this.gridTilemap.removeCharacter(t),this.gridCharacters.delete(t),this.charRemoved$.next(t)}removeAllCharacters(){this.initGuard();for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(){return this.initGuard(),[...this.gridCharacters.keys()]}follow(t,e,r=0,i=!1){this.initGuard(),this.unknownCharGuard(t),this.unknownCharGuard(e);let n=new St(this.gridTilemap,this.gridCharacters.get(e),r,i?T.CLOSEST_REACHABLE:T.STOP);n.setNumberOfDirections(x.get().numberOfDirections),this.gridCharacters.get(t).setMovement(n)}isMoving(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).isMoving()}getFacingDirection(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getFacingDirection()}turnTowards(t,e){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).turnTowards(e)}setPosition(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setTilePosition(new p(e))}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}takeUntilCharRemoved(t){return G(this.charRemoved$.pipe(xt(e=>e==t)))}initGuard(){if(!this.isCreated)throw new Error("Plugin not initialized. You need to call create() first.")}unknownCharGuard(t){if(!this.gridCharacters.has(t))throw new Error(`Character unknown: ${t}`)}createCharacter(t,e){return this._isIsometric()?new Tt(t,e):new q(t,e)}addCharacters(){x.get().characters.forEach(t=>this.addCharacter(t))}moveChar(t,e){if(this.initGuard(),this.unknownCharGuard(t),x.get().numberOfDirections===S.FOUR){if(!this._isIsometric()&&ut(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}else if(this._isIsometric()&&!ut(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}this.gridCharacters.get(t).move(e)}_stopMovement(t){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setMovement(void 0)}_isIsometric(){return this.tilemap.orientation==`${Phaser.Tilemaps.Orientation.ISOMETRIC}`}assembleMoveToConfig(t){let e=Ot(pt({},t),{noPathFoundStrategy:T.STOP,pathBlockedStrategy:C.WAIT});return(t==null?void 0:t.noPathFoundStrategy)&&(Object.values(T).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to '${T.STOP}'`)),(t==null?void 0:t.pathBlockedStrategy)&&(Object.values(C).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to '${C.WAIT}'`)),e}};var Rn=_t;export{a as Direction,_t as GridEngine,Rn as default};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
