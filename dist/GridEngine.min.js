var GridEngine=(()=>{var Zi=Object.create;var Pt=Object.defineProperty,Ji=Object.defineProperties,eo=Object.getOwnPropertyDescriptor,to=Object.getOwnPropertyDescriptors,ro=Object.getOwnPropertyNames,ar=Object.getOwnPropertySymbols,io=Object.getPrototypeOf,cr=Object.prototype.hasOwnProperty,oo=Object.prototype.propertyIsEnumerable;var hr=(o,e,t)=>e in o?Pt(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,N=(o,e)=>{for(var t in e||(e={}))cr.call(e,t)&&hr(o,t,e[t]);if(ar)for(var t of ar(e))oo.call(e,t)&&hr(o,t,e[t]);return o},ie=(o,e)=>Ji(o,to(e));var l=(o,e)=>()=>(o&&(e=o(o=0)),e);var lr=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var no=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ro(e))!cr.call(o,i)&&i!==t&&Pt(o,i,{get:()=>e[i],enumerable:!(r=eo(e,i))||r.enumerable});return o};var so=(o,e,t)=>(t=o!=null?Zi(io(o)):{},no(e||!o||!o.__esModule?Pt(t,"default",{value:o,enumerable:!0}):t,o));var p,E=l(()=>{p=class{static get ZERO(){return new p(0,0)}static get ONE(){return new p(1,1)}static get UP(){return new p(0,-1)}static get DOWN(){return new p(0,1)}static get LEFT(){return new p(-1,0)}static get RIGHT(){return new p(1,0)}static get UP_LEFT(){return new p(-1,-1)}static get UP_RIGHT(){return new p(1,-1)}static get DOWN_RIGHT(){return new p(1,1)}static get DOWN_LEFT(){return new p(-1,1)}constructor(e,t){typeof e=="number"?(this.x=e,this.y=t||0):(this.x=e.x,this.y=e.y)}clone(){return new p(this.x,this.y)}add(e){return new p(this.x+e.x,this.y+e.y)}multiply(e){return new p(this.x*e.x,this.y*e.y)}divide(e){return new p(this.x/e.x,this.y/e.y)}subtract(e){return new p(this.x-e.x,this.y-e.y)}equals(e){return this.x===e.x&&this.y===e.y}abs(){return new p(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}modulo(e){return new p(this.x%e.x,this.y%e.y)}scalarModulo(e){return new p(this.x%e,this.y%e)}scalarMult(e){return new p(this.x*e,this.y*e)}toPosition(){return{x:this.x,y:this.y}}toString(){return`${this.x}#${this.y}`}}});var P,de=l(()=>{E();P=class{static equal(e,t){return e.position.x===t.position.x&&e.position.y===t.position.y&&e.layer===t.layer}static copyOver(e,t){t.position.x=e.position.x,t.position.y=e.position.y,t.layer=e.layer}static clone(e){return{position:e.position.clone(),layer:e.layer}}static toString(e){return`${e.position.toString()}#${e.layer}`}static toInternal(e){return{position:new p(e.position.x,e.position.y),layer:e.charLayer}}static fromInternal(e){return{position:e.position.toPosition(),charLayer:e.layer}}}});function xt(o){return["down-left","down-right","up-right","up-left"].includes(o)}function pr(o){return{["left"]:"down-left",["up-left"]:"left",["up"]:"up-left",["up-right"]:"up",["right"]:"up-right",["down-right"]:"right",["down"]:"down-right",["down-left"]:"down",["none"]:"none"}[o]}function ur(o){return{["left"]:"up-left",["up-left"]:"up",["up"]:"up-right",["up-right"]:"right",["right"]:"down-right",["down-right"]:"down",["down"]:"down-left",["down-left"]:"left",["none"]:"none"}[o]}function j(o){return{["up"]:p.UP,["down"]:p.DOWN,["left"]:p.LEFT,["right"]:p.RIGHT,["none"]:p.ZERO,["up-left"]:p.UP_LEFT,["up-right"]:p.UP_RIGHT,["down-right"]:p.DOWN_RIGHT,["down-left"]:p.DOWN_LEFT}[o]}function Oe(o){return{["up"]:"down",["down"]:"up",["left"]:"right",["right"]:"left",["none"]:"none",["up-left"]:"down-right",["up-right"]:"down-left",["down-right"]:"up-left",["down-left"]:"up-right"}[o]}function mr(o,e){if(o.x===e.x){if(o.y>e.y)return"up";if(o.y<e.y)return"down"}else if(o.y===e.y){if(o.x>e.x)return"left";if(o.x<e.x)return"right"}else if(o.x>e.x){if(o.y<e.y)return"down-left";if(o.y>e.y)return"up-left"}else if(o.x<e.x){if(o.y<e.y)return"down-right";if(o.y>e.y)return"up-right"}return"none"}var R=l(()=>{E()});var Fr=lr((No,Le)=>{var fr,dr,gr,yr,vr,br,Pr,xr,Tr,Ee,Tt,Cr,Sr,wr,oe,Dr,Or,Er,_r,Lr,Ar,Rr,Mr,Ir,_e;(function(o){var e=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){o(t(e,t(r)))}):typeof Le=="object"&&typeof Le.exports=="object"?o(t(e,t(Le.exports))):o(t(e));function t(r,i){return r!==e&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,s){return r[n]=i?i(n,s):s}}})(function(o){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,i){r.__proto__=i}||function(r,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])};fr=function(r,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");e(r,i);function n(){this.constructor=r}r.prototype=i===null?Object.create(i):(n.prototype=i.prototype,new n)},dr=Object.assign||function(r){for(var i,n=1,s=arguments.length;n<s;n++){i=arguments[n];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(r[a]=i[a])}return r},gr=function(r,i){var n={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&i.indexOf(s)<0&&(n[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,s=Object.getOwnPropertySymbols(r);a<s.length;a++)i.indexOf(s[a])<0&&Object.prototype.propertyIsEnumerable.call(r,s[a])&&(n[s[a]]=r[s[a]]);return n},yr=function(r,i,n,s){var a=arguments.length,h=a<3?i:s===null?s=Object.getOwnPropertyDescriptor(i,n):s,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")h=Reflect.decorate(r,i,n,s);else for(var m=r.length-1;m>=0;m--)(c=r[m])&&(h=(a<3?c(h):a>3?c(i,n,h):c(i,n))||h);return a>3&&h&&Object.defineProperty(i,n,h),h},vr=function(r,i){return function(n,s){i(n,s,r)}},br=function(r,i){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,i)},Pr=function(r,i,n,s){function a(h){return h instanceof n?h:new n(function(c){c(h)})}return new(n||(n=Promise))(function(h,c){function m(f){try{u(s.next(f))}catch(b){c(b)}}function y(f){try{u(s.throw(f))}catch(b){c(b)}}function u(f){f.done?h(f.value):a(f.value).then(m,y)}u((s=s.apply(r,i||[])).next())})},xr=function(r,i){var n={label:0,sent:function(){if(h[0]&1)throw h[1];return h[1]},trys:[],ops:[]},s,a,h,c;return c={next:m(0),throw:m(1),return:m(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function m(u){return function(f){return y([u,f])}}function y(u){if(s)throw new TypeError("Generator is already executing.");for(;c&&(c=0,u[0]&&(n=0)),n;)try{if(s=1,a&&(h=u[0]&2?a.return:u[0]?a.throw||((h=a.return)&&h.call(a),0):a.next)&&!(h=h.call(a,u[1])).done)return h;switch(a=0,h&&(u=[u[0]&2,h.value]),u[0]){case 0:case 1:h=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,a=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(h=n.trys,!(h=h.length>0&&h[h.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!h||u[1]>h[0]&&u[1]<h[3])){n.label=u[1];break}if(u[0]===6&&n.label<h[1]){n.label=h[1],h=u;break}if(h&&n.label<h[2]){n.label=h[2],n.ops.push(u);break}h[2]&&n.ops.pop(),n.trys.pop();continue}u=i.call(r,n)}catch(f){u=[6,f],a=0}finally{s=h=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}},Tr=function(r,i){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&_e(i,r,n)},_e=Object.create?function(r,i,n,s){s===void 0&&(s=n);var a=Object.getOwnPropertyDescriptor(i,n);(!a||("get"in a?!i.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(r,s,a)}:function(r,i,n,s){s===void 0&&(s=n),r[s]=i[n]},Ee=function(r){var i=typeof Symbol=="function"&&Symbol.iterator,n=i&&r[i],s=0;if(n)return n.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")},Tt=function(r,i){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var s=n.call(r),a,h=[],c;try{for(;(i===void 0||i-- >0)&&!(a=s.next()).done;)h.push(a.value)}catch(m){c={error:m}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(c)throw c.error}}return h},Cr=function(){for(var r=[],i=0;i<arguments.length;i++)r=r.concat(Tt(arguments[i]));return r},Sr=function(){for(var r=0,i=0,n=arguments.length;i<n;i++)r+=arguments[i].length;for(var s=Array(r),a=0,i=0;i<n;i++)for(var h=arguments[i],c=0,m=h.length;c<m;c++,a++)s[a]=h[c];return s},wr=function(r,i,n){if(n||arguments.length===2)for(var s=0,a=i.length,h;s<a;s++)(h||!(s in i))&&(h||(h=Array.prototype.slice.call(i,0,s)),h[s]=i[s]);return r.concat(h||Array.prototype.slice.call(i))},oe=function(r){return this instanceof oe?(this.v=r,this):new oe(r)},Dr=function(r,i,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=n.apply(r,i||[]),a,h=[];return a={},c("next"),c("throw"),c("return"),a[Symbol.asyncIterator]=function(){return this},a;function c(d){s[d]&&(a[d]=function(O){return new Promise(function(D,H){h.push([d,O,D,H])>1||m(d,O)})})}function m(d,O){try{y(s[d](O))}catch(D){b(h[0][3],D)}}function y(d){d.value instanceof oe?Promise.resolve(d.value.v).then(u,f):b(h[0][2],d)}function u(d){m("next",d)}function f(d){m("throw",d)}function b(d,O){d(O),h.shift(),h.length&&m(h[0][0],h[0][1])}},Or=function(r){var i,n;return i={},s("next"),s("throw",function(a){throw a}),s("return"),i[Symbol.iterator]=function(){return this},i;function s(a,h){i[a]=r[a]?function(c){return(n=!n)?{value:oe(r[a](c)),done:a==="return"}:h?h(c):c}:h}},Er=function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=r[Symbol.asyncIterator],n;return i?i.call(r):(r=typeof Ee=="function"?Ee(r):r[Symbol.iterator](),n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n);function s(h){n[h]=r[h]&&function(c){return new Promise(function(m,y){c=r[h](c),a(m,y,c.done,c.value)})}}function a(h,c,m,y){Promise.resolve(y).then(function(u){h({value:u,done:m})},c)}},_r=function(r,i){return Object.defineProperty?Object.defineProperty(r,"raw",{value:i}):r.raw=i,r};var t=Object.create?function(r,i){Object.defineProperty(r,"default",{enumerable:!0,value:i})}:function(r,i){r.default=i};Lr=function(r){if(r&&r.__esModule)return r;var i={};if(r!=null)for(var n in r)n!=="default"&&Object.prototype.hasOwnProperty.call(r,n)&&_e(i,r,n);return t(i,r),i},Ar=function(r){return r&&r.__esModule?r:{default:r}},Rr=function(r,i,n,s){if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof i=="function"?r!==i||!s:!i.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?s:n==="a"?s.call(r):s?s.value:i.get(r)},Mr=function(r,i,n,s,a){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof i=="function"?r!==i||!a:!i.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?a.call(r,n):a?a.value=n:i.set(r,n),n},Ir=function(r,i){if(i===null||typeof i!="object"&&typeof i!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof r=="function"?i===r:r.has(i)},o("__extends",fr),o("__assign",dr),o("__rest",gr),o("__decorate",yr),o("__param",vr),o("__metadata",br),o("__awaiter",Pr),o("__generator",xr),o("__exportStar",Tr),o("__createBinding",_e),o("__values",Ee),o("__read",Tt),o("__spread",Cr),o("__spreadArrays",Sr),o("__spreadArray",wr),o("__await",oe),o("__asyncGenerator",Dr),o("__asyncDelegator",Or),o("__asyncValues",Er),o("__makeTemplateObject",_r),o("__importStar",Lr),o("__importDefault",Ar),o("__classPrivateFieldGet",Rr),o("__classPrivateFieldSet",Mr),o("__classPrivateFieldIn",Ir)})});var Gr,Y,ko,Vo,Wo,Uo,Bo,Nr,Ae,Ho,jo,X,V,$o,zo,W,Re,kr,qo,Vr,Yo,Xo,Ko,Qo,Zo,Jo,U=l(()=>{Gr=so(Fr(),1),{__extends:Y,__assign:ko,__rest:Vo,__decorate:Wo,__param:Uo,__metadata:Bo,__awaiter:Nr,__generator:Ae,__exportStar:Ho,__createBinding:jo,__values:X,__read:V,__spread:$o,__spreadArrays:zo,__spreadArray:W,__await:Re,__asyncGenerator:kr,__asyncDelegator:qo,__asyncValues:Vr,__makeTemplateObject:Yo,__importStar:Xo,__importDefault:Ko,__classPrivateFieldGet:Qo,__classPrivateFieldSet:Zo,__classPrivateFieldIn:Jo}=Gr.default});function g(o){return typeof o=="function"}var _=l(()=>{});function Me(o){var e=function(r){Error.call(r),r.stack=new Error().stack},t=o(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var Ct=l(()=>{});var Ie,Wr=l(()=>{Ct();Ie=Me(function(o){return function(t){o(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(r,i){return i+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}})});function ge(o,e){if(o){var t=o.indexOf(e);0<=t&&o.splice(t,1)}}var St=l(()=>{});function Fe(o){return o instanceof ne||o&&"closed"in o&&g(o.remove)&&g(o.add)&&g(o.unsubscribe)}function Ur(o){g(o)?o():o.unsubscribe()}var ne,wt,Ge=l(()=>{U();_();Wr();St();ne=function(){function o(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return o.prototype.unsubscribe=function(){var e,t,r,i,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=X(s),h=a.next();!h.done;h=a.next()){var c=h.value;c.remove(this)}}catch(d){e={error:d}}finally{try{h&&!h.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else s.remove(this);var m=this.initialTeardown;if(g(m))try{m()}catch(d){n=d instanceof Ie?d.errors:[d]}var y=this._finalizers;if(y){this._finalizers=null;try{for(var u=X(y),f=u.next();!f.done;f=u.next()){var b=f.value;try{Ur(b)}catch(d){n=n!=null?n:[],d instanceof Ie?n=W(W([],V(n)),V(d.errors)):n.push(d)}}}catch(d){r={error:d}}finally{try{f&&!f.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}}if(n)throw new Ie(n)}},o.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)Ur(e);else{if(e instanceof o){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},o.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},o.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},o.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&ge(t,e)},o.prototype.remove=function(e){var t=this._finalizers;t&&ge(t,e),e instanceof o&&e._removeParent(this)},o.EMPTY=function(){var e=new o;return e.closed=!0,e}(),o}(),wt=ne.EMPTY});var k,ye=l(()=>{k={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1}});var se,Dt=l(()=>{U();se={setTimeout:function(o,e){for(var t=[],r=2;r<arguments.length;r++)t[r-2]=arguments[r];var i=se.delegate;return i!=null&&i.setTimeout?i.setTimeout.apply(i,W([o,e],V(t))):setTimeout.apply(void 0,W([o,e],V(t)))},clearTimeout:function(o){var e=se.delegate;return((e==null?void 0:e.clearTimeout)||clearTimeout)(o)},delegate:void 0}});function Ne(o){se.setTimeout(function(){var e=k.onUnhandledError;if(e)e(o);else throw o})}var Ot=l(()=>{ye();Dt()});function ve(){}var Et=l(()=>{});function Hr(o){return _t("E",void 0,o)}function jr(o){return _t("N",o,void 0)}function _t(o,e,t){return{kind:o,value:e,error:t}}var Br,$r=l(()=>{Br=function(){return _t("C",void 0,void 0)}()});function ae(o){if(k.useDeprecatedSynchronousErrorHandling){var e=!K;if(e&&(K={errorThrown:!1,error:null}),o(),e){var t=K,r=t.errorThrown,i=t.error;if(K=null,r)throw i}}else o()}function zr(o){k.useDeprecatedSynchronousErrorHandling&&K&&(K.errorThrown=!0,K.error=o)}var K,ke=l(()=>{ye();K=null});function Lt(o,e){return ao.call(o,e)}function Ve(o){k.useDeprecatedSynchronousErrorHandling?zr(o):Ne(o)}function co(o){throw o}function At(o,e){var t=k.onStoppedNotification;t&&se.setTimeout(function(){return t(o,e)})}var be,ao,ho,We,lo,Rt=l(()=>{U();_();Ge();ye();Ot();Et();$r();Dt();ke();be=function(o){Y(e,o);function e(t){var r=o.call(this)||this;return r.isStopped=!1,t?(r.destination=t,Fe(t)&&t.add(r)):r.destination=lo,r}return e.create=function(t,r,i){return new We(t,r,i)},e.prototype.next=function(t){this.isStopped?At(jr(t),this):this._next(t)},e.prototype.error=function(t){this.isStopped?At(Hr(t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?At(Br,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(ne),ao=Function.prototype.bind;ho=function(){function o(e){this.partialObserver=e}return o.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(r){Ve(r)}},o.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(r){Ve(r)}else Ve(e)},o.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){Ve(t)}},o}(),We=function(o){Y(e,o);function e(t,r,i){var n=o.call(this)||this,s;if(g(t)||!t)s={next:t!=null?t:void 0,error:r!=null?r:void 0,complete:i!=null?i:void 0};else{var a;n&&k.useDeprecatedNextContext?(a=Object.create(t),a.unsubscribe=function(){return n.unsubscribe()},s={next:t.next&&Lt(t.next,a),error:t.error&&Lt(t.error,a),complete:t.complete&&Lt(t.complete,a)}):s=t}return n.destination=new ho(s),n}return e}(be);lo={closed:!0,next:ve,error:co,complete:ve}});var he,Ue=l(()=>{he=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function Be(o){return o}var Mt=l(()=>{});function It(){for(var o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];return Ft(o)}function Ft(o){return o.length===0?Be:o.length===1?o[0]:function(t){return o.reduce(function(r,i){return i(r)},t)}}var Gt=l(()=>{Mt()});function qr(o){var e;return(e=o!=null?o:k.Promise)!==null&&e!==void 0?e:Promise}function po(o){return o&&g(o.next)&&g(o.error)&&g(o.complete)}function uo(o){return o&&o instanceof be||po(o)&&Fe(o)}var T,Q=l(()=>{Rt();Ge();Ue();Gt();ye();_();ke();T=function(){function o(e){e&&(this._subscribe=e)}return o.prototype.lift=function(e){var t=new o;return t.source=this,t.operator=e,t},o.prototype.subscribe=function(e,t,r){var i=this,n=uo(e)?e:new We(e,t,r);return ae(function(){var s=i,a=s.operator,h=s.source;n.add(a?a.call(n,h):h?i._subscribe(n):i._trySubscribe(n))}),n},o.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},o.prototype.forEach=function(e,t){var r=this;return t=qr(t),new t(function(i,n){var s=new We({next:function(a){try{e(a)}catch(h){n(h),s.unsubscribe()}},error:n,complete:i});r.subscribe(s)})},o.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},o.prototype[he]=function(){return this},o.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Ft(e)(this)},o.prototype.toPromise=function(e){var t=this;return e=qr(e),new e(function(r,i){var n;t.subscribe(function(s){return n=s},function(s){return i(s)},function(){return r(n)})})},o.create=function(e){return new o(e)},o}()});function mo(o){return g(o==null?void 0:o.lift)}function w(o){return function(e){if(mo(e))return e.lift(function(t){try{return o(t,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var $=l(()=>{_()});function L(o,e,t,r,i){return new fo(o,e,t,r,i)}var fo,Z=l(()=>{U();Rt();fo=function(o){Y(e,o);function e(t,r,i,n,s,a){var h=o.call(this,t)||this;return h.onFinalize=s,h.shouldUnsubscribe=a,h._next=r?function(c){try{r(c)}catch(m){t.error(m)}}:o.prototype._next,h._error=n?function(c){try{n(c)}catch(m){t.error(m)}finally{this.unsubscribe()}}:o.prototype._error,h._complete=i?function(){try{i()}catch(c){t.error(c)}finally{this.unsubscribe()}}:o.prototype._complete,h}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;o.prototype.unsubscribe.call(this),!r&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e}(be)});var Yr,Xr=l(()=>{Ct();Yr=Me(function(o){return function(){o(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})});var v,Kr,Qr=l(()=>{U();Q();Ge();Xr();St();ke();v=function(o){Y(e,o);function e(){var t=o.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var r=new Kr(this,this);return r.operator=t,r},e.prototype._throwIfClosed=function(){if(this.closed)throw new Yr},e.prototype.next=function(t){var r=this;ae(function(){var i,n;if(r._throwIfClosed(),!r.isStopped){r.currentObservers||(r.currentObservers=Array.from(r.observers));try{for(var s=X(r.currentObservers),a=s.next();!a.done;a=s.next()){var h=a.value;h.next(t)}}catch(c){i={error:c}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}}})},e.prototype.error=function(t){var r=this;ae(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=t;for(var i=r.observers;i.length;)i.shift().error(t)}})},e.prototype.complete=function(){var t=this;ae(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var r=t.observers;r.length;)r.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),o.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var r=this,i=this,n=i.hasError,s=i.isStopped,a=i.observers;return n||s?wt:(this.currentObservers=null,a.push(t),new ne(function(){r.currentObservers=null,ge(a,t)}))},e.prototype._checkFinalizedStatuses=function(t){var r=this,i=r.hasError,n=r.thrownError,s=r.isStopped;i?t.error(n):s&&t.complete()},e.prototype.asObservable=function(){var t=new T;return t.source=this,t},e.create=function(t,r){return new Kr(t,r)},e}(T),Kr=function(o){Y(e,o);function e(t,r){var i=o.call(this)||this;return i.destination=t,i.source=r,i}return e.prototype.next=function(t){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.next)===null||i===void 0||i.call(r,t)},e.prototype.error=function(t){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.error)===null||i===void 0||i.call(r,t)},e.prototype.complete=function(){var t,r;(r=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||r===void 0||r.call(t)},e.prototype._subscribe=function(t){var r,i;return(i=(r=this.source)===null||r===void 0?void 0:r.subscribe(t))!==null&&i!==void 0?i:wt},e}(v)});var Zr,Jr=l(()=>{Q();Zr=new T(function(o){return o.complete()})});function ei(o){return o&&g(o.schedule)}var ti=l(()=>{_()});function ri(o){return o[o.length-1]}function ii(o){return ei(ri(o))?o.pop():void 0}function oi(o,e){return typeof ri(o)=="number"?o.pop():e}var ni=l(()=>{ti()});var He,Nt=l(()=>{He=function(o){return o&&typeof o.length=="number"&&typeof o!="function"}});function je(o){return g(o==null?void 0:o.then)}var kt=l(()=>{_()});function $e(o){return g(o[he])}var Vt=l(()=>{Ue();_()});function ze(o){return Symbol.asyncIterator&&g(o==null?void 0:o[Symbol.asyncIterator])}var Wt=l(()=>{_()});function qe(o){return new TypeError("You provided "+(o!==null&&typeof o=="object"?"an invalid object":"'"+o+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var Ut=l(()=>{});function go(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Ye,Bt=l(()=>{Ye=go()});function Xe(o){return g(o==null?void 0:o[Ye])}var Ht=l(()=>{Bt();_()});function Ke(o){return kr(this,arguments,function(){var t,r,i,n;return Ae(this,function(s){switch(s.label){case 0:t=o.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,Re(t.read())];case 3:return r=s.sent(),i=r.value,n=r.done,n?[4,Re(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,Re(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function Qe(o){return g(o==null?void 0:o.getReader)}var Ze=l(()=>{U();_()});function M(o){if(o instanceof T)return o;if(o!=null){if($e(o))return yo(o);if(He(o))return vo(o);if(je(o))return bo(o);if(ze(o))return si(o);if(Xe(o))return Po(o);if(Qe(o))return xo(o)}throw qe(o)}function yo(o){return new T(function(e){var t=o[he]();if(g(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function vo(o){return new T(function(e){for(var t=0;t<o.length&&!e.closed;t++)e.next(o[t]);e.complete()})}function bo(o){return new T(function(e){o.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,Ne)})}function Po(o){return new T(function(e){var t,r;try{for(var i=X(o),n=i.next();!n.done;n=i.next()){var s=n.value;if(e.next(s),e.closed)return}}catch(a){t={error:a}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}e.complete()})}function si(o){return new T(function(e){To(o,e).catch(function(t){return e.error(t)})})}function xo(o){return si(Ke(o))}function To(o,e){var t,r,i,n;return Nr(this,void 0,void 0,function(){var s,a;return Ae(this,function(h){switch(h.label){case 0:h.trys.push([0,5,6,11]),t=Vr(o),h.label=1;case 1:return[4,t.next()];case 2:if(r=h.sent(),!!r.done)return[3,4];if(s=r.value,e.next(s),e.closed)return[2];h.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=h.sent(),i={error:a},[3,11];case 6:return h.trys.push([6,,9,10]),r&&!r.done&&(n=t.return)?[4,n.call(t)]:[3,8];case 7:h.sent(),h.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}var J=l(()=>{U();Nt();kt();Q();Vt();Wt();Ut();Ht();Ze();_();Ot();Ue()});function I(o,e,t,r,i){r===void 0&&(r=0),i===void 0&&(i=!1);var n=e.schedule(function(){t(),i?o.add(this.schedule(null,r)):this.unsubscribe()},r);if(o.add(n),!i)return n}var Pe=l(()=>{});function Je(o,e){return e===void 0&&(e=0),w(function(t,r){t.subscribe(L(r,function(i){return I(r,o,function(){return r.next(i)},e)},function(){return I(r,o,function(){return r.complete()},e)},function(i){return I(r,o,function(){return r.error(i)},e)}))})}var jt=l(()=>{Pe();$();Z()});function et(o,e){return e===void 0&&(e=0),w(function(t,r){r.add(o.schedule(function(){return t.subscribe(r)},e))})}var $t=l(()=>{$()});function ai(o,e){return M(o).pipe(et(e),Je(e))}var hi=l(()=>{J();jt();$t()});function ci(o,e){return M(o).pipe(et(e),Je(e))}var li=l(()=>{J();jt();$t()});function pi(o,e){return new T(function(t){var r=0;return e.schedule(function(){r===o.length?t.complete():(t.next(o[r++]),t.closed||this.schedule())})})}var ui=l(()=>{Q()});function mi(o,e){return new T(function(t){var r;return I(t,e,function(){r=o[Ye](),I(t,e,function(){var i,n,s;try{i=r.next(),n=i.value,s=i.done}catch(a){t.error(a);return}s?t.complete():t.next(n)},0,!0)}),function(){return g(r==null?void 0:r.return)&&r.return()}})}var fi=l(()=>{Q();Bt();_();Pe()});function tt(o,e){if(!o)throw new Error("Iterable cannot be null");return new T(function(t){I(t,e,function(){var r=o[Symbol.asyncIterator]();I(t,e,function(){r.next().then(function(i){i.done?t.complete():t.next(i.value)})},0,!0)})})}var zt=l(()=>{Q();Pe()});function di(o,e){return tt(Ke(o),e)}var gi=l(()=>{zt();Ze()});function yi(o,e){if(o!=null){if($e(o))return ai(o,e);if(He(o))return pi(o,e);if(je(o))return ci(o,e);if(ze(o))return tt(o,e);if(Xe(o))return mi(o,e);if(Qe(o))return di(o,e)}throw qe(o)}var vi=l(()=>{hi();li();ui();fi();zt();Vt();kt();Nt();Ht();Wt();Ut();Ze();gi()});function bi(o,e){return e?yi(o,e):M(o)}var Pi=l(()=>{vi();J()});function B(o,e){return w(function(t,r){var i=0;t.subscribe(L(r,function(n){r.next(o.call(e,n,i++))}))})}var rt=l(()=>{$();Z()});function xi(o,e,t,r,i,n,s,a){var h=[],c=0,m=0,y=!1,u=function(){y&&!h.length&&!c&&e.complete()},f=function(d){return c<r?b(d):h.push(d)},b=function(d){n&&e.next(d),c++;var O=!1;M(t(d,m++)).subscribe(L(e,function(D){i==null||i(D),n?f(D):e.next(D)},function(){O=!0},void 0,function(){if(O)try{c--;for(var D=function(){var H=h.shift();s?I(e,s,function(){return b(H)}):b(H)};h.length&&c<r;)D();u()}catch(H){e.error(H)}}))};return o.subscribe(L(e,f,function(){y=!0,u()})),function(){a==null||a()}}var Ti=l(()=>{J();Pe();Z()});function qt(o,e,t){return t===void 0&&(t=1/0),g(e)?qt(function(r,i){return B(function(n,s){return e(r,n,i,s)})(M(o(r,i)))},t):(typeof e=="number"&&(t=e),w(function(r,i){return xi(r,i,o,t)}))}var Ci=l(()=>{rt();J();$();Ti();_()});function Si(o){return o===void 0&&(o=1/0),qt(Be,o)}var wi=l(()=>{Ci();Mt()});function Di(o){return o.length===1&&Co(o[0])?o[0]:o}var Co,Oi=l(()=>{Co=Array.isArray});function A(o,e){return w(function(t,r){var i=0;t.subscribe(L(r,function(n){return o.call(e,n,i++)&&r.next(n)}))})}var Yt=l(()=>{$();Z()});var Ei=l(()=>{});function F(o){return o<=0?function(){return Zr}:w(function(e,t){var r=0;e.subscribe(L(t,function(i){++r<=o&&(t.next(i),o<=r&&t.complete())}))})}var Xt=l(()=>{Jr();$();Z()});function _i(){for(var o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];var t=ii(o),r=oi(o,1/0);return o=Di(o),w(function(i,n){Si(r)(bi(W([i],V(o)),t)).subscribe(n)})}var Li=l(()=>{U();$();Oi();wi();ni();Pi()});function Kt(){for(var o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];return _i.apply(void 0,W([],V(o)))}var Ai=l(()=>{U();Li()});function C(o){return w(function(e,t){M(o).subscribe(L(t,function(){return t.complete()},ve)),!t.closed&&e.subscribe(t)})}var Qt=l(()=>{$();Z();J();Et()});var ee=l(()=>{Qr();Gt();Ei();Yt();rt();Xt();Qt()});var ce,it,Zt=l(()=>{de();R();R();ee();E();ce=1e3,it=class{constructor(e,t){this.id=e;this.movementDirection="none";this._tilePos={position:new p(0,0),layer:void 0};this.movementStarted$=new v;this.movementStopped$=new v;this.directionChanged$=new v;this.positionChangeStarted$=new v;this.positionChangeFinished$=new v;this.tilePositionSet$=new v;this.autoMovementSet$=new v;this.lastMovementImpulse="none";this.facingDirection="down";this.depthChanged$=new v;this.movementProgress=0;var r,i;this.tilemap=t.tilemap,this.speed=t.speed,this.collidesWithTilesInternal=t.collidesWithTiles,this._tilePos.layer=t.charLayer,this.collisionGroups=new Set(t.collisionGroups||[]),this.labels=new Set(t.labels||[]),this.numberOfDirections=t.numberOfDirections,t.facingDirection&&this.turnTowards(t.facingDirection),this.tileWidth=(r=t.tileWidth)!=null?r:1,this.tileHeight=(i=t.tileHeight)!=null?i:1}getId(){return this.id}getSpeed(){return this.speed}setSpeed(e){this.speed=e}setMovement(e){this.autoMovementSet$.next(e),this.movement=e}getMovement(){return this.movement}collidesWithTiles(){return this.collidesWithTilesInternal}setTilePosition(e){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.tilePositionSet$.next(N({},e)),this.fire(this.positionChangeStarted$,this.tilePos,e),this.fire(this.positionChangeFinished$,this.tilePos,e),this.movementDirection="none",this.lastMovementImpulse="none",this.tilePos=e,this.movementProgress=0}getTilePos(){return this.tilePos}getNextTilePos(){if(!this.isMoving())return this.tilePos;let e=this.tilePos.layer,t=this.tilePosInDirection(this.tilePos.position,this.movementDirection),r=this.tilemap.getTransition(t,this.tilePos.layer);return r&&(e=r),{position:this.tilePosInDirection(this.tilePos.position,this.movementDirection),layer:e}}getTileWidth(){return this.tileWidth}getTileHeight(){return this.tileHeight}move(e){this.lastMovementImpulse=e,e!="none"&&(this.isMoving()||(this.isBlockingDirection(e)?this.changeFacingDirection(e):this.startMoving(e)))}update(e){var t;(t=this.movement)==null||t.update(e),this.isMoving()&&this.updateCharacterPosition(e),this.lastMovementImpulse="none"}getMovementDirection(){return this.movementDirection}isBlockingDirection(e){if(e=="none")return!1;let t=this.tilePosInDirection(this.getNextTilePos().position,e),r=this.tilemap.getTransition(t,this.getNextTilePos().layer)||this.getNextTilePos().layer;return this.collidesWithTilesInternal&&this.isTileBlocking(e,r)?!0:this.isCharBlocking(e,r)}isTileBlocking(e,t){return this.someCharTile((r,i)=>{let n=this.tilePosInDirection(new p(r,i),e);return this.tilemap.hasBlockingTile(n,t,Oe(e))})}isCharBlocking(e,t){return this.someCharTile((r,i)=>{let n=this.tilePosInDirection(new p(r,i),e);return this.tilemap.hasBlockingChar(n,t,this.getCollisionGroups(),new Set([this.getId()]))})}isMoving(){return this.movementDirection!="none"}turnTowards(e){this.isMoving()||e!="none"&&this.changeFacingDirection(e)}changeFacingDirection(e){this.facingDirection!==e&&(this.facingDirection=e,this.directionChanged$.next(e))}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.position.add(j(this.facingDirection))}addCollisionGroup(e){this.collisionGroups.add(e)}setCollisionGroups(e){this.collisionGroups=new Set(e)}getCollisionGroups(){return Array.from(this.collisionGroups)}hasCollisionGroup(e){return this.collisionGroups.has(e)}removeCollisionGroup(e){this.collisionGroups.delete(e)}removeAllCollisionGroups(){this.collisionGroups.clear()}addLabels(e){for(let t of e)this.labels.add(t)}getLabels(){return[...this.labels.values()]}hasLabel(e){return this.labels.has(e)}clearLabels(){this.labels.clear()}removeLabels(e){for(let t of e)this.labels.delete(t)}getNumberOfDirections(){return this.numberOfDirections}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}tilePositionSet(){return this.tilePositionSet$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}depthChanged(){return this.depthChanged$}getMovementProgress(){return this.movementProgress}hasWalkedHalfATile(){return this.movementProgress>ce/2}updateCharacterPosition(e){let r=e/1e3,i=Math.floor(r*this.speed*ce),n=ce-this.movementProgress<=i&&this.movementProgress<ce,a=1-(n?ce-this.movementProgress:i)/i;this.movementProgress=Math.min(this.movementProgress+i,ce),n&&(this.movementProgress=0,this.shouldContinueMoving()&&a>0?(this.fire(this.positionChangeFinished$,this.tilePos,this.getNextTilePos()),this.tilePos=this.getNextTilePos(),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(e*a)):this.stopMoving())}get tilePos(){return P.clone(this._tilePos)}set tilePos(e){P.copyOver(e,this._tilePos)}startMoving(e){e!=="none"&&(e!=this.movementDirection&&this.movementStarted$.next(e),this.movementDirection=e,this.facingDirection=e,this.fire(this.positionChangeStarted$,this.tilePos,this.getNextTilePos()))}tilePosInDirection(e,t){return e.add(j(this.tilemap.toMapDirection(t)))}shouldContinueMoving(){return this.lastMovementImpulse!=="none"&&!this.isBlockingDirection(this.lastMovementImpulse)}stopMoving(){if(this.movementDirection==="none")return;let e=this.tilePos,t=this.getNextTilePos(),r=this.movementDirection;this.tilePos=this.getNextTilePos(),this.movementDirection="none",this.movementStopped$.next(r),this.fire(this.positionChangeFinished$,e,t)}fire(e,{position:t,layer:r},{position:i,layer:n}){e.next({exitTile:t,enterTile:i,exitLayer:r,enterLayer:n})}someCharTile(e){let t=this.getNextTilePos().position;for(let r=t.x;r<t.x+this.getTileWidth();r++)for(let i=t.y;i<t.y+this.getTileHeight();i++)if(e(r,i))return!0;return!1}}});var xe,re,Jt=l(()=>{R();ee();xe=class{constructor(e,t){this.walkingAnimationMapping=e;this.charsInRow=t;this.lastFootLeft=!1;this.directionToFrameRow={["down"]:0,["down-left"]:1,["down-right"]:2,["left"]:1,["right"]:2,["up"]:3,["up-left"]:1,["up-right"]:2};this._isEnabled=!0;this.frameChange$=new v;this.setWalkingAnimationMapping(e)}frameChange(){return this.frameChange$}setIsEnabled(e){this._isEnabled=e}isEnabled(){return this._isEnabled}updateCharacterFrame(e,t,r){this._isEnabled&&(t?this.setStandingFrameDuringWalk(e,r):this.setWalkingFrame(e))}setStandingFrame(e){this._isEnabled&&this._setStandingFrame(e)}setWalkingAnimationMapping(e){this.walkingAnimationMapping=e,this._isEnabled=this.walkingAnimationMapping!==void 0}getWalkingAnimationMapping(){return this.walkingAnimationMapping}getCharsInRow(){return this.charsInRow}setStandingFrameDuringWalk(e,t){this.isCurrentFrameStanding(e,t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(e)}setWalkingFrame(e){let t=this.framesOfDirection(e);t&&this.frameChange$.next(this.lastFootLeft?t.rightFoot:t.leftFoot)}_setStandingFrame(e){let t=this.framesOfDirection(e);t&&this.frameChange$.next(t.standing)}isCurrentFrameStanding(e,t){var r;return t===((r=this.framesOfDirection(e))==null?void 0:r.standing)}framesOfDirection(e){return typeof this.walkingAnimationMapping=="number"?this.getFramesForCharIndex(e,this.walkingAnimationMapping):this.getFramesForAnimationMapping(e)}getFramesForAnimationMapping(e){if(!!this.walkingAnimationMapping)return this.walkingAnimationMapping[e]||this.walkingAnimationMapping[this.fallbackDirection(e)]}fallbackDirection(e){switch(e){case"down-left":return"left";case"down-right":return"right";case"up-left":return"left";case"up-right":return"right"}return e}getFramesForCharIndex(e,t){var c;let r=Math.floor(t/this.charsInRow),i=t%this.charsInRow,n=this.charsInRow*xe.FRAMES_CHAR_ROW,s=xe.FRAMES_CHAR_ROW*i,a=((c=this.directionToFrameRow[e])!=null?c:0)+r*xe.FRAMES_CHAR_COL,h=s+a*n;return{rightFoot:h,standing:h+1,leftFoot:h+2}}},re=xe;re.FRAMES_CHAR_ROW=3,re.FRAMES_CHAR_COL=4});var le,er=l(()=>{le=class{static shiftPad(e,t){let r=Math.floor(e),n=`${r}`.padStart(t,"0").length;return r/Math.pow(10,n)}}});var Te=l(()=>{Yt();rt();Ai();Xt();Qt()});var S,Ce=l(()=>{S=class{static get(){return S.config}static set(e){S.config=e}}});var ot,Ri=l(()=>{Zt();E();Jt();er();ee();Te();R();Ce();ot=class{constructor(e,t,r,i){this.charData=e;this.scene=t;this.tilemap=r;this.layerOverlay=i;this.customOffset=new p(0,0);this.newSpriteSet$=new v;this.destroy$=new v;this.gridCharacter=this.createChar(this.charData,this.layerOverlay)}destroy(){this.destroy$.next(),this.destroy$.complete(),this.newSpriteSet$.complete()}getGridCharacter(){return this.gridCharacter}setSprite(e){e?(this.sprite&&(e.x=this.sprite.x,e.y=this.sprite.y),this.sprite=e,this.newSpriteSet$.next(),this.layerOverlaySprite=this.layerOverlaySprite?this.scene.add.sprite(0,0,this.sprite.texture):void 0,this.updateOverlaySprite(),this.resetAnimation(this.gridCharacter,this.sprite),this.updateDepth(this.gridCharacter)):(this.layerOverlaySprite=void 0,this.sprite=void 0)}getSprite(){return this.sprite}getLayerOverlaySprite(){return this.layerOverlaySprite}setContainer(e){this.container=e}getContainer(){return this.container}getOffsetX(){return this.customOffset.x}getOffsetY(){return this.customOffset.y}getWalkingAnimationMapping(){return this.walkingAnimationMapping}turnTowards(e){var t;this.gridCharacter.isMoving()||e!="none"&&(this.gridCharacter.turnTowards(e),(t=this.animation)==null||t.setStandingFrame(e))}getAnimation(){return this.animation}setAnimation(e){this.animation=e}update(e){this.gridCharacter.update(e),this.updateGridChar(this.gridCharacter)}getEngineOffset(){var r,i,n,s;if(!this.sprite)return p.ZERO;let e=this.tilemap.getTileWidth()/2-Math.floor(((i=(r=this.sprite)==null?void 0:r.displayWidth)!=null?i:0)/2),t=-((s=(n=this.sprite)==null?void 0:n.displayHeight)!=null?s:0)+this.tilemap.getTileHeight();return new p(e,t)}updatePixelPos(e){let t=e.getTilePos().position.clone(),r=e.getMovementProgress()/1e3,n=this.tilemap.tilePosToPixelPos(t).add(this.getEngineOffset()).add(this.customOffset).add(j(e.getMovementDirection()).multiply(this.tilemap.getTileDistance(e.getMovementDirection()).scalarMult(r))),s=this.getGameObj();s&&(s.x=n.x,s.y=n.y)}getGameObj(){return this.container||this.sprite}createChar(e,t){var n;this.layerOverlaySprite=t&&e.sprite?this.scene.add.sprite(0,0,e.sprite.texture):void 0,this.walkingAnimationMapping=e.walkingAnimationMapping;let r={speed:e.speed||4,tilemap:this.tilemap,collidesWithTiles:!0,collisionGroups:["geDefault"],charLayer:e.charLayer,facingDirection:e.facingDirection,labels:e.labels,numberOfDirections:(n=e.numberOfDirections)!=null?n:S.get().numberOfDirections,tileWidth:e.tileWidth,tileHeight:e.tileHeight};this.customOffset=new p(e.offsetX||0,e.offsetY||0),typeof e.collides=="boolean"?e.collides===!1&&(r.collidesWithTiles=!1,r.collisionGroups=[]):e.collides!==void 0&&(e.collides.collidesWithTiles===!1&&(r.collidesWithTiles=!1),e.collides.collisionGroups&&(r.collisionGroups=e.collides.collisionGroups)),this.sprite=e.sprite,this.container=e.container;let i=new it(e.id,r);return i.directionChanged().subscribe(s=>{var a;(a=this.animation)==null||a.setStandingFrame(s)}),this.sprite&&(this.sprite.setOrigin(0,0),this.resetAnimation(i,this.sprite),this.updateOverlaySprite(),e.startPosition&&(i.setTilePosition({position:new p(e.startPosition),layer:i.getTilePos().layer}),this.updateGridChar(i))),i}updateGridChar(e){var t;this.updatePixelPos(e),this.sprite&&e.isMoving()&&((t=this.getAnimation())==null||t.updateCharacterFrame(e.getMovementDirection(),e.hasWalkedHalfATile(),Number(this.sprite.frame.name))),this.updateDepth(e)}resetAnimation(e,t){let r=new re(this.walkingAnimationMapping,t.texture.source[0].width/t.width/re.FRAMES_CHAR_ROW);this.setAnimation(r),r.frameChange().pipe(C(this.newSpriteSet$)).subscribe(i=>{t==null||t.setFrame(i)}),r.setIsEnabled(this.walkingAnimationMapping!==void 0),r.setStandingFrame(e.getFacingDirection())}updateOverlaySprite(){if(!this.layerOverlaySprite||!this.sprite)return;this.layerOverlaySprite.scale=this.sprite.scale;let e=this.tilemap.getTileHeight()/this.layerOverlaySprite.scale;this.layerOverlaySprite.setCrop(0,0,this.layerOverlaySprite.displayWidth,this.sprite.height-e),this.layerOverlaySprite.setOrigin(0,0)}updateDepth(e){let t=this.getGameObj();if(!t)return;this.setDepth(t,e.getNextTilePos());let r=this.getLayerOverlaySprite();if(r){let i=new p(ie(N({},e.getNextTilePos().position),{y:e.getNextTilePos().position.y-1}));this.setDepth(r,{position:i,layer:e.getNextTilePos().layer})}}setDepth(e,t){e.setDepth(this.tilemap.getDepthOfCharLayer(this.getTransitionLayer(t))+this.getPaddedPixelDepth(e))}getPaddedPixelDepth(e){return le.shiftPad(e.y+e.displayHeight,7)}getTransitionLayer(e){return this.tilemap.getTransition(e.position,e.layer)||e.layer}}});var tr=l(()=>{});var Se,nt=l(()=>{Se=(r=>(r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY",r))(Se||{})});var x,pe=l(()=>{E();x=class{static vec2str(e){return`${e.x}#${e.y}`}static equal(e,t){return x.vec2str(e)==x.vec2str(t)}static manhattanDistance(e,t){let r=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return r+i}static chebyshevDistance(e,t){let r=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.max(r,i)}static scalarMult(e,t){return e.clone().multiply(new p(t,t))}}});var st,Mi=l(()=>{pe();R();E();st=class{distance(e,t){return x.manhattanDistance(e,t)}direction(e,t){if(x.equal(e,t))return"none";let r=e.clone().subtract(t);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?"left":"right":r.y>0?"up":"down"}neighbors(e){return[new p(e.x,e.y+1),new p(e.x+1,e.y),new p(e.x-1,e.y),new p(e.x,e.y-1)]}getDirections(){return["up","right","down","left"]}}});var at,Ii=l(()=>{pe();R();E();at=class{distance(e,t){return x.chebyshevDistance(e,t)}neighbors(e){let t=[new p(e.x,e.y+1),new p(e.x+1,e.y),new p(e.x-1,e.y),new p(e.x,e.y-1)],r=[new p(e.x+1,e.y+1),new p(e.x+1,e.y-1),new p(e.x-1,e.y+1),new p(e.x-1,e.y-1)];return[...t,...r]}direction(e,t){return t.x>e.x?t.y>e.y?"down-right":t.y<e.y?"up-right":"right":t.x<e.x?t.y>e.y?"down-left":t.y<e.y?"up-left":"left":t.y<e.y?"up":t.y>e.y?"down":"none"}getDirections(){return["up","right","down","left","down-left","down-right","up-right","up-left"]}}});var z,ht=l(()=>{Mi();R();Ii();z=class{static create(e){switch(e){case 4:return new st;case 8:return new at}}}});var we,Gi=l(()=>{we=class{constructor(e,t,r){this.backoffMs=e;this.maxRetries=t;this.onFinished=r;this.retries=0;this.elapsed=0}retry(e,t){this.shouldRetry()?(this.elapsed+=e,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,t())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}getBackoffMs(){return this.backoffMs}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}}});var ct,rr=l(()=>{ct=(r=>(r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP",r))(ct||{})});var lt,ue,ir=l(()=>{lt=class{constructor(e){this.data=e}},ue=class{constructor(){this.sizeInternal=0}dequeue(){if(this.tail===void 0)return;this.sizeInternal--;let e=this.tail.data;return this.tail.prev===void 0?(this.tail=void 0,this.head=void 0,e):(this.tail.prev.next=void 0,this.tail=this.tail.prev,e)}enqueue(e){if(this.sizeInternal++,this.head===void 0){this.head=new lt(e),this.tail=this.head;return}let t=new lt(e);t.next=this.head,this.head.prev=t,this.head=t}peek(){return this.tail?this.tail.data:void 0}size(){return this.sizeInternal}}});var pt,Ni=l(()=>{pe();ir();pt=class{getShortestPath(e,t,r){let i=this.shortestPathBfs(e,t,r);return{path:this.returnPath(i.previous,e,t),closestToTarget:i.closestToTarget,steps:i.steps}}distance(e,t){return x.manhattanDistance(e.position,t.position)}pos2Str(e){return`${e.position.toString()}#${e.layer}`}equal(e,t){return x.equal(e.position,t.position)?e.layer===t.layer:!1}shortestPathBfs(e,t,r){let i=new Map,n=new Set,s=new ue,a=e,h=this.distance(e,t),c=0;for(s.enqueue({node:e,dist:0}),n.add(this.pos2Str(e));s.size()>0;){let m=s.dequeue();if(c++,!m)break;let{node:y,dist:u}=m,f=this.distance(y,t);if(f<h&&(h=f,a=y),this.equal(y,t))return{shortestDistance:u,previous:i,closestToTarget:a,steps:c};for(let b of r(y))n.has(this.pos2Str(b))||(i.set(this.pos2Str(b),y),s.enqueue({node:b,dist:u+1}),n.add(this.pos2Str(b)))}return{shortestDistance:-1,previous:i,closestToTarget:a,steps:c}}returnPath(e,t,r){let i=[],n=r;for(i.push(n);!this.equal(n,t);){if(n=e.get(this.pos2Str(n)),!n)return[];i.push(n)}return i.reverse()}}});var ut,mt,ki=l(()=>{de();pe();ir();ut=class{constructor(){this.previous=new Map;this.visited=new Map;this.queue=new ue}step(e,t,r){for(let i of e)this.visited.has(P.toString(i))||(this.previous.set(P.toString(i),t),this.queue.enqueue({node:i,dist:r+1}),this.visited.set(P.toString(i),r+1))}},mt=class{getShortestPath(e,t,r,i){let n=this.shortestPathBfs(e,t,r,i);return{path:this.returnPath(n.previous,n.previous2,n.matchingPos,e,t),closestToTarget:n.closestToTarget,steps:n.steps}}distance(e,t){return x.manhattanDistance(e.position,t.position)}equal(e,t){return x.equal(e.position,t.position)?e.layer===t.layer:!1}shortestPathBfs(e,t,r,i){var m,y;let n=new ut,s=new ut,a=0;n.otherBfs=s,s.otherBfs=n;let h=e,c=this.distance(e,t);for(n.queue.enqueue({node:e,dist:0}),s.queue.enqueue({node:t,dist:0}),n.visited.set(P.toString(e),0),s.visited.set(P.toString(t),0);n.queue.size()>0||s.queue.size()>0;){let u=n.queue.dequeue();if(!u)break;let{node:f,dist:b}=u,d=this.distance(f,t);if(d<c&&(c=d,h=f),s.visited.has(P.toString(f)))return{shortestDistance:b+((m=s.visited.get(P.toString(f)))!=null?m:0),previous:n.previous,previous2:s.previous,closestToTarget:t,matchingPos:f,steps:a};a++,n.step(r(f),f,b);let O=s.queue.dequeue();if(!O)continue;let{node:D,dist:H}=O;if(n.visited.has(P.toString(D)))return{shortestDistance:H+((y=n.visited.get(P.toString(D)))!=null?y:0),previous:n.previous,previous2:s.previous,closestToTarget:t,matchingPos:D,steps:a};a++,s.step(i(D),D,H)}return{shortestDistance:-1,previous:n.previous,previous2:s.previous,closestToTarget:h,steps:a}}returnPath(e,t,r,i,n){if(r){let s=this.getPathFromPrev(e,i,r).reverse(),a=this.getPathFromPrev(t,n,r);return s.pop(),[...s,...a]}else return this.getPathFromPrev(e,i,n).reverse()}getPathFromPrev(e,t,r){let i=[],n=r;for(i.push(n);!this.equal(n,t);){if(n=e.get(P.toString(n)),!n)return[];i.push(n)}return i}}});function Vi(o){switch(o){case"BIDIRECTIONAL_SEARCH":return new mt}return new pt}var or=l(()=>{Ni();ki()});function So(o,e,t){var n;let r=z.create((n=o.numberOfDirections)!=null?n:4);return s=>r.neighbors(s.position).map(c=>{let m=t.getTransition(c,s.layer);return{position:c,layer:m||s.layer}}).filter(c=>!ft(s,c,t,o)||o.ignoreBlockedTarget&&P.equal(c,e))}function wo(o,e,t){var n;let r=z.create((n=o.numberOfDirections)!=null?n:4);return s=>{let a=r.neighbors(s.position),h=t.getTransitions(),c=[...h.keys()].filter(u=>u===s.position.toString()).map(u=>h.get(u)).map(u=>u?[...u.keys()].filter(f=>u.get(f)===s.layer):[]).flat(),m=t.getTransition(s.position,s.layer);return m&&m!==s.layer||c.push(s.layer),a.map(u=>c.map(f=>({position:u,layer:f||s.layer}))).flat().filter(u=>!ft(u,s,t,o)||o.ignoreBlockedTarget&&P.equal(s,e))}}function ft(o,e,t,r){let i=r.isPositionAllowed(e.position,e.layer),n=!r.ignoreTiles&&Oo(o,e,r.pathWidth,r.pathHeight,r.ignoreMapBounds,t),s=r.ignoreMapBounds||t.isInRange(e.position);return Do(e,r.pathWidth,r.pathHeight,r.collisionGroups,r.ignoredChars,t)||n||!s||!i}function Do(o,e,t,r,i,n){for(let s=o.position.x;s<o.position.x+e;s++)for(let a=o.position.y;a<o.position.y+t;a++)if(n.hasBlockingChar(new p(s,a),o.layer,r,new Set(i)))return!0;return!1}function Oo(o,e,t,r,i,n){for(let s=e.position.x;s<e.position.x+t;s++)for(let a=e.position.y;a<e.position.y+r;a++)if(n.hasBlockingTile(new p(s,a),e.layer,Oe(mr(o.position,e.position)),i))return!0;return!1}var me,nr=l(()=>{R();ht();de();E();or();me=class{constructor(e,t){this.shortestPathAlgorithm=e;this.gridTilemap=t}findShortestPath(e,t,{shortestPathAlgorithm:r,pathWidth:i=1,pathHeight:n=1,numberOfDirections:s=4,isPositionAllowed:a=(f,b)=>!0,collisionGroups:h=[],ignoredChars:c=[],ignoreTiles:m=!1,ignoreMapBounds:y=!1,ignoreBlockedTarget:u=!1}={}){let f=Vi(r!=null?r:this.shortestPathAlgorithm),b={shortestPathAlgorithm:r||this.shortestPathAlgorithm,pathWidth:i,pathHeight:n,numberOfDirections:s,isPositionAllowed:a,collisionGroups:h,ignoredChars:c,ignoreTiles:m,ignoreMapBounds:y,ignoreBlockedTarget:u},d=So(b,t,this.gridTilemap),O=wo(b,t,this.gridTilemap);return f.getShortestPath(e,t,d,O)}}});var fe,sr=l(()=>{nt();ht();Gi();rr();ee();nr();fe=class{constructor(e,t,r,{config:i,ignoreBlockedTarget:n=!1,distance:s=0}={}){this.character=e;this.tilemap=t;this.targetPos=r;this.shortestPath=[];this.distOffset=0;this.posOnPath=0;this.stopped=!1;this.pathBlockedWaitElapsed=0;this.isPositionAllowed=()=>!0;this.shortestPathAlgorithm="BIDIRECTIONAL_SEARCH";this.isBlocking=(e,t)=>e?ft(this.character.getTilePos(),{position:e,layer:t},this.tilemap,this.getPathfindingOptions()):!0;var a;this.shortestPathAlgorithm=(a=i==null?void 0:i.algorithm)!=null?a:this.shortestPathAlgorithm,this.ignoreBlockedTarget=n,this.distance=s,this.noPathFoundStrategy=(i==null?void 0:i.noPathFoundStrategy)||"STOP",this.pathBlockedStrategy=(i==null?void 0:i.pathBlockedStrategy)||"WAIT",this.noPathFoundRetryable=new we((i==null?void 0:i.noPathFoundRetryBackoffMs)||200,(i==null?void 0:i.noPathFoundMaxRetries)||-1,()=>{this.stop("NO_PATH_FOUND_MAX_RETRIES_EXCEEDED")}),this.pathBlockedRetryable=new we((i==null?void 0:i.pathBlockedRetryBackoffMs)||200,(i==null?void 0:i.pathBlockedMaxRetries)||-1,()=>{this.stop("PATH_BLOCKED_MAX_RETRIES_EXCEEDED")}),i!=null&&i.isPositionAllowedFn&&(this.isPositionAllowed=i.isPositionAllowedFn),this.distanceUtils=z.create(e.getNumberOfDirections()),this.pathBlockedWaitTimeoutMs=(i==null?void 0:i.pathBlockedWaitTimeoutMs)||-1,this.finished$=new v,this.setCharacter(e)}setPathBlockedStrategy(e){this.pathBlockedStrategy=e}getPathBlockedStrategy(){return this.pathBlockedStrategy}setCharacter(e){this.character=e,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(F(1),A(t=>t!==this)).subscribe(()=>{this.stop("MOVEMENT_TERMINATED")})}getPathfindingOptions(){return{shortestPathAlgorithm:this.shortestPathAlgorithm,pathWidth:this.character.getTileWidth(),pathHeight:this.character.getTileHeight(),numberOfDirections:this.character.getNumberOfDirections(),isPositionAllowed:this.isPositionAllowed,collisionGroups:this.character.getCollisionGroups(),ignoredChars:[this.character.getId()],ignoreTiles:!this.character.collidesWithTiles(),ignoreMapBounds:!1,ignoreBlockedTarget:this.ignoreBlockedTarget}}update(e){var t,r,i,n;this.stopped||(this.noPathFound()&&(this.noPathFoundStrategy==="RETRY"?this.noPathFoundRetryable.retry(e,()=>this.calcShortestPath()):this.noPathFoundStrategy==="STOP"&&this.stop("NO_PATH_FOUND")),this.updatePosOnPath(),this.isBlocking((t=this.nextTileOnPath())==null?void 0:t.position,(r=this.character)==null?void 0:r.getNextTilePos().layer)?this.applyPathBlockedStrategy(e):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop("SUCCESS"),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking((i=this.nextTileOnPath())==null?void 0:i.position,(n=this.character)==null?void 0:n.getNextTilePos().layer)||this.moveCharOnPath())}finishedObs(){return this.finished$}getInfo(){return{type:"Target",config:{algorithm:this.shortestPathAlgorithm,ignoreBlockedTarget:this.ignoreBlockedTarget,distance:this.distance,targetPos:this.targetPos,noPathFoundStrategy:this.noPathFoundStrategy,pathBlockedStrategy:this.pathBlockedStrategy,noPathFoundRetryBackoffMs:this.noPathFoundRetryable.getBackoffMs(),noPathFoundMaxRetries:this.noPathFoundRetryable.getMaxRetries()}}}resultToReason(e){switch(e){case"SUCCESS":return"Successfully arrived.";case"MOVEMENT_TERMINATED":return"Movement of character has been replaced before destination was reached.";case"PATH_BLOCKED":return"PathBlockedStrategy STOP: Path blocked.";case"NO_PATH_FOUND_MAX_RETRIES_EXCEEDED":return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case"NO_PATH_FOUND":return"NoPathFoundStrategy STOP: No path found.";case"PATH_BLOCKED_MAX_RETRIES_EXCEEDED":return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case"PATH_BLOCKED_WAIT_TIMEOUT":return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`}}applyPathBlockedStrategy(e){this.pathBlockedStrategy==="RETRY"?this.pathBlockedRetryable.retry(e,()=>{let t=this.getShortestPath();t.path.length>0&&this.calcShortestPath(t)}):this.pathBlockedStrategy==="STOP"?this.stop("PATH_BLOCKED"):this.pathBlockedStrategy==="WAIT"&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=e,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop("PATH_BLOCKED_WAIT_TIMEOUT"))}moveCharOnPath(){let e=this.nextTileOnPath();if(!e)return;let t=this.getDir(this.character.getNextTilePos().position,e.position);this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(e){this.finished$.next({position:this.character.getTilePos().position,result:e,description:this.resultToReason(e),layer:this.character.getTilePos().layer}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let e=this.shortestPath[this.posOnPath+1],t=this.getDir(this.character.getNextTilePos().position,e.position);this.character.turnTowards(t)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let e=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().position.x!=e.position.x||this.character.getNextTilePos().position.y!=e.position.y);)this.posOnPath++,e=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(e){e=e!=null?e:this.getShortestPath(),this.posOnPath=0,this.shortestPath=e.path,this.distOffset=e.distOffset}getShortestPath(){let e=new me(this.shortestPathAlgorithm,this.tilemap),{path:t,closestToTarget:r}=e.findShortestPath(this.character.getNextTilePos(),this.targetPos,this.getPathfindingOptions());if(t.length==0&&this.noPathFoundStrategy==="CLOSEST_REACHABLE"){let n=e.findShortestPath(this.character.getNextTilePos(),r,this.getPathfindingOptions()).path,s=this.distanceUtils.distance(r.position,this.targetPos.position);return{path:n,distOffset:s}}return{path:t,distOffset:0}}getDir(e,t){return this.tilemap.fromMapDirection(this.distanceUtils.direction(e,t))}}});var dt,Wi=l(()=>{Te();sr();E();nt();dt=class{constructor(e,t,r,i=0,n="STOP"){this.character=e;this.gridTilemap=t;this.charToFollow=r;this.distance=i;this.noPathFoundStrategy=n;this.character=e,this.updateTarget(this.charToFollow.getTilePos().position,this.charToFollow.getTilePos().layer),this.charToFollow.positionChangeStarted().pipe(C(this.character.autoMovementSet().pipe(F(1),A(s=>s!==this)))).subscribe(({enterTile:s,enterLayer:a})=>{this.updateTarget(s,a)})}update(e){var t;(t=this.targetMovement)==null||t.update(e)}getInfo(){return{type:"Follow",config:{charToFollow:this.charToFollow.getId(),distance:this.distance,noPathFoundStrategy:this.noPathFoundStrategy}}}updateTarget(e,t){this.targetMovement=new fe(this.character,this.gridTilemap,{position:new p(e),layer:t},{distance:this.distance+1,config:{noPathFoundStrategy:this.noPathFoundStrategy},ignoreBlockedTarget:!0})}}});var gt,Ui=l(()=>{Ce();ee();E();tr();gt=class{constructor(){this.tilePosToCharacters=new Map;this.charRemoved$=new v}isCharBlockingAt(e,t,r,i=new Set){let n=this.posToString(e,t),s=this.tilePosToCharacters.get(n);return!!(s&&s.size>0&&[...s].filter(a=>!i.has(a.getId())).some(a=>a.getCollisionGroups().some(h=>r.includes(h))))}getCharactersAt(e,t){let r=this.posToString(e,t),i=this.tilePosToCharacters.get(r);return new Set(i)}addCharacter(e){this.addTilePositions(e.getTilePos(),e),this.addTilePositions(e.getNextTilePos(),e),this.addPositionChangeSub(e),this.addPositionChangeFinishedSub(e),this.addTilePosSetSub(e)}removeCharacter(e){let t=e.getId();this.charRemoved$.next(t),this.deleteTilePositions(e.getTilePos(),e),this.deleteTilePositions(e.getNextTilePos(),e)}add(e,t){var r;this.tilePosToCharacters.has(e)||this.tilePosToCharacters.set(e,new Set),(r=this.tilePosToCharacters.get(e))==null||r.add(t)}addTilePosSetSub(e){e.tilePositionSet().pipe(C(this.charRemoved(e.getId()))).subscribe(t=>{this.deleteTilePositions(e.getNextTilePos(),e),this.addTilePositions(t,e)})}charRemoved(e){var t;return(t=this.charRemoved$)==null?void 0:t.pipe(F(1),A(r=>r==e))}addPositionChangeSub(e){e.positionChangeStarted().pipe(C(this.charRemoved(e.getId())),this.posChangeToLayerPos()).subscribe(t=>{S.get().characterCollisionStrategy==="BLOCK_ONE_TILE_AHEAD"&&this.deleteTilePositions(t.exit,e),this.addTilePositions(t.enter,e)})}addPositionChangeFinishedSub(e){e.positionChangeFinished().pipe(C(this.charRemoved(e.getId())),this.posChangeToLayerPos()).subscribe(t=>{this.deleteTilePositions(t.exit,e),this.addTilePositions(t.enter,e)})}addTilePositions(e,t){this.forEachCharTile(e,t,(r,i)=>{this.add(this.posToString(new p(r,i),e.layer),t)})}deleteTilePositions(e,t){this.forEachCharTile(e,t,(r,i)=>{var n;(n=this.tilePosToCharacters.get(this.posToString(new p(r,i),e.layer)))==null||n.delete(t)})}forEachCharTile(e,t,r){let i=e.position;for(let n=i.x;n<i.x+t.getTileWidth();n++)for(let s=i.y;s<i.y+t.getTileHeight();s++)r(n,s)}posChangeToLayerPos(){return It(B(e=>({enter:{position:new p(e.enterTile),layer:e.enterLayer},exit:{position:new p(e.exitTile),layer:e.exitLayer}})))}posToString(e,t){return`${e.x}#${e.y}#${t}`}}});var yt,Bi=l(()=>{yt=class{constructor(e,t,r,i){this.x=e;this.y=t;this.width=r;this.height=i}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}isInRange(e){return e.x>=this.x&&e.x<this.x+this.width&&e.y>=this.y&&e.y<this.y+this.height}}});var G,q,Hi=l(()=>{Ce();R();E();Ui();Bi();pe();er();G=class{constructor(e){this.tilemap=e;this.characters=new Map;this.charBlockCache=new gt;this.charLayerDepths=new Map;this.transitions=new Map;this.setLayerDepths()}addCharacter(e){this.characters.set(e.getId(),e),e.getNextTilePos().layer===void 0&&e.setTilePosition(ie(N({},e.getNextTilePos()),{layer:this.getLowestCharLayer()})),this.charBlockCache.addCharacter(e)}removeCharacter(e){let t=this.characters.get(e);!t||(this.charBlockCache.removeCharacter(t),this.characters.delete(e))}getCharacters(){return[...this.characters.values()]}getCharactersAt(e,t){return this.charBlockCache.getCharactersAt(e,t)}hasBlockingTile(e,t,r,i){return!i&&this.hasNoTile(e,t)?!0:this.getCollisionRelevantLayers(t).some(n=>this.isLayerBlockingAt(n,e,r))}getTransition(e,t){let r=this.transitions.get(e.toString());if(r)return r.get(t)}setTransition(e,t,r){var i;this.transitions.has(e.toString())||this.transitions.set(e.toString(),new Map),(i=this.transitions.get(e.toString()))==null||i.set(t,r)}getTransitions(){return new Map([...this.transitions].map(([e,t])=>[e,new Map(t)]))}hasNoTile(e,t){return!this.getCollisionRelevantLayers(t).some(r=>this.tilemap.hasTileAt(e.x,e.y,r.name))}hasBlockingChar(e,t,r,i=new Set){return this.charBlockCache.isCharBlockingAt(e,t,r,i)}getTileWidth(){let e=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*e}getTileHeight(){let e=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*e}getDepthOfCharLayer(e){var t;return(t=this.charLayerDepths.get(e))!=null?t:0}isInRange(e){return new yt(0,0,this.tilemap.width,this.tilemap.height).isInRange(e)}getTileSize(){return new p(this.getTileWidth(),this.getTileHeight())}tilePosToPixelPos(e){return this.isIsometric()?x.scalarMult(this.getTileSize(),.5).multiply(new p(e.x-e.y,e.x+e.y)):e.clone().multiply(this.getTileSize())}getTileDistance(e){if(this.isIsometric())switch(e){case"down-left":case"down-right":case"up-left":case"up-right":return x.scalarMult(this.getTileSize(),.5);default:return this.getTileSize()}return this.getTileSize()}toMapDirection(e){return this.isIsometric()?pr(e):e}fromMapDirection(e){return this.isIsometric()?ur(e):e}isIsometric(){return this.tilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()}getTilePosInDirection(e,t){let r=e.position.add(j(this.toMapDirection(t))),i=this.getTransition(r,e.layer)||e.layer;return{position:r,layer:i}}isLayerBlockingAt(e,t,r){let i=G.ONE_WAY_COLLIDE_PROP_PREFIX+r,n=this.tilemap.getTileAt(t.x,t.y,!1,e.name);return Boolean((n==null?void 0:n.properties)&&(n.properties[S.get().collisionTilePropertyName]||n.properties[i]))}getCharLayerIndexes(){return this.tilemap.layers.map((e,t)=>({layer:e,index:t})).filter(({layer:e})=>this.isCharLayer(e)).map(({index:e})=>e)}findPrevAndCharLayer(e){let t=this.getCharLayerIndexes(),r=t.findIndex(i=>this.getLayerProp(this.tilemap.layers[i],G.CHAR_LAYER_PROP_NAME)==e);return r==0?{prevIndex:-1,charLayerIndex:t[r]}:{prevIndex:t[r-1],charLayerIndex:t[r]}}getCollisionRelevantLayers(e){if(!e)return this.tilemap.layers;let{prevIndex:t,charLayerIndex:r}=this.findPrevAndCharLayer(e);return this.tilemap.layers.slice(t+1,r+1)}getLowestCharLayer(){let e=this.tilemap.layers.find(t=>this.hasLayerProp(t,G.CHAR_LAYER_PROP_NAME));if(e)return this.getLayerProp(e,G.CHAR_LAYER_PROP_NAME)}getLayerProp(e,t){let i=e.properties.find(n=>n.name==t);return i==null?void 0:i.value}hasLayerProp(e,t){return this.getLayerProp(e,t)!=null}isLayerAlwaysOnTop(e){return this.hasLayerProp(e,G.ALWAYS_TOP_PROP_NAME)}isCharLayer(e){return this.hasLayerProp(e,G.CHAR_LAYER_PROP_NAME)}setLayerDepths(){let e=[],t=-1,r=this.tilemap.layers.filter(n=>this.isLayerAlwaysOnTop(n));this.tilemap.layers.filter(n=>!this.isLayerAlwaysOnTop(n)).forEach(n=>{this.hasLayerProp(n,G.HEIGHT_SHIFT_PROP_NAME)?(this.createHeightShiftLayers(n,t),e.push(n.tilemapLayer)):this.setDepth(n,++t)}),this.charLayerDepths.set(void 0,t),r.forEach((n,s)=>{n.tilemapLayer.setDepth(s+1+t)}),e.forEach(n=>n.destroy())}setDepth(e,t){e.tilemapLayer.setDepth(t),this.isCharLayer(e)&&this.charLayerDepths.set(this.getLayerProp(e,G.CHAR_LAYER_PROP_NAME),t)}createHeightShiftLayers(e,t){let r=this.getLayerProp(e,G.HEIGHT_SHIFT_PROP_NAME),i=1;for(let n=0;n<e.height;n++){let s=this.copyLayer(e,n);s.scale=e.tilemapLayer.scale,s.setDepth(t+le.shiftPad((n+r)*this.getTileHeight()+i,G.Z_INDEX_PADDING))}}copyLayer(e,t){let r=this.tilemap.createBlankLayer(`${e.name}#${t}`,e.tilemapLayer.tileset);for(let i=0;i<e.width;i++)r.putTileAt(e.data[t][i],i,t);return r}},q=G;q.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",q.CHAR_LAYER_PROP_NAME="ge_charLayer",q.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",q.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_",q.Z_INDEX_PADDING=7});var De,ji=l(()=>{De=class{static getRandomInt(e){return Math.floor(Math.random()*Math.floor(e))}}});var vt,$i=l(()=>{ji();ht();R();Te();E();vt=class{constructor(e,t=0,r=-1){this.character=e;this.delay=t;this.radius=r;this.stepSize=0;this.delayLeft=this.delay,this.initialRow=e.getNextTilePos().position.y,this.initialCol=e.getNextTilePos().position.x,this.randomizeStepSize(),this.stepsWalked=0,this.currentMovementDirection="none",this.character.positionChangeStarted().pipe(C(this.character.autoMovementSet().pipe(F(1),A(i=>i!==this)))).subscribe(()=>{this.stepsWalked++}),this.distanceUtils=z.create(e.getNumberOfDirections())}update(e){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=e,this.delayLeft<=0){this.delayLeft=this.delay;let t=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(t),this.currentMovementDirection=t,this.randomizeStepSize()}}getInfo(){return{type:"Random",config:{delay:this.delay,radius:this.radius}}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!=="none"&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return this.distanceUtils.getDirections().filter(t=>!this.character.isBlockingDirection(t)).filter(t=>this.isWithinRadius(t))}isWithinRadius(e){return this.radius==-1?!0:this.getDist(e)<=this.radius}getDist(e){return this.distanceUtils.distance(this.character.getNextTilePos().position.add(j(e)),new p(this.initialCol,this.initialRow))}getFreeRandomDirection(){let e=this.getFreeDirections();return e.length==0?"none":e[De.getRandomInt(e.length)]}randomizeStepSize(){this.stepSize=De.getRandomInt(this.radius)+1}}});function zi(o,e){return o.filter(t=>{var r,i,n,s,a,h;return(r=e.labels)!=null&&r.withAllLabels?(i=e.labels)==null?void 0:i.withAllLabels.every(c=>t.hasLabel(c)):(n=e.labels)!=null&&n.withOneOfLabels?(s=e.labels)==null?void 0:s.withOneOfLabels.some(c=>t.hasLabel(c)):(a=e.labels)!=null&&a.withNoneLabels?!((h=e.labels)!=null&&h.withNoneLabels.some(c=>t.hasLabel(c))):!0})}var qi=l(()=>{});var Xi,Yi=l(()=>{Xi="2.23.0"});var bt,Ki=l(()=>{Ri();Ce();tr();Wi();sr();Zt();R();Hi();$i();ee();Te();E();nt();rr();Jt();qi();Yi();nr();de();or();bt=class{constructor(e){this.scene=e;this.isCreatedInternal=!1;console.log(`Using GridEngine v${Xi}`),this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this)}getCharLayer(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.getTilePos().layer}getTransition(e,t){var r;return this.initGuard(),(r=this.gridTilemap)==null?void 0:r.getTransition(new p(e),t)}setTransition(e,t,r){var i;return this.initGuard(),(i=this.gridTilemap)==null?void 0:i.setTransition(new p(e),t,r)}create(e,t){this.isCreatedInternal=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(t);S.set(r),this.movementStopped$=new v,this.movementStarted$=new v,this.directionChanged$=new v,this.positionChangeStarted$=new v,this.positionChangeFinished$=new v,this.charRemoved$=new v,this.charAdded$=new v,this.gridTilemap=new q(e),this.addCharacters()}getPosition(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.getTilePos().position}move(e,t){this.moveChar(e,t)}moveRandomly(e,t=0,r=-1){var s,a;this.initGuard();let i=(a=(s=this.gridCharacters)==null?void 0:s.get(e))==null?void 0:a.getGridCharacter();if(!i)throw this.createCharUnknownErr(e);let n=new vt(i,t,r);i.setMovement(n)}getMovement(e){var i,n;this.initGuard();let t=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);let r=t.getMovement();return r?r.getInfo():{type:"None"}}moveTo(e,t,r){var a,h;let i=this.assembleMoveToConfig(r);this.initGuard();let n=(h=(a=this.gridCharacters)==null?void 0:a.get(e))==null?void 0:h.getGridCharacter();if(!n)throw this.createCharUnknownErr(e);if(!this.gridTilemap)throw this.createUninitializedErr();let s=new fe(n,this.gridTilemap,{position:new p(t),layer:(r==null?void 0:r.targetLayer)||n.getNextTilePos().layer},{distance:0,config:i});return n.setMovement(s),s.finishedObs().pipe(B(c=>({charId:e,position:c.position,result:c.result,description:c.description,layer:c.layer})))}stopMovement(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);t.setMovement(void 0)}setSpeed(e,t){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(e);r.setSpeed(t)}getSpeed(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.getSpeed()}getContainer(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getContainer()}getOffsetX(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getOffsetX()}getOffsetY(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getOffsetY()}collidesWithTiles(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.collidesWithTiles()}getWalkingAnimationMapping(e){var i;this.initGuard();let t=(i=this.gridCharacters)==null?void 0:i.get(e);if(!t)throw this.createCharUnknownErr(e);let r=t.getAnimation();return r==null?void 0:r.getWalkingAnimationMapping()}hasLayerOverlay(){return S.get().layerOverlay}setWalkingAnimationMapping(e,t){var n;this.initGuard();let r=(n=this.gridCharacters)==null?void 0:n.get(e);if(!r)throw this.createCharUnknownErr(e);let i=r.getAnimation();i==null||i.setWalkingAnimationMapping(t)}update(e,t){if(this.isCreatedInternal&&this.gridCharacters)for(let[r,i]of this.gridCharacters)i.update(t)}addCharacter(e){var n,s;if(this.initGuard(),!this.gridTilemap)throw this.createUninitializedErr();let t=new ot(e,this.scene,this.gridTilemap,S.get().layerOverlay),r=t.getGridCharacter();(n=this.gridCharacters)==null||n.set(e.id,t),this.gridTilemap.addCharacter(r);let i=r.getId();r.movementStopped().pipe(C(this.charRemoved(i))).subscribe(a=>{var h;(h=this.movementStopped$)==null||h.next({charId:i,direction:a})}),r.movementStarted().pipe(C(this.charRemoved(i))).subscribe(a=>{var h;(h=this.movementStarted$)==null||h.next({charId:i,direction:a})}),r.directionChanged().pipe(C(this.charRemoved(i))).subscribe(a=>{var h;(h=this.directionChanged$)==null||h.next({charId:i,direction:a})}),r.positionChangeStarted().pipe(C(this.charRemoved(i))).subscribe(a=>{var h;(h=this.positionChangeStarted$)==null||h.next(N({charId:i},a))}),r.positionChangeFinished().pipe(C(this.charRemoved(i))).subscribe(a=>{var h;(h=this.positionChangeFinished$)==null||h.next(N({charId:i},a))}),(s=this.charAdded$)==null||s.next(i)}hasCharacter(e){var t;return this.initGuard(),!!((t=this.gridCharacters)!=null&&t.has(e))}removeCharacter(e){var r,i,n,s;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);t.destroy(),(i=this.gridTilemap)==null||i.removeCharacter(e),(n=this.gridCharacters)==null||n.delete(e),(s=this.charRemoved$)==null||s.next(e)}removeAllCharacters(){if(this.initGuard(),!!this.gridCharacters)for(let e of this.gridCharacters.keys())this.removeCharacter(e)}getAllCharacters(e){if(this.initGuard(),!this.gridCharacters)return[];let t=[...this.gridCharacters.values()].map(i=>i.getGridCharacter());return(e?zi(t,e):t).map(i=>i.getId())}getLabels(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.getLabels()}addLabels(e,t){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(e);r.addLabels(t)}removeLabels(e,t){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(e);r.removeLabels(t)}clearLabels(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);t.clearLabels()}follow(e,t,r=0,i=!1){var h,c,m,y;this.initGuard();let n=(c=(h=this.gridCharacters)==null?void 0:h.get(e))==null?void 0:c.getGridCharacter(),s=(y=(m=this.gridCharacters)==null?void 0:m.get(t))==null?void 0:y.getGridCharacter();if(!n)throw this.createCharUnknownErr(e);if(!s)throw this.createCharUnknownErr(t);if(!this.gridTilemap)throw this.createUninitializedErr();let a=new dt(n,this.gridTilemap,s,r,i?"CLOSEST_REACHABLE":"STOP");n.setMovement(a)}isMoving(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.isMoving()}getFacingDirection(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.getFacingDirection()}getFacingPosition(e){var i,n;this.initGuard();let t=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);let r=t.getFacingPosition();return{x:r.x,y:r.y}}turnTowards(e,t){var i;this.initGuard();let r=(i=this.gridCharacters)==null?void 0:i.get(e);if(!r)throw this.createCharUnknownErr(e);return r.turnTowards(t)}getCharactersAt(e,t){if(this.initGuard(),!this.gridTilemap)return[];let r=this.gridTilemap.getCharactersAt(new p(e),t);return Array.from(r).map(i=>i.getId())}setPosition(e,t,r){var n,s;this.initGuard();let i=(s=(n=this.gridCharacters)==null?void 0:n.get(e))==null?void 0:s.getGridCharacter();if(!i)throw this.createCharUnknownErr(e);r||i.setTilePosition({position:new p(t),layer:i.getTilePos().layer}),i.setTilePosition({position:new p(t),layer:r})}getSprite(e){var i;this.initGuard();let t=(i=this.gridCharacters)==null?void 0:i.get(e);if(!(t==null?void 0:t.getGridCharacter()))throw this.createCharUnknownErr(e);return t==null?void 0:t.getSprite()}setSprite(e,t){var i;this.initGuard();let r=(i=this.gridCharacters)==null?void 0:i.get(e);if(!r)throw this.createCharUnknownErr(e);t.setOrigin(0,0),this.setCharSprite(t,r)}setCharSprite(e,t){t.setSprite(e)}isBlocked(e,t,r=["geDefault"]){var n,s;this.initGuard();let i=new p(e);return!!(((n=this.gridTilemap)==null?void 0:n.hasBlockingTile(i,t))||((s=this.gridTilemap)==null?void 0:s.hasBlockingChar(i,t,r)))}isTileBlocked(e,t){var r;return this.initGuard(),!!((r=this.gridTilemap)!=null&&r.hasBlockingTile(new p(e),t))}getCollisionGroups(e){var r,i;this.initGuard();let t=(i=(r=this.gridCharacters)==null?void 0:r.get(e))==null?void 0:i.getGridCharacter();if(!t)throw this.createCharUnknownErr(e);return t.getCollisionGroups()||[]}setCollisionGroups(e,t){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(e);r.setCollisionGroups(t)}getTilePosInDirection(e,t,r){if(this.initGuard(),!this.gridTilemap)throw this.createUninitializedErr();let i=this.gridTilemap.getTilePosInDirection({position:new p(e),layer:t},r);return{position:i.position.toPosition(),charLayer:i.layer}}findShortestPath(e,t,r={}){if(this.initGuard(),!this.gridTilemap)throw this.createUninitializedErr();let n=new me("BFS",this.gridTilemap).findShortestPath(P.toInternal(e),P.toInternal(t),r);return{path:n.path.map(P.fromInternal),closestToTarget:P.fromInternal(n.closestToTarget)}}steppedOn(e,t,r){return this.positionChangeFinished().pipe(A(i=>e.includes(i.charId)&&t.some(n=>n.x===i.enterTile.x&&n.y===i.enterTile.y)&&(r===void 0||r.includes(i.enterLayer))))}characterShifted(){if(!this.charAdded$||!this.charRemoved$)throw this.createUninitializedErr();return this.charAdded$.pipe(B(e=>({charId:e,action:"ADDED"})),Kt(this.charRemoved$.pipe(B(e=>({charId:e,action:"REMOVED"})))))}movementStarted(){if(!this.movementStarted$)throw this.createUninitializedErr();return this.movementStarted$}movementStopped(){if(!this.movementStopped$)throw this.createUninitializedErr();return this.movementStopped$}directionChanged(){if(!this.directionChanged$)throw this.createUninitializedErr();return this.directionChanged$}positionChangeStarted(){if(!this.positionChangeStarted$)throw this.createUninitializedErr();return this.positionChangeStarted$}positionChangeFinished(){if(!this.positionChangeFinished$)throw this.createUninitializedErr();return this.positionChangeFinished$}setConfigDefaults(e){return N({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES",layerOverlay:!1},e)}charRemoved(e){var t;if(!this.charRemoved$)throw this.createUninitializedErr();return(t=this.charRemoved$)==null?void 0:t.pipe(F(1),A(r=>r==e))}initGuard(){if(!this.isCreatedInternal)throw this.createUninitializedErr()}createUninitializedErr(){throw new Error("Plugin not initialized. You need to call create() first.")}addCharacters(){S.get().characters.forEach(e=>this.addCharacter(e))}moveChar(e,t){var i,n,s,a;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(e))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(e);if(S.get().numberOfDirections===4){if(!((s=this.gridTilemap)!=null&&s.isIsometric())&&xt(t)){console.warn(`GridEngine: Character '${e}' can't be moved '${t}' in 4 direction mode.`);return}else if(((a=this.gridTilemap)==null?void 0:a.isIsometric())&&!xt(t)){console.warn(`GridEngine: Character '${e}' can't be moved '${t}' in 4 direction isometric mode.`);return}}r.move(t)}createCharUnknownErr(e){return new Error(`Character unknown: ${e}`)}assembleMoveToConfig(e={}){let t=ie(N({},e),{noPathFoundStrategy:"STOP",pathBlockedStrategy:"WAIT"});return e!=null&&e.noPathFoundStrategy&&(Object.values(Se).includes(e.noPathFoundStrategy)?t.noPathFoundStrategy=e.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${e.noPathFoundStrategy}'. Falling back to '${"STOP"}'`)),e!=null&&e.pathBlockedStrategy&&(Object.values(ct).includes(e.pathBlockedStrategy)?t.pathBlockedStrategy=e.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${e.pathBlockedStrategy}'. Falling back to '${"WAIT"}'`)),t}}});var Lo=lr((sp,Qi)=>{Ki();Qi.exports=bt});return Lo();})();
