var GridEngine=(()=>{var Lr=Object.create;var ut=Object.defineProperty,Vr=Object.defineProperties,Br=Object.getOwnPropertyDescriptor,Hr=Object.getOwnPropertyDescriptors,jr=Object.getOwnPropertyNames,le=Object.getOwnPropertySymbols,$r=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty,zr=Object.prototype.propertyIsEnumerable;var pe=(i,t,e)=>t in i?ut(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,Rt=(i,t)=>{for(var e in t||(t={}))ce.call(t,e)&&pe(i,e,t[e]);if(le)for(var e of le(t))zr.call(t,e)&&pe(i,e,t[e]);return i},he=(i,t)=>Vr(i,Hr(t)),Yr=i=>ut(i,"__esModule",{value:!0});var h=(i,t)=>()=>(i&&(t=i(i=0)),t);var ue=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var Kr=(i,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of jr(t))!ce.call(i,r)&&r!=="default"&&ut(i,r,{get:()=>t[r],enumerable:!(e=Br(t,r))||e.enumerable});return i},Xr=i=>Kr(Yr(ut(i!=null?Lr($r(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var S,mt=h(()=>{S=class{static get(){return S.config}static set(t){S.config=t}}});var K,kt=h(()=>{(function(o){o.DONT_BLOCK="DONT_BLOCK",o.BLOCK_TWO_TILES="BLOCK_TWO_TILES",o.BLOCK_ONE_TILE_AHEAD="BLOCK_ONE_TILE_AHEAD",o.BLOCK_ONE_TILE_BEHIND="BLOCK_ONE_TILE_BEHIND"})(K||(K={}))});var _,u,M=h(()=>{_=class{constructor(t,e){typeof t=="number"?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new _(this.x,this.y)}add(t){return new _(this.x+t.x,this.y+t.y)}multiply(t){return new _(this.x*t.x,this.y*t.y)}divide(t){return new _(this.x/t.x,this.y/t.y)}subtract(t){return new _(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}abs(){return new _(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}},u=_;u.ZERO=new _(0,0),u.UP=new _(0,-1),u.DOWN=new _(0,1),u.LEFT=new _(-1,0),u.RIGHT=new _(1,0)});function me(i){let t=[s.UP,s.RIGHT,s.DOWN,s.LEFT],e=[s.DOWN_LEFT,s.DOWN_RIGHT,s.UP_RIGHT,s.UP_LEFT];return i===C.EIGHT?[...t,...e]:t}function At(i){return[s.DOWN_LEFT,s.DOWN_RIGHT,s.UP_RIGHT,s.UP_LEFT].includes(i)}function fe(i){return{[s.LEFT]:s.DOWN_LEFT,[s.UP_LEFT]:s.LEFT,[s.UP]:s.UP_LEFT,[s.UP_RIGHT]:s.UP,[s.RIGHT]:s.UP_RIGHT,[s.DOWN_RIGHT]:s.RIGHT,[s.DOWN]:s.DOWN_RIGHT,[s.DOWN_LEFT]:s.DOWN,[s.NONE]:s.NONE}[i]}function U(i){return{[s.UP]:u.UP.clone(),[s.DOWN]:u.DOWN.clone(),[s.LEFT]:u.LEFT.clone(),[s.RIGHT]:u.RIGHT.clone(),[s.NONE]:u.ZERO.clone(),[s.UP_LEFT]:new u(-1,-1),[s.UP_RIGHT]:new u(1,-1),[s.DOWN_RIGHT]:new u(1,1),[s.DOWN_LEFT]:new u(-1,1)}[i]}function de(i){return{[s.UP]:s.DOWN,[s.DOWN]:s.UP,[s.LEFT]:s.RIGHT,[s.RIGHT]:s.LEFT,[s.NONE]:s.NONE,[s.UP_LEFT]:s.DOWN_RIGHT,[s.UP_RIGHT]:s.DOWN_LEFT,[s.DOWN_RIGHT]:s.UP_LEFT,[s.DOWN_LEFT]:s.UP_RIGHT}[i]}var s,C,E=h(()=>{M();(function(p){p.NONE="none",p.LEFT="left",p.UP_LEFT="up-left",p.UP="up",p.UP_RIGHT="up-right",p.RIGHT="right",p.DOWN_RIGHT="down-right",p.DOWN="down",p.DOWN_LEFT="down-left"})(s||(s={}));(function(e){e[e.FOUR=4]="FOUR",e[e.EIGHT=8]="EIGHT"})(C||(C={}))});var g,X=h(()=>{M();g=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return g.vec2str(t)==g.vec2str(e)}static manhattanDistance(t,e){let r=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return r+o}static chebyshevDistance(t,e){let r=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return Math.max(r,o)}static scalarMult(t,e){return t.clone().multiply(new u(e,e))}}});var q,it,be=h(()=>{E();q=class{constructor(t,e,r){this.sprite=t;this.walkingAnimationMapping=e;this.characterIndex=r;this.lastFootLeft=!1;this.directionToFrameRow={[s.DOWN]:0,[s.DOWN_LEFT]:1,[s.DOWN_RIGHT]:2,[s.LEFT]:1,[s.RIGHT]:2,[s.UP]:3,[s.UP_LEFT]:1,[s.UP_RIGHT]:2};this._isEnabled=!0}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t}setStandingFrameDuringWalk(t){this.isCurrentFrameStanding(t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);this.sprite.setFrame(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){this.sprite.setFrame(this.framesOfDirection(t).standing)}isCurrentFrameStanding(t){return Number(this.sprite.frame.name)==this.framesOfDirection(t).standing}framesOfDirection(t){return this.walkingAnimationMapping?this.getFramesForAnimationMapping(t):this.getFramesForCharIndex(t)}getFramesForAnimationMapping(t){return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case s.DOWN_LEFT:return s.LEFT;case s.DOWN_RIGHT:return s.RIGHT;case s.UP_LEFT:return s.LEFT;case s.UP_RIGHT:return s.RIGHT}return t}getFramesForCharIndex(t){let e=this.sprite.texture.source[0].width/this.sprite.width/q.FRAMES_CHAR_ROW,r=Math.floor(this.characterIndex/e),o=this.characterIndex%e,n=e*q.FRAMES_CHAR_ROW,a=q.FRAMES_CHAR_ROW*o,l=this.directionToFrameRow[t]+r*q.FRAMES_CHAR_COL,c=a+l*n;return{rightFoot:c,standing:c+1,leftFoot:c+2}}},it=q;it.FRAMES_CHAR_ROW=3,it.FRAMES_CHAR_COL=4});var It,ge=h(()=>{mt();kt();It=class{constructor(){this.tilePosToCharacters=new Map;this.positionChangeStartedSubs=new Map;this.positionChangeFinishedSubs=new Map}isCharBlockingAt(t){let e=this.posToString(t);return this.tilePosToCharacters.has(e)&&this.tilePosToCharacters.get(e).size>0}addCharacter(t){this.add(this.posToString(t.getTilePos()),t),this.add(this.posToString(t.getNextTilePos()),t),this.addPositionChangeSub(t),this.addPositionChangeFinishedSub(t)}removeCharacter(t){let e=t.getId();this.positionChangeStartedSubs.get(e).unsubscribe(),this.positionChangeFinishedSubs.get(e).unsubscribe(),this.tilePosToCharacters.get(this.posToString(t.getTilePos())).delete(t),this.tilePosToCharacters.get(this.posToString(t.getNextTilePos())).delete(t)}add(t,e){this.tilePosToCharacters.has(t)||this.tilePosToCharacters.set(t,new Set),this.tilePosToCharacters.get(t).add(e)}addPositionChangeSub(t){let e=t.positionChangeStarted().subscribe(r=>{S.get().characterCollisionStrategy===K.BLOCK_ONE_TILE_AHEAD&&this.tilePosToCharacters.get(this.posToString(r.exitTile)).delete(t),this.add(this.posToString(r.enterTile),t)});this.positionChangeStartedSubs.set(t.getId(),e)}addPositionChangeFinishedSub(t){let e=t.positionChangeFinished().subscribe(r=>{this.tilePosToCharacters.get(this.posToString(r.exitTile)).delete(t)});this.positionChangeFinishedSubs.set(t.getId(),e)}posToString(t){return`${t.x}#${t.y}`}}});var k,R,Gt=h(()=>{mt();ge();k=class{constructor(t,e){this.tilemap=t;this.firstLayerAboveChar=e;this.characters=new Map;this.charBlockCache=new It;this.setLayerDepths()}addCharacter(t){this.characters.set(t.getId(),t),this.charBlockCache.addCharacter(t)}removeCharacter(t){this.charBlockCache.removeCharacter(this.characters.get(t)),this.characters.delete(t)}getCharacters(){return[...this.characters.values()]}isBlocking(t,e){return this.hasNoTile(t)||this.hasBlockingTile(t,e)||this.hasBlockingChar(t)}hasBlockingTile(t,e){if(this.hasNoTile(t))return!0;let r=k.ONE_WAY_COLLIDE_PROP_PREFIX+e;return this.tilemap.layers.some(o=>{let n=this.tilemap.getTileAt(t.x,t.y,!1,o.name);return(n==null?void 0:n.properties)&&(n.properties[S.get().collisionTilePropertyName]||n.properties[r])})}hasNoTile(t){return!this.tilemap.layers.some(e=>this.tilemap.hasTileAt(t.x,t.y,e.name))}hasBlockingChar(t){return this.charBlockCache.isCharBlockingAt(t)}getTileWidth(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*t}getTileHeight(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*t}getLayerProp(t,e){let o=t.properties.find(n=>n.name==e);return o==null?void 0:o.value}hasLayerProp(t,e){return this.getLayerProp(t,e)!=null}isLayerAlwaysOnTop(t,e){return e>=this.firstLayerAboveChar||this.hasLayerProp(t,k.ALWAYS_TOP_PROP_NAME)}setLayerDepths(){let t=[];this.tilemap.layers.forEach((e,r)=>{this.isLayerAlwaysOnTop(e,r)?e.tilemapLayer.setDepth(k.FIRST_PLAYER_LAYER+k.MAX_PLAYER_LAYERS+r):this.hasLayerProp(e,k.HEIGHT_SHIFT_PROP_NAME)?(this.createLayerForEachRow(e,r),t.push(e.tilemapLayer)):e.tilemapLayer.setDepth(r)}),t.forEach(e=>e.destroy())}createLayerForEachRow(t,e){let r=this.getLayerProp(t,k.HEIGHT_SHIFT_PROP_NAME);for(let o=0;o<t.height;o++){let n=this.tilemap.createBlankLayer(`${e}#${o}`,t.tilemapLayer.tileset);for(let l=0;l<t.width;l++)n.putTileAt(t.data[o][l],l,o);n.scale=t.tilemapLayer.scale;let a=.5;n.setDepth(k.FIRST_PLAYER_LAYER+o+r-1+a)}}},R=k;R.MAX_PLAYER_LAYERS=1e3,R.FIRST_PLAYER_LAYER=1e3,R.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",R.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",R.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_"});var We=ue((_i,bt)=>{var ve,xe,ye,Te,Se,Pe,_e,Ce,Ee,ft,Nt,we,De,Oe,Z,Fe,Me,Re,ke,Ae,Ie,Ge,Ne,dt;(function(i){var t=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){i(e(t,e(r)))}):typeof bt=="object"&&typeof bt.exports=="object"?i(e(t,e(bt.exports))):i(e(t));function e(r,o){return r!==t&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,a){return r[n]=o?o(n,a):a}}})(function(i){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(r[n]=o[n])};ve=function(r,o){if(typeof o!="function"&&o!==null)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");t(r,o);function n(){this.constructor=r}r.prototype=o===null?Object.create(o):(n.prototype=o.prototype,new n)},xe=Object.assign||function(r){for(var o,n=1,a=arguments.length;n<a;n++){o=arguments[n];for(var l in o)Object.prototype.hasOwnProperty.call(o,l)&&(r[l]=o[l])}return r},ye=function(r,o){var n={};for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&o.indexOf(a)<0&&(n[a]=r[a]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var l=0,a=Object.getOwnPropertySymbols(r);l<a.length;l++)o.indexOf(a[l])<0&&Object.prototype.propertyIsEnumerable.call(r,a[l])&&(n[a[l]]=r[a[l]]);return n},Te=function(r,o,n,a){var l=arguments.length,c=l<3?o:a===null?a=Object.getOwnPropertyDescriptor(o,n):a,p;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")c=Reflect.decorate(r,o,n,a);else for(var f=r.length-1;f>=0;f--)(p=r[f])&&(c=(l<3?p(c):l>3?p(o,n,c):p(o,n))||c);return l>3&&c&&Object.defineProperty(o,n,c),c},Se=function(r,o){return function(n,a){o(n,a,r)}},Pe=function(r,o){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,o)},_e=function(r,o,n,a){function l(c){return c instanceof n?c:new n(function(p){p(c)})}return new(n||(n=Promise))(function(c,p){function f(v){try{m(a.next(v))}catch(A){p(A)}}function T(v){try{m(a.throw(v))}catch(A){p(A)}}function m(v){v.done?c(v.value):l(v.value).then(f,T)}m((a=a.apply(r,o||[])).next())})},Ce=function(r,o){var n={label:0,sent:function(){if(c[0]&1)throw c[1];return c[1]},trys:[],ops:[]},a,l,c,p;return p={next:f(0),throw:f(1),return:f(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function f(m){return function(v){return T([m,v])}}function T(m){if(a)throw new TypeError("Generator is already executing.");for(;n;)try{if(a=1,l&&(c=m[0]&2?l.return:m[0]?l.throw||((c=l.return)&&c.call(l),0):l.next)&&!(c=c.call(l,m[1])).done)return c;switch(l=0,c&&(m=[m[0]&2,c.value]),m[0]){case 0:case 1:c=m;break;case 4:return n.label++,{value:m[1],done:!1};case 5:n.label++,l=m[1],m=[0];continue;case 7:m=n.ops.pop(),n.trys.pop();continue;default:if(c=n.trys,!(c=c.length>0&&c[c.length-1])&&(m[0]===6||m[0]===2)){n=0;continue}if(m[0]===3&&(!c||m[1]>c[0]&&m[1]<c[3])){n.label=m[1];break}if(m[0]===6&&n.label<c[1]){n.label=c[1],c=m;break}if(c&&n.label<c[2]){n.label=c[2],n.ops.push(m);break}c[2]&&n.ops.pop(),n.trys.pop();continue}m=o.call(r,n)}catch(v){m=[6,v],l=0}finally{a=c=0}if(m[0]&5)throw m[1];return{value:m[0]?m[1]:void 0,done:!0}}},Ee=function(r,o){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(o,n)&&dt(o,r,n)},dt=Object.create?function(r,o,n,a){a===void 0&&(a=n),Object.defineProperty(r,a,{enumerable:!0,get:function(){return o[n]}})}:function(r,o,n,a){a===void 0&&(a=n),r[a]=o[n]},ft=function(r){var o=typeof Symbol=="function"&&Symbol.iterator,n=o&&r[o],a=0;if(n)return n.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&a>=r.length&&(r=void 0),{value:r&&r[a++],done:!r}}};throw new TypeError(o?"Object is not iterable.":"Symbol.iterator is not defined.")},Nt=function(r,o){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var a=n.call(r),l,c=[],p;try{for(;(o===void 0||o-- >0)&&!(l=a.next()).done;)c.push(l.value)}catch(f){p={error:f}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(p)throw p.error}}return c},we=function(){for(var r=[],o=0;o<arguments.length;o++)r=r.concat(Nt(arguments[o]));return r},De=function(){for(var r=0,o=0,n=arguments.length;o<n;o++)r+=arguments[o].length;for(var a=Array(r),l=0,o=0;o<n;o++)for(var c=arguments[o],p=0,f=c.length;p<f;p++,l++)a[l]=c[p];return a},Oe=function(r,o){for(var n=0,a=o.length,l=r.length;n<a;n++,l++)r[l]=o[n];return r},Z=function(r){return this instanceof Z?(this.v=r,this):new Z(r)},Fe=function(r,o,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a=n.apply(r,o||[]),l,c=[];return l={},p("next"),p("throw"),p("return"),l[Symbol.asyncIterator]=function(){return this},l;function p(d){a[d]&&(l[d]=function(Y){return new Promise(function(Mt,Ur){c.push([d,Y,Mt,Ur])>1||f(d,Y)})})}function f(d,Y){try{T(a[d](Y))}catch(Mt){A(c[0][3],Mt)}}function T(d){d.value instanceof Z?Promise.resolve(d.value.v).then(m,v):A(c[0][2],d)}function m(d){f("next",d)}function v(d){f("throw",d)}function A(d,Y){d(Y),c.shift(),c.length&&f(c[0][0],c[0][1])}},Me=function(r){var o,n;return o={},a("next"),a("throw",function(l){throw l}),a("return"),o[Symbol.iterator]=function(){return this},o;function a(l,c){o[l]=r[l]?function(p){return(n=!n)?{value:Z(r[l](p)),done:l==="return"}:c?c(p):p}:c}},Re=function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o=r[Symbol.asyncIterator],n;return o?o.call(r):(r=typeof ft=="function"?ft(r):r[Symbol.iterator](),n={},a("next"),a("throw"),a("return"),n[Symbol.asyncIterator]=function(){return this},n);function a(c){n[c]=r[c]&&function(p){return new Promise(function(f,T){p=r[c](p),l(f,T,p.done,p.value)})}}function l(c,p,f,T){Promise.resolve(T).then(function(m){c({value:m,done:f})},p)}},ke=function(r,o){return Object.defineProperty?Object.defineProperty(r,"raw",{value:o}):r.raw=o,r};var e=Object.create?function(r,o){Object.defineProperty(r,"default",{enumerable:!0,value:o})}:function(r,o){r.default=o};Ae=function(r){if(r&&r.__esModule)return r;var o={};if(r!=null)for(var n in r)n!=="default"&&Object.prototype.hasOwnProperty.call(r,n)&&dt(o,r,n);return e(o,r),o},Ie=function(r){return r&&r.__esModule?r:{default:r}},Ge=function(r,o){if(!o.has(r))throw new TypeError("attempted to get private field on non-instance");return o.get(r)},Ne=function(r,o,n){if(!o.has(r))throw new TypeError("attempted to set private field on non-instance");return o.set(r,n),n},i("__extends",ve),i("__assign",xe),i("__rest",ye),i("__decorate",Te),i("__param",Se),i("__metadata",Pe),i("__awaiter",_e),i("__generator",Ce),i("__exportStar",Ee),i("__createBinding",dt),i("__values",ft),i("__read",Nt),i("__spread",we),i("__spreadArrays",De),i("__spreadArray",Oe),i("__await",Z),i("__asyncGenerator",Fe),i("__asyncDelegator",Me),i("__asyncValues",Re),i("__makeTemplateObject",ke),i("__importStar",Ae),i("__importDefault",Ie),i("__classPrivateFieldGet",Ge),i("__classPrivateFieldSet",Ne)})});var Ue,I,Ci,Ei,wi,Di,Oi,Le,gt,Fi,Mi,L,V,Ri,ki,B,vt,Ve,Ai,Be,Ii,Gi,Ni,Wi,Ui,G=h(()=>{Ue=Xr(We()),{__extends:I,__assign:Ci,__rest:Ei,__decorate:wi,__param:Di,__metadata:Oi,__awaiter:Le,__generator:gt,__exportStar:Fi,__createBinding:Mi,__values:L,__read:V,__spread:Ri,__spreadArrays:ki,__spreadArray:B,__await:vt,__asyncGenerator:Ve,__asyncDelegator:Ai,__asyncValues:Be,__makeTemplateObject:Ii,__importStar:Gi,__importDefault:Ni,__classPrivateFieldGet:Wi,__classPrivateFieldSet:Ui}=Ue.default});function b(i){return typeof i=="function"}var D=h(()=>{});function xt(i){var t=function(r){Error.call(r),r.stack=new Error().stack},e=i(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var Wt=h(()=>{});var yt,He=h(()=>{Wt();yt=xt(function(i){return function(e){i(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,o){return o+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}})});function ot(i,t){if(i){var e=i.indexOf(t);0<=e&&i.splice(e,1)}}var Ut=h(()=>{});function Tt(i){return i instanceof J||i&&"closed"in i&&b(i.remove)&&b(i.add)&&b(i.unsubscribe)}function je(i){b(i)?i():i.unsubscribe()}var J,Lt,St=h(()=>{G();D();He();Ut();J=function(){function i(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._teardowns=null}return i.prototype.unsubscribe=function(){var t,e,r,o,n;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var l=L(a),c=l.next();!c.done;c=l.next()){var p=c.value;p.remove(this)}}catch(d){t={error:d}}finally{try{c&&!c.done&&(e=l.return)&&e.call(l)}finally{if(t)throw t.error}}else a.remove(this);var f=this.initialTeardown;if(b(f))try{f()}catch(d){n=d instanceof yt?d.errors:[d]}var T=this._teardowns;if(T){this._teardowns=null;try{for(var m=L(T),v=m.next();!v.done;v=m.next()){var A=v.value;try{je(A)}catch(d){n=n!=null?n:[],d instanceof yt?n=B(B([],V(n)),V(d.errors)):n.push(d)}}}catch(d){r={error:d}}finally{try{v&&!v.done&&(o=m.return)&&o.call(m)}finally{if(r)throw r.error}}}if(n)throw new yt(n)}},i.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)je(t);else{if(t instanceof i){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=(e=this._teardowns)!==null&&e!==void 0?e:[]).push(t)}},i.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},i.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},i.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&ot(e,t)},i.prototype.remove=function(t){var e=this._teardowns;e&&ot(e,t),t instanceof i&&t._removeParent(this)},i.EMPTY=function(){var t=new i;return t.closed=!0,t}(),i}(),Lt=J.EMPTY});var O,nt=h(()=>{O={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1}});var Q,Vt=h(()=>{G();Q={setTimeout:function(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];var e=Q.delegate;return((e==null?void 0:e.setTimeout)||setTimeout).apply(void 0,B([],V(i)))},clearTimeout:function(i){var t=Q.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(i)},delegate:void 0}});function Pt(i){Q.setTimeout(function(){var t=O.onUnhandledError;if(t)t(i);else throw i})}var Bt=h(()=>{nt();Vt()});function H(){}var Ht=h(()=>{});function ze(i){return jt("E",void 0,i)}function Ye(i){return jt("N",i,void 0)}function jt(i,t,e){return{kind:i,value:t,error:e}}var $e,Ke=h(()=>{$e=function(){return jt("C",void 0,void 0)}()});function tt(i){if(O.useDeprecatedSynchronousErrorHandling){var t=!j;if(t&&(j={errorThrown:!1,error:null}),i(),t){var e=j,r=e.errorThrown,o=e.error;if(j=null,r)throw o}}else i()}function Xe(i){O.useDeprecatedSynchronousErrorHandling&&j&&(j.errorThrown=!0,j.error=i)}var j,_t=h(()=>{nt();j=null});function zt(i,t){return function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];try{i.apply(void 0,B([],V(e)))}catch(o){O.useDeprecatedSynchronousErrorHandling?Xe(o):Pt(o)}}}function qe(i){throw i}function Yt(i,t){var e=O.onStoppedNotification;e&&Q.setTimeout(function(){return e(i,t)})}var at,$t,qr,Kt=h(()=>{G();D();St();nt();Bt();Ht();Ke();Vt();_t();at=function(i){I(t,i);function t(e){var r=i.call(this)||this;return r.isStopped=!1,e?(r.destination=e,Tt(e)&&e.add(r)):r.destination=qr,r}return t.create=function(e,r,o){return new $t(e,r,o)},t.prototype.next=function(e){this.isStopped?Yt(Ye(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?Yt(ze(e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?Yt($e,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(J),$t=function(i){I(t,i);function t(e,r,o){var n=i.call(this)||this,a;if(b(e))a=e;else if(e){a=e.next,r=e.error,o=e.complete;var l;n&&O.useDeprecatedNextContext?(l=Object.create(e),l.unsubscribe=function(){return n.unsubscribe()}):l=e,a=a==null?void 0:a.bind(l),r=r==null?void 0:r.bind(l),o=o==null?void 0:o.bind(l)}return n.destination={next:a?zt(a,n):H,error:zt(r!=null?r:qe,n),complete:o?zt(o,n):H},n}return t}(at);qr={closed:!0,next:H,error:qe,complete:H}});var et,Ct=h(()=>{et=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function Ze(i){return i}var Je=h(()=>{});function Qe(i){return i.length===0?Ze:i.length===1?i[0]:function(e){return i.reduce(function(r,o){return o(r)},e)}}var tr=h(()=>{Je()});function er(i){var t;return(t=i!=null?i:O.Promise)!==null&&t!==void 0?t:Promise}function Zr(i){return i&&b(i.next)&&b(i.error)&&b(i.complete)}function Jr(i){return i&&i instanceof at||Zr(i)&&Tt(i)}var w,Et=h(()=>{Kt();St();Ct();tr();nt();D();_t();w=function(){function i(t){t&&(this._subscribe=t)}return i.prototype.lift=function(t){var e=new i;return e.source=this,e.operator=t,e},i.prototype.subscribe=function(t,e,r){var o=this,n=Jr(t)?t:new $t(t,e,r);return tt(function(){var a=o,l=a.operator,c=a.source;n.add(l?l.call(n,c):c?o._subscribe(n):o._trySubscribe(n))}),n},i.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},i.prototype.forEach=function(t,e){var r=this;return e=er(e),new e(function(o,n){var a;a=r.subscribe(function(l){try{t(l)}catch(c){n(c),a==null||a.unsubscribe()}},n,o)})},i.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},i.prototype[et]=function(){return this},i.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Qe(t)(this)},i.prototype.toPromise=function(t){var e=this;return t=er(t),new t(function(r,o){var n;e.subscribe(function(a){return n=a},function(a){return o(a)},function(){return r(n)})})},i.create=function(t){return new i(t)},i}()});function Qr(i){return b(i==null?void 0:i.lift)}function N(i){return function(t){if(Qr(t))return t.lift(function(e){try{return i(e,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var st=h(()=>{D()});var W,lt=h(()=>{G();Kt();W=function(i){I(t,i);function t(e,r,o,n,a){var l=i.call(this,e)||this;return l.onFinalize=a,l._next=r?function(c){try{r(c)}catch(p){e.error(p)}}:i.prototype._next,l._error=n?function(c){try{n(c)}catch(p){e.error(p)}finally{this.unsubscribe()}}:i.prototype._error,l._complete=o?function(){try{o()}catch(c){e.error(c)}finally{this.unsubscribe()}}:i.prototype._complete,l}return t.prototype.unsubscribe=function(){var e,r=this.closed;i.prototype.unsubscribe.call(this),!r&&((e=this.onFinalize)===null||e===void 0||e.call(this))},t}(at)});var rr,ir=h(()=>{Wt();rr=xt(function(i){return function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})});var x,or,nr=h(()=>{G();Et();St();ir();Ut();_t();x=function(i){I(t,i);function t(){var e=i.call(this)||this;return e.closed=!1,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var r=new or(this,this);return r.operator=e,r},t.prototype._throwIfClosed=function(){if(this.closed)throw new rr},t.prototype.next=function(e){var r=this;tt(function(){var o,n;if(r._throwIfClosed(),!r.isStopped){var a=r.observers.slice();try{for(var l=L(a),c=l.next();!c.done;c=l.next()){var p=c.value;p.next(e)}}catch(f){o={error:f}}finally{try{c&&!c.done&&(n=l.return)&&n.call(l)}finally{if(o)throw o.error}}}})},t.prototype.error=function(e){var r=this;tt(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var o=r.observers;o.length;)o.shift().error(e)}})},t.prototype.complete=function(){var e=this;tt(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var r=e.observers;r.length;)r.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),i.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var r=this,o=r.hasError,n=r.isStopped,a=r.observers;return o||n?Lt:(a.push(e),new J(function(){return ot(a,e)}))},t.prototype._checkFinalizedStatuses=function(e){var r=this,o=r.hasError,n=r.thrownError,a=r.isStopped;o?e.error(n):a&&e.complete()},t.prototype.asObservable=function(){var e=new w;return e.source=this,e},t.create=function(e,r){return new or(e,r)},t}(w),or=function(i){I(t,i);function t(e,r){var o=i.call(this)||this;return o.destination=e,o.source=r,o}return t.prototype.next=function(e){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.next)===null||o===void 0||o.call(r,e)},t.prototype.error=function(e){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.error)===null||o===void 0||o.call(r,e)},t.prototype.complete=function(){var e,r;(r=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||r===void 0||r.call(e)},t.prototype._subscribe=function(e){var r,o;return(o=(r=this.source)===null||r===void 0?void 0:r.subscribe(e))!==null&&o!==void 0?o:Lt},t}(x)});var ar,sr=h(()=>{Et();ar=new w(function(i){return i.complete()})});var lr,cr=h(()=>{lr=function(i){return i&&typeof i.length=="number"&&typeof i!="function"}});function pr(i){return b(i==null?void 0:i.then)}var hr=h(()=>{D()});function ti(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ur,mr=h(()=>{ur=ti()});function fr(i){return b(i[et])}var dr=h(()=>{Ct();D()});function br(i){return b(i==null?void 0:i[ur])}var gr=h(()=>{mr();D()});function vr(i){return Symbol.asyncIterator&&b(i==null?void 0:i[Symbol.asyncIterator])}var xr=h(()=>{D()});function yr(i){return new TypeError("You provided "+(i!==null&&typeof i=="object"?"an invalid object":"'"+i+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var Tr=h(()=>{});function Sr(i){return Ve(this,arguments,function(){var e,r,o,n;return gt(this,function(a){switch(a.label){case 0:e=i.getReader(),a.label=1;case 1:a.trys.push([1,,9,10]),a.label=2;case 2:return[4,vt(e.read())];case 3:return r=a.sent(),o=r.value,n=r.done,n?[4,vt(void 0)]:[3,5];case 4:return[2,a.sent()];case 5:return[4,vt(o)];case 6:return[4,a.sent()];case 7:return a.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Pr(i){return b(i==null?void 0:i.getReader)}var _r=h(()=>{G();D()});function Cr(i){if(i instanceof w)return i;if(i!=null){if(fr(i))return ei(i);if(lr(i))return ri(i);if(pr(i))return ii(i);if(vr(i))return Er(i);if(br(i))return oi(i);if(Pr(i))return ni(i)}throw yr(i)}function ei(i){return new w(function(t){var e=i[et]();if(b(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function ri(i){return new w(function(t){for(var e=0;e<i.length&&!t.closed;e++)t.next(i[e]);t.complete()})}function ii(i){return new w(function(t){i.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,Pt)})}function oi(i){return new w(function(t){var e,r;try{for(var o=L(i),n=o.next();!n.done;n=o.next()){var a=n.value;if(t.next(a),t.closed)return}}catch(l){e={error:l}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}t.complete()})}function Er(i){return new w(function(t){ai(i,t).catch(function(e){return t.error(e)})})}function ni(i){return Er(Sr(i))}function ai(i,t){var e,r,o,n;return Le(this,void 0,void 0,function(){var a,l;return gt(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),e=Be(i),c.label=1;case 1:return[4,e.next()];case 2:if(r=c.sent(),!!r.done)return[3,4];if(a=r.value,t.next(a),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=c.sent(),o={error:l},[3,11];case 6:return c.trys.push([6,,9,10]),r&&!r.done&&(n=e.return)?[4,n.call(e)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}var wr=h(()=>{G();cr();hr();Ct();Et();D();Bt();dr();xr();Tr();gr();_r()});function Xt(i,t){return N(function(e,r){var o=0;e.subscribe(new W(r,function(n){r.next(i.call(t,n,o++))}))})}var Dr=h(()=>{st();lt()});function qt(i,t){return N(function(e,r){var o=0;e.subscribe(new W(r,function(n){return i.call(t,n,o++)&&r.next(n)}))})}var Or=h(()=>{st();lt()});var Fr=h(()=>{});function rt(i){return i<=0?function(){return ar}:N(function(t,e){var r=0;t.subscribe(new W(e,function(o){++r<=i&&(e.next(o),i<=r&&e.complete())}))})}var Zt=h(()=>{sr();st();lt()});function $(i){return N(function(t,e){Cr(i).subscribe(new W(e,function(){return e.complete()},H)),!e.closed&&t.subscribe(e)})}var Mr=h(()=>{st();lt();wr();Ht()});var wt=h(()=>{nr();Fr();Zt()});var ct,Jt=h(()=>{be();X();E();E();Gt();wt();M();ct=class{constructor(t,e){this.id=t;this.movementDirection=s.NONE;this.tileSizePixelsWalked=u.ZERO.clone();this._nextTilePos=new u(0,0);this._tilePos=new u(0,0);this.movementStarted$=new x;this.movementStopped$=new x;this.directionChanged$=new x;this.positionChangeStarted$=new x;this.positionChangeFinished$=new x;this.autoMovementSet$=new x;this.lastMovementImpulse=s.NONE;this.facingDirection=s.DOWN;this.characterIndex=-1;typeof e.walkingAnimationMapping=="number"?this.characterIndex=e.walkingAnimationMapping:this.walkingAnimationMapping=e.walkingAnimationMapping,this.container=e.container,this.tilemap=e.tilemap,this.speed=e.speed,this.customOffset=new u(e.offsetX||0,e.offsetY||0),this.tileSize=e.tileSize.clone(),this.sprite=e.sprite,this._setSprite(this.sprite)}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}getSprite(){return this.sprite}setSprite(t){this._setSprite(t)}setMovement(t){var e;this.autoMovementSet$.next(),this.movement=t,(e=this.movement)==null||e.setCharacter(this)}getMovement(){return this.movement}setWalkingAnimationMapping(t){this.animation.setWalkingAnimationMapping(t)}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.positionChangeStarted$.next({exitTile:this.tilePos,enterTile:t}),this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:t}),this.movementDirection=s.NONE,this.nextTilePos=t,this.tilePos=t,this.updateZindex(),this.setPosition(this.tilePosToPixelPos(t).add(this.getOffset()).add(this.customOffset))}getTilePos(){return this.tilePos}getNextTilePos(){return this.nextTilePos}move(t){this.lastMovementImpulse=t,t!=s.NONE&&(this.isMoving()||(this.isBlockingDirection(t)?(this.facingDirection=t,this.animation.setStandingFrame(t),this.directionChanged$.next(t)):this.startMoving(t)))}update(t){var e;(e=this.movement)==null||e.update(t),this.isMoving()&&(this.updateCharacterPosition(t),this.updateZindex()),this.lastMovementImpulse=s.NONE}getMovementDirection(){return this.movementDirection}isBlockingTile(t){return this.nextTilePos.equals(t)||this.tilePos.equals(t)}isBlockingDirection(t){if(t==s.NONE)return!1;let e=this.tilePosInDirection(t),r=this.tilemap.hasBlockingTile(e,de(this.toMapDirection(t))),o=this.tilemap.hasBlockingChar(e)&&!this.tilePos.equals(e);return r||o}isMoving(){return this.movementDirection!=s.NONE}turnTowards(t){this.isMoving()||t!=s.NONE&&(this.facingDirection=t,this.animation.setStandingFrame(t))}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.add(U(this.facingDirection))}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}tilePosToPixelPos(t){return t.clone().multiply(this.tileSize)}getTileDistance(t){return this.tileSize.clone()}toMapDirection(t){return t}_setSprite(t){t.setOrigin(0,0),t.x=this.sprite.x,t.y=this.sprite.y,this.sprite=t,this.animation=new it(this.sprite,this.walkingAnimationMapping,this.characterIndex),this.animation.setIsEnabled(this.walkingAnimationMapping!==void 0||this.characterIndex!==-1),this.animation.setStandingFrame(s.DOWN),this.updateZindex()}getOffset(){let t=this.tileSize.x/2-Math.floor(this.sprite.width*this.sprite.scale/2),e=-(this.sprite.height*this.sprite.scale)+this.tileSize.y;return new u(t,e)}createSpeedPixelsPerSecond(){let t={[s.LEFT]:new u(this.tileSize.x,0),[s.RIGHT]:new u(this.tileSize.x,0),[s.UP]:new u(0,this.tileSize.y),[s.DOWN]:new u(0,this.tileSize.y),[s.UP_LEFT]:this.getTileDistance(s.UP_LEFT),[s.UP_RIGHT]:this.getTileDistance(s.UP_RIGHT),[s.DOWN_LEFT]:this.getTileDistance(s.DOWN_LEFT),[s.DOWN_RIGHT]:this.getTileDistance(s.DOWN_RIGHT),[s.NONE]:u.ZERO.clone()};return Object.entries(t).forEach(([e,r])=>{t[e]=g.scalarMult(r,this.speed)}),t}get nextTilePos(){return this._nextTilePos.clone()}set nextTilePos(t){this._nextTilePos.x=t.x,this._nextTilePos.y=t.y}get tilePos(){return this._tilePos.clone()}set tilePos(t){this._tilePos.x=t.x,this._tilePos.y=t.y}updateZindex(){(this.container||this.sprite).setDepth(R.FIRST_PLAYER_LAYER+this.mapDepth(this.nextTilePos))}mapDepth(t){return t.y}setPosition(t){let e=this.container||this.sprite;e.x=t.x,e.y=t.y}getPosition(){let t=this.container||this.sprite;return new u(t.x,t.y)}startMoving(t){t!=this.movementDirection&&this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.updateTilePos()}updateTilePos(){this.tilePos=this.nextTilePos;let t=this.tilePosInDirection(this.movementDirection);this.nextTilePos=t,this.positionChangeStarted$.next({exitTile:this.tilePos,enterTile:t})}tilePosInDirection(t){return this.nextTilePos.add(U(this.toMapDirection(t)))}getDistToNextTile(){return this.getTileDistance(this.movementDirection).clone().subtract(this.tileSizePixelsWalked).multiply(U(this.movementDirection))}updateCharacterPosition(t){let e=this.getSpeedPerDelta(t),r=this.getDistToNextTile(),o=r.length()<=e.length(),n=o?r:e;this.moveCharacterSprite(n),o&&(this.shouldContinueMoving()?(this.positionChangeFinished$.next({exitTile:this.tilePos,enterTile:this.nextTilePos}),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(t*this.getProportionWalked(e,r))):this.stopMoving())}getProportionWalked(t,e){let o=t.subtract(e).divide(t);return isNaN(o.x)&&(o.x=0),Math.max(Math.abs(o.x),Math.abs(o.y))}shouldContinueMoving(){return this.lastMovementImpulse!==s.NONE&&!this.isBlockingDirection(this.lastMovementImpulse)}getSpeedPerDelta(t){let e=t/1e3;return this.createSpeedPixelsPerSecond()[this.movementDirection].clone().multiply(new u(e,e)).multiply(U(this.movementDirection))}moveCharacterSprite(t){let e=this.getPosition().add(t);this.setPosition(e),this.tileSizePixelsWalked.x+=Math.abs(t.x),this.tileSizePixelsWalked.y+=Math.abs(t.y),this.animation.updateCharacterFrame(this.movementDirection,this.hasWalkedHalfATile()),this.tileSizePixelsWalked.x%=this.getTileDistance(this.movementDirection).x,this.tileSizePixelsWalked.y%=this.getTileDistance(this.movementDirection).y}stopMoving(){let t=this.tilePos,e=this.nextTilePos,r=this.movementDirection;this.tilePos=this.nextTilePos,this.movementDirection=s.NONE,this.movementStopped$.next(r),this.positionChangeFinished$.next({exitTile:t,enterTile:e})}hasWalkedHalfATile(){return this.tileSizePixelsWalked.x>this.getTileDistance(this.movementDirection).x/2||this.tileSizePixelsWalked.y>this.getTileDistance(this.movementDirection).y/2}}});var Qt,Rr=h(()=>{E();M();X();Jt();Qt=class extends ct{tilePosToPixelPos(t){return this.getTileDistance(s.UP_LEFT).multiply(new u(t.x-t.y,t.x+t.y))}getTileDistance(t){switch(t){case s.DOWN_LEFT:case s.DOWN_RIGHT:case s.UP_LEFT:case s.UP_RIGHT:return g.scalarMult(this.tileSize,.5);default:return super.getTileDistance(t)}}toMapDirection(t){return fe(t)}mapDepth(t){return t.x+t.y}}});var Dt=h(()=>{Or();Dr();Zt();Mr()});var te,kr=h(()=>{X();te=class{getShortestPath(t,e,r){let o=this.shortestPathBfs(t,e,r);return{path:this.returnPath(o.previous,t,e),closestToTarget:o.closestToTarget}}shortestPathBfs(t,e,r){let o=new Map,n=new Set,a=[],l=t,c=g.manhattanDistance(t,e);for(a.push({node:t,dist:0}),n.add(g.vec2str(t));a.length>0;){let{node:p,dist:f}=a.shift(),T=g.manhattanDistance(p,e);if(T<c&&(c=T,l=p),g.equal(p,e))return{shortestDistance:f,previous:o,closestToTarget:l};for(let m of r(p))n.has(g.vec2str(m))||(o.set(g.vec2str(m),p),a.push({node:m,dist:f+1}),n.add(g.vec2str(m)))}return{shortestDistance:-1,previous:o,closestToTarget:l}}returnPath(t,e,r){let o=[],n=r;for(o.push(n);!g.equal(n,e);){if(n=t.get(g.vec2str(n)),!n)return[];o.push(n)}return o.reverse()}}});var Ot,Ar=h(()=>{Ot=class{constructor(t,e,r){this.backoffMs=t;this.maxRetries=e;this.onFinished=r;this.retries=0;this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}}});var pt,ee=h(()=>{X();E();M();pt=class{distance(t,e){return g.chebyshevDistance(t,e)}neighbours(t){let e=[new u(t.x,t.y+1),new u(t.x+1,t.y),new u(t.x-1,t.y),new u(t.x,t.y-1)],r=[new u(t.x+1,t.y+1),new u(t.x+1,t.y-1),new u(t.x-1,t.y+1),new u(t.x-1,t.y-1)];return[...e,...r]}direction(t,e){return e.x>t.x?e.y>t.y?s.DOWN_RIGHT:e.y<t.y?s.UP_RIGHT:s.RIGHT:e.x<t.x?e.y>t.y?s.DOWN_LEFT:e.y<t.y?s.UP_LEFT:s.LEFT:e.y<t.y?s.UP:e.y>t.y?s.DOWN:s.NONE}}});var z,re=h(()=>{X();E();M();z=class{distance(t,e){return g.manhattanDistance(t,e)}direction(t,e){if(g.equal(t,e))return s.NONE;let r=t.clone().subtract(e);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?s.LEFT:s.RIGHT:r.y>0?s.UP:s.DOWN}neighbours(t){return[new u(t.x,t.y+1),new u(t.x+1,t.y),new u(t.x-1,t.y),new u(t.x,t.y-1)]}}});var P,Ft=h(()=>{(function(r){r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY"})(P||(P={}))});var F,ie=h(()=>{(function(r){r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP"})(F||(F={}))});var y,ht,oe=h(()=>{E();kr();Ar();ee();re();Ft();ie();wt();(function(l){l.SUCCESS="SUCCESS",l.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED="NO_PATH_FOUND_MAX_RETRIES_EXCEEDED",l.PATH_BLOCKED_MAX_RETRIES_EXCEEDED="PATH_BLOCKED_MAX_RETRIES_EXCEEDED",l.PATH_BLOCKED="PATH_BLOCKED",l.NO_PATH_FOUND="NO_PATH_FOUND",l.PATH_BLOCKED_WAIT_TIMEOUT="PATH_BLOCKED_WAIT_TIMEOUT",l.MOVEMENT_TERMINATED="MOVEMENT_TERMINATED"})(y||(y={}));ht=class{constructor(t,e,r=0,o){this.tilemap=t;this.targetPos=e;this.distance=r;this.posOnPath=0;this.stopped=!1;this.distanceUtils=new z;this.getNeighbours=t=>this.distanceUtils.neighbours(t).filter(r=>!this.isBlocking(r));this.isBlocking=t=>!t||this.tilemap.isBlocking(t);this.noPathFoundStrategy=(o==null?void 0:o.noPathFoundStrategy)||P.STOP,this.pathBlockedStrategy=(o==null?void 0:o.pathBlockedStrategy)||F.WAIT,this.noPathFoundRetryable=new Ot((o==null?void 0:o.noPathFoundRetryBackoffMs)||200,(o==null?void 0:o.noPathFoundMaxRetries)||-1,()=>{this.stop(y.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED)}),this.pathBlockedRetryable=new Ot((o==null?void 0:o.pathBlockedRetryBackoffMs)||200,(o==null?void 0:o.pathBlockedMaxRetries)||-1,()=>{this.stop(y.PATH_BLOCKED_MAX_RETRIES_EXCEEDED)}),this.pathBlockedWaitTimeoutMs=(o==null?void 0:o.pathBlockedWaitTimeoutMs)||-1,this.finished$=new x}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setNumberOfDirections(t){t===C.EIGHT?this.distanceUtils=new pt:this.distanceUtils=new z}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(rt(1)).subscribe(()=>{this.stop(y.MOVEMENT_TERMINATED)})}update(t){this.stopped||(this.noPathFound()&&(this.noPathFoundStrategy===P.RETRY?this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()):this.noPathFoundStrategy===P.STOP&&this.stop(y.NO_PATH_FOUND)),this.updatePosOnPath(),this.isBlocking(this.nextTileOnPath())?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop(y.SUCCESS),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking(this.nextTileOnPath())||this.moveCharOnPath())}finishedObs(){return this.finished$}resultToReason(t){switch(t){case y.SUCCESS:return"Successfully arrived.";case y.MOVEMENT_TERMINATED:return"Movement of character has been replaced before destination was reached.";case y.PATH_BLOCKED:return"PathBlockedStrategy STOP: Path blocked.";case y.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED:return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case y.NO_PATH_FOUND:return"NoPathFoundStrategy STOP: No path found.";case y.PATH_BLOCKED_MAX_RETRIES_EXCEEDED:return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case y.PATH_BLOCKED_WAIT_TIMEOUT:return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`;default:return}}applyPathBlockedStrategy(t){this.pathBlockedStrategy===F.RETRY?this.pathBlockedRetryable.retry(t,()=>this.calcShortestPath()):this.pathBlockedStrategy===F.STOP?this.stop(y.PATH_BLOCKED):this.pathBlockedStrategy===F.WAIT&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop(y.PATH_BLOCKED_WAIT_TIMEOUT))}moveCharOnPath(){let t=this.getDir(this.character.getNextTilePos(),this.nextTileOnPath());this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(t){this.finished$.next({position:this.character.getTilePos(),result:t,description:this.resultToReason(t)}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos(),t);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().x!=t.x||this.character.getNextTilePos().y!=t.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(){let t=this.getShortestPath();this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new te,{path:e,closestToTarget:r}=t.getShortestPath(this.character.getNextTilePos(),this.targetPos,this.getNeighbours);if(e.length==0&&this.noPathFoundStrategy===P.CLOSEST_REACHABLE){let n=t.getShortestPath(this.character.getNextTilePos(),r,this.getNeighbours).path,a=this.distanceUtils.distance(r,this.targetPos);return{path:n,distOffset:a}}return{path:e,distOffset:0}}getDir(t,e){return this.distanceUtils.direction(t,e)}}});var ne,Ir=h(()=>{Dt();E();oe();M();Ft();ne=class{constructor(t,e,r=0,o=P.STOP){this.gridTilemap=t;this.charToFollow=e;this.distance=r;this.noPathFoundStrategy=o;this.numberOfDirections=C.FOUR}setNumberOfDirections(t){this.numberOfDirections=t}setCharacter(t){this.character=t,this.updateTarget(this.charToFollow.getTilePos()),this.charToFollow.positionChangeStarted().pipe($(this.character.autoMovementSet())).subscribe(({enterTile:e})=>{this.updateTarget(e)})}update(t){var e;(e=this.targetMovement)==null||e.update(t)}updateTarget(t){this.targetMovement=new ht(this.gridTilemap,new u(t),this.distance+1,{noPathFoundStrategy:this.noPathFoundStrategy}),this.targetMovement.setNumberOfDirections(this.numberOfDirections),this.targetMovement.setCharacter(this.character)}}});var ae,Gr=h(()=>{E();E();Dt();M();ee();re();ae=class{constructor(t=0,e=-1){this.delay=t;this.radius=e;this.numberOfDirections=C.FOUR;this.distanceUtils=new z}setNumberOfDirections(t){this.numberOfDirections=t,t===C.EIGHT?this.distanceUtils=new pt:this.distanceUtils=new z}setCharacter(t){this.character=t,this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().y,this.initialCol=t.getNextTilePos().x,this.stepSize=this.getRandomInt(this.radius)+1,this.stepsWalked=0,this.currentMovementDirection=s.NONE,this.character.positionChangeStarted().pipe($(this.character.autoMovementSet())).subscribe(()=>{this.stepsWalked++})}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let e=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(e),this.currentMovementDirection=e,this.stepSize=this.getRandomInt(this.radius)+1}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!==s.NONE&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return me(this.numberOfDirections).filter(e=>!this.character.isBlockingDirection(e)).filter(e=>this.isWithinRadius(e))}isWithinRadius(t){return this.radius==-1?!0:this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().add(U(t)),new u(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return t.length==0?s.NONE:t[this.getRandomInt(t.length)]}getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}}});var se,Nr=h(()=>{mt();kt();Rr();Ir();oe();Jt();E();Gt();Gr();wt();Dt();M();Ft();ie();se=class{constructor(t){this.scene=t;this.isCreated=!1;console.log("test2"),this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this),this.scene.sys.events.on("destroy",this.destroy,this)}destroy(){this.scene=void 0,this.tilemap=void 0,this.gridCharacters=void 0,this.gridTilemap=void 0,this.movementStarted$=void 0,this.movementStopped$=void 0,this.directionChanged$=void 0,this.positionChangeStarted$=void 0,this.positionChangeFinished$=void 0,this.charRemoved$=void 0}create(t,e){this.isCreated=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(e);S.set(r),this.tilemap=t,this.movementStopped$=new x,this.movementStarted$=new x,this.directionChanged$=new x,this.positionChangeStarted$=new x,this.positionChangeFinished$=new x,this.charRemoved$=new x,this.gridTilemap=new R(t),this.addCharacters()}getPosition(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos()}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,r=-1){this.initGuard(),this.unknownCharGuard(t);let o=new ae(e,r);o.setNumberOfDirections(S.get().numberOfDirections),this.gridCharacters.get(t).setMovement(o)}moveTo(t,e,r){let o=this.assembleMoveToConfig(r);this.initGuard(),this.unknownCharGuard(t);let n=new ht(this.gridTilemap,new u(e),0,o);return n.setNumberOfDirections(S.get().numberOfDirections),this.gridCharacters.get(t).setMovement(n),n.finishedObs().pipe(rt(1),Xt(a=>({charId:t,position:a.position,result:a.result,description:a.description})))}stopMovement(t){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setMovement(void 0)}setSpeed(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setSpeed(e)}setWalkingAnimationMapping(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setWalkingAnimationMapping(e)}update(t,e){if(this.isCreated&&this.gridCharacters)for(let[r,o]of this.gridCharacters)o.update(e)}addCharacter(t){this.initGuard();let e={sprite:t.sprite,speed:t.speed||4,tilemap:this.gridTilemap,tileSize:new u(this.gridTilemap.getTileWidth(),this.gridTilemap.getTileHeight()),walkingAnimationMapping:t.walkingAnimationMapping,container:t.container,offsetX:t.offsetX,offsetY:t.offsetY},r=this.createCharacter(t.id,e);t.facingDirection&&r.turnTowards(t.facingDirection),this.gridCharacters.set(t.id,r);let o=t.startPosition?new u(t.startPosition):new u(0,0);r.setTilePosition(o),this.gridTilemap.addCharacter(r),r.movementStopped().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.movementStopped$.next({charId:r.getId(),direction:n})}),r.movementStarted().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.movementStarted$.next({charId:r.getId(),direction:n})}),r.directionChanged().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(n=>{this.directionChanged$.next({charId:r.getId(),direction:n})}),r.positionChangeStarted().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(({exitTile:n,enterTile:a})=>{this.positionChangeStarted$.next({charId:r.getId(),exitTile:n,enterTile:a})}),r.positionChangeFinished().pipe(this.takeUntilCharRemoved(r.getId())).subscribe(({exitTile:n,enterTile:a})=>{this.positionChangeFinished$.next({charId:r.getId(),exitTile:n,enterTile:a})})}hasCharacter(t){return this.initGuard(),this.gridCharacters.has(t)}removeCharacter(t){this.initGuard(),this.unknownCharGuard(t),this.gridTilemap.removeCharacter(t),this.gridCharacters.delete(t),this.charRemoved$.next(t)}removeAllCharacters(){this.initGuard();for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(){return this.initGuard(),[...this.gridCharacters.keys()]}follow(t,e,r=0,o=!1){this.initGuard(),this.unknownCharGuard(t),this.unknownCharGuard(e);let n=new ne(this.gridTilemap,this.gridCharacters.get(e),r,o?P.CLOSEST_REACHABLE:P.STOP);n.setNumberOfDirections(S.get().numberOfDirections),this.gridCharacters.get(t).setMovement(n)}isMoving(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).isMoving()}getFacingDirection(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getFacingDirection()}getFacingPosition(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getFacingPosition()}turnTowards(t,e){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).turnTowards(e)}setPosition(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setTilePosition(new u(e))}getSprite(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getSprite()}setSprite(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setSprite(e)}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}setConfigDefaults(t){return Rt({collisionTilePropertyName:"ge_collide",numberOfDirections:C.FOUR,characterCollisionStrategy:K.BLOCK_TWO_TILES},t)}takeUntilCharRemoved(t){return $(this.charRemoved$.pipe(qt(e=>e==t)))}initGuard(){if(!this.isCreated)throw new Error("Plugin not initialized. You need to call create() first.")}unknownCharGuard(t){if(!this.gridCharacters.has(t))throw new Error(`Character unknown: ${t}`)}createCharacter(t,e){return this._isIsometric()?new Qt(t,e):new ct(t,e)}addCharacters(){S.get().characters.forEach(t=>this.addCharacter(t))}moveChar(t,e){if(this.initGuard(),this.unknownCharGuard(t),S.get().numberOfDirections===C.FOUR){if(!this._isIsometric()&&At(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}else if(this._isIsometric()&&!At(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}this.gridCharacters.get(t).move(e)}_isIsometric(){return this.tilemap.orientation==`${Phaser.Tilemaps.Orientation.ISOMETRIC}`}assembleMoveToConfig(t){let e=he(Rt({},t),{noPathFoundStrategy:P.STOP,pathBlockedStrategy:F.WAIT});return(t==null?void 0:t.noPathFoundStrategy)&&(Object.values(P).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to '${P.STOP}'`)),(t==null?void 0:t.pathBlockedStrategy)&&(Object.values(F).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to '${F.WAIT}'`)),e}}});var si=ue((hs,Wr)=>{Nr();Wr.exports=se});return si();})();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
