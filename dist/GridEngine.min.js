var GridEngine=(()=>{var ki=Object.create;var ue=Object.defineProperty,Ni=Object.defineProperties,Gi=Object.getOwnPropertyDescriptor,Wi=Object.getOwnPropertyDescriptors,Bi=Object.getOwnPropertyNames,Ye=Object.getOwnPropertySymbols,Ui=Object.getPrototypeOf,Xe=Object.prototype.hasOwnProperty,Hi=Object.prototype.propertyIsEnumerable;var qe=(i,t,e)=>t in i?ue(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,I=(i,t)=>{for(var e in t||(t={}))Xe.call(t,e)&&qe(i,e,t[e]);if(Ye)for(var e of Ye(t))Hi.call(t,e)&&qe(i,e,t[e]);return i},J=(i,t)=>Ni(i,Wi(t));var p=(i,t)=>()=>(i&&(t=i(i=0)),t);var Ke=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var ji=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Bi(t))!Xe.call(i,o)&&o!==e&&ue(i,o,{get:()=>t[o],enumerable:!(r=Gi(t,o))||r.enumerable});return i};var Vi=(i,t,e)=>(e=i!=null?ki(Ui(i)):{},ji(t||!i||!i.__esModule?ue(e,"default",{value:i,enumerable:!0}):e,i));var P,bt=p(()=>{P=class{static get(){return P.config}static set(t){P.config=t}}});var me=p(()=>{});function d(i){return typeof i=="function"}var C=p(()=>{});function $i(i){return d(i==null?void 0:i.lift)}function T(i){return function(t){if($i(t))return t.lift(function(e){try{return i(e,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var W=p(()=>{C()});var vr=Ke((co,St)=>{var Ze,Qe,Je,tr,er,rr,ir,or,nr,Pt,fe,sr,ar,hr,tt,pr,lr,cr,ur,mr,fr,dr,gr,Tt;(function(i){var t=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){i(e(t,e(r)))}):typeof St=="object"&&typeof St.exports=="object"?i(e(t,e(St.exports))):i(e(t));function e(r,o){return r!==t&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,s){return r[n]=o?o(n,s):s}}})(function(i){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(r[n]=o[n])};Ze=function(r,o){if(typeof o!="function"&&o!==null)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");t(r,o);function n(){this.constructor=r}r.prototype=o===null?Object.create(o):(n.prototype=o.prototype,new n)},Qe=Object.assign||function(r){for(var o,n=1,s=arguments.length;n<s;n++){o=arguments[n];for(var h in o)Object.prototype.hasOwnProperty.call(o,h)&&(r[h]=o[h])}return r},Je=function(r,o){var n={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&o.indexOf(s)<0&&(n[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var h=0,s=Object.getOwnPropertySymbols(r);h<s.length;h++)o.indexOf(s[h])<0&&Object.prototype.propertyIsEnumerable.call(r,s[h])&&(n[s[h]]=r[s[h]]);return n},tr=function(r,o,n,s){var h=arguments.length,a=h<3?o:s===null?s=Object.getOwnPropertyDescriptor(o,n):s,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(r,o,n,s);else for(var f=r.length-1;f>=0;f--)(c=r[f])&&(a=(h<3?c(a):h>3?c(o,n,a):c(o,n))||a);return h>3&&a&&Object.defineProperty(o,n,a),a},er=function(r,o){return function(n,s){o(n,s,r)}},rr=function(r,o){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,o)},ir=function(r,o,n,s){function h(a){return a instanceof n?a:new n(function(c){c(a)})}return new(n||(n=Promise))(function(a,c){function f(g){try{u(s.next(g))}catch(D){c(D)}}function v(g){try{u(s.throw(g))}catch(D){c(D)}}function u(g){g.done?a(g.value):h(g.value).then(f,v)}u((s=s.apply(r,o||[])).next())})},or=function(r,o){var n={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},s,h,a,c;return c={next:f(0),throw:f(1),return:f(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function f(u){return function(g){return v([u,g])}}function v(u){if(s)throw new TypeError("Generator is already executing.");for(;n;)try{if(s=1,h&&(a=u[0]&2?h.return:u[0]?h.throw||((a=h.return)&&a.call(h),0):h.next)&&!(a=a.call(h,u[1])).done)return a;switch(h=0,a&&(u=[u[0]&2,a.value]),u[0]){case 0:case 1:a=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,h=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(a=n.trys,!(a=a.length>0&&a[a.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!a||u[1]>a[0]&&u[1]<a[3])){n.label=u[1];break}if(u[0]===6&&n.label<a[1]){n.label=a[1],a=u;break}if(a&&n.label<a[2]){n.label=a[2],n.ops.push(u);break}a[2]&&n.ops.pop(),n.trys.pop();continue}u=o.call(r,n)}catch(g){u=[6,g],h=0}finally{s=a=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}},nr=function(r,o){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(o,n)&&Tt(o,r,n)},Tt=Object.create?function(r,o,n,s){s===void 0&&(s=n),Object.defineProperty(r,s,{enumerable:!0,get:function(){return o[n]}})}:function(r,o,n,s){s===void 0&&(s=n),r[s]=o[n]},Pt=function(r){var o=typeof Symbol=="function"&&Symbol.iterator,n=o&&r[o],s=0;if(n)return n.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(o?"Object is not iterable.":"Symbol.iterator is not defined.")},fe=function(r,o){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var s=n.call(r),h,a=[],c;try{for(;(o===void 0||o-- >0)&&!(h=s.next()).done;)a.push(h.value)}catch(f){c={error:f}}finally{try{h&&!h.done&&(n=s.return)&&n.call(s)}finally{if(c)throw c.error}}return a},sr=function(){for(var r=[],o=0;o<arguments.length;o++)r=r.concat(fe(arguments[o]));return r},ar=function(){for(var r=0,o=0,n=arguments.length;o<n;o++)r+=arguments[o].length;for(var s=Array(r),h=0,o=0;o<n;o++)for(var a=arguments[o],c=0,f=a.length;c<f;c++,h++)s[h]=a[c];return s},hr=function(r,o){for(var n=0,s=o.length,h=r.length;n<s;n++,h++)r[h]=o[n];return r},tt=function(r){return this instanceof tt?(this.v=r,this):new tt(r)},pr=function(r,o,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=n.apply(r,o||[]),h,a=[];return h={},c("next"),c("throw"),c("return"),h[Symbol.asyncIterator]=function(){return this},h;function c(m){s[m]&&(h[m]=function(N){return new Promise(function(G,Q){a.push([m,N,G,Q])>1||f(m,N)})})}function f(m,N){try{v(s[m](N))}catch(G){D(a[0][3],G)}}function v(m){m.value instanceof tt?Promise.resolve(m.value.v).then(u,g):D(a[0][2],m)}function u(m){f("next",m)}function g(m){f("throw",m)}function D(m,N){m(N),a.shift(),a.length&&f(a[0][0],a[0][1])}},lr=function(r){var o,n;return o={},s("next"),s("throw",function(h){throw h}),s("return"),o[Symbol.iterator]=function(){return this},o;function s(h,a){o[h]=r[h]?function(c){return(n=!n)?{value:tt(r[h](c)),done:h==="return"}:a?a(c):c}:a}},cr=function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o=r[Symbol.asyncIterator],n;return o?o.call(r):(r=typeof Pt=="function"?Pt(r):r[Symbol.iterator](),n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n);function s(a){n[a]=r[a]&&function(c){return new Promise(function(f,v){c=r[a](c),h(f,v,c.done,c.value)})}}function h(a,c,f,v){Promise.resolve(v).then(function(u){a({value:u,done:f})},c)}},ur=function(r,o){return Object.defineProperty?Object.defineProperty(r,"raw",{value:o}):r.raw=o,r};var e=Object.create?function(r,o){Object.defineProperty(r,"default",{enumerable:!0,value:o})}:function(r,o){r.default=o};mr=function(r){if(r&&r.__esModule)return r;var o={};if(r!=null)for(var n in r)n!=="default"&&Object.prototype.hasOwnProperty.call(r,n)&&Tt(o,r,n);return e(o,r),o},fr=function(r){return r&&r.__esModule?r:{default:r}},dr=function(r,o){if(!o.has(r))throw new TypeError("attempted to get private field on non-instance");return o.get(r)},gr=function(r,o,n){if(!o.has(r))throw new TypeError("attempted to set private field on non-instance");return o.set(r,n),n},i("__extends",Ze),i("__assign",Qe),i("__rest",Je),i("__decorate",tr),i("__param",er),i("__metadata",rr),i("__awaiter",ir),i("__generator",or),i("__exportStar",nr),i("__createBinding",Tt),i("__values",Pt),i("__read",fe),i("__spread",sr),i("__spreadArrays",ar),i("__spreadArray",hr),i("__await",tt),i("__asyncGenerator",pr),i("__asyncDelegator",lr),i("__asyncValues",cr),i("__makeTemplateObject",ur),i("__importStar",mr),i("__importDefault",fr),i("__classPrivateFieldGet",dr),i("__classPrivateFieldSet",gr)})});var yr,H,uo,mo,fo,go,vo,xr,Ct,yo,xo,V,R,bo,Po,M,_t,br,To,Pr,So,Co,_o,Oo,Do,A=p(()=>{yr=Vi(vr(),1),{__extends:H,__assign:uo,__rest:mo,__decorate:fo,__param:go,__metadata:vo,__awaiter:xr,__generator:Ct,__exportStar:yo,__createBinding:xo,__values:V,__read:R,__spread:bo,__spreadArrays:Po,__spreadArray:M,__await:_t,__asyncGenerator:br,__asyncDelegator:To,__asyncValues:Pr,__makeTemplateObject:So,__importStar:Co,__importDefault:_o,__classPrivateFieldGet:Oo,__classPrivateFieldSet:Do}=yr.default});var Ot,de=p(()=>{Ot=function(i){return i&&typeof i.length=="number"&&typeof i!="function"}});function Dt(i){return d(i==null?void 0:i.then)}var ge=p(()=>{C()});function Et(i){var t=function(r){Error.call(r),r.stack=new Error().stack},e=i(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var ve=p(()=>{});var wt,Tr=p(()=>{ve();wt=Et(function(i){return function(e){i(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,o){return o+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}})});function ut(i,t){if(i){var e=i.indexOf(t);0<=e&&i.splice(e,1)}}var ye=p(()=>{});function Lt(i){return i instanceof et||i&&"closed"in i&&d(i.remove)&&d(i.add)&&d(i.unsubscribe)}function Sr(i){d(i)?i():i.unsubscribe()}var et,xe,Rt=p(()=>{A();C();Tr();ye();et=function(){function i(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._teardowns=null}return i.prototype.unsubscribe=function(){var t,e,r,o,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var h=V(s),a=h.next();!a.done;a=h.next()){var c=a.value;c.remove(this)}}catch(m){t={error:m}}finally{try{a&&!a.done&&(e=h.return)&&e.call(h)}finally{if(t)throw t.error}}else s.remove(this);var f=this.initialTeardown;if(d(f))try{f()}catch(m){n=m instanceof wt?m.errors:[m]}var v=this._teardowns;if(v){this._teardowns=null;try{for(var u=V(v),g=u.next();!g.done;g=u.next()){var D=g.value;try{Sr(D)}catch(m){n=n!=null?n:[],m instanceof wt?n=M(M([],R(n),!1),R(m.errors),!1):n.push(m)}}}catch(m){r={error:m}}finally{try{g&&!g.done&&(o=u.return)&&o.call(u)}finally{if(r)throw r.error}}}if(n)throw new wt(n)}},i.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)Sr(t);else{if(t instanceof i){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=(e=this._teardowns)!==null&&e!==void 0?e:[]).push(t)}},i.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},i.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},i.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&ut(e,t)},i.prototype.remove=function(t){var e=this._teardowns;e&&ut(e,t),t instanceof i&&t._removeParent(this)},i.EMPTY=function(){var t=new i;return t.closed=!0,t}(),i}(),xe=et.EMPTY});var F,mt=p(()=>{F={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1}});var rt,be=p(()=>{A();rt={setTimeout:function(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];var e=rt.delegate;return((e==null?void 0:e.setTimeout)||setTimeout).apply(void 0,M([],R(i),!1))},clearTimeout:function(i){var t=rt.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(i)},delegate:void 0}});function Mt(i){rt.setTimeout(function(){var t=F.onUnhandledError;if(t)t(i);else throw i})}var Pe=p(()=>{mt();be()});function $(){}var Te=p(()=>{});function _r(i){return Se("E",void 0,i)}function Or(i){return Se("N",i,void 0)}function Se(i,t,e){return{kind:i,value:t,error:e}}var Cr,Dr=p(()=>{Cr=function(){return Se("C",void 0,void 0)}()});function it(i){if(F.useDeprecatedSynchronousErrorHandling){var t=!z;if(t&&(z={errorThrown:!1,error:null}),i(),t){var e=z,r=e.errorThrown,o=e.error;if(z=null,r)throw o}}else i()}function Er(i){F.useDeprecatedSynchronousErrorHandling&&z&&(z.errorThrown=!0,z.error=i)}var z,Ft=p(()=>{mt();z=null});function Ce(i,t){return function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];try{i.apply(void 0,M([],R(e),!1))}catch(o){F.useDeprecatedSynchronousErrorHandling?Er(o):Mt(o)}}}function wr(i){throw i}function _e(i,t){var e=F.onStoppedNotification;e&&rt.setTimeout(function(){return e(i,t)})}var ft,Oe,zi,De=p(()=>{A();C();Rt();mt();Pe();Te();Dr();be();Ft();ft=function(i){H(t,i);function t(e){var r=i.call(this)||this;return r.isStopped=!1,e?(r.destination=e,Lt(e)&&e.add(r)):r.destination=zi,r}return t.create=function(e,r,o){return new Oe(e,r,o)},t.prototype.next=function(e){this.isStopped?_e(Or(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?_e(_r(e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?_e(Cr,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(et),Oe=function(i){H(t,i);function t(e,r,o){var n=i.call(this)||this,s;if(d(e))s=e;else if(e){s=e.next,r=e.error,o=e.complete;var h;n&&F.useDeprecatedNextContext?(h=Object.create(e),h.unsubscribe=function(){return n.unsubscribe()}):h=e,s=s==null?void 0:s.bind(h),r=r==null?void 0:r.bind(h),o=o==null?void 0:o.bind(h)}return n.destination={next:s?Ce(s,n):$,error:Ce(r!=null?r:wr,n),complete:o?Ce(o,n):$},n}return t}(ft);zi={closed:!0,next:$,error:wr,complete:$}});var ot,It=p(()=>{ot=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function At(i){return i}var Ee=p(()=>{});function Lr(i){return i.length===0?At:i.length===1?i[0]:function(e){return i.reduce(function(r,o){return o(r)},e)}}var Rr=p(()=>{Ee()});function Mr(i){var t;return(t=i!=null?i:F.Promise)!==null&&t!==void 0?t:Promise}function Yi(i){return i&&d(i.next)&&d(i.error)&&d(i.complete)}function qi(i){return i&&i instanceof ft||Yi(i)&&Lt(i)}var b,Y=p(()=>{De();Rt();It();Rr();mt();C();Ft();b=function(){function i(t){t&&(this._subscribe=t)}return i.prototype.lift=function(t){var e=new i;return e.source=this,e.operator=t,e},i.prototype.subscribe=function(t,e,r){var o=this,n=qi(t)?t:new Oe(t,e,r);return it(function(){var s=o,h=s.operator,a=s.source;n.add(h?h.call(n,a):a?o._subscribe(n):o._trySubscribe(n))}),n},i.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},i.prototype.forEach=function(t,e){var r=this;return e=Mr(e),new e(function(o,n){var s;s=r.subscribe(function(h){try{t(h)}catch(a){n(a),s==null||s.unsubscribe()}},n,o)})},i.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},i.prototype[ot]=function(){return this},i.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Lr(t)(this)},i.prototype.toPromise=function(t){var e=this;return t=Mr(t),new t(function(r,o){var n;e.subscribe(function(s){return n=s},function(s){return o(s)},function(){return r(n)})})},i.create=function(t){return new i(t)},i}()});function kt(i){return d(i[ot])}var we=p(()=>{It();C()});function Nt(i){return Symbol.asyncIterator&&d(i==null?void 0:i[Symbol.asyncIterator])}var Le=p(()=>{C()});function Gt(i){return new TypeError("You provided "+(i!==null&&typeof i=="object"?"an invalid object":"'"+i+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var Re=p(()=>{});function Xi(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Wt,Me=p(()=>{Wt=Xi()});function Bt(i){return d(i==null?void 0:i[Wt])}var Fe=p(()=>{Me();C()});function Ut(i){return br(this,arguments,function(){var e,r,o,n;return Ct(this,function(s){switch(s.label){case 0:e=i.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,_t(e.read())];case 3:return r=s.sent(),o=r.value,n=r.done,n?[4,_t(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,_t(o)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Ht(i){return d(i==null?void 0:i.getReader)}var jt=p(()=>{A();C()});function E(i){if(i instanceof b)return i;if(i!=null){if(kt(i))return Ki(i);if(Ot(i))return Zi(i);if(Dt(i))return Qi(i);if(Nt(i))return Fr(i);if(Bt(i))return Ji(i);if(Ht(i))return to(i)}throw Gt(i)}function Ki(i){return new b(function(t){var e=i[ot]();if(d(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Zi(i){return new b(function(t){for(var e=0;e<i.length&&!t.closed;e++)t.next(i[e]);t.complete()})}function Qi(i){return new b(function(t){i.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,Mt)})}function Ji(i){return new b(function(t){var e,r;try{for(var o=V(i),n=o.next();!n.done;n=o.next()){var s=n.value;if(t.next(s),t.closed)return}}catch(h){e={error:h}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}t.complete()})}function Fr(i){return new b(function(t){eo(i,t).catch(function(e){return t.error(e)})})}function to(i){return Fr(Ut(i))}function eo(i,t){var e,r,o,n;return xr(this,void 0,void 0,function(){var s,h;return Ct(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),e=Pr(i),a.label=1;case 1:return[4,e.next()];case 2:if(r=a.sent(),!!r.done)return[3,4];if(s=r.value,t.next(s),t.closed)return[2];a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return h=a.sent(),o={error:h},[3,11];case 6:return a.trys.push([6,,9,10]),r&&!r.done&&(n=e.return)?[4,n.call(e)]:[3,8];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}var q=p(()=>{A();de();ge();Y();we();Le();Re();Fe();jt();C();Pe();It()});var _,X=p(()=>{A();De();_=function(i){H(t,i);function t(e,r,o,n,s){var h=i.call(this,e)||this;return h.onFinalize=s,h._next=r?function(a){try{r(a)}catch(c){e.error(c)}}:i.prototype._next,h._error=n?function(a){try{n(a)}catch(c){e.error(c)}finally{this.unsubscribe()}}:i.prototype._error,h._complete=o?function(){try{o()}catch(a){e.error(a)}finally{this.unsubscribe()}}:i.prototype._complete,h}return t.prototype.unsubscribe=function(){var e,r=this.closed;i.prototype.unsubscribe.call(this),!r&&((e=this.onFinalize)===null||e===void 0||e.call(this))},t}(ft)});function Ir(i){return i&&d(i.schedule)}var Ar=p(()=>{C()});function kr(i){return i[i.length-1]}function Nr(i){return Ir(kr(i))?i.pop():void 0}function Gr(i,t){return typeof kr(i)=="number"?i.pop():t}var Wr=p(()=>{Ar()});function w(i,t,e,r,o){r===void 0&&(r=0),o===void 0&&(o=!1);var n=t.schedule(function(){e(),o?i.add(this.schedule(null,r)):this.unsubscribe()},r);if(i.add(n),!o)return n}var dt=p(()=>{});function Vt(i,t){return t===void 0&&(t=0),T(function(e,r){e.subscribe(new _(r,function(o){return w(r,i,function(){return r.next(o)},t)},function(){return w(r,i,function(){return r.complete()},t)},function(o){return w(r,i,function(){return r.error(o)},t)}))})}var Ie=p(()=>{dt();W();X()});function $t(i,t){return t===void 0&&(t=0),T(function(e,r){r.add(i.schedule(function(){return e.subscribe(r)},t))})}var Ae=p(()=>{W()});function Br(i,t){return E(i).pipe($t(t),Vt(t))}var Ur=p(()=>{q();Ie();Ae()});function Hr(i,t){return E(i).pipe($t(t),Vt(t))}var jr=p(()=>{q();Ie();Ae()});function Vr(i,t){return new b(function(e){var r=0;return t.schedule(function(){r===i.length?e.complete():(e.next(i[r++]),e.closed||this.schedule())})})}var $r=p(()=>{Y()});function zr(i,t){return new b(function(e){var r;return w(e,t,function(){r=i[Wt](),w(e,t,function(){var o,n,s;try{o=r.next(),n=o.value,s=o.done}catch(h){e.error(h);return}s?e.complete():e.next(n)},0,!0)}),function(){return d(r==null?void 0:r.return)&&r.return()}})}var Yr=p(()=>{Y();Me();C();dt()});function zt(i,t){if(!i)throw new Error("Iterable cannot be null");return new b(function(e){w(e,t,function(){var r=i[Symbol.asyncIterator]();w(e,t,function(){r.next().then(function(o){o.done?e.complete():e.next(o.value)})},0,!0)})})}var ke=p(()=>{Y();dt()});function qr(i,t){return zt(Ut(i),t)}var Xr=p(()=>{ke();jt()});function Kr(i,t){if(i!=null){if(kt(i))return Br(i,t);if(Ot(i))return Vr(i,t);if(Dt(i))return Hr(i,t);if(Nt(i))return zt(i,t);if(Bt(i))return zr(i,t);if(Ht(i))return qr(i,t)}throw Gt(i)}var Zr=p(()=>{Ur();jr();$r();Yr();ke();we();ge();de();Fe();Le();Re();jt();Xr()});function Qr(i,t){return t?Kr(i,t):E(i)}var Jr=p(()=>{Zr();q()});function K(i,t){return T(function(e,r){var o=0;e.subscribe(new _(r,function(n){r.next(i.call(t,n,o++))}))})}var Ne=p(()=>{W();X()});function ti(i,t,e,r,o,n,s,h){var a=[],c=0,f=0,v=!1,u=function(){v&&!a.length&&!c&&t.complete()},g=function(m){return c<r?D(m):a.push(m)},D=function(m){n&&t.next(m),c++;var N=!1;E(e(m,f++)).subscribe(new _(t,function(G){o==null||o(G),n?g(G):t.next(G)},function(){N=!0},void 0,function(){if(N)try{c--;for(var G=function(){var Q=a.shift();s?w(t,s,function(){return D(Q)}):D(Q)};a.length&&c<r;)G();u()}catch(Q){t.error(Q)}}))};return i.subscribe(new _(t,g,function(){v=!0,u()})),function(){h==null||h()}}var ei=p(()=>{q();dt();X()});function Ge(i,t,e){return e===void 0&&(e=1/0),d(t)?Ge(function(r,o){return K(function(n,s){return t(r,n,o,s)})(E(i(r,o)))},e):(typeof t=="number"&&(e=t),T(function(r,o){return ti(r,o,i,e)}))}var ri=p(()=>{Ne();q();W();ei();C()});function ii(i){return i.length===1&&ro(i[0])?i[0]:i}var ro,oi=p(()=>{ro=Array.isArray});function ni(i){return i===void 0&&(i=1/0),Ge(At,i)}var si=p(()=>{ri();Ee()});var ai,hi=p(()=>{ve();ai=Et(function(i){return function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})});var y,pi,li=p(()=>{A();Y();Rt();hi();ye();Ft();y=function(i){H(t,i);function t(){var e=i.call(this)||this;return e.closed=!1,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var r=new pi(this,this);return r.operator=e,r},t.prototype._throwIfClosed=function(){if(this.closed)throw new ai},t.prototype.next=function(e){var r=this;it(function(){var o,n;if(r._throwIfClosed(),!r.isStopped){var s=r.observers.slice();try{for(var h=V(s),a=h.next();!a.done;a=h.next()){var c=a.value;c.next(e)}}catch(f){o={error:f}}finally{try{a&&!a.done&&(n=h.return)&&n.call(h)}finally{if(o)throw o.error}}}})},t.prototype.error=function(e){var r=this;it(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var o=r.observers;o.length;)o.shift().error(e)}})},t.prototype.complete=function(){var e=this;it(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var r=e.observers;r.length;)r.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),i.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var r=this,o=r.hasError,n=r.isStopped,s=r.observers;return o||n?xe:(s.push(e),new et(function(){return ut(s,e)}))},t.prototype._checkFinalizedStatuses=function(e){var r=this,o=r.hasError,n=r.thrownError,s=r.isStopped;o?e.error(n):s&&e.complete()},t.prototype.asObservable=function(){var e=new b;return e.source=this,e},t.create=function(e,r){return new pi(e,r)},t}(b),pi=function(i){H(t,i);function t(e,r){var o=i.call(this)||this;return o.destination=e,o.source=r,o}return t.prototype.next=function(e){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.next)===null||o===void 0||o.call(r,e)},t.prototype.error=function(e){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.error)===null||o===void 0||o.call(r,e)},t.prototype.complete=function(){var e,r;(r=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||r===void 0||r.call(e)},t.prototype._subscribe=function(e){var r,o;return(o=(r=this.source)===null||r===void 0?void 0:r.subscribe(e))!==null&&o!==void 0?o:xe},t}(y)});var ci,ui=p(()=>{Y();ci=new b(function(i){return i.complete()})});function nt(i){return i<=0?function(){return ci}:T(function(t,e){var r=0;t.subscribe(new _(e,function(o){++r<=i&&(e.next(o),i<=r&&e.complete())}))})}var We=p(()=>{ui();W();X()});function B(i,t){return T(function(e,r){var o=0;e.subscribe(new _(r,function(n){return i.call(t,n,o++)&&r.next(n)}))})}var Be=p(()=>{W();X()});function mi(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];var e=Nr(i),r=Gr(i,1/0);return i=ii(i),T(function(o,n){ni(r)(Qr(M([o],R(i),!1),e)).subscribe(n)})}var fi=p(()=>{A();W();oi();si();Wr();Jr()});function Ue(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];return mi.apply(void 0,M([],R(i),!1))}var di=p(()=>{A();fi()});function Z(i){return T(function(t,e){E(i).subscribe(new _(e,function(){return e.complete()},$)),!e.closed&&t.subscribe(e)})}var gi=p(()=>{W();X();q();Te()});var Yt=p(()=>{Be();Ne();di();We();gi()});var l,k=p(()=>{l=class{static get ZERO(){return new l(0,0)}static get ONE(){return new l(1,1)}static get UP(){return new l(0,-1)}static get DOWN(){return new l(0,1)}static get LEFT(){return new l(-1,0)}static get RIGHT(){return new l(1,0)}static get UP_LEFT(){return new l(-1,-1)}static get UP_RIGHT(){return new l(1,-1)}static get DOWN_RIGHT(){return new l(1,1)}static get DOWN_LEFT(){return new l(-1,1)}constructor(t,e){typeof t=="number"?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new l(this.x,this.y)}add(t){return new l(this.x+t.x,this.y+t.y)}multiply(t){return new l(this.x*t.x,this.y*t.y)}divide(t){return new l(this.x/t.x,this.y/t.y)}subtract(t){return new l(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}abs(){return new l(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}modulo(t){return new l(this.x%t.x,this.y%t.y)}scalarModulo(t){return new l(this.x%t,this.y%t)}scalarMult(t){return new l(this.x*t,this.y*t)}toString(){return`${this.x}#${this.y}`}}});function He(i){return["down-left","down-right","up-right","up-left"].includes(i)}function vi(i){return{["left"]:"down-left",["up-left"]:"left",["up"]:"up-left",["up-right"]:"up",["right"]:"up-right",["down-right"]:"right",["down"]:"down-right",["down-left"]:"down",["none"]:"none"}[i]}function j(i){return{["up"]:l.UP,["down"]:l.DOWN,["left"]:l.LEFT,["right"]:l.RIGHT,["none"]:l.ZERO,["up-left"]:l.UP_LEFT,["up-right"]:l.UP_RIGHT,["down-right"]:l.DOWN_RIGHT,["down-left"]:l.DOWN_LEFT}[i]}function yi(i){return{["up"]:"down",["down"]:"up",["left"]:"right",["right"]:"left",["none"]:"none",["up-left"]:"down-right",["up-right"]:"down-left",["down-right"]:"up-left",["down-left"]:"up-right"}[i]}var O=p(()=>{k()});var x,qt=p(()=>{x=class{static equal(t,e){return t.position.x===e.position.x&&t.position.y===e.position.y&&t.layer===e.layer}static copyOver(t,e){e.position.x=t.position.x,e.position.y=t.position.y,e.layer=t.layer}static clone(t){return{position:t.position.clone(),layer:t.layer}}static toString(t){return`${t.position.toString()}#${t.layer}`}}});var S,gt=p(()=>{k();S=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return S.vec2str(t)==S.vec2str(e)}static manhattanDistance(t,e){let r=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return r+o}static chebyshevDistance(t,e){let r=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y);return Math.max(r,o)}static scalarMult(t,e){return t.clone().multiply(new l(e,e))}}});var Xt,Kt,xi=p(()=>{Xt=class{constructor(t){this.data=t}},Kt=class{constructor(){this.sizeInternal=0}dequeue(){if(this.tail===void 0)return;this.sizeInternal--;let t=this.tail.data;return this.tail.prev===void 0?(this.tail=void 0,this.head=void 0,t):(this.tail.prev.next=void 0,this.tail=this.tail.prev,t)}enqueue(t){if(this.sizeInternal++,this.head===void 0){this.head=new Xt(t),this.tail=this.head;return}let e=new Xt(t);e.next=this.head,this.head.prev=e,this.head=e}peek(){return this.tail?this.tail.data:void 0}size(){return this.sizeInternal}}});var Zt,Qt,bi=p(()=>{qt();gt();xi();Zt=class{constructor(){this.previous=new Map;this.visited=new Map;this.queue=new Kt}step(t,e,r){for(let o of t)this.visited.has(x.toString(o))||(this.previous.set(x.toString(o),e),this.queue.enqueue({node:o,dist:r+1}),this.visited.set(x.toString(o),r+1))}},Qt=class{getShortestPath(t,e,r){let o=this.shortestPathBfs(t,e,r);return{path:this.returnPath(o.previous,o.previous2,o.matchingPos,t,e),closestToTarget:o.closestToTarget}}distance(t,e){return S.manhattanDistance(t.position,e.position)}equal(t,e){return S.equal(t.position,e.position)?t.layer===e.layer:!1}shortestPathBfs(t,e,r){let o=new Zt,n=new Zt;o.otherBfs=n,n.otherBfs=o;let s=t,h=this.distance(t,e);for(o.queue.enqueue({node:t,dist:0}),n.queue.enqueue({node:e,dist:0}),o.visited.set(x.toString(t),0),n.visited.set(x.toString(e),0);o.queue.size()>0&&n.queue.size()>0;){let{node:a,dist:c}=o.queue.dequeue(),f=this.distance(a,e);if(f<h&&(h=f,s=a),n.visited.has(x.toString(a)))return{shortestDistance:c+n.visited.get(x.toString(a)),previous:o.previous,previous2:n.previous,closestToTarget:e,matchingPos:a};o.step(r(a),a,c);let{node:v,dist:u}=n.queue.dequeue();if(o.visited.has(x.toString(v)))return{shortestDistance:u+o.visited.get(x.toString(v)),previous:o.previous,previous2:n.previous,closestToTarget:e,matchingPos:v};n.step(r(v),v,u)}return{shortestDistance:-1,previous:o.previous,previous2:n.previous,closestToTarget:s}}returnPath(t,e,r,o,n){if(r){let s=this.getPathFromPrev(t,o,r).reverse(),h=this.getPathFromPrev(e,n,r);return s.pop(),[...s,...h]}else return this.getPathFromPrev(t,o,n).reverse()}getPathFromPrev(t,e,r){let o=[],n=r;for(o.push(n);!this.equal(n,e);){if(n=t.get(x.toString(n)),!n)return[];o.push(n)}return o}}});var vt,Jt=p(()=>{vt=(r=>(r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY",r))(vt||{})});var te,Pi=p(()=>{gt();O();k();te=class{distance(t,e){return S.manhattanDistance(t,e)}direction(t,e){if(S.equal(t,e))return"none";let r=t.clone().subtract(e);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?"left":"right":r.y>0?"up":"down"}neighbours(t){return[new l(t.x,t.y+1),new l(t.x+1,t.y),new l(t.x-1,t.y),new l(t.x,t.y-1)]}getDirections(){return["up","right","down","left"]}}});var ee,Ti=p(()=>{gt();O();k();ee=class{distance(t,e){return S.chebyshevDistance(t,e)}neighbours(t){let e=[new l(t.x,t.y+1),new l(t.x+1,t.y),new l(t.x-1,t.y),new l(t.x,t.y-1)],r=[new l(t.x+1,t.y+1),new l(t.x+1,t.y-1),new l(t.x-1,t.y+1),new l(t.x-1,t.y-1)];return[...e,...r]}direction(t,e){return e.x>t.x?e.y>t.y?"down-right":e.y<t.y?"up-right":"right":e.x<t.x?e.y>t.y?"down-left":e.y<t.y?"up-left":"left":e.y<t.y?"up":e.y>t.y?"down":"none"}getDirections(){return["up","right","down","left","down-left","down-right","up-right","up-left"]}}});var at,je=p(()=>{Pi();O();Ti();at=class{static create(t){switch(t){case 4:return new te;case 8:return new ee}}}});var yt,Si=p(()=>{yt=class{constructor(t,e,r){this.backoffMs=t;this.maxRetries=e;this.onFinished=r;this.retries=0;this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}}});var ie,Ve=p(()=>{ie=(r=>(r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP",r))(ie||{})});var Ci=p(()=>{});var oe=p(()=>{li();Ci();Be();We()});var ht,$e=p(()=>{bi();Jt();je();O();Si();Ve();oe();qt();ht=class{constructor(t,e,r,{numberOfDirections:o=4,config:n,ignoreBlockedTarget:s=!1,distance:h=0}={}){this.character=t;this.tilemap=e;this.targetPos=r;this.posOnPath=0;this.stopped=!1;this.getNeighbours=t=>this.distanceUtils.neighbours(t.position).map(o=>{let n=this.tilemap.getTransition(o,t.layer);return{position:o,layer:n||t.layer}}).filter(o=>!this.isBlocking(o.position,o.layer)||this.ignoreBlockedTarget&&x.equal(o,this.targetPos));this.isBlocking=(t,e)=>{var r;return!t||!this.tilemap.isInRange(t)?!0:(r=this.character)!=null&&r.collidesWithTiles()?this.tilemap.isBlocking(e,t,this.character.getCollisionGroups()):this.tilemap.hasBlockingChar(t,e,this.character.getCollisionGroups())};this.ignoreBlockedTarget=s,this.distance=h,this.noPathFoundStrategy=(n==null?void 0:n.noPathFoundStrategy)||"STOP",this.pathBlockedStrategy=(n==null?void 0:n.pathBlockedStrategy)||"WAIT",this.noPathFoundRetryable=new yt((n==null?void 0:n.noPathFoundRetryBackoffMs)||200,(n==null?void 0:n.noPathFoundMaxRetries)||-1,()=>{this.stop("NO_PATH_FOUND_MAX_RETRIES_EXCEEDED")}),this.pathBlockedRetryable=new yt((n==null?void 0:n.pathBlockedRetryBackoffMs)||200,(n==null?void 0:n.pathBlockedMaxRetries)||-1,()=>{this.stop("PATH_BLOCKED_MAX_RETRIES_EXCEEDED")}),this.distanceUtils=at.create(o),this.pathBlockedWaitTimeoutMs=(n==null?void 0:n.pathBlockedWaitTimeoutMs)||-1,this.finished$=new y,this.setCharacter(t)}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(nt(1),B(e=>e!==this)).subscribe(()=>{this.stop("MOVEMENT_TERMINATED")})}update(t){var e,r,o,n;this.stopped||(this.noPathFound()&&(this.noPathFoundStrategy==="RETRY"?this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()):this.noPathFoundStrategy==="STOP"&&this.stop("NO_PATH_FOUND")),this.updatePosOnPath(),this.isBlocking((e=this.nextTileOnPath())==null?void 0:e.position,(r=this.character)==null?void 0:r.getNextTilePos().layer)?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop("SUCCESS"),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking((o=this.nextTileOnPath())==null?void 0:o.position,(n=this.character)==null?void 0:n.getNextTilePos().layer)||this.moveCharOnPath())}finishedObs(){return this.finished$}resultToReason(t){switch(t){case"SUCCESS":return"Successfully arrived.";case"MOVEMENT_TERMINATED":return"Movement of character has been replaced before destination was reached.";case"PATH_BLOCKED":return"PathBlockedStrategy STOP: Path blocked.";case"NO_PATH_FOUND_MAX_RETRIES_EXCEEDED":return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case"NO_PATH_FOUND":return"NoPathFoundStrategy STOP: No path found.";case"PATH_BLOCKED_MAX_RETRIES_EXCEEDED":return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case"PATH_BLOCKED_WAIT_TIMEOUT":return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`}}applyPathBlockedStrategy(t){this.pathBlockedStrategy==="RETRY"?this.pathBlockedRetryable.retry(t,()=>this.calcShortestPath()):this.pathBlockedStrategy==="STOP"?this.stop("PATH_BLOCKED"):this.pathBlockedStrategy==="WAIT"&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop("PATH_BLOCKED_WAIT_TIMEOUT"))}moveCharOnPath(){let t=this.getDir(this.character.getNextTilePos().position,this.nextTileOnPath().position);this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(t){this.finished$.next({position:this.character.getTilePos().position,result:t,description:this.resultToReason(t),layer:this.character.getTilePos().layer}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos().position,t.position);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().position.x!=t.position.x||this.character.getNextTilePos().position.y!=t.position.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(){let t=this.getShortestPath();this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new Qt,{path:e,closestToTarget:r}=t.getShortestPath(this.character.getNextTilePos(),this.targetPos,this.getNeighbours);if(e.length==0&&this.noPathFoundStrategy==="CLOSEST_REACHABLE"){let n=t.getShortestPath(this.character.getNextTilePos(),r,this.getNeighbours).path,s=this.distanceUtils.distance(r.position,this.targetPos.position);return{path:n,distOffset:s}}return{path:e,distOffset:0}}getDir(t,e){return this.distanceUtils.direction(t,e)}}});var ne,_i=p(()=>{Yt();O();$e();k();Jt();ne=class{constructor(t,e,r,o=4,n=0,s="STOP"){this.character=t;this.gridTilemap=e;this.charToFollow=r;this.numberOfDirections=o;this.distance=n;this.noPathFoundStrategy=s;this.character=t,this.updateTarget(this.charToFollow.getTilePos().position,this.charToFollow.getTilePos().layer),this.charToFollow.positionChangeStarted().pipe(Z(this.character.autoMovementSet().pipe(B(h=>h!==this)))).subscribe(({enterTile:h,enterLayer:a})=>{this.updateTarget(h,a)})}update(t){var e;(e=this.targetMovement)==null||e.update(t)}updateTarget(t,e){this.targetMovement=new ht(this.character,this.gridTilemap,{position:new l(t),layer:e},{numberOfDirections:this.numberOfDirections,distance:this.distance+1,config:{noPathFoundStrategy:this.noPathFoundStrategy},ignoreBlockedTarget:!0})}}});var lt,pt,Oi=p(()=>{O();lt=class{constructor(t,e,r){this.sprite=t;this.walkingAnimationMapping=e;this.characterIndex=r;this.lastFootLeft=!1;this.directionToFrameRow={["down"]:0,["down-left"]:1,["down-right"]:2,["left"]:1,["right"]:2,["up"]:3,["up-left"]:1,["up-right"]:2};this._isEnabled=!0}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t,this._isEnabled=this.walkingAnimationMapping!==void 0}setCharacterIndex(t){this.characterIndex=t,this._isEnabled=this.characterIndex!==-1}getWalkingAnimationMapping(){return this.walkingAnimationMapping}getCharacterIndex(){return this.characterIndex}setStandingFrameDuringWalk(t){this.isCurrentFrameStanding(t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);this.sprite.setFrame(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){this.sprite.setFrame(this.framesOfDirection(t).standing)}isCurrentFrameStanding(t){return Number(this.sprite.frame.name)==this.framesOfDirection(t).standing}framesOfDirection(t){return this.walkingAnimationMapping?this.getFramesForAnimationMapping(t):this.getFramesForCharIndex(t)}getFramesForAnimationMapping(t){return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case"down-left":return"left";case"down-right":return"right";case"up-left":return"left";case"up-right":return"right"}return t}getFramesForCharIndex(t){let e=this.sprite.texture.source[0].width/this.sprite.width/lt.FRAMES_CHAR_ROW,r=Math.floor(this.characterIndex/e),o=this.characterIndex%e,n=e*lt.FRAMES_CHAR_ROW,s=lt.FRAMES_CHAR_ROW*o,h=this.directionToFrameRow[t]+r*lt.FRAMES_CHAR_COL,a=s+h*n;return{rightFoot:a,standing:a+1,leftFoot:a+2}}},pt=lt;pt.FRAMES_CHAR_ROW=3,pt.FRAMES_CHAR_COL=4});var ct,ze=p(()=>{ct=class{static shiftPad(t,e){let r=Math.floor(t),n=`${r}`.padStart(e,"0").length;return r/Math.pow(10,n)}}});var se,Di=p(()=>{se=class{static copyOverImportantProperties(t,e){e.x=t.x,e.y=t.y,e.tint=t.tint,e.alpha=t.alpha,e.scale=t.scale,e.setFrame(t.frame.name),e.active=t.active,e.alphaBottomLeft=t.alphaBottomLeft,e.alphaBottomRight=t.alphaBottomRight,e.alphaTopLeft=t.alphaTopLeft,e.alphaTopRight=t.alphaTopRight,e.angle=t.angle}}});var ae,Ei=p(()=>{qt();Oi();O();O();oe();k();ze();Di();ae=class{constructor(t,e){this.id=t;this.movementDirection="none";this.tileSizePixelsWalked=l.ZERO;this._nextTilePos={position:new l(0,0),layer:void 0};this._tilePos={position:new l(0,0),layer:void 0};this.movementStarted$=new y;this.movementStopped$=new y;this.directionChanged$=new y;this.positionChangeStarted$=new y;this.positionChangeFinished$=new y;this.tilePositionSet$=new y;this.autoMovementSet$=new y;this.lastMovementImpulse="none";this.facingDirection="down";this.characterIndex=-1;typeof e.walkingAnimationMapping=="number"?this.characterIndex=e.walkingAnimationMapping:this.walkingAnimationMapping=e.walkingAnimationMapping,this.container=e.container,this.tilemap=e.tilemap,this.speed=e.speed,this.collidesWithTilesInternal=e.collidesWithTiles,this.customOffset=new l(e.offsetX||0,e.offsetY||0),this._tilePos.layer=e.charLayer,this.sprite=e.sprite,this.layerOverlaySprite=e.layerOverlaySprite,this.collisionGroups=new Set(e.collisionGroups||[]),this.layerOverlaySprite&&this.initLayerOverlaySprite(),this._setSprite(this.sprite)}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}getSprite(){return this.sprite}setSprite(t){this._setSprite(t)}setMovement(t){this.autoMovementSet$.next(t),this.movement=t}getMovement(){return this.movement}collidesWithTiles(){return this.collidesWithTilesInternal}setWalkingAnimationMapping(t){typeof t=="number"?this.animation.setCharacterIndex(t):this.animation.setWalkingAnimationMapping(t)}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.tilePositionSet$.next(I({},t)),this.nextTilePos=t,this.fire(this.positionChangeStarted$,this.tilePos,this.nextTilePos),this.fire(this.positionChangeFinished$,this.tilePos,this.nextTilePos),this.movementDirection="none",this.lastMovementImpulse="none",this.tilePos=t,this.setPosition(this.tilemap.tilePosToPixelPos(t.position).add(this.getOffset()).add(this.customOffset)),this.updateZindex()}getTilePos(){return this.tilePos}getNextTilePos(){return this.nextTilePos}move(t){this.lastMovementImpulse=t,t!="none"&&(this.isMoving()||(this.isBlockingDirection(t)?(this.facingDirection=t,this.animation.setStandingFrame(t),this.directionChanged$.next(t)):this.startMoving(t)))}update(t){var e,r,o;(e=this.movement)==null||e.update(t),this.isMoving()&&(this.updateCharacterPosition(t),this.updateZindex()),this.lastMovementImpulse="none",this.layerOverlaySprite&&(se.copyOverImportantProperties(this.sprite,this.layerOverlaySprite),this.layerOverlaySprite.x=this.sprite.x+(((r=this.container)==null?void 0:r.x)||0),this.layerOverlaySprite.y=this.sprite.y+(((o=this.container)==null?void 0:o.y)||0))}getMovementDirection(){return this.movementDirection}isBlockingDirection(t){if(t=="none")return!1;let e=this.tilePosInDirection(t),r=this.tilemap.getTransition(e,this.nextTilePos.layer)||this.nextTilePos.layer;return this.collidesWithTilesInternal&&this.tilemap.hasBlockingTile(r,e,yi(t))?!0:this.tilemap.hasBlockingChar(e,r,this.getCollisionGroups())}isMoving(){return this.movementDirection!="none"}turnTowards(t){this.isMoving()||t!="none"&&(this.facingDirection=t,this.animation.setStandingFrame(t))}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.position.add(j(this.facingDirection))}addCollisionGroup(t){this.collisionGroups.add(t)}setCollisionGroups(t){this.collisionGroups=new Set(t)}getCollisionGroups(){return Array.from(this.collisionGroups)}hasCollisionGroup(t){return this.collisionGroups.has(t)}removeCollisionGroup(t){this.collisionGroups.delete(t)}removeAllCollisionGroups(){this.collisionGroups.clear()}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}tilePositionSet(){return this.tilePositionSet$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}_setSprite(t){t.setOrigin(0,0),t.x=this.sprite.x,t.y=this.sprite.y,this.sprite=t,this.animation=new pt(this.sprite,this.walkingAnimationMapping,this.characterIndex),this.animation.setIsEnabled(this.walkingAnimationMapping!==void 0||this.characterIndex!==-1),this.animation.setStandingFrame("down"),this.updateZindex()}getOffset(){let t=this.tilemap.getTileWidth()/2-Math.floor(this.sprite.displayWidth/2),e=-this.sprite.displayHeight+this.tilemap.getTileHeight();return new l(t,e)}updateCharacterPosition(t){let e=this.getSpeedPerDelta(t),r=this.getDistToNextTile(),o=r.length()<=e.length(),n=o?r:e;this.moveCharacterSprite(n),o&&(this.shouldContinueMoving()?(this.fire(this.positionChangeFinished$,this.tilePos,this.nextTilePos),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(t*this.getProportionWalked(e,r))):this.stopMoving())}speedPixelsPerSecond(t){return j(t).abs().multiply(this.tilemap.getTileDistance(t)).scalarMult(this.speed)}get nextTilePos(){return{position:this._nextTilePos.position.clone(),layer:this._nextTilePos.layer}}set nextTilePos(t){x.copyOver(t,this._nextTilePos)}get tilePos(){return x.clone(this._tilePos)}set tilePos(t){x.copyOver(t,this._tilePos)}gameObject(){return this.container||this.sprite}updateZindex(){if(this.setDepth(this.gameObject(),this.nextTilePos),this.layerOverlaySprite){let t=new l(J(I({},this.nextTilePos.position),{y:this.nextTilePos.position.y-1}));this.setDepth(this.layerOverlaySprite,{position:t,layer:this.nextTilePos.layer})}}setDepth(t,e){t.setDepth(this.tilemap.getDepthOfCharLayer(this.getTransitionLayer(e))+this.getPaddedPixelDepth())}getPaddedPixelDepth(){return ct.shiftPad(this.gameObject().y+this.gameObject().displayHeight,7)}getTransitionLayer(t){return this.tilemap.getTransition(t.position,t.layer)||t.layer}setPosition(t){this.gameObject().x=t.x,this.gameObject().y=t.y}getPosition(){return new l(this.gameObject().x,this.gameObject().y)}startMoving(t){t!=="none"&&(t!=this.movementDirection&&this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.updateTilePos())}updateTilePos(){this.tilePos=this.nextTilePos;let t=this.tilePosInDirection(this.movementDirection),r=this.tilemap.getTransition(t,this.tilePos.layer)||this.tilePos.layer;this.nextTilePos={position:t,layer:r},this.fire(this.positionChangeStarted$,this.tilePos,this.nextTilePos)}tilePosInDirection(t){return this.nextTilePos.position.add(j(this.tilemap.toMapDirection(t)))}getDistToNextTile(){return this.tilemap.getTileDistance(this.movementDirection).subtract(this.tileSizePixelsWalked).multiply(j(this.movementDirection))}getProportionWalked(t,e){let o=t.subtract(e).divide(t);return isNaN(o.x)&&(o.x=0),Math.max(Math.abs(o.x),Math.abs(o.y))}shouldContinueMoving(){return this.lastMovementImpulse!=="none"&&!this.isBlockingDirection(this.lastMovementImpulse)}getSpeedPerDelta(t){let e=t/1e3;return this.speedPixelsPerSecond(this.movementDirection).scalarMult(e).multiply(j(this.movementDirection))}moveCharacterSprite(t){let e=this.getPosition().add(t);this.setPosition(e),this.tileSizePixelsWalked=this.tileSizePixelsWalked.add(t.abs()),this.animation.updateCharacterFrame(this.movementDirection,this.hasWalkedHalfATile()),this.tileSizePixelsWalked=this.tileSizePixelsWalked.modulo(this.tilemap.getTileDistance(this.movementDirection))}stopMoving(){if(this.movementDirection==="none")return;let t=this.tilePos,e=this.nextTilePos,r=this.movementDirection;this.tilePos=this.nextTilePos,this.movementDirection="none",this.movementStopped$.next(r),this.fire(this.positionChangeFinished$,t,e)}hasWalkedHalfATile(){return this.tileSizePixelsWalked.x>this.tilemap.getTileDistance(this.movementDirection).x/2||this.tileSizePixelsWalked.y>this.tilemap.getTileDistance(this.movementDirection).y/2}fire(t,{position:e,layer:r},{position:o,layer:n}){t.next({exitTile:e,enterTile:o,exitLayer:r,enterLayer:n})}initLayerOverlaySprite(){this.layerOverlaySprite.scale=this.sprite.scale;let t=this.tilemap.getTileHeight()/this.layerOverlaySprite.scale;this.layerOverlaySprite.setCrop(0,0,this.layerOverlaySprite.displayWidth,this.sprite.height-t),this.layerOverlaySprite.setOrigin(0,0)}}});var he,wi=p(()=>{bt();me();he=class{constructor(){this.tilePosToCharacters=new Map;this.positionChangeStartedSubs=new Map;this.tilePosSetSubs=new Map;this.positionChangeFinishedSubs=new Map}isCharBlockingAt(t,e,r){let o=this.posToString(t,e);return this.tilePosToCharacters.has(o)&&this.tilePosToCharacters.get(o).size>0&&[...this.tilePosToCharacters.get(o)].some(n=>n.getCollisionGroups().some(s=>r.includes(s)))}getCharactersAt(t,e){let r=this.posToString(t,e),o=this.tilePosToCharacters.get(r);return new Set(o)}addCharacter(t){this.add(this.posToString(t.getTilePos().position,t.getTilePos().layer),t),this.add(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer),t),this.addPositionChangeSub(t),this.addPositionChangeFinishedSub(t),this.addTilePosSetSub(t)}removeCharacter(t){let e=t.getId();this.positionChangeStartedSubs.get(e).unsubscribe(),this.positionChangeFinishedSubs.get(e).unsubscribe(),this.tilePosSetSubs.get(e).unsubscribe(),this.tilePosToCharacters.get(this.posToString(t.getTilePos().position,t.getTilePos().layer)).delete(t),this.tilePosToCharacters.get(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer)).delete(t)}add(t,e){this.tilePosToCharacters.has(t)||this.tilePosToCharacters.set(t,new Set),this.tilePosToCharacters.get(t).add(e)}addTilePosSetSub(t){let e=t.tilePositionSet().subscribe(r=>{this.tilePosToCharacters.get(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer)).delete(t)});this.tilePosSetSubs.set(t.getId(),e)}addPositionChangeSub(t){let e=t.positionChangeStarted().subscribe(r=>{P.get().characterCollisionStrategy==="BLOCK_ONE_TILE_AHEAD"&&this.tilePosToCharacters.get(this.posToString(r.exitTile,r.exitLayer)).delete(t),this.add(this.posToString(r.enterTile,r.enterLayer),t)});this.positionChangeStartedSubs.set(t.getId(),e)}addPositionChangeFinishedSub(t){let e=t.positionChangeFinished().subscribe(r=>{this.tilePosToCharacters.get(this.posToString(r.exitTile,r.exitLayer)).delete(t)});this.positionChangeFinishedSubs.set(t.getId(),e)}posToString(t,e){return`${t.x}#${t.y}#${e}`}}});var pe,Li=p(()=>{pe=class{constructor(t,e,r,o){this.x=t;this.y=e;this.width=r;this.height=o}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}isInRange(t){return t.x>=this.x&&t.x<this.x+this.width&&t.y>=this.y&&t.y<this.y+this.height}}});var L,U,Ri=p(()=>{bt();O();k();wi();Li();gt();ze();L=class{constructor(t){this.tilemap=t;this.characters=new Map;this.charBlockCache=new he;this.charLayerDepths=new Map;this.transitions=new Map;this.setLayerDepths()}addCharacter(t){this.characters.set(t.getId(),t),t.getNextTilePos().layer===void 0&&t.setTilePosition(J(I({},t.getNextTilePos()),{layer:this.getLowestCharLayer()})),this.charBlockCache.addCharacter(t)}removeCharacter(t){this.charBlockCache.removeCharacter(this.characters.get(t)),this.characters.delete(t)}getCharacters(){return[...this.characters.values()]}getCharactersAt(t,e){return this.charBlockCache.getCharactersAt(t,e)}isBlocking(t,e,r,o){return this.hasBlockingTile(t,e,o)||this.hasBlockingChar(e,t,r)}hasBlockingTile(t,e,r){return this.hasNoTile(e,t)?!0:this.getCollisionRelevantLayers(t).some(o=>this.isLayerBlockingAt(o,e,r))}getTransition(t,e){let r=this.transitions.get(t.toString());if(r)return r.get(e)}setTransition(t,e,r){this.transitions.has(t.toString())||this.transitions.set(t.toString(),new Map),this.transitions.get(t.toString()).set(e,r)}getTransitions(){return new Map([...this.transitions].map(([t,e])=>[t,new Map(e)]))}hasNoTile(t,e){return!this.getCollisionRelevantLayers(e).some(r=>this.tilemap.hasTileAt(t.x,t.y,r.name))}hasBlockingChar(t,e,r){return this.charBlockCache.isCharBlockingAt(t,e,r)}getTileWidth(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*t}getTileHeight(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*t}getDepthOfCharLayer(t){return this.charLayerDepths.get(t)||0}isInRange(t){return new pe(0,0,this.tilemap.width,this.tilemap.height).isInRange(t)}getTileSize(){return new l(this.getTileWidth(),this.getTileHeight())}tilePosToPixelPos(t){return this.isIsometric()?S.scalarMult(this.getTileSize(),.5).multiply(new l(t.x-t.y,t.x+t.y)):t.clone().multiply(this.getTileSize())}getTileDistance(t){if(this.isIsometric())switch(t){case"down-left":case"down-right":case"up-left":case"up-right":return S.scalarMult(this.getTileSize(),.5);default:return this.getTileSize()}return this.getTileSize()}toMapDirection(t){return this.isIsometric()?vi(t):t}isIsometric(){return this.tilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()}isLayerBlockingAt(t,e,r){let o=L.ONE_WAY_COLLIDE_PROP_PREFIX+r,n=this.tilemap.getTileAt(e.x,e.y,!1,t.name);return Boolean((n==null?void 0:n.properties)&&(n.properties[P.get().collisionTilePropertyName]||n.properties[o]))}getCharLayerIndexes(){return this.tilemap.layers.map((t,e)=>({layer:t,index:e})).filter(({layer:t})=>this.isCharLayer(t)).map(({index:t})=>t)}findPrevAndCharLayer(t){let e=this.getCharLayerIndexes(),r=e.findIndex(o=>this.getLayerProp(this.tilemap.layers[o],L.CHAR_LAYER_PROP_NAME)==t);return r==0?{prevIndex:-1,charLayerIndex:e[r]}:{prevIndex:e[r-1],charLayerIndex:e[r]}}getCollisionRelevantLayers(t){if(!t)return this.tilemap.layers;let{prevIndex:e,charLayerIndex:r}=this.findPrevAndCharLayer(t);return this.tilemap.layers.slice(e+1,r+1)}getLowestCharLayer(){let t=this.tilemap.layers.find(e=>this.hasLayerProp(e,L.CHAR_LAYER_PROP_NAME));if(t)return this.getLayerProp(t,L.CHAR_LAYER_PROP_NAME)}getLayerProp(t,e){let o=t.properties.find(n=>n.name==e);return o==null?void 0:o.value}hasLayerProp(t,e){return this.getLayerProp(t,e)!=null}isLayerAlwaysOnTop(t){return this.hasLayerProp(t,L.ALWAYS_TOP_PROP_NAME)}isCharLayer(t){return this.hasLayerProp(t,L.CHAR_LAYER_PROP_NAME)}setLayerDepths(){let t=[],e=-1,r=this.tilemap.layers.filter(n=>this.isLayerAlwaysOnTop(n)),o=this.tilemap.layers.filter(n=>!this.isLayerAlwaysOnTop(n));o.forEach(n=>{this.hasLayerProp(n,L.HEIGHT_SHIFT_PROP_NAME)?(this.createHeightShiftLayers(n,e),t.push(n.tilemapLayer)):this.setDepth(n,++e)}),o.forEach(n=>{this.isCharLayer(n)||this.charLayerDepths.set(void 0,e)}),r.forEach((n,s)=>{n.tilemapLayer.setDepth(s+1+e)}),t.forEach(n=>n.destroy())}setDepth(t,e){t.tilemapLayer.setDepth(e),this.isCharLayer(t)&&this.charLayerDepths.set(this.getLayerProp(t,L.CHAR_LAYER_PROP_NAME),e)}createHeightShiftLayers(t,e){let r=this.getLayerProp(t,L.HEIGHT_SHIFT_PROP_NAME),o=1;for(let n=0;n<t.height;n++){let s=this.copyLayer(t,n);s.scale=t.tilemapLayer.scale,s.setDepth(e+ct.shiftPad((n+r)*this.getTileHeight()+o,L.Z_INDEX_PADDING))}}copyLayer(t,e){let r=this.tilemap.createBlankLayer(`${t.name}#${e}`,t.tilemapLayer.tileset);for(let o=0;o<t.width;o++)r.putTileAt(t.data[e][o],o,e);return r}},U=L;U.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",U.CHAR_LAYER_PROP_NAME="ge_charLayer",U.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",U.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_",U.Z_INDEX_PADDING=7});var xt,Mi=p(()=>{xt=class{static getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}}});var le,Fi=p(()=>{Mi();je();O();O();Yt();k();le=class{constructor(t,e=4,r=0,o=-1){this.character=t;this.delay=r;this.radius=o;this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().position.y,this.initialCol=t.getNextTilePos().position.x,this.randomizeStepSize(),this.stepsWalked=0,this.currentMovementDirection="none",this.character.positionChangeStarted().pipe(Z(this.character.autoMovementSet())).subscribe(()=>{this.stepsWalked++}),this.distanceUtils=at.create(e)}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let e=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(e),this.currentMovementDirection=e,this.randomizeStepSize()}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!=="none"&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return this.distanceUtils.getDirections().filter(e=>!this.character.isBlockingDirection(e)).filter(e=>this.isWithinRadius(e))}isWithinRadius(t){return this.radius==-1?!0:this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().position.add(j(t)),new l(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return t.length==0?"none":t[xt.getRandomInt(t.length)]}randomizeStepSize(){this.stepSize=xt.getRandomInt(this.radius)+1}}});var ce,Ii=p(()=>{bt();me();_i();$e();Ei();O();Ri();Fi();oe();Yt();k();Jt();Ve();ce=class{constructor(t){this.scene=t;this.isCreated=!1;this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this),this.scene.sys.events.on("destroy",this.destroy,this)}destroy(){this.scene=void 0,this.gridCharacters=void 0,this.gridTilemap=void 0,this.movementStarted$=void 0,this.movementStopped$=void 0,this.directionChanged$=void 0,this.positionChangeStarted$=void 0,this.positionChangeFinished$=void 0,this.charRemoved$=void 0,this.charAdded$=void 0}getCharLayer(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos().layer}getTransition(t,e){return this.initGuard(),this.gridTilemap.getTransition(new l(t),e)}setTransition(t,e,r){return this.initGuard(),this.gridTilemap.setTransition(new l(t),e,r)}create(t,e){this.isCreated=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(e);P.set(r),this.movementStopped$=new y,this.movementStarted$=new y,this.directionChanged$=new y,this.positionChangeStarted$=new y,this.positionChangeFinished$=new y,this.charRemoved$=new y,this.charAdded$=new y,this.gridTilemap=new U(t),this.addCharacters()}getPosition(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getTilePos().position}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,r=-1){this.initGuard(),this.unknownCharGuard(t);let o=new le(this.gridCharacters.get(t),P.get().numberOfDirections,e,r);this.gridCharacters.get(t).setMovement(o)}moveTo(t,e,r){let o=this.assembleMoveToConfig(r);this.initGuard(),this.unknownCharGuard(t);let n=new ht(this.gridCharacters.get(t),this.gridTilemap,{position:new l(e),layer:(r==null?void 0:r.targetLayer)||this.gridCharacters.get(t).getNextTilePos().layer},{numberOfDirections:P.get().numberOfDirections,distance:0,config:o});return this.gridCharacters.get(t).setMovement(n),n.finishedObs().pipe(nt(1),K(s=>({charId:t,position:s.position,result:s.result,description:s.description,layer:s.layer})))}stopMovement(t){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setMovement(void 0)}setSpeed(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setSpeed(e)}setWalkingAnimationMapping(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setWalkingAnimationMapping(e)}update(t,e){if(this.isCreated&&this.gridCharacters)for(let[r,o]of this.gridCharacters)o.update(e)}addCharacter(t){this.initGuard();let e=P.get().layerOverlay?this.scene.add.sprite(0,0,t.sprite.texture):void 0,r={sprite:t.sprite,layerOverlaySprite:e,speed:t.speed||4,tilemap:this.gridTilemap,walkingAnimationMapping:t.walkingAnimationMapping,container:t.container,offsetX:t.offsetX,offsetY:t.offsetY,collidesWithTiles:!0,collisionGroups:["geDefault"],charLayer:t.charLayer};typeof t.collides=="boolean"?t.collides===!1&&(r.collidesWithTiles=!1,r.collisionGroups=[]):t.collides!==void 0&&(t.collides.collidesWithTiles===!1&&(r.collidesWithTiles=!1),t.collides.collisionGroups&&(r.collisionGroups=t.collides.collisionGroups));let o=this.createCharacter(t.id,r);t.facingDirection&&o.turnTowards(t.facingDirection),this.gridCharacters.set(t.id,o);let n=t.startPosition?new l(t.startPosition):new l(0,0);o.setTilePosition({position:n,layer:o.getTilePos().layer}),this.gridTilemap.addCharacter(o),o.movementStopped().pipe(this.takeUntilCharRemoved(o.getId())).subscribe(s=>{this.movementStopped$.next({charId:o.getId(),direction:s})}),o.movementStarted().pipe(this.takeUntilCharRemoved(o.getId())).subscribe(s=>{this.movementStarted$.next({charId:o.getId(),direction:s})}),o.directionChanged().pipe(this.takeUntilCharRemoved(o.getId())).subscribe(s=>{this.directionChanged$.next({charId:o.getId(),direction:s})}),o.positionChangeStarted().pipe(this.takeUntilCharRemoved(o.getId())).subscribe(s=>{this.positionChangeStarted$.next(I({charId:o.getId()},s))}),o.positionChangeFinished().pipe(this.takeUntilCharRemoved(o.getId())).subscribe(s=>{this.positionChangeFinished$.next(I({charId:o.getId()},s))}),this.charAdded$.next(t.id)}hasCharacter(t){return this.initGuard(),this.gridCharacters.has(t)}removeCharacter(t){this.initGuard(),this.unknownCharGuard(t),this.gridTilemap.removeCharacter(t),this.gridCharacters.delete(t),this.charRemoved$.next(t)}removeAllCharacters(){this.initGuard();for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(){return this.initGuard(),[...this.gridCharacters.keys()]}follow(t,e,r=0,o=!1){this.initGuard(),this.unknownCharGuard(t),this.unknownCharGuard(e);let n=new ne(this.gridCharacters.get(t),this.gridTilemap,this.gridCharacters.get(e),P.get().numberOfDirections,r,o?"CLOSEST_REACHABLE":"STOP");this.gridCharacters.get(t).setMovement(n)}isMoving(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).isMoving()}getFacingDirection(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getFacingDirection()}getFacingPosition(t){this.initGuard(),this.unknownCharGuard(t);let e=this.gridCharacters.get(t).getFacingPosition();return{x:e.x,y:e.y}}turnTowards(t,e){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).turnTowards(e)}getCharactersAt(t,e){this.initGuard();let r=this.gridTilemap.getCharactersAt(new l(t),e);return Array.from(r).map(o=>o.getId())}setPosition(t,e,r){this.initGuard(),this.unknownCharGuard(t),r||this.gridCharacters.get(t).setTilePosition({position:new l(e),layer:this.gridCharacters.get(t).getTilePos().layer}),this.gridCharacters.get(t).setTilePosition({position:new l(e),layer:r})}getSprite(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getSprite()}setSprite(t,e){this.initGuard(),this.unknownCharGuard(t),e.setOrigin(0,0),this.gridCharacters.get(t).setSprite(e)}isBlocked(t,e,r=["geDefault"]){return this.initGuard(),this.gridTilemap.isBlocking(e,new l(t),r)}isTileBlocked(t,e){return this.initGuard(),this.gridTilemap.hasBlockingTile(e,new l(t))}getCollisionGroups(t){return this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).getCollisionGroups()}setCollisionGroups(t,e){this.initGuard(),this.unknownCharGuard(t),this.gridCharacters.get(t).setCollisionGroups(e)}steppedOn(t,e,r){return this.positionChangeFinished().pipe(B(o=>t.includes(o.charId)&&e.some(n=>n.x===o.enterTile.x&&n.y===o.enterTile.y)&&(r===void 0||r.includes(o.enterLayer))))}characterShifted(){return this.charAdded$.pipe(K(t=>({charId:t,action:"ADDED"})),Ue(this.charRemoved$.pipe(K(t=>({charId:t,action:"REMOVED"})))))}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}setConfigDefaults(t){return I({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES",layerOverlay:!1},t)}takeUntilCharRemoved(t){return Z(this.charRemoved$.pipe(B(e=>e==t)))}initGuard(){if(!this.isCreated)throw new Error("Plugin not initialized. You need to call create() first.")}unknownCharGuard(t){if(!this.gridCharacters.has(t))throw new Error(`Character unknown: ${t}`)}createCharacter(t,e){return new ae(t,e)}addCharacters(){P.get().characters.forEach(t=>this.addCharacter(t))}moveChar(t,e){if(this.initGuard(),this.unknownCharGuard(t),P.get().numberOfDirections===4){if(!this.gridTilemap.isIsometric()&&He(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}else if(this.gridTilemap.isIsometric()&&!He(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}this.gridCharacters.get(t).move(e)}assembleMoveToConfig(t){let e=J(I({},t),{noPathFoundStrategy:"STOP",pathBlockedStrategy:"WAIT"});return t!=null&&t.noPathFoundStrategy&&(Object.values(vt).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to '${"STOP"}'`)),t!=null&&t.pathBlockedStrategy&&(Object.values(ie).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to '${"WAIT"}'`)),e}}});var oo=Ke((Bp,Ai)=>{Ii();Ai.exports=ce});return oo();})();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
