var GridEngine=(()=>{var Ai=Object.defineProperty,Gi=Object.defineProperties;var ki=Object.getOwnPropertyDescriptors;var gr=Object.getOwnPropertySymbols;var Ni=Object.prototype.hasOwnProperty,Hi=Object.prototype.propertyIsEnumerable;var yr=(i,e,t)=>e in i?Ai(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,L=(i,e)=>{for(var t in e||(e={}))Ni.call(e,t)&&yr(i,t,e[t]);if(gr)for(var t of gr(e))Hi.call(e,t)&&yr(i,t,e[t]);return i},se=(i,e)=>Gi(i,ki(e));var h=(i,e)=>()=>(i&&(e=i(i=0)),e);var Ui=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var l,O=h(()=>{l=class{static get ZERO(){return new l(0,0)}static get ONE(){return new l(1,1)}static get UP(){return new l(0,-1)}static get DOWN(){return new l(0,1)}static get LEFT(){return new l(-1,0)}static get RIGHT(){return new l(1,0)}static get UP_LEFT(){return new l(-1,-1)}static get UP_RIGHT(){return new l(1,-1)}static get DOWN_RIGHT(){return new l(1,1)}static get DOWN_LEFT(){return new l(-1,1)}constructor(e,t){typeof e=="number"?(this.x=e,this.y=t||0):(this.x=e.x,this.y=e.y)}clone(){return new l(this.x,this.y)}add(e){return new l(this.x+e.x,this.y+e.y)}multiply(e){return new l(this.x*e.x,this.y*e.y)}divide(e){return new l(this.x/e.x,this.y/e.y)}subtract(e){return new l(this.x-e.x,this.y-e.y)}equals(e){return this.x===e.x&&this.y===e.y}abs(){return new l(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}modulo(e){return new l(this.x%e.x,this.y%e.y)}scalarModulo(e){return new l(this.x%e,this.y%e)}scalarMult(e){return new l(this.x*e,this.y*e)}toPosition(){return{x:this.x,y:this.y}}toString(){return`${this.x}#${this.y}`}}});var b,ge=h(()=>{O();b=class{static equal(e,t){return e.position.x===t.position.x&&e.position.y===t.position.y&&e.layer===t.layer}static copyOver(e,t){t.position.x=e.position.x,t.position.y=e.position.y,t.layer=e.layer}static clone(e){return{position:e.position.clone(),layer:e.layer}}static toString(e){return`${e.position.toString()}#${e.layer}`}static toInternal(e){return{position:new l(e.position.x,e.position.y),layer:e.charLayer}}static fromInternal(e){return{position:e.position.toPosition(),charLayer:e.layer}}}});function It(i){return["down-left","down-right","up-right","up-left"].includes(i)}function vr(i){return{["left"]:"down-left",["up-left"]:"left",["up"]:"up-left",["up-right"]:"up",["right"]:"up-right",["down-right"]:"right",["down"]:"down-right",["down-left"]:"down",["none"]:"none"}[i]}function br(i){return{["left"]:"up-left",["up-left"]:"up",["up"]:"up-right",["up-right"]:"right",["right"]:"down-right",["down-right"]:"down",["down"]:"down-left",["down-left"]:"left",["none"]:"none"}[i]}function U(i){return{["up"]:l.UP,["down"]:l.DOWN,["left"]:l.LEFT,["right"]:l.RIGHT,["none"]:l.ZERO,["up-left"]:l.UP_LEFT,["up-right"]:l.UP_RIGHT,["down-right"]:l.DOWN_RIGHT,["down-left"]:l.DOWN_LEFT}[i]}function Ie(i){return{["up"]:"down",["down"]:"up",["left"]:"right",["right"]:"left",["none"]:"none",["up-left"]:"down-right",["up-right"]:"down-left",["down-right"]:"up-left",["down-left"]:"up-right"}[i]}function Pr(i,e){if(i.x===e.x){if(i.y>e.y)return"up";if(i.y<e.y)return"down"}else if(i.y===e.y){if(i.x>e.x)return"left";if(i.x<e.x)return"right"}else if(i.x>e.x){if(i.y<e.y)return"down-left";if(i.y>e.y)return"up-left"}else if(i.x<e.x){if(i.y<e.y)return"down-right";if(i.y>e.y)return"up-right"}return"none"}var E=h(()=>{O()});function j(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");_t(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function xr(i,e,t,r){function o(n){return n instanceof t?n:new t(function(s){s(n)})}return new(t||(t=Promise))(function(n,s){function a(u){try{c(r.next(u))}catch(d){s(d)}}function p(u){try{c(r.throw(u))}catch(d){s(d)}}function c(u){u.done?n(u.value):o(u.value).then(a,p)}c((r=r.apply(i,e||[])).next())})}function _e(i,e){var t={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},r,o,n,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(c){return function(u){return p([c,u])}}function p(c){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(t=0)),t;)try{if(r=1,o&&(n=c[0]&2?o.return:c[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,c[1])).done)return n;switch(o=0,n&&(c=[c[0]&2,n.value]),c[0]){case 0:case 1:n=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,o=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(n=t.trys,!(n=n.length>0&&n[n.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!n||c[1]>n[0]&&c[1]<n[3])){t.label=c[1];break}if(c[0]===6&&t.label<n[1]){t.label=n[1],n=c;break}if(n&&t.label<n[2]){t.label=n[2],t.ops.push(c);break}n[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(i,t)}catch(u){c=[6,u],o=0}finally{r=n=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function W(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],r=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&r>=i.length&&(i=void 0),{value:i&&i[r++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function G(i,e){var t=typeof Symbol=="function"&&i[Symbol.iterator];if(!t)return i;var r=t.call(i),o,n=[],s;try{for(;(e===void 0||e-- >0)&&!(o=r.next()).done;)n.push(o.value)}catch(a){s={error:a}}finally{try{o&&!o.done&&(t=r.return)&&t.call(r)}finally{if(s)throw s.error}}return n}function k(i,e,t){if(t||arguments.length===2)for(var r=0,o=e.length,n;r<o;r++)(n||!(r in e))&&(n||(n=Array.prototype.slice.call(e,0,r)),n[r]=e[r]);return i.concat(n||Array.prototype.slice.call(e))}function Q(i){return this instanceof Q?(this.v=i,this):new Q(i)}function Tr(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(i,e||[]),o,n=[];return o={},s("next"),s("throw"),s("return"),o[Symbol.asyncIterator]=function(){return this},o;function s(m){r[m]&&(o[m]=function(f){return new Promise(function(x,y){n.push([m,f,x,y])>1||a(m,f)})})}function a(m,f){try{p(r[m](f))}catch(x){d(n[0][3],x)}}function p(m){m.value instanceof Q?Promise.resolve(m.value.v).then(c,u):d(n[0][2],m)}function c(m){a("next",m)}function u(m){a("throw",m)}function d(m,f){m(f),n.shift(),n.length&&a(n[0][0],n[0][1])}}function Cr(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof W=="function"?W(i):i[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=i[n]&&function(s){return new Promise(function(a,p){s=i[n](s),o(a,p,s.done,s.value)})}}function o(n,s,a,p){Promise.resolve(p).then(function(c){n({value:c,done:a})},s)}}var _t,N=h(()=>{_t=function(i,e){return _t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])},_t(i,e)}});function g(i){return typeof i=="function"}var D=h(()=>{});function Re(i){var e=function(r){Error.call(r),r.stack=new Error().stack},t=i(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var Rt=h(()=>{});var Me,Sr=h(()=>{Rt();Me=Re(function(i){return function(t){i(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(r,o){return o+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}})});function ye(i,e){if(i){var t=i.indexOf(e);0<=t&&i.splice(t,1)}}var Mt=h(()=>{});function Fe(i){return i instanceof ae||i&&"closed"in i&&g(i.remove)&&g(i.add)&&g(i.unsubscribe)}function wr(i){g(i)?i():i.unsubscribe()}var ae,Ft,Ae=h(()=>{N();D();Sr();Mt();ae=function(){function i(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return i.prototype.unsubscribe=function(){var e,t,r,o,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=W(s),p=a.next();!p.done;p=a.next()){var c=p.value;c.remove(this)}}catch(y){e={error:y}}finally{try{p&&!p.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else s.remove(this);var u=this.initialTeardown;if(g(u))try{u()}catch(y){n=y instanceof Me?y.errors:[y]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var m=W(d),f=m.next();!f.done;f=m.next()){var x=f.value;try{wr(x)}catch(y){n=n!=null?n:[],y instanceof Me?n=k(k([],G(n)),G(y.errors)):n.push(y)}}}catch(y){r={error:y}}finally{try{f&&!f.done&&(o=m.return)&&o.call(m)}finally{if(r)throw r.error}}}if(n)throw new Me(n)}},i.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)wr(e);else{if(e instanceof i){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},i.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},i.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},i.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&ye(t,e)},i.prototype.remove=function(e){var t=this._finalizers;t&&ye(t,e),e instanceof i&&e._removeParent(this)},i.EMPTY=function(){var e=new i;return e.closed=!0,e}(),i}(),Ft=ae.EMPTY});var A,ve=h(()=>{A={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1}});var he,At=h(()=>{N();he={setTimeout:function(i,e){for(var t=[],r=2;r<arguments.length;r++)t[r-2]=arguments[r];var o=he.delegate;return o!=null&&o.setTimeout?o.setTimeout.apply(o,k([i,e],G(t))):setTimeout.apply(void 0,k([i,e],G(t)))},clearTimeout:function(i){var e=he.delegate;return((e==null?void 0:e.clearTimeout)||clearTimeout)(i)},delegate:void 0}});function Ge(i){he.setTimeout(function(){var e=A.onUnhandledError;if(e)e(i);else throw i})}var Gt=h(()=>{ve();At()});function be(){}var kt=h(()=>{});function Dr(i){return Nt("E",void 0,i)}function Lr(i){return Nt("N",i,void 0)}function Nt(i,e,t){return{kind:i,value:e,error:t}}var Or,Er=h(()=>{Or=function(){return Nt("C",void 0,void 0)}()});function le(i){if(A.useDeprecatedSynchronousErrorHandling){var e=!Z;if(e&&(Z={errorThrown:!1,error:null}),i(),e){var t=Z,r=t.errorThrown,o=t.error;if(Z=null,r)throw o}}else i()}function Ir(i){A.useDeprecatedSynchronousErrorHandling&&Z&&(Z.errorThrown=!0,Z.error=i)}var Z,ke=h(()=>{ve();Z=null});function Ht(i,e){return Wi.call(i,e)}function Ne(i){A.useDeprecatedSynchronousErrorHandling?Ir(i):Ge(i)}function Bi(i){throw i}function Ut(i,e){var t=A.onStoppedNotification;t&&he.setTimeout(function(){return t(i,e)})}var Pe,Wi,Vi,He,$i,Wt=h(()=>{N();D();Ae();ve();Gt();kt();Er();At();ke();Pe=function(i){j(e,i);function e(t){var r=i.call(this)||this;return r.isStopped=!1,t?(r.destination=t,Fe(t)&&t.add(r)):r.destination=$i,r}return e.create=function(t,r,o){return new He(t,r,o)},e.prototype.next=function(t){this.isStopped?Ut(Lr(t),this):this._next(t)},e.prototype.error=function(t){this.isStopped?Ut(Dr(t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?Ut(Or,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(ae),Wi=Function.prototype.bind;Vi=function(){function i(e){this.partialObserver=e}return i.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(r){Ne(r)}},i.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(r){Ne(r)}else Ne(e)},i.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){Ne(t)}},i}(),He=function(i){j(e,i);function e(t,r,o){var n=i.call(this)||this,s;if(g(t)||!t)s={next:t!=null?t:void 0,error:r!=null?r:void 0,complete:o!=null?o:void 0};else{var a;n&&A.useDeprecatedNextContext?(a=Object.create(t),a.unsubscribe=function(){return n.unsubscribe()},s={next:t.next&&Ht(t.next,a),error:t.error&&Ht(t.error,a),complete:t.complete&&Ht(t.complete,a)}):s=t}return n.destination=new Vi(s),n}return e}(Pe);$i={closed:!0,next:be,error:Bi,complete:be}});var ce,Ue=h(()=>{ce=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function We(i){return i}var Vt=h(()=>{});function Bt(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];return $t(i)}function $t(i){return i.length===0?We:i.length===1?i[0]:function(t){return i.reduce(function(r,o){return o(r)},t)}}var jt=h(()=>{Vt()});function _r(i){var e;return(e=i!=null?i:A.Promise)!==null&&e!==void 0?e:Promise}function ji(i){return i&&g(i.next)&&g(i.error)&&g(i.complete)}function zi(i){return i&&i instanceof Pe||ji(i)&&Fe(i)}var T,J=h(()=>{Wt();Ae();Ue();jt();ve();D();ke();T=function(){function i(e){e&&(this._subscribe=e)}return i.prototype.lift=function(e){var t=new i;return t.source=this,t.operator=e,t},i.prototype.subscribe=function(e,t,r){var o=this,n=zi(e)?e:new He(e,t,r);return le(function(){var s=o,a=s.operator,p=s.source;n.add(a?a.call(n,p):p?o._subscribe(n):o._trySubscribe(n))}),n},i.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},i.prototype.forEach=function(e,t){var r=this;return t=_r(t),new t(function(o,n){var s=new He({next:function(a){try{e(a)}catch(p){n(p),s.unsubscribe()}},error:n,complete:o});r.subscribe(s)})},i.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},i.prototype[ce]=function(){return this},i.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return $t(e)(this)},i.prototype.toPromise=function(e){var t=this;return e=_r(e),new e(function(r,o){var n;t.subscribe(function(s){return n=s},function(s){return o(s)},function(){return r(n)})})},i.create=function(e){return new i(e)},i}()});function qi(i){return g(i==null?void 0:i.lift)}function S(i){return function(e){if(qi(e))return e.lift(function(t){try{return i(t,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var V=h(()=>{D()});function I(i,e,t,r,o){return new Yi(i,e,t,r,o)}var Yi,ee=h(()=>{N();Wt();Yi=function(i){j(e,i);function e(t,r,o,n,s,a){var p=i.call(this,t)||this;return p.onFinalize=s,p.shouldUnsubscribe=a,p._next=r?function(c){try{r(c)}catch(u){t.error(u)}}:i.prototype._next,p._error=n?function(c){try{n(c)}catch(u){t.error(u)}finally{this.unsubscribe()}}:i.prototype._error,p._complete=o?function(){try{o()}catch(c){t.error(c)}finally{this.unsubscribe()}}:i.prototype._complete,p}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;i.prototype.unsubscribe.call(this),!r&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e}(Pe)});var Rr,Mr=h(()=>{Rt();Rr=Re(function(i){return function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})});var v,Fr,Ar=h(()=>{N();J();Ae();Mr();Mt();ke();v=function(i){j(e,i);function e(){var t=i.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var r=new Fr(this,this);return r.operator=t,r},e.prototype._throwIfClosed=function(){if(this.closed)throw new Rr},e.prototype.next=function(t){var r=this;le(function(){var o,n;if(r._throwIfClosed(),!r.isStopped){r.currentObservers||(r.currentObservers=Array.from(r.observers));try{for(var s=W(r.currentObservers),a=s.next();!a.done;a=s.next()){var p=a.value;p.next(t)}}catch(c){o={error:c}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}}})},e.prototype.error=function(t){var r=this;le(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=t;for(var o=r.observers;o.length;)o.shift().error(t)}})},e.prototype.complete=function(){var t=this;le(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var r=t.observers;r.length;)r.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),i.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var r=this,o=this,n=o.hasError,s=o.isStopped,a=o.observers;return n||s?Ft:(this.currentObservers=null,a.push(t),new ae(function(){r.currentObservers=null,ye(a,t)}))},e.prototype._checkFinalizedStatuses=function(t){var r=this,o=r.hasError,n=r.thrownError,s=r.isStopped;o?t.error(n):s&&t.complete()},e.prototype.asObservable=function(){var t=new T;return t.source=this,t},e.create=function(t,r){return new Fr(t,r)},e}(T),Fr=function(i){j(e,i);function e(t,r){var o=i.call(this)||this;return o.destination=t,o.source=r,o}return e.prototype.next=function(t){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.next)===null||o===void 0||o.call(r,t)},e.prototype.error=function(t){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.error)===null||o===void 0||o.call(r,t)},e.prototype.complete=function(){var t,r;(r=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||r===void 0||r.call(t)},e.prototype._subscribe=function(t){var r,o;return(o=(r=this.source)===null||r===void 0?void 0:r.subscribe(t))!==null&&o!==void 0?o:Ft},e}(v)});var Gr,kr=h(()=>{J();Gr=new T(function(i){return i.complete()})});function Nr(i){return i&&g(i.schedule)}var Hr=h(()=>{D()});function Ur(i){return i[i.length-1]}function Wr(i){return Nr(Ur(i))?i.pop():void 0}function Vr(i,e){return typeof Ur(i)=="number"?i.pop():e}var Br=h(()=>{Hr()});var Ve,zt=h(()=>{Ve=function(i){return i&&typeof i.length=="number"&&typeof i!="function"}});function Be(i){return g(i==null?void 0:i.then)}var qt=h(()=>{D()});function $e(i){return g(i[ce])}var Yt=h(()=>{Ue();D()});function je(i){return Symbol.asyncIterator&&g(i==null?void 0:i[Symbol.asyncIterator])}var Xt=h(()=>{D()});function ze(i){return new TypeError("You provided "+(i!==null&&typeof i=="object"?"an invalid object":"'"+i+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var Kt=h(()=>{});function Xi(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var qe,Qt=h(()=>{qe=Xi()});function Ye(i){return g(i==null?void 0:i[qe])}var Zt=h(()=>{Qt();D()});function Xe(i){return Tr(this,arguments,function(){var t,r,o,n;return _e(this,function(s){switch(s.label){case 0:t=i.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,Q(t.read())];case 3:return r=s.sent(),o=r.value,n=r.done,n?[4,Q(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,Q(o)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function Ke(i){return g(i==null?void 0:i.getReader)}var Qe=h(()=>{N();D()});function R(i){if(i instanceof T)return i;if(i!=null){if($e(i))return Ki(i);if(Ve(i))return Qi(i);if(Be(i))return Zi(i);if(je(i))return $r(i);if(Ye(i))return Ji(i);if(Ke(i))return eo(i)}throw ze(i)}function Ki(i){return new T(function(e){var t=i[ce]();if(g(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Qi(i){return new T(function(e){for(var t=0;t<i.length&&!e.closed;t++)e.next(i[t]);e.complete()})}function Zi(i){return new T(function(e){i.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,Ge)})}function Ji(i){return new T(function(e){var t,r;try{for(var o=W(i),n=o.next();!n.done;n=o.next()){var s=n.value;if(e.next(s),e.closed)return}}catch(a){t={error:a}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}e.complete()})}function $r(i){return new T(function(e){to(i,e).catch(function(t){return e.error(t)})})}function eo(i){return $r(Xe(i))}function to(i,e){var t,r,o,n;return xr(this,void 0,void 0,function(){var s,a;return _e(this,function(p){switch(p.label){case 0:p.trys.push([0,5,6,11]),t=Cr(i),p.label=1;case 1:return[4,t.next()];case 2:if(r=p.sent(),!!r.done)return[3,4];if(s=r.value,e.next(s),e.closed)return[2];p.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=p.sent(),o={error:a},[3,11];case 6:return p.trys.push([6,,9,10]),r&&!r.done&&(n=t.return)?[4,n.call(t)]:[3,8];case 7:p.sent(),p.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}var te=h(()=>{N();zt();qt();J();Yt();Xt();Kt();Zt();Qe();D();Gt();Ue()});function M(i,e,t,r,o){r===void 0&&(r=0),o===void 0&&(o=!1);var n=e.schedule(function(){t(),o?i.add(this.schedule(null,r)):this.unsubscribe()},r);if(i.add(n),!o)return n}var xe=h(()=>{});function Ze(i,e){return e===void 0&&(e=0),S(function(t,r){t.subscribe(I(r,function(o){return M(r,i,function(){return r.next(o)},e)},function(){return M(r,i,function(){return r.complete()},e)},function(o){return M(r,i,function(){return r.error(o)},e)}))})}var Jt=h(()=>{xe();V();ee()});function Je(i,e){return e===void 0&&(e=0),S(function(t,r){r.add(i.schedule(function(){return t.subscribe(r)},e))})}var er=h(()=>{V()});function jr(i,e){return R(i).pipe(Je(e),Ze(e))}var zr=h(()=>{te();Jt();er()});function qr(i,e){return R(i).pipe(Je(e),Ze(e))}var Yr=h(()=>{te();Jt();er()});function Xr(i,e){return new T(function(t){var r=0;return e.schedule(function(){r===i.length?t.complete():(t.next(i[r++]),t.closed||this.schedule())})})}var Kr=h(()=>{J()});function Qr(i,e){return new T(function(t){var r;return M(t,e,function(){r=i[qe](),M(t,e,function(){var o,n,s;try{o=r.next(),n=o.value,s=o.done}catch(a){t.error(a);return}s?t.complete():t.next(n)},0,!0)}),function(){return g(r==null?void 0:r.return)&&r.return()}})}var Zr=h(()=>{J();Qt();D();xe()});function et(i,e){if(!i)throw new Error("Iterable cannot be null");return new T(function(t){M(t,e,function(){var r=i[Symbol.asyncIterator]();M(t,e,function(){r.next().then(function(o){o.done?t.complete():t.next(o.value)})},0,!0)})})}var tr=h(()=>{J();xe()});function Jr(i,e){return et(Xe(i),e)}var ei=h(()=>{tr();Qe()});function ti(i,e){if(i!=null){if($e(i))return jr(i,e);if(Ve(i))return Xr(i,e);if(Be(i))return qr(i,e);if(je(i))return et(i,e);if(Ye(i))return Qr(i,e);if(Ke(i))return Jr(i,e)}throw ze(i)}var ri=h(()=>{zr();Yr();Kr();Zr();tr();Yt();qt();zt();Zt();Xt();Kt();Qe();ei()});function ii(i,e){return e?ti(i,e):R(i)}var oi=h(()=>{ri();te()});function H(i,e){return S(function(t,r){var o=0;t.subscribe(I(r,function(n){r.next(i.call(e,n,o++))}))})}var tt=h(()=>{V();ee()});function ni(i,e,t,r,o,n,s,a){var p=[],c=0,u=0,d=!1,m=function(){d&&!p.length&&!c&&e.complete()},f=function(y){return c<r?x(y):p.push(y)},x=function(y){n&&e.next(y),c++;var K=!1;R(t(y,u++)).subscribe(I(e,function(_){o==null||o(_),n?f(_):e.next(_)},function(){K=!0},void 0,function(){if(K)try{c--;for(var _=function(){var $=p.shift();s?M(e,s,function(){return x($)}):x($)};p.length&&c<r;)_();m()}catch($){e.error($)}}))};return i.subscribe(I(e,f,function(){d=!0,m()})),function(){a==null||a()}}var si=h(()=>{te();xe();ee()});function rr(i,e,t){return t===void 0&&(t=1/0),g(e)?rr(function(r,o){return H(function(n,s){return e(r,n,o,s)})(R(i(r,o)))},t):(typeof e=="number"&&(t=e),S(function(r,o){return ni(r,o,i,t)}))}var ai=h(()=>{tt();te();V();si();D()});function hi(i){return i===void 0&&(i=1/0),rr(We,i)}var li=h(()=>{ai();Vt()});function ci(i){return i.length===1&&ro(i[0])?i[0]:i}var ro,pi=h(()=>{ro=Array.isArray});function w(i,e){return S(function(t,r){var o=0;t.subscribe(I(r,function(n){return i.call(e,n,o++)&&r.next(n)}))})}var ir=h(()=>{V();ee()});var ui=h(()=>{});function F(i){return i<=0?function(){return Gr}:S(function(e,t){var r=0;e.subscribe(I(t,function(o){++r<=i&&(t.next(o),i<=r&&t.complete())}))})}var or=h(()=>{kr();V();ee()});function mi(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];var t=Wr(i),r=Vr(i,1/0);return i=ci(i),S(function(o,n){hi(r)(ii(k([o],G(i)),t)).subscribe(n)})}var di=h(()=>{N();V();pi();li();Br();oi()});function nr(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];return mi.apply(void 0,k([],G(i)))}var fi=h(()=>{N();di()});function C(i){return S(function(e,t){R(i).subscribe(I(t,function(){return t.complete()},be)),!t.closed&&e.subscribe(t)})}var sr=h(()=>{V();ee();te();kt()});var re=h(()=>{Ar();jt();ui();ir();tt();or();sr()});var z,rt,it=h(()=>{ge();E();E();re();O();z=1e3,rt=class{constructor(e,t){this.id=e;this.movementDirection="none";this._tilePos={position:new l(0,0),layer:void 0};this.movementStarted$=new v;this.movementStopped$=new v;this.directionChanged$=new v;this.positionChangeStarted$=new v;this.positionChangeFinished$=new v;this.tilePositionSet$=new v;this.autoMovementSet$=new v;this.lastMovementImpulse="none";this.facingDirection="down";this.depthChanged$=new v;this.movementProgress=0;var r,o,n;this.tilemap=t.tilemap,this.speed=t.speed,this.collidesWithTilesInternal=t.collidesWithTiles,this._tilePos.layer=t.charLayer,this.ignoreMissingTiles=(r=t.ignoreMissingTiles)!=null?r:!1,this.collisionGroups=new Set(t.collisionGroups||[]),this.labels=new Set(t.labels||[]),this.numberOfDirections=t.numberOfDirections,t.facingDirection&&this.turnTowards(t.facingDirection),this.tileWidth=(o=t.tileWidth)!=null?o:1,this.tileHeight=(n=t.tileHeight)!=null?n:1}getId(){return this.id}getSpeed(){return this.speed}setSpeed(e){this.speed=e}setMovement(e){this.autoMovementSet$.next(e),this.movement=e}getMovement(){return this.movement}collidesWithTiles(){return this.collidesWithTilesInternal}getIgnoreMissingTiles(){return this.ignoreMissingTiles}setTilePosition(e){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.tilePositionSet$.next(L({},e)),this.fire(this.positionChangeStarted$,this.tilePos,e),this.fire(this.positionChangeFinished$,this.tilePos,e),this.movementDirection="none",this.lastMovementImpulse="none",this.tilePos=e,this.movementProgress=0}getTilePos(){return this.tilePos}getNextTilePos(){if(!this.isMoving())return this.tilePos;let e=this.tilePos.layer,t=this.tilePosInDirection(this.tilePos.position,this.movementDirection),r=this.tilemap.getTransition(t,this.tilePos.layer);return r&&(e=r),{position:this.tilePosInDirection(this.tilePos.position,this.movementDirection),layer:e}}getTileWidth(){return this.tileWidth}getTileHeight(){return this.tileHeight}move(e){this.lastMovementImpulse=e,e!="none"&&(this.isMoving()||(this.isBlockingDirection(e)?this.changeFacingDirection(e):this.startMoving(e)))}update(e){var t;(t=this.movement)==null||t.update(e),this.isMoving()&&this.updateCharacterPosition(e),this.lastMovementImpulse="none"}getMovementDirection(){return this.movementDirection}isBlockingDirection(e){if(e=="none")return!1;let t=this.tilePosInDirection(this.getNextTilePos().position,e),r=this.tilemap.getTransition(t,this.getNextTilePos().layer)||this.getNextTilePos().layer;return this.collidesWithTilesInternal&&this.isTileBlocking(e,r)?!0:this.isCharBlocking(e,r)}isTileBlocking(e,t){return this.someCharTile((r,o)=>{let n=this.tilePosInDirection(new l(r,o),e);return this.tilemap.hasBlockingTile(n,t,Ie(e),this.ignoreMissingTiles)})}isCharBlocking(e,t){return this.someCharTile((r,o)=>{let n=this.tilePosInDirection(new l(r,o),e);return this.tilemap.hasBlockingChar(n,t,this.getCollisionGroups(),new Set([this.getId()]))})}isMoving(){return this.movementDirection!="none"}turnTowards(e){this.isMoving()||e!="none"&&this.changeFacingDirection(e)}changeFacingDirection(e){this.facingDirection!==e&&(this.facingDirection=e,this.directionChanged$.next(e))}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.position.add(U(this.facingDirection))}addCollisionGroup(e){this.collisionGroups.add(e)}setCollisionGroups(e){this.collisionGroups=new Set(e)}getCollisionGroups(){return Array.from(this.collisionGroups)}hasCollisionGroup(e){return this.collisionGroups.has(e)}removeCollisionGroup(e){this.collisionGroups.delete(e)}removeAllCollisionGroups(){this.collisionGroups.clear()}addLabels(e){for(let t of e)this.labels.add(t)}getLabels(){return[...this.labels.values()]}hasLabel(e){return this.labels.has(e)}clearLabels(){this.labels.clear()}removeLabels(e){for(let t of e)this.labels.delete(t)}getNumberOfDirections(){return this.numberOfDirections}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}tilePositionSet(){return this.tilePositionSet$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}depthChanged(){return this.depthChanged$}getMovementProgress(){return this.movementProgress}hasWalkedHalfATile(){return this.movementProgress>z/2}updateCharacterPosition(e){let r=e/1e3,o=Math.floor(r*this.speed*z),n=z-this.movementProgress<=o&&this.movementProgress<z,a=1-(n?z-this.movementProgress:o)/o;this.movementProgress=Math.min(this.movementProgress+o,z),n&&(this.movementProgress=0,this.shouldContinueMoving()&&a>0?(this.fire(this.positionChangeFinished$,this.tilePos,this.getNextTilePos()),this.tilePos=this.getNextTilePos(),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(e*a)):this.stopMoving())}get tilePos(){return b.clone(this._tilePos)}set tilePos(e){b.copyOver(e,this._tilePos)}startMoving(e){e!=="none"&&(e!=this.movementDirection&&this.movementStarted$.next(e),this.movementDirection=e,this.facingDirection=e,this.fire(this.positionChangeStarted$,this.tilePos,this.getNextTilePos()))}tilePosInDirection(e,t){return e.add(U(this.tilemap.toMapDirection(t)))}shouldContinueMoving(){return this.lastMovementImpulse!=="none"&&!this.isBlockingDirection(this.lastMovementImpulse)}stopMoving(){if(this.movementDirection==="none")return;let e=this.tilePos,t=this.getNextTilePos(),r=this.movementDirection;this.tilePos=this.getNextTilePos(),this.movementDirection="none",this.movementStopped$.next(r),this.fire(this.positionChangeFinished$,e,t)}fire(e,{position:t,layer:r},{position:o,layer:n}){e.next({exitTile:t,enterTile:o,exitLayer:r,enterLayer:n})}someCharTile(e){let t=this.getNextTilePos().position;for(let r=t.x;r<t.x+this.getTileWidth();r++)for(let o=t.y;o<t.y+this.getTileHeight();o++)if(e(r,o))return!0;return!1}}});var Te,ie,ot=h(()=>{E();re();Te=class{constructor(e,t){this.walkingAnimationMapping=e;this.charsInRow=t;this.lastFootLeft=!1;this.directionToFrameRow={["down"]:0,["down-left"]:1,["down-right"]:2,["left"]:1,["right"]:2,["up"]:3,["up-left"]:1,["up-right"]:2};this._isEnabled=!0;this.frameChange$=new v;this.setWalkingAnimationMapping(e)}frameChange(){return this.frameChange$}setIsEnabled(e){this._isEnabled=e}isEnabled(){return this._isEnabled}updateCharacterFrame(e,t,r){this._isEnabled&&(t?this.setStandingFrameDuringWalk(e,r):this.setWalkingFrame(e))}setStandingFrame(e){this._isEnabled&&this._setStandingFrame(e)}setWalkingAnimationMapping(e){this.walkingAnimationMapping=e,this._isEnabled=this.walkingAnimationMapping!==void 0}getWalkingAnimationMapping(){return this.walkingAnimationMapping}getCharsInRow(){return this.charsInRow}setStandingFrameDuringWalk(e,t){this.isCurrentFrameStanding(e,t)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(e)}setWalkingFrame(e){let t=this.framesOfDirection(e);t&&this.frameChange$.next(this.lastFootLeft?t.rightFoot:t.leftFoot)}_setStandingFrame(e){let t=this.framesOfDirection(e);t&&this.frameChange$.next(t.standing)}isCurrentFrameStanding(e,t){var r;return t===((r=this.framesOfDirection(e))==null?void 0:r.standing)}framesOfDirection(e){return typeof this.walkingAnimationMapping=="number"?this.getFramesForCharIndex(e,this.walkingAnimationMapping):this.getFramesForAnimationMapping(e)}getFramesForAnimationMapping(e){if(this.walkingAnimationMapping)return this.walkingAnimationMapping[e]||this.walkingAnimationMapping[this.fallbackDirection(e)]}fallbackDirection(e){switch(e){case"down-left":return"left";case"down-right":return"right";case"up-left":return"left";case"up-right":return"right"}return e}getFramesForCharIndex(e,t){var c;let r=Math.floor(t/this.charsInRow),o=t%this.charsInRow,n=this.charsInRow*Te.FRAMES_CHAR_ROW,s=Te.FRAMES_CHAR_ROW*o,a=((c=this.directionToFrameRow[e])!=null?c:0)+r*Te.FRAMES_CHAR_COL,p=s+a*n;return{rightFoot:p,standing:p+1,leftFoot:p+2}}},ie=Te;ie.FRAMES_CHAR_ROW=3,ie.FRAMES_CHAR_COL=4});var pe,ar=h(()=>{pe=class{static shiftPad(e,t){let r=Math.floor(e),n=`${r}`.padStart(t,"0").length;return r/Math.pow(10,n)}}});var Ce=h(()=>{ir();tt();fi();or();sr()});var nt,gi=h(()=>{it();O();ot();ar();re();Ce();E();nt=class{constructor(e,t,r,o,n){this.charData=e;this.scene=t;this.tilemap=r;this.geHeadless=n;this.customOffset=new l(0,0);this.newSpriteSet$=new v;this.destroy$=new v;this.layerOverlaySprite=o&&e.sprite?this.scene.add.sprite(0,0,e.sprite.texture):void 0,this.walkingAnimationMapping=e.walkingAnimationMapping,this.customOffset=new l(e.offsetX||0,e.offsetY||0),this.sprite=e.sprite,this.container=e.container,this.geHeadless.directionChanged().pipe(w(({charId:s})=>s===this.charData.id)).subscribe(({direction:s})=>{var a;(a=this.animation)==null||a.setStandingFrame(s)}),this.sprite&&(this.sprite.setOrigin(0,0),this.resetAnimation(this.sprite),this.updateOverlaySprite(),this.updateGridChar())}destroy(){this.destroy$.next(),this.destroy$.complete(),this.newSpriteSet$.complete()}setSprite(e){e?(this.sprite&&(e.x=this.sprite.x,e.y=this.sprite.y),this.sprite=e,this.newSpriteSet$.next(),this.layerOverlaySprite=this.layerOverlaySprite?this.scene.add.sprite(0,0,this.sprite.texture):void 0,this.updateOverlaySprite(),this.resetAnimation(this.sprite),this.updateDepth()):(this.layerOverlaySprite=void 0,this.sprite=void 0)}getSprite(){return this.sprite}getLayerOverlaySprite(){return this.layerOverlaySprite}setContainer(e){this.container=e}getContainer(){return this.container}getOffsetX(){return this.customOffset.x}getOffsetY(){return this.customOffset.y}getWalkingAnimationMapping(){return this.walkingAnimationMapping}turnTowards(e){var t;this.geHeadless.isMoving(this.charData.id)||e!="none"&&(this.geHeadless.turnTowards(this.charData.id,e),(t=this.animation)==null||t.setStandingFrame(e))}getAnimation(){return this.animation}setAnimation(e){this.animation=e}update(e){this.updateGridChar()}getEngineOffset(){var r,o,n,s;if(!this.sprite)return l.ZERO;let e=this.tilemap.getTileWidth()/2-Math.floor(((o=(r=this.sprite)==null?void 0:r.displayWidth)!=null?o:0)/2),t=-((s=(n=this.sprite)==null?void 0:n.displayHeight)!=null?s:0)+this.tilemap.getTileHeight();return new l(e,t)}updatePixelPos(){let e=new l(this.geHeadless.getPosition(this.charData.id)),t=this.geHeadless.getMovementProgress(this.charData.id)/1e3,o=this.tilemap.tilePosToPixelPos(e).add(this.getEngineOffset()).add(this.customOffset).add(U(this.geHeadless.getFacingDirection(this.charData.id)).multiply(this.tilemap.getTileDistance(this.geHeadless.getFacingDirection(this.charData.id)).scalarMult(t))),n=this.getGameObj();n&&(n.x=o.x,n.y=o.y)}getGameObj(){return this.container||this.sprite}updateGridChar(){var e;if(this.updatePixelPos(),this.sprite&&this.geHeadless.isMoving(this.charData.id)){let t=this.geHeadless.getMovementProgress(this.charData.id)>z/2;(e=this.getAnimation())==null||e.updateCharacterFrame(this.geHeadless.getFacingDirection(this.charData.id),t,Number(this.sprite.frame.name))}this.updateDepth()}resetAnimation(e){let t=new ie(this.walkingAnimationMapping,e.texture.source[0].width/e.width/ie.FRAMES_CHAR_ROW);this.setAnimation(t),t.frameChange().pipe(C(this.newSpriteSet$)).subscribe(r=>{e==null||e.setFrame(r)}),t.setIsEnabled(this.walkingAnimationMapping!==void 0),t.setStandingFrame(this.geHeadless.getFacingDirection(this.charData.id))}updateOverlaySprite(){if(!this.layerOverlaySprite||!this.sprite)return;this.layerOverlaySprite.scale=this.sprite.scale;let e=this.tilemap.getTileHeight()/this.layerOverlaySprite.scale;this.layerOverlaySprite.setCrop(0,0,this.layerOverlaySprite.displayWidth,this.sprite.height-e),this.layerOverlaySprite.setOrigin(0,0)}updateDepth(){let e=this.getGameObj();if(!e)return;let t=new l(this.geHeadless.getPosition(this.charData.id)),r=this.geHeadless.getCharLayer(this.charData.id);this.setDepth(e,{position:t,layer:r});let o=this.getLayerOverlaySprite();if(o){let n=new l(se(L({},t),{y:t.y-1}));this.setDepth(o,{position:n,layer:r})}}setDepth(e,t){e.setDepth(this.tilemap.getDepthOfCharLayer(this.getTransitionLayer(t))+this.getPaddedPixelDepth(e))}getPaddedPixelDepth(e){return pe.shiftPad(e.y+e.displayHeight,7)}getTransitionLayer(e){if(e.layer)return this.geHeadless.getTransition(e.position,e.layer)||e.layer}}});var st=h(()=>{});var ue,Se=h(()=>{ue=(r=>(r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY",r))(ue||{})});var P,oe=h(()=>{O();P=class{static vec2str(e){return`${e.x}#${e.y}`}static equal(e,t){return P.vec2str(e)==P.vec2str(t)}static manhattanDistance(e,t){let r=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return r+o}static chebyshevDistance(e,t){let r=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.max(r,o)}static scalarMult(e,t){return e.clone().multiply(new l(t,t))}}});var at,yi=h(()=>{oe();E();O();at=class{distance(e,t){return P.manhattanDistance(e,t)}direction(e,t){if(P.equal(e,t))return"none";let r=e.clone().subtract(t);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?"left":"right":r.y>0?"up":"down"}neighbors(e){return[new l(e.x,e.y+1),new l(e.x+1,e.y),new l(e.x-1,e.y),new l(e.x,e.y-1)]}getDirections(){return["up","right","down","left"]}}});var ht,vi=h(()=>{oe();E();O();ht=class{distance(e,t){return P.chebyshevDistance(e,t)}neighbors(e){let t=[new l(e.x,e.y+1),new l(e.x+1,e.y),new l(e.x-1,e.y),new l(e.x,e.y-1)],r=[new l(e.x+1,e.y+1),new l(e.x+1,e.y-1),new l(e.x-1,e.y+1),new l(e.x-1,e.y-1)];return[...t,...r]}direction(e,t){return t.x>e.x?t.y>e.y?"down-right":t.y<e.y?"up-right":"right":t.x<e.x?t.y>e.y?"down-left":t.y<e.y?"up-left":"left":t.y<e.y?"up":t.y>e.y?"down":"none"}getDirections(){return["up","right","down","left","down-left","down-right","up-right","up-left"]}}});var B,lt=h(()=>{yi();E();vi();B=class{static create(e){switch(e){case 4:return new at;case 8:return new ht}}}});var we,bi=h(()=>{we=class{constructor(e,t,r){this.backoffMs=e;this.maxRetries=t;this.onFinished=r;this.retries=0;this.elapsed=0}retry(e,t){this.shouldRetry()?(this.elapsed+=e,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,t())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}getBackoffMs(){return this.backoffMs}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}}});var Oe,ct=h(()=>{Oe=(r=>(r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP",r))(Oe||{})});var pt,me,lr=h(()=>{pt=class{constructor(e){this.data=e}},me=class{constructor(){this.sizeInternal=0}dequeue(){if(this.tail===void 0)return;this.sizeInternal--;let e=this.tail.data;return this.tail.prev===void 0?(this.tail=void 0,this.head=void 0,e):(this.tail.prev.next=void 0,this.tail=this.tail.prev,e)}enqueue(e){if(this.sizeInternal++,this.head===void 0){this.head=new pt(e),this.tail=this.head;return}let t=new pt(e);t.next=this.head,this.head.prev=t,this.head=t}peek(){return this.tail?this.tail.data:void 0}size(){return this.sizeInternal}}});var ut,Pi=h(()=>{oe();lr();ut=class{constructor(){this.maxPathLength=1/0}setMaxPathLength(e){this.maxPathLength=e}getShortestPath(e,t,r,o){let n=this.shortestPathBfs(e,t,r,o);return{path:this.returnPath(n.previous,e,t),closestToTarget:n.closestToTarget,steps:n.steps,maxPathLengthReached:n.maxPathLengthReached}}pos2Str(e){return`${e.position.toString()}#${e.layer}`}equal(e,t){return P.equal(e.position,t.position)?e.layer===t.layer:!1}shortestPathBfs(e,t,r,o){let n=new Map,s=new Set,a=new me,p=e,c=o(e.position,t.position),u=0;for(a.enqueue({node:e,dist:0}),s.add(this.pos2Str(e));a.size()>0;){let d=a.dequeue();if(u++,!d)break;let{node:m,dist:f}=d;if(f>this.maxPathLength)return{previous:new Map,closestToTarget:p,steps:u,maxPathLengthReached:!0};let x=o(m.position,t.position);if(x<c&&(c=x,p=m),this.equal(m,t))return{previous:n,closestToTarget:p,steps:u,maxPathLengthReached:!1};for(let y of r(m))s.has(this.pos2Str(y))||(n.set(this.pos2Str(y),m),a.enqueue({node:y,dist:f+1}),s.add(this.pos2Str(y)))}return{previous:n,closestToTarget:p,steps:u,maxPathLengthReached:!1}}returnPath(e,t,r){let o=[],n=r;for(o.push(n);!this.equal(n,t);){if(n=e.get(this.pos2Str(n)),!n)return[];o.push(n)}return o.reverse()}}});var mt,dt,xi=h(()=>{ge();oe();lr();mt=class{constructor(){this.previous=new Map;this.visited=new Map;this.queue=new me}step(e,t,r){for(let o of e)this.visited.has(b.toString(o))||(this.previous.set(b.toString(o),t),this.queue.enqueue({node:o,dist:r+1}),this.visited.set(b.toString(o),r+1))}},dt=class{constructor(){this.maxPathLength=1/0}setMaxPathLength(e){this.maxPathLength=e}getShortestPath(e,t,r,o,n){let s=this.shortestPathBfs(e,t,r,o,n);return{path:this.returnPath(s.previous,s.previous2,s.matchingPos,e,t),closestToTarget:s.closestToTarget,steps:s.steps,maxPathLengthReached:s.maxPathLengthReached}}equal(e,t){return P.equal(e.position,t.position)?e.layer===t.layer:!1}shortestPathBfs(e,t,r,o,n){var d;let s=new mt,a=new mt,p=0;s.otherBfs=a,a.otherBfs=s;let c=e,u=o(e.position,t.position);for(s.queue.enqueue({node:e,dist:0}),a.queue.enqueue({node:t,dist:0}),s.visited.set(b.toString(e),0),a.visited.set(b.toString(t),0);s.queue.size()>0||a.queue.size()>0;){let m=s.queue.dequeue();if(!m)break;let{node:f,dist:x}=m;if(x+1+(((d=a.queue.peek())==null?void 0:d.dist)||0)>this.maxPathLength)return{previous:s.previous,previous2:a.previous,closestToTarget:c,steps:p,maxPathLengthReached:!0};let y=o(f.position,t.position);if(y<u&&(u=y,c=f),a.visited.has(b.toString(f)))return{previous:s.previous,previous2:a.previous,closestToTarget:t,matchingPos:f,steps:p,maxPathLengthReached:!1};p++,s.step(r(f),f,x);let K=a.queue.dequeue();if(!K)continue;let{node:_,dist:$}=K;if(s.visited.has(b.toString(_)))return{previous:s.previous,previous2:a.previous,closestToTarget:t,matchingPos:_,steps:p,maxPathLengthReached:!1};p++,a.step(n(_),_,$)}return{previous:s.previous,previous2:a.previous,closestToTarget:c,steps:p,maxPathLengthReached:!1}}returnPath(e,t,r,o,n){if(r){let s=this.getPathFromPrev(e,o,r).reverse(),a=this.getPathFromPrev(t,n,r);return s.pop(),[...s,...a]}else return this.getPathFromPrev(e,o,n).reverse()}getPathFromPrev(e,t,r){let o=[],n=r;for(o.push(n);!this.equal(n,t);){if(n=e.get(b.toString(n)),!n)return[];o.push(n)}return o}}});function Ti(i){switch(i){case"BIDIRECTIONAL_SEARCH":return new dt}return new ut}var ft=h(()=>{Pi();xi()});function io(i,e,t){var n;let r=B.create((n=i.numberOfDirections)!=null?n:4);return s=>r.neighbors(s.position).map(c=>{let u=t.getTransition(c,s.layer);return{position:c,layer:u||s.layer}}).filter(c=>!gt(s,c,t,i)||i.ignoreBlockedTarget&&b.equal(c,e))}function oo(i,e,t){var n;let r=B.create((n=i.numberOfDirections)!=null?n:4);return s=>{let a=r.neighbors(s.position),p=t.getTransitions(),c=[...p.keys()].filter(m=>m===s.position.toString()).map(m=>p.get(m)).map(m=>m?[...m.keys()].filter(f=>m.get(f)===s.layer):[]).flat(),u=t.getTransition(s.position,s.layer);return u&&u!==s.layer||c.push(s.layer),a.map(m=>c.map(f=>({position:m,layer:f||s.layer}))).flat().filter(m=>!gt(m,s,t,i)||i.ignoreBlockedTarget&&b.equal(s,e))}}function gt(i,e,t,r){let o=r.isPositionAllowed(e.position,e.layer),n=!r.ignoreTiles&&so(i,e,r.pathWidth,r.pathHeight,r.ignoreMapBounds,t),s=r.ignoreMapBounds||t.isInRange(e.position);return no(e,r.pathWidth,r.pathHeight,r.collisionGroups,r.ignoredChars,t)||n||!s||!o}function no(i,e,t,r,o,n){for(let s=i.position.x;s<i.position.x+e;s++)for(let a=i.position.y;a<i.position.y+t;a++)if(n.hasBlockingChar(new l(s,a),i.layer,r,new Set(o)))return!0;return!1}function so(i,e,t,r,o,n){for(let s=e.position.x;s<e.position.x+t;s++)for(let a=e.position.y;a<e.position.y+r;a++)if(n.hasBlockingTile(new l(s,a),e.layer,Ie(Pr(i.position,e.position)),o))return!0;return!1}var de,yt=h(()=>{E();lt();ge();O();oe();ft();de=class{constructor(e,t){this.shortestPathAlgorithm=e;this.gridTilemap=t}findShortestPath(e,t,{shortestPathAlgorithm:r,pathWidth:o=1,pathHeight:n=1,numberOfDirections:s=4,isPositionAllowed:a=(x,y)=>!0,collisionGroups:p=[],ignoredChars:c=[],ignoreTiles:u=!1,ignoreMapBounds:d=!1,ignoreBlockedTarget:m=!1,maxPathLength:f=1/0}={}){let x=Ti(r!=null?r:this.shortestPathAlgorithm);x.setMaxPathLength(f);let y={shortestPathAlgorithm:r||this.shortestPathAlgorithm,pathWidth:o,pathHeight:n,numberOfDirections:s,isPositionAllowed:a,collisionGroups:p,ignoredChars:c,ignoreTiles:u,ignoreMapBounds:d,ignoreBlockedTarget:m,maxPathLength:f},K=io(y,t,this.gridTilemap),_=oo(y,t,this.gridTilemap),$=s===4?P.manhattanDistance:P.chebyshevDistance;return x.getShortestPath(e,t,K,$,_)}}});var fe,vt=h(()=>{Se();lt();bi();ct();re();yt();fe=class{constructor(e,t,r,{config:o,ignoreBlockedTarget:n=!1,distance:s=0}={}){this.character=e;this.tilemap=t;this.targetPos=r;this.shortestPath=[];this.distOffset=0;this.posOnPath=0;this.stopped=!1;this.pathBlockedWaitElapsed=0;this.isPositionAllowed=()=>!0;this.shortestPathAlgorithm="BIDIRECTIONAL_SEARCH";this.maxPathLength=1/0;this.isBlocking=(e,t)=>e?gt(this.character.getTilePos(),{position:e,layer:t},this.tilemap,this.getPathfindingOptions()):!0;var a;this.shortestPathAlgorithm=(a=o==null?void 0:o.algorithm)!=null?a:this.shortestPathAlgorithm,this.ignoreBlockedTarget=n,this.distance=s,this.noPathFoundStrategy=(o==null?void 0:o.noPathFoundStrategy)||"STOP",this.pathBlockedStrategy=(o==null?void 0:o.pathBlockedStrategy)||"WAIT",this.noPathFoundRetryable=new we((o==null?void 0:o.noPathFoundRetryBackoffMs)||200,(o==null?void 0:o.noPathFoundMaxRetries)||-1,()=>{this.stop("NO_PATH_FOUND_MAX_RETRIES_EXCEEDED")}),this.pathBlockedRetryable=new we((o==null?void 0:o.pathBlockedRetryBackoffMs)||200,(o==null?void 0:o.pathBlockedMaxRetries)||-1,()=>{this.stop("PATH_BLOCKED_MAX_RETRIES_EXCEEDED")}),o!=null&&o.isPositionAllowedFn&&(this.isPositionAllowed=o.isPositionAllowedFn),o!=null&&o.maxPathLength&&(this.maxPathLength=o.maxPathLength),this.distanceUtils=B.create(e.getNumberOfDirections()),this.pathBlockedWaitTimeoutMs=(o==null?void 0:o.pathBlockedWaitTimeoutMs)||-1,this.finished$=new v,this.setCharacter(e)}setPathBlockedStrategy(e){this.pathBlockedStrategy=e}getPathBlockedStrategy(){return this.pathBlockedStrategy}setCharacter(e){this.character=e,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(w(t=>t!==this),F(1)).subscribe(()=>{this.stop("MOVEMENT_TERMINATED")})}getPathfindingOptions(){return{shortestPathAlgorithm:this.shortestPathAlgorithm,pathWidth:this.character.getTileWidth(),pathHeight:this.character.getTileHeight(),numberOfDirections:this.character.getNumberOfDirections(),isPositionAllowed:this.isPositionAllowed,collisionGroups:this.character.getCollisionGroups(),ignoredChars:[this.character.getId()],ignoreTiles:!this.character.collidesWithTiles(),ignoreMapBounds:this.character.getIgnoreMissingTiles(),ignoreBlockedTarget:this.ignoreBlockedTarget,maxPathLength:this.maxPathLength}}update(e){var t,r,o,n;this.stopped||(this.noPathFound()&&(this.noPathFoundStrategy==="RETRY"?this.noPathFoundRetryable.retry(e,()=>this.calcShortestPath()):this.noPathFoundStrategy==="STOP"&&this.stop("NO_PATH_FOUND")),this.updatePosOnPath(),this.isBlocking((t=this.nextTileOnPath())==null?void 0:t.position,(r=this.character)==null?void 0:r.getNextTilePos().layer)?this.applyPathBlockedStrategy(e):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop("SUCCESS"),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking((o=this.nextTileOnPath())==null?void 0:o.position,(n=this.character)==null?void 0:n.getNextTilePos().layer)||this.moveCharOnPath())}finishedObs(){return this.finished$}getInfo(){return{type:"Target",config:{algorithm:this.shortestPathAlgorithm,ignoreBlockedTarget:this.ignoreBlockedTarget,distance:this.distance,targetPos:this.targetPos,noPathFoundStrategy:this.noPathFoundStrategy,pathBlockedStrategy:this.pathBlockedStrategy,noPathFoundRetryBackoffMs:this.noPathFoundRetryable.getBackoffMs(),noPathFoundMaxRetries:this.noPathFoundRetryable.getMaxRetries()}}}resultToReason(e){switch(e){case"SUCCESS":return"Successfully arrived.";case"MOVEMENT_TERMINATED":return"Movement of character has been replaced before destination was reached.";case"PATH_BLOCKED":return"PathBlockedStrategy STOP: Path blocked.";case"NO_PATH_FOUND_MAX_RETRIES_EXCEEDED":return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case"NO_PATH_FOUND":return"NoPathFoundStrategy STOP: No path found.";case"PATH_BLOCKED_MAX_RETRIES_EXCEEDED":return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case"PATH_BLOCKED_WAIT_TIMEOUT":return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`}}applyPathBlockedStrategy(e){this.pathBlockedStrategy==="RETRY"?this.pathBlockedRetryable.retry(e,()=>{let t=this.getShortestPath();t.path.length>0&&this.calcShortestPath(t)}):this.pathBlockedStrategy==="STOP"?this.stop("PATH_BLOCKED"):this.pathBlockedStrategy==="WAIT"&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=e,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop("PATH_BLOCKED_WAIT_TIMEOUT"))}moveCharOnPath(){let e=this.nextTileOnPath();if(!e)return;let t=this.getDir(this.character.getNextTilePos().position,e.position);this.character.move(t)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(e){this.finished$.next({position:this.character.getTilePos().position,result:e,description:this.resultToReason(e),layer:this.character.getTilePos().layer}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let e=this.shortestPath[this.posOnPath+1],t=this.getDir(this.character.getNextTilePos().position,e.position);this.character.turnTowards(t)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let e=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().position.x!=e.position.x||this.character.getNextTilePos().position.y!=e.position.y);)this.posOnPath++,e=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(e){e=e!=null?e:this.getShortestPath(),this.posOnPath=0,this.shortestPath=e.path,this.distOffset=e.distOffset}getShortestPath(){let e=new de(this.shortestPathAlgorithm,this.tilemap),{path:t,closestToTarget:r}=e.findShortestPath(this.character.getNextTilePos(),this.targetPos,this.getPathfindingOptions());if(t.length==0&&this.noPathFoundStrategy==="CLOSEST_REACHABLE"){let n=e.findShortestPath(this.character.getNextTilePos(),r,this.getPathfindingOptions()).path,s=this.distanceUtils.distance(r.position,this.targetPos.position);return{path:n,distOffset:s}}return{path:t,distOffset:0}}getDir(e,t){return this.tilemap.fromMapDirection(this.distanceUtils.direction(e,t))}}});function Ci(i,e){return i.filter(t=>{var r,o,n,s,a,p;return(r=e.labels)!=null&&r.withAllLabels?(o=e.labels)==null?void 0:o.withAllLabels.every(c=>t.hasLabel(c)):(n=e.labels)!=null&&n.withOneOfLabels?(s=e.labels)==null?void 0:s.withOneOfLabels.some(c=>t.hasLabel(c)):(a=e.labels)!=null&&a.withNoneLabels?!((p=e.labels)!=null&&p.withNoneLabels.some(c=>t.hasLabel(c))):!0})}var cr=h(()=>{});var bt,pr=h(()=>{bt="2.27.0"});var Pt,Si=h(()=>{Ce();vt();O();Se();Pt=class{constructor(e,t,r,o=0,n="STOP",s=1/0){this.character=e;this.gridTilemap=t;this.charToFollow=r;this.distance=o;this.noPathFoundStrategy=n;this.maxPathLength=s;this.character=e,this.updateTarget(this.charToFollow.getTilePos().position,this.charToFollow.getTilePos().layer),this.charToFollow.positionChangeStarted().pipe(C(this.character.autoMovementSet().pipe(w(a=>a!==this),F(1)))).subscribe(({enterTile:a,enterLayer:p})=>{this.updateTarget(a,p)})}update(e){var t;(t=this.targetMovement)==null||t.update(e)}getInfo(){return{type:"Follow",config:{charToFollow:this.charToFollow.getId(),distance:this.distance,noPathFoundStrategy:this.noPathFoundStrategy,maxPathLength:this.maxPathLength}}}updateTarget(e,t){this.targetMovement=new fe(this.character,this.gridTilemap,{position:new l(e),layer:t},{distance:this.distance+1,config:{noPathFoundStrategy:this.noPathFoundStrategy,maxPathLength:this.maxPathLength},ignoreBlockedTarget:!0})}}});var De,wi=h(()=>{De=class{static getRandomInt(e){return Math.floor(Math.random()*Math.floor(e))}}});var xt,Oi=h(()=>{wi();lt();E();Ce();O();xt=class{constructor(e,t=0,r=-1){this.character=e;this.delay=t;this.radius=r;this.stepSize=0;this.delayLeft=this.delay,this.initialRow=e.getNextTilePos().position.y,this.initialCol=e.getNextTilePos().position.x,this.randomizeStepSize(),this.stepsWalked=0,this.currentMovementDirection="none",this.character.positionChangeStarted().pipe(C(this.character.autoMovementSet().pipe(w(o=>o!==this),F(1)))).subscribe(()=>{this.stepsWalked++}),this.distanceUtils=B.create(e.getNumberOfDirections())}update(e){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=e,this.delayLeft<=0){this.delayLeft=this.delay;let t=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(t),this.currentMovementDirection=t,this.randomizeStepSize()}}getInfo(){return{type:"Random",config:{delay:this.delay,radius:this.radius}}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!=="none"&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return this.distanceUtils.getDirections().filter(t=>!this.character.isBlockingDirection(t)).filter(t=>this.isWithinRadius(t))}isWithinRadius(e){return this.radius==-1?!0:this.getDist(e)<=this.radius}getDist(e){return this.distanceUtils.distance(this.character.getNextTilePos().position.add(U(e)),new l(this.initialCol,this.initialRow))}getFreeRandomDirection(){let e=this.getFreeDirections();return e.length==0?"none":e[De.getRandomInt(e.length)]}randomizeStepSize(){this.stepSize=De.getRandomInt(this.radius)+1}}});var Tt,Li=h(()=>{re();O();st();Tt=class{constructor(e){this.collistionStrategy=e;this.tilePosToCharacters=new Map;this.charRemoved$=new v}isCharBlockingAt(e,t,r,o=new Set){let n=this.posToString(e,t),s=this.tilePosToCharacters.get(n);return!!(s&&s.size>0&&[...s].filter(a=>!o.has(a.getId())).some(a=>a.getCollisionGroups().some(p=>r.includes(p))))}getCharactersAt(e,t){let r=this.posToString(e,t),o=this.tilePosToCharacters.get(r);return new Set(o)}addCharacter(e){this.addTilePositions(e.getTilePos(),e),this.addTilePositions(e.getNextTilePos(),e),this.addPositionChangeSub(e),this.addPositionChangeFinishedSub(e),this.addTilePosSetSub(e)}removeCharacter(e){let t=e.getId();this.charRemoved$.next(t),this.deleteTilePositions(e.getTilePos(),e),this.deleteTilePositions(e.getNextTilePos(),e)}add(e,t){var r;this.tilePosToCharacters.has(e)||this.tilePosToCharacters.set(e,new Set),(r=this.tilePosToCharacters.get(e))==null||r.add(t)}addTilePosSetSub(e){e.tilePositionSet().pipe(C(this.charRemoved(e.getId()))).subscribe(t=>{this.deleteTilePositions(e.getNextTilePos(),e),this.addTilePositions(t,e)})}charRemoved(e){var t;return(t=this.charRemoved$)==null?void 0:t.pipe(F(1),w(r=>r==e))}addPositionChangeSub(e){e.positionChangeStarted().pipe(C(this.charRemoved(e.getId())),this.posChangeToLayerPos()).subscribe(t=>{this.collistionStrategy==="BLOCK_ONE_TILE_AHEAD"&&this.deleteTilePositions(t.exit,e),this.addTilePositions(t.enter,e)})}addPositionChangeFinishedSub(e){e.positionChangeFinished().pipe(C(this.charRemoved(e.getId())),this.posChangeToLayerPos()).subscribe(t=>{this.deleteTilePositions(t.exit,e),this.addTilePositions(t.enter,e)})}addTilePositions(e,t){this.forEachCharTile(e,t,(r,o)=>{this.add(this.posToString(new l(r,o),e.layer),t)})}deleteTilePositions(e,t){this.forEachCharTile(e,t,(r,o)=>{var n;(n=this.tilePosToCharacters.get(this.posToString(new l(r,o),e.layer)))==null||n.delete(t)})}forEachCharTile(e,t,r){let o=e.position;for(let n=o.x;n<o.x+t.getTileWidth();n++)for(let s=o.y;s<o.y+t.getTileHeight();s++)r(n,s)}posChangeToLayerPos(){return Bt(H(e=>({enter:{position:new l(e.enterTile),layer:e.enterLayer},exit:{position:new l(e.exitTile),layer:e.exitLayer}})))}posToString(e,t){return`${e.x}#${e.y}#${t}`}}});var Ct,Ei=h(()=>{Ct=class{constructor(e,t,r,o){this.x=e;this.y=t;this.width=r;this.height=o}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}isInRange(e){return e.x>=this.x&&e.x<this.x+this.width&&e.y>=this.y&&e.y<this.y+this.height}}});var St,wt=h(()=>{St="ge_charLayer"});var ur,Le,Ii=h(()=>{E();Li();Ei();wt();ur=class{constructor(e,t,r){this.tilemap=e;this.collisionTilePropertyName=t;this.characters=new Map;this.transitions=new Map;this.charBlockCache=new Tt(r)}addCharacter(e){this.characters.set(e.getId(),e),e.getNextTilePos().layer===void 0&&e.setTilePosition(se(L({},e.getNextTilePos()),{layer:this.getLowestCharLayer()})),this.charBlockCache.addCharacter(e)}removeCharacter(e){let t=this.characters.get(e);t&&(this.charBlockCache.removeCharacter(t),this.characters.delete(e))}getCharacters(){return[...this.characters.values()]}getCharactersAt(e,t){return this.charBlockCache.getCharactersAt(e,t)}hasBlockingTile(e,t,r,o){return!o&&this.hasNoTile(e,t)?!0:this.getCollisionRelevantLayers(t).some(n=>this.isLayerBlockingAt(n.getName(),e,r))}getTransition(e,t){let r=this.transitions.get(e.toString());if(r)return r.get(t)}setTransition(e,t,r){var o;this.transitions.has(e.toString())||this.transitions.set(e.toString(),new Map),(o=this.transitions.get(e.toString()))==null||o.set(t,r)}getTransitions(){return new Map([...this.transitions].map(([e,t])=>[e,new Map(t)]))}hasNoTile(e,t){return!this.getCollisionRelevantLayers(t).some(r=>this.tilemap.hasTileAt(e.x,e.y,r.getName()))}hasBlockingChar(e,t,r,o=new Set){return this.charBlockCache.isCharBlockingAt(e,t,r,o)}isInRange(e){return new Ct(0,0,this.tilemap.getWidth(),this.tilemap.getHeight()).isInRange(e)}toMapDirection(e){return this.isIsometric()?vr(e):e}fromMapDirection(e){return this.isIsometric()?br(e):e}isIsometric(){return this.tilemap.getOrientation()==="isometric"}getTilePosInDirection(e,t){let r=e.position.add(U(this.toMapDirection(t))),o=this.getTransition(r,e.layer)||e.layer;return{position:r,layer:o}}isLayerBlockingAt(e,t,r){let o=ur.ONE_WAY_COLLIDE_PROP_PREFIX+r,n=this.tilemap.getTileAt(t.x,t.y,e);return!!(n!=null&&n.getProperty(this.collisionTilePropertyName)||n!=null&&n.getProperty(o))}getCharLayerIndexes(){return this.tilemap.getLayers().map((e,t)=>({layer:e,index:t})).filter(({layer:e})=>e.isCharLayer()).map(({index:e})=>e)}findPrevAndCharLayer(e){let t=this.getCharLayerIndexes(),r=this.tilemap.getLayers(),o=t.findIndex(n=>r[n].getProperty(St)==e);return o==0?{prevIndex:-1,charLayerIndex:t[o]}:{prevIndex:t[o-1],charLayerIndex:t[o]}}getCollisionRelevantLayers(e){if(!e)return this.tilemap.getLayers();let{prevIndex:t,charLayerIndex:r}=this.findPrevAndCharLayer(e);return this.tilemap.getLayers().slice(t+1,r+1)}getLowestCharLayer(){for(let e of this.tilemap.getLayers())if(e.isCharLayer())return e.getName()}},Le=ur;Le.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_"});var mr=h(()=>{});var Ot,_i=h(()=>{st();Si();vt();it();E();Oi();re();Ce();O();Se();ct();ot();cr();pr();yt();ge();ft();Ii();mr();Ot=class{constructor(){this.isCreatedInternal=!1;console.log(`Using GridEngine v${bt}`)}getCharLayer(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getTilePos().layer}getTransition(e,t){var r;return this.initGuard(),(r=this.gridTilemap)==null?void 0:r.getTransition(new l(e),t)}setTransition(e,t,r){var o;return this.initGuard(),(o=this.gridTilemap)==null?void 0:o.setTransition(new l(e),t,r)}create(e,t){this.isCreatedInternal=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(t);this.config=r,this.movementStopped$=new v,this.movementStarted$=new v,this.directionChanged$=new v,this.positionChangeStarted$=new v,this.positionChangeFinished$=new v,this.charRemoved$=new v,this.charAdded$=new v,this.gridTilemap=new Le(e,this.config.collisionTilePropertyName,this.config.characterCollisionStrategy),this.addCharacters()}getPosition(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getTilePos().position}move(e,t){this.moveChar(e,t)}moveRandomly(e,t=0,r=-1){var s;this.initGuard();let o=(s=this.gridCharacters)==null?void 0:s.get(e);if(!o)throw this.createCharUnknownErr(e);let n=new xt(o,t,r);o.setMovement(n)}getMovement(e){var o;this.initGuard();let t=(o=this.gridCharacters)==null?void 0:o.get(e);if(!t)throw this.createCharUnknownErr(e);let r=t.getMovement();return r?r.getInfo():{type:"None"}}moveTo(e,t,r){var a;let o=this.assembleMoveToConfig(r);this.initGuard();let n=(a=this.gridCharacters)==null?void 0:a.get(e);if(!n)throw this.createCharUnknownErr(e);if(!this.gridTilemap)throw this.createUninitializedErr();let s=new fe(n,this.gridTilemap,{position:new l(t),layer:(r==null?void 0:r.targetLayer)||n.getNextTilePos().layer},{distance:0,config:o});return n.setMovement(s),s.finishedObs().pipe(H(p=>({charId:e,position:p.position,result:p.result,description:p.description,layer:p.layer})))}stopMovement(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);t.setMovement(void 0)}setSpeed(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);r.setSpeed(t)}getSpeed(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getSpeed()}collidesWithTiles(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.collidesWithTiles()}update(e,t){if(this.isCreatedInternal&&this.gridCharacters)for(let[r,o]of this.gridCharacters)o.update(t)}addCharacter(e){var n,s,a,p,c;if(!this.gridTilemap)throw this.createUninitializedErr();if(!this.config)throw this.createUninitializedErr();let t={speed:e.speed||4,tilemap:this.gridTilemap,collidesWithTiles:!0,collisionGroups:["geDefault"],charLayer:e.charLayer,facingDirection:e.facingDirection,labels:e.labels,numberOfDirections:(n=e.numberOfDirections)!=null?n:this.config.numberOfDirections,tileWidth:e.tileWidth,tileHeight:e.tileHeight};typeof e.collides=="boolean"?e.collides===!1&&(t.collidesWithTiles=!1,t.collisionGroups=[]):e.collides!==void 0&&(e.collides.collidesWithTiles===!1&&(t.collidesWithTiles=!1),e.collides.collisionGroups&&(t.collisionGroups=e.collides.collisionGroups),t.ignoreMissingTiles=(a=(s=e.collides)==null?void 0:s.ignoreMissingTiles)!=null?a:!1);let r=new rt(e.id,t);e.startPosition&&r.setTilePosition({position:new l(e.startPosition),layer:r.getTilePos().layer}),(p=this.gridCharacters)==null||p.set(e.id,r),this.gridTilemap.addCharacter(r);let o=r.getId();r.movementStopped().pipe(C(this.charRemoved(o))).subscribe(u=>{var d;(d=this.movementStopped$)==null||d.next({charId:o,direction:u})}),r.movementStarted().pipe(C(this.charRemoved(o))).subscribe(u=>{var d;(d=this.movementStarted$)==null||d.next({charId:o,direction:u})}),r.directionChanged().pipe(C(this.charRemoved(o))).subscribe(u=>{var d;(d=this.directionChanged$)==null||d.next({charId:o,direction:u})}),r.positionChangeStarted().pipe(C(this.charRemoved(o))).subscribe(u=>{var d;(d=this.positionChangeStarted$)==null||d.next(L({charId:o},u))}),r.positionChangeFinished().pipe(C(this.charRemoved(o))).subscribe(u=>{var d;(d=this.positionChangeFinished$)==null||d.next(L({charId:o},u))}),(c=this.charAdded$)==null||c.next(o)}hasCharacter(e){var t;return this.initGuard(),!!((t=this.gridCharacters)!=null&&t.has(e))}removeCharacter(e){var r,o,n,s;if(this.initGuard(),!((r=this.gridCharacters)==null?void 0:r.get(e)))throw this.createCharUnknownErr(e);(o=this.gridTilemap)==null||o.removeCharacter(e),(n=this.gridCharacters)==null||n.delete(e),(s=this.charRemoved$)==null||s.next(e)}removeAllCharacters(){if(this.initGuard(),!!this.gridCharacters)for(let e of this.gridCharacters.keys())this.removeCharacter(e)}getAllCharacters(e){if(this.initGuard(),!this.gridCharacters)return[];let t=[...this.gridCharacters.values()];return(e?Ci(t,e):t).map(o=>o.getId())}getLabels(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getLabels()}addLabels(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);r.addLabels(t)}removeLabels(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);r.removeLabels(t)}clearLabels(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);t.clearLabels()}follow(e,t,r,o){var c,u;let n;r===void 0?n={distance:0,closestPointIfBlocked:!1}:typeof r=="number"?(n={distance:r,closestPointIfBlocked:!1},o&&(n.closestPointIfBlocked=!0)):n=r,this.initGuard();let s=(c=this.gridCharacters)==null?void 0:c.get(e),a=(u=this.gridCharacters)==null?void 0:u.get(t);if(!s)throw this.createCharUnknownErr(e);if(!a)throw this.createCharUnknownErr(t);if(!this.gridTilemap)throw this.createUninitializedErr();let p=new Pt(s,this.gridTilemap,a,n.distance,n.closestPointIfBlocked?"CLOSEST_REACHABLE":"STOP",n.maxPathLength);s.setMovement(p)}isMoving(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.isMoving()}getFacingDirection(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getFacingDirection()}getFacingPosition(e){var o;this.initGuard();let t=(o=this.gridCharacters)==null?void 0:o.get(e);if(!t)throw this.createCharUnknownErr(e);let r=t.getFacingPosition();return{x:r.x,y:r.y}}turnTowards(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);return r.turnTowards(t)}getCharactersAt(e,t){if(!this.gridTilemap)return[];let r=this.gridTilemap.getCharactersAt(new l(e),t);return Array.from(r).map(o=>o.getId())}setPosition(e,t,r){var n;this.initGuard();let o=(n=this.gridCharacters)==null?void 0:n.get(e);if(!o)throw this.createCharUnknownErr(e);r||o.setTilePosition({position:new l(t),layer:o.getTilePos().layer}),o.setTilePosition({position:new l(t),layer:r})}isBlocked(e,t,r=["geDefault"]){var n,s;this.initGuard();let o=new l(e);return!!((n=this.gridTilemap)!=null&&n.hasBlockingTile(o,t)||(s=this.gridTilemap)!=null&&s.hasBlockingChar(o,t,r))}isTileBlocked(e,t){var r;return this.initGuard(),!!((r=this.gridTilemap)!=null&&r.hasBlockingTile(new l(e),t))}getCollisionGroups(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getCollisionGroups()||[]}setCollisionGroups(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);r.setCollisionGroups(t)}getTilePosInDirection(e,t,r){if(!this.gridTilemap)throw this.createUninitializedErr();let o=this.gridTilemap.getTilePosInDirection({position:new l(e),layer:t},r);return{position:o.position.toPosition(),charLayer:o.layer}}findShortestPath(e,t,r={}){if(!this.gridTilemap)throw this.createUninitializedErr();let n=new de(r.shortestPathAlgorithm||"BFS",this.gridTilemap).findShortestPath(b.toInternal(e),b.toInternal(t),r);return{path:n.path.map(b.fromInternal),closestToTarget:b.fromInternal(n.closestToTarget),reachedMaxPathLength:!1}}steppedOn(e,t,r){return this.positionChangeFinished().pipe(w(o=>e.includes(o.charId)&&t.some(n=>n.x===o.enterTile.x&&n.y===o.enterTile.y)&&(r===void 0||r.includes(o.enterLayer))))}characterShifted(){if(!this.charAdded$||!this.charRemoved$)throw this.createUninitializedErr();return this.charAdded$.pipe(H(e=>({charId:e,action:"ADDED"})),nr(this.charRemoved$.pipe(H(e=>({charId:e,action:"REMOVED"})))))}movementStarted(){if(!this.movementStarted$)throw this.createUninitializedErr();return this.movementStarted$}movementStopped(){if(!this.movementStopped$)throw this.createUninitializedErr();return this.movementStopped$}directionChanged(){if(!this.directionChanged$)throw this.createUninitializedErr();return this.directionChanged$}positionChangeStarted(){if(!this.positionChangeStarted$)throw this.createUninitializedErr();return this.positionChangeStarted$}positionChangeFinished(){if(!this.positionChangeFinished$)throw this.createUninitializedErr();return this.positionChangeFinished$}getMovementProgress(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getMovementProgress()}charRemoved(e){var t;if(!this.charRemoved$)throw this.createUninitializedErr();return(t=this.charRemoved$)==null?void 0:t.pipe(F(1),w(r=>r==e))}initGuard(){if(!this.isCreatedInternal)throw this.createUninitializedErr()}createUninitializedErr(){throw new Error("GridEngine not initialized. You need to call create() first.")}addCharacters(){var e;(e=this.config)==null||e.characters.forEach(t=>this.addCharacter(t))}moveChar(e,t){var o,n,s;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);if(r.getNumberOfDirections()===4){if(!((n=this.gridTilemap)!=null&&n.isIsometric())&&It(t)){console.warn(`GridEngine: Character '${e}' can't be moved '${t}' in 4 direction mode.`);return}else if((s=this.gridTilemap)!=null&&s.isIsometric()&&!It(t)){console.warn(`GridEngine: Character '${e}' can't be moved '${t}' in 4 direction isometric mode.`);return}}r.move(t)}createCharUnknownErr(e){return new Error(`Character unknown: ${e}`)}assembleMoveToConfig(e={}){let t=se(L({},e),{noPathFoundStrategy:"STOP",pathBlockedStrategy:"WAIT"});return e!=null&&e.noPathFoundStrategy&&(Object.values(ue).includes(e.noPathFoundStrategy)?t.noPathFoundStrategy=e.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${e.noPathFoundStrategy}'. Falling back to '${"STOP"}'`)),e!=null&&e.pathBlockedStrategy&&(Object.values(Oe).includes(e.pathBlockedStrategy)?t.pathBlockedStrategy=e.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${e.pathBlockedStrategy}'. Falling back to '${"WAIT"}'`)),t}setConfigDefaults(e){return L({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES"},e)}}});var X,Y,Ri=h(()=>{dr();ar();O();oe();X=class{constructor(e){this.tilemap=e;this.charLayerDepths=new Map;this.setLayerDepths()}getTileWidth(){var t,r;let e=(r=(t=this.tilemap.layers[0])==null?void 0:t.tilemapLayer.scale)!=null?r:1;return this.tilemap.tileWidth*e}getTileHeight(){var t,r;let e=(r=(t=this.tilemap.layers[0])==null?void 0:t.tilemapLayer.scale)!=null?r:1;return this.tilemap.tileHeight*e}getDepthOfCharLayer(e){var t;return(t=this.charLayerDepths.get(e))!=null?t:0}tilePosToPixelPos(e){return this.isIsometric()?P.scalarMult(this.getTileSize(),.5).multiply(new l(e.x-e.y,e.x+e.y)):e.clone().multiply(this.getTileSize())}getTileDistance(e){if(this.isIsometric())switch(e){case"down-left":case"down-right":case"up-left":case"up-right":return P.scalarMult(this.getTileSize(),.5);default:return this.getTileSize()}return this.getTileSize()}getTileSize(){return new l(this.getTileWidth(),this.getTileHeight())}isIsometric(){return this.tilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()}isLayerAlwaysOnTop(e){return this.hasLayerProp(e,X.ALWAYS_TOP_PROP_NAME)}isCharLayer(e){return this.hasLayerProp(e,X.CHAR_LAYER_PROP_NAME)}setLayerDepths(){let e=[],t=-1,r=this.tilemap.layers.filter(n=>this.isLayerAlwaysOnTop(n));this.tilemap.layers.filter(n=>!this.isLayerAlwaysOnTop(n)).forEach(n=>{this.hasLayerProp(n,X.HEIGHT_SHIFT_PROP_NAME)?(this.createHeightShiftLayers(n,t),e.push(n.tilemapLayer)):this.setDepth(n,++t)}),this.charLayerDepths.set(void 0,t),r.forEach((n,s)=>{n.tilemapLayer.setDepth(s+1+t)}),e.forEach(n=>n.destroy())}setDepth(e,t){e.tilemapLayer.setDepth(t),this.isCharLayer(e)&&this.charLayerDepths.set(this.getLayerProp(e,X.CHAR_LAYER_PROP_NAME),t)}createHeightShiftLayers(e,t){let r=this.getLayerProp(e,X.HEIGHT_SHIFT_PROP_NAME);isNaN(r)&&(r=0);let o=1;for(let n=0;n<e.height;n++){let s=this.copyLayer(e,n);s.scale=e.tilemapLayer.scale,s.setDepth(t+pe.shiftPad((n+r)*this.getTileHeight()+o,X.Z_INDEX_PADDING))}}getLayerProp(e,t){let o=e.properties.find(n=>n.name==t);return o==null?void 0:o.value}hasLayerProp(e,t){return this.getLayerProp(e,t)!=null}copyLayer(e,t){let r=`${e.name}#${t}`,o=this.tilemap.createBlankLayer(r,e.tilemapLayer.tileset);o.name=r;for(let n=0;n<e.width;n++)o.putTileAt(e.data[t][n],n,t);return o}},Y=X;Y.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",Y.CHAR_LAYER_PROP_NAME="ge_charLayer",Y.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",Y.Z_INDEX_PADDING=7});var ne,Dt=h(()=>{ne=class{constructor(e){this.phaserTile=e}getProperty(e){return this.phaserTile.properties[e]}hasProperty(e){return this.getProperty(e)!=null}}});var Ee,fr=h(()=>{wt();Dt();Ee=class{constructor(e){this.phaserTilemapLayer=e}getName(){return this.phaserTilemapLayer.layer.name}getProperty(e){let t=this.phaserTilemapLayer.layer.properties,r=t==null?void 0:t.find(o=>o.name==e);return r==null?void 0:r.value}hasProperty(e){return this.getProperty(e)!=null}isCharLayer(){return this.hasProperty(St)}getData(){return this.phaserTilemapLayer.layer.data.map(e=>e.map(t=>new ne(t)))}}});var Lt,Mi=h(()=>{Dt();fr();Lt=class{constructor(e){this.phaserTilemap=e}getTileWidth(){return this.phaserTilemap.tileWidth}getTileHeight(){return this.phaserTilemap.tileHeight}getWidth(){return this.phaserTilemap.width}getHeight(){return this.phaserTilemap.height}getOrientation(){return this.phaserTilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()?"isometric":"orthogonal"}getLayers(){return this.phaserTilemap.layers.map(e=>new Ee(e.tilemapLayer))}hasTileAt(e,t,r){return!!this.phaserTilemap.hasTileAt(e,t,r)}getTileAt(e,t,r){if(this.phaserTilemap.getTileAt(e,t,!1,r))return new ne(this.phaserTilemap.getTileAt(e,t,!1,r))}}});var Et,dr=h(()=>{gi();st();vt();it();E();Se();ct();ot();cr();pr();yt();ft();_i();Ri();Mi();wt();fr();Dt();mr();Et=class{constructor(e){this.scene=e;this.geHeadless=new Ot;this.isCreatedInternal=!1;console.log(`Using GridEngine Phaser Plugin v${bt}`),this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this)}getCharLayer(e){return this.geHeadless.getCharLayer(e)}getTransition(e,t){return this.geHeadless.getTransition(e,t)}setTransition(e,t,r){this.geHeadless.setTransition(e,t,r)}create(e,t){this.geHeadless.create(new Lt(e),t),this.isCreatedInternal=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(t);this.config=r,this.gridTilemap=new Y(e),this.addCharacters()}getPosition(e){return this.geHeadless.getPosition(e)}move(e,t){this.geHeadless.move(e,t)}moveRandomly(e,t=0,r=-1){this.geHeadless.moveRandomly(e,t,r)}getMovement(e){return this.geHeadless.getMovement(e)}moveTo(e,t,r){return this.geHeadless.moveTo(e,t,r)}stopMovement(e){this.geHeadless.stopMovement(e)}setSpeed(e,t){this.geHeadless.setSpeed(e,t)}getSpeed(e){return this.geHeadless.getSpeed(e)}getContainer(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getContainer()}getOffsetX(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getOffsetX()}getOffsetY(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getOffsetY()}collidesWithTiles(e){return this.geHeadless.collidesWithTiles(e)}getWalkingAnimationMapping(e){var o;this.initGuard();let t=(o=this.gridCharacters)==null?void 0:o.get(e);if(!t)throw this.createCharUnknownErr(e);let r=t.getAnimation();return r==null?void 0:r.getWalkingAnimationMapping()}hasLayerOverlay(){var e;return this.initGuard(),!!((e=this.config)!=null&&e.layerOverlay)}setWalkingAnimationMapping(e,t){var n;this.initGuard();let r=(n=this.gridCharacters)==null?void 0:n.get(e);if(!r)throw this.createCharUnknownErr(e);let o=r.getAnimation();o==null||o.setWalkingAnimationMapping(t)}update(e,t){if(this.isCreatedInternal&&this.gridCharacters)for(let[r,o]of this.gridCharacters)o.update(t);this.geHeadless.update(e,t)}addCharacter(e){this.geHeadless.addCharacter(e),this.addCharacterInternal(e)}hasCharacter(e){return this.geHeadless.hasCharacter(e)}removeCharacter(e){var r,o;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);t.destroy(),(o=this.gridCharacters)==null||o.delete(e),this.geHeadless.removeCharacter(e)}removeAllCharacters(){if(this.initGuard(),!!this.gridCharacters){for(let e of this.gridCharacters.keys())this.removeCharacter(e);this.geHeadless.removeAllCharacters()}}getAllCharacters(e){return this.geHeadless.getAllCharacters(e)}getLabels(e){return this.geHeadless.getLabels(e)}addLabels(e,t){this.geHeadless.addLabels(e,t)}removeLabels(e,t){this.geHeadless.removeLabels(e,t)}clearLabels(e){this.geHeadless.clearLabels(e)}follow(e,t,r,o){let n;r===void 0?n={distance:0,closestPointIfBlocked:!1}:typeof r=="number"?(n={distance:r,closestPointIfBlocked:!1},o&&(n.closestPointIfBlocked=!0)):n=r,this.geHeadless.follow(e,t,n)}isMoving(e){return this.geHeadless.isMoving(e)}getFacingDirection(e){return this.geHeadless.getFacingDirection(e)}getFacingPosition(e){return this.geHeadless.getFacingPosition(e)}turnTowards(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);r.turnTowards(t),this.geHeadless.turnTowards(e,t)}getCharactersAt(e,t){return this.geHeadless.getCharactersAt(e,t)}setPosition(e,t,r){this.geHeadless.setPosition(e,t,r)}getSprite(e){var r;this.initGuard();let t=(r=this.gridCharacters)==null?void 0:r.get(e);if(!t)throw this.createCharUnknownErr(e);return t.getSprite()}setSprite(e,t){var o;this.initGuard();let r=(o=this.gridCharacters)==null?void 0:o.get(e);if(!r)throw this.createCharUnknownErr(e);t.setOrigin(0,0),this.setCharSprite(t,r)}isBlocked(e,t,r=["geDefault"]){return this.geHeadless.isBlocked(e,t,r)}isTileBlocked(e,t){return this.geHeadless.isTileBlocked(e,t)}getCollisionGroups(e){return this.geHeadless.getCollisionGroups(e)}setCollisionGroups(e,t){this.geHeadless.setCollisionGroups(e,t)}getTilePosInDirection(e,t,r){return this.geHeadless.getTilePosInDirection(e,t,r)}findShortestPath(e,t,r={}){return this.geHeadless.findShortestPath(e,t,r)}steppedOn(e,t,r){return this.geHeadless.steppedOn(e,t,r)}characterShifted(){return this.geHeadless.characterShifted()}movementStarted(){return this.geHeadless.movementStarted()}movementStopped(){return this.geHeadless.movementStopped()}directionChanged(){return this.geHeadless.directionChanged()}positionChangeStarted(){return this.geHeadless.positionChangeStarted()}positionChangeFinished(){return this.geHeadless.positionChangeFinished()}getMovementProgress(e){return this.geHeadless.getMovementProgress(e)}setConfigDefaults(e){return L({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES",layerOverlay:!1},e)}initGuard(){if(!this.isCreatedInternal)throw this.createUninitializedErr()}createUninitializedErr(){throw new Error("GridEngine not initialized. You need to call create() first.")}addCharacters(){var e;(e=this.config)==null||e.characters.forEach(t=>this.addCharacterInternal(t))}createCharUnknownErr(e){return new Error(`Character unknown: ${e}`)}setCharSprite(e,t){t.setSprite(e)}addCharacterInternal(e){var r;if(this.initGuard(),!this.gridTilemap)throw this.createUninitializedErr();if(!this.config)throw this.createUninitializedErr();let t=new nt(e,this.scene,this.gridTilemap,this.config.layerOverlay,this.geHeadless);(r=this.gridCharacters)==null||r.set(e.id,t)}}});var co=Ui((Fp,Fi)=>{dr();Fi.exports=Et});return co();})();
