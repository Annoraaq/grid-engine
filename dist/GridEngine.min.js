var GridEngine=(()=>{var Ui=Object.create;var de=Object.defineProperty,Wi=Object.defineProperties,Bi=Object.getOwnPropertyDescriptor,Hi=Object.getOwnPropertyDescriptors,$i=Object.getOwnPropertyNames,Ze=Object.getOwnPropertySymbols,ji=Object.getPrototypeOf,Je=Object.prototype.hasOwnProperty,Vi=Object.prototype.propertyIsEnumerable;var Qe=(o,t,e)=>t in o?de(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,F=(o,t)=>{for(var e in t||(t={}))Je.call(t,e)&&Qe(o,e,t[e]);if(Ze)for(var e of Ze(t))Vi.call(t,e)&&Qe(o,e,t[e]);return o},et=(o,t)=>Wi(o,Hi(t));var c=(o,t)=>()=>(o&&(t=o(o=0)),t);var tr=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var zi=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of $i(t))!Je.call(o,i)&&i!==e&&de(o,i,{get:()=>t[i],enumerable:!(r=Bi(t,i))||r.enumerable});return o};var Yi=(o,t,e)=>(e=o!=null?Ui(ji(o)):{},zi(t||!o||!o.__esModule?de(e,"default",{value:o,enumerable:!0}):e,o));var b,Ct=c(()=>{b=class{static equal(t,e){return t.position.x===e.position.x&&t.position.y===e.position.y&&t.layer===e.layer}static copyOver(t,e){e.position.x=t.position.x,e.position.y=t.position.y,e.layer=t.layer}static clone(t){return{position:t.position.clone(),layer:t.layer}}static toString(t){return`${t.position.toString()}#${t.layer}`}}});var p,A=c(()=>{p=class{static get ZERO(){return new p(0,0)}static get ONE(){return new p(1,1)}static get UP(){return new p(0,-1)}static get DOWN(){return new p(0,1)}static get LEFT(){return new p(-1,0)}static get RIGHT(){return new p(1,0)}static get UP_LEFT(){return new p(-1,-1)}static get UP_RIGHT(){return new p(1,-1)}static get DOWN_RIGHT(){return new p(1,1)}static get DOWN_LEFT(){return new p(-1,1)}constructor(t,e){typeof t=="number"?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new p(this.x,this.y)}add(t){return new p(this.x+t.x,this.y+t.y)}multiply(t){return new p(this.x*t.x,this.y*t.y)}divide(t){return new p(this.x/t.x,this.y/t.y)}subtract(t){return new p(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}abs(){return new p(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}modulo(t){return new p(this.x%t.x,this.y%t.y)}scalarModulo(t){return new p(this.x%t,this.y%t)}scalarMult(t){return new p(this.x*t,this.y*t)}toString(){return`${this.x}#${this.y}`}}});function ge(o){return["down-left","down-right","up-right","up-left"].includes(o)}function er(o){return{["left"]:"down-left",["up-left"]:"left",["up"]:"up-left",["up-right"]:"up",["right"]:"up-right",["down-right"]:"right",["down"]:"down-right",["down-left"]:"down",["none"]:"none"}[o]}function V(o){return{["up"]:p.UP,["down"]:p.DOWN,["left"]:p.LEFT,["right"]:p.RIGHT,["none"]:p.ZERO,["up-left"]:p.UP_LEFT,["up-right"]:p.UP_RIGHT,["down-right"]:p.DOWN_RIGHT,["down-left"]:p.DOWN_LEFT}[o]}function rr(o){return{["up"]:"down",["down"]:"up",["left"]:"right",["right"]:"left",["none"]:"none",["up-left"]:"down-right",["up-right"]:"down-left",["down-right"]:"up-left",["down-left"]:"up-right"}[o]}var O=c(()=>{A()});var Cr=tr((yo,wt)=>{var ir,or,nr,sr,ar,hr,cr,pr,lr,St,ve,ur,mr,fr,rt,dr,gr,vr,yr,br,xr,Pr,Tr,Ot;(function(o){var t=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(r){o(e(t,e(r)))}):typeof wt=="object"&&typeof wt.exports=="object"?o(e(t,e(wt.exports))):o(e(t));function e(r,i){return r!==t&&(typeof Object.create=="function"?Object.defineProperty(r,"__esModule",{value:!0}):r.__esModule=!0),function(n,s){return r[n]=i?i(n,s):s}}})(function(o){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,i){r.__proto__=i}||function(r,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])};ir=function(r,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");t(r,i);function n(){this.constructor=r}r.prototype=i===null?Object.create(i):(n.prototype=i.prototype,new n)},or=Object.assign||function(r){for(var i,n=1,s=arguments.length;n<s;n++){i=arguments[n];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(r[a]=i[a])}return r},nr=function(r,i){var n={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&i.indexOf(s)<0&&(n[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,s=Object.getOwnPropertySymbols(r);a<s.length;a++)i.indexOf(s[a])<0&&Object.prototype.propertyIsEnumerable.call(r,s[a])&&(n[s[a]]=r[s[a]]);return n},sr=function(r,i,n,s){var a=arguments.length,h=a<3?i:s===null?s=Object.getOwnPropertyDescriptor(i,n):s,l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")h=Reflect.decorate(r,i,n,s);else for(var f=r.length-1;f>=0;f--)(l=r[f])&&(h=(a<3?l(h):a>3?l(i,n,h):l(i,n))||h);return a>3&&h&&Object.defineProperty(i,n,h),h},ar=function(r,i){return function(n,s){i(n,s,r)}},hr=function(r,i){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,i)},cr=function(r,i,n,s){function a(h){return h instanceof n?h:new n(function(l){l(h)})}return new(n||(n=Promise))(function(h,l){function f(y){try{u(s.next(y))}catch(S){l(S)}}function g(y){try{u(s.throw(y))}catch(S){l(S)}}function u(y){y.done?h(y.value):a(y.value).then(f,g)}u((s=s.apply(r,i||[])).next())})},pr=function(r,i){var n={label:0,sent:function(){if(h[0]&1)throw h[1];return h[1]},trys:[],ops:[]},s,a,h,l;return l={next:f(0),throw:f(1),return:f(2)},typeof Symbol=="function"&&(l[Symbol.iterator]=function(){return this}),l;function f(u){return function(y){return g([u,y])}}function g(u){if(s)throw new TypeError("Generator is already executing.");for(;n;)try{if(s=1,a&&(h=u[0]&2?a.return:u[0]?a.throw||((h=a.return)&&h.call(a),0):a.next)&&!(h=h.call(a,u[1])).done)return h;switch(a=0,h&&(u=[u[0]&2,h.value]),u[0]){case 0:case 1:h=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,a=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(h=n.trys,!(h=h.length>0&&h[h.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!h||u[1]>h[0]&&u[1]<h[3])){n.label=u[1];break}if(u[0]===6&&n.label<h[1]){n.label=h[1],h=u;break}if(h&&n.label<h[2]){n.label=h[2],n.ops.push(u);break}h[2]&&n.ops.pop(),n.trys.pop();continue}u=i.call(r,n)}catch(y){u=[6,y],a=0}finally{s=h=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}},lr=function(r,i){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&Ot(i,r,n)},Ot=Object.create?function(r,i,n,s){s===void 0&&(s=n),Object.defineProperty(r,s,{enumerable:!0,get:function(){return i[n]}})}:function(r,i,n,s){s===void 0&&(s=n),r[s]=i[n]},St=function(r){var i=typeof Symbol=="function"&&Symbol.iterator,n=i&&r[i],s=0;if(n)return n.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")},ve=function(r,i){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var s=n.call(r),a,h=[],l;try{for(;(i===void 0||i-- >0)&&!(a=s.next()).done;)h.push(a.value)}catch(f){l={error:f}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(l)throw l.error}}return h},ur=function(){for(var r=[],i=0;i<arguments.length;i++)r=r.concat(ve(arguments[i]));return r},mr=function(){for(var r=0,i=0,n=arguments.length;i<n;i++)r+=arguments[i].length;for(var s=Array(r),a=0,i=0;i<n;i++)for(var h=arguments[i],l=0,f=h.length;l<f;l++,a++)s[a]=h[l];return s},fr=function(r,i){for(var n=0,s=i.length,a=r.length;n<s;n++,a++)r[a]=i[n];return r},rt=function(r){return this instanceof rt?(this.v=r,this):new rt(r)},dr=function(r,i,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=n.apply(r,i||[]),a,h=[];return a={},l("next"),l("throw"),l("return"),a[Symbol.asyncIterator]=function(){return this},a;function l(m){s[m]&&(a[m]=function(D){return new Promise(function(B,tt){h.push([m,D,B,tt])>1||f(m,D)})})}function f(m,D){try{g(s[m](D))}catch(B){S(h[0][3],B)}}function g(m){m.value instanceof rt?Promise.resolve(m.value.v).then(u,y):S(h[0][2],m)}function u(m){f("next",m)}function y(m){f("throw",m)}function S(m,D){m(D),h.shift(),h.length&&f(h[0][0],h[0][1])}},gr=function(r){var i,n;return i={},s("next"),s("throw",function(a){throw a}),s("return"),i[Symbol.iterator]=function(){return this},i;function s(a,h){i[a]=r[a]?function(l){return(n=!n)?{value:rt(r[a](l)),done:a==="return"}:h?h(l):l}:h}},vr=function(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=r[Symbol.asyncIterator],n;return i?i.call(r):(r=typeof St=="function"?St(r):r[Symbol.iterator](),n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n);function s(h){n[h]=r[h]&&function(l){return new Promise(function(f,g){l=r[h](l),a(f,g,l.done,l.value)})}}function a(h,l,f,g){Promise.resolve(g).then(function(u){h({value:u,done:f})},l)}},yr=function(r,i){return Object.defineProperty?Object.defineProperty(r,"raw",{value:i}):r.raw=i,r};var e=Object.create?function(r,i){Object.defineProperty(r,"default",{enumerable:!0,value:i})}:function(r,i){r.default=i};br=function(r){if(r&&r.__esModule)return r;var i={};if(r!=null)for(var n in r)n!=="default"&&Object.prototype.hasOwnProperty.call(r,n)&&Ot(i,r,n);return e(i,r),i},xr=function(r){return r&&r.__esModule?r:{default:r}},Pr=function(r,i){if(!i.has(r))throw new TypeError("attempted to get private field on non-instance");return i.get(r)},Tr=function(r,i,n){if(!i.has(r))throw new TypeError("attempted to set private field on non-instance");return i.set(r,n),n},o("__extends",ir),o("__assign",or),o("__rest",nr),o("__decorate",sr),o("__param",ar),o("__metadata",hr),o("__awaiter",cr),o("__generator",pr),o("__exportStar",lr),o("__createBinding",Ot),o("__values",St),o("__read",ve),o("__spread",ur),o("__spreadArrays",mr),o("__spreadArray",fr),o("__await",rt),o("__asyncGenerator",dr),o("__asyncDelegator",gr),o("__asyncValues",vr),o("__makeTemplateObject",yr),o("__importStar",br),o("__importDefault",xr),o("__classPrivateFieldGet",Pr),o("__classPrivateFieldSet",Tr)})});var Sr,j,bo,xo,Po,To,Co,Or,Et,So,Oo,z,N,wo,Eo,k,_t,wr,_o,Er,Do,Lo,Mo,Ro,Fo,U=c(()=>{Sr=Yi(Cr(),1),{__extends:j,__assign:bo,__rest:xo,__decorate:Po,__param:To,__metadata:Co,__awaiter:Or,__generator:Et,__exportStar:So,__createBinding:Oo,__values:z,__read:N,__spread:wo,__spreadArrays:Eo,__spreadArray:k,__await:_t,__asyncGenerator:wr,__asyncDelegator:_o,__asyncValues:Er,__makeTemplateObject:Do,__importStar:Lo,__importDefault:Mo,__classPrivateFieldGet:Ro,__classPrivateFieldSet:Fo}=Sr.default});function d(o){return typeof o=="function"}var w=c(()=>{});function Dt(o){var t=function(r){Error.call(r),r.stack=new Error().stack},e=o(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var ye=c(()=>{});var Lt,_r=c(()=>{ye();Lt=Dt(function(o){return function(e){o(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,i){return i+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}})});function ut(o,t){if(o){var e=o.indexOf(t);0<=e&&o.splice(e,1)}}var be=c(()=>{});function Mt(o){return o instanceof it||o&&"closed"in o&&d(o.remove)&&d(o.add)&&d(o.unsubscribe)}function Dr(o){d(o)?o():o.unsubscribe()}var it,xe,Rt=c(()=>{U();w();_r();be();it=function(){function o(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return o.prototype.unsubscribe=function(){var t,e,r,i,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var a=z(s),h=a.next();!h.done;h=a.next()){var l=h.value;l.remove(this)}}catch(m){t={error:m}}finally{try{h&&!h.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}else s.remove(this);var f=this.initialTeardown;if(d(f))try{f()}catch(m){n=m instanceof Lt?m.errors:[m]}var g=this._finalizers;if(g){this._finalizers=null;try{for(var u=z(g),y=u.next();!y.done;y=u.next()){var S=y.value;try{Dr(S)}catch(m){n=n!=null?n:[],m instanceof Lt?n=k(k([],N(n)),N(m.errors)):n.push(m)}}}catch(m){r={error:m}}finally{try{y&&!y.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}}if(n)throw new Lt(n)}},o.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)Dr(t);else{if(t instanceof o){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(e=this._finalizers)!==null&&e!==void 0?e:[]).push(t)}},o.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},o.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},o.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&ut(e,t)},o.prototype.remove=function(t){var e=this._finalizers;e&&ut(e,t),t instanceof o&&t._removeParent(this)},o.EMPTY=function(){var t=new o;return t.closed=!0,t}(),o}(),xe=it.EMPTY});var I,mt=c(()=>{I={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1}});var ot,Pe=c(()=>{U();ot={setTimeout:function(o,t){for(var e=[],r=2;r<arguments.length;r++)e[r-2]=arguments[r];var i=ot.delegate;return i!=null&&i.setTimeout?i.setTimeout.apply(i,k([o,t],N(e))):setTimeout.apply(void 0,k([o,t],N(e)))},clearTimeout:function(o){var t=ot.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(o)},delegate:void 0}});function Ft(o){ot.setTimeout(function(){var t=I.onUnhandledError;if(t)t(o);else throw o})}var Te=c(()=>{mt();Pe()});function ft(){}var Ce=c(()=>{});function Mr(o){return Se("E",void 0,o)}function Rr(o){return Se("N",o,void 0)}function Se(o,t,e){return{kind:o,value:t,error:e}}var Lr,Fr=c(()=>{Lr=function(){return Se("C",void 0,void 0)}()});function nt(o){if(I.useDeprecatedSynchronousErrorHandling){var t=!Y;if(t&&(Y={errorThrown:!1,error:null}),o(),t){var e=Y,r=e.errorThrown,i=e.error;if(Y=null,r)throw i}}else o()}function Ar(o){I.useDeprecatedSynchronousErrorHandling&&Y&&(Y.errorThrown=!0,Y.error=o)}var Y,At=c(()=>{mt();Y=null});function Oe(o,t){return qi.call(o,t)}function It(o){I.useDeprecatedSynchronousErrorHandling?Ar(o):Ft(o)}function Ki(o){throw o}function we(o,t){var e=I.onStoppedNotification;e&&ot.setTimeout(function(){return e(o,t)})}var dt,qi,Xi,Gt,Zi,Ee=c(()=>{U();w();Rt();mt();Te();Ce();Fr();Pe();At();dt=function(o){j(t,o);function t(e){var r=o.call(this)||this;return r.isStopped=!1,e?(r.destination=e,Mt(e)&&e.add(r)):r.destination=Zi,r}return t.create=function(e,r,i){return new Gt(e,r,i)},t.prototype.next=function(e){this.isStopped?we(Rr(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?we(Mr(e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?we(Lr,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(it),qi=Function.prototype.bind;Xi=function(){function o(t){this.partialObserver=t}return o.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(r){It(r)}},o.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(r){It(r)}else It(t)},o.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(e){It(e)}},o}(),Gt=function(o){j(t,o);function t(e,r,i){var n=o.call(this)||this,s;if(d(e)||!e)s={next:e!=null?e:void 0,error:r!=null?r:void 0,complete:i!=null?i:void 0};else{var a;n&&I.useDeprecatedNextContext?(a=Object.create(e),a.unsubscribe=function(){return n.unsubscribe()},s={next:e.next&&Oe(e.next,a),error:e.error&&Oe(e.error,a),complete:e.complete&&Oe(e.complete,a)}):s=e}return n.destination=new Xi(s),n}return t}(dt);Zi={closed:!0,next:ft,error:Ki,complete:ft}});var st,Nt=c(()=>{st=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}()});function kt(o){return o}var _e=c(()=>{});function Ir(o){return o.length===0?kt:o.length===1?o[0]:function(e){return o.reduce(function(r,i){return i(r)},e)}}var Gr=c(()=>{_e()});function Nr(o){var t;return(t=o!=null?o:I.Promise)!==null&&t!==void 0?t:Promise}function Qi(o){return o&&d(o.next)&&d(o.error)&&d(o.complete)}function Ji(o){return o&&o instanceof dt||Qi(o)&&Mt(o)}var x,q=c(()=>{Ee();Rt();Nt();Gr();mt();w();At();x=function(){function o(t){t&&(this._subscribe=t)}return o.prototype.lift=function(t){var e=new o;return e.source=this,e.operator=t,e},o.prototype.subscribe=function(t,e,r){var i=this,n=Ji(t)?t:new Gt(t,e,r);return nt(function(){var s=i,a=s.operator,h=s.source;n.add(a?a.call(n,h):h?i._subscribe(n):i._trySubscribe(n))}),n},o.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},o.prototype.forEach=function(t,e){var r=this;return e=Nr(e),new e(function(i,n){var s=new Gt({next:function(a){try{t(a)}catch(h){n(h),s.unsubscribe()}},error:n,complete:i});r.subscribe(s)})},o.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},o.prototype[st]=function(){return this},o.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Ir(t)(this)},o.prototype.toPromise=function(t){var e=this;return t=Nr(t),new t(function(r,i){var n;e.subscribe(function(s){return n=s},function(s){return i(s)},function(){return r(n)})})},o.create=function(t){return new o(t)},o}()});function to(o){return d(o==null?void 0:o.lift)}function T(o){return function(t){if(to(t))return t.lift(function(e){try{return o(e,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}var H=c(()=>{w()});function E(o,t,e,r,i){return new eo(o,t,e,r,i)}var eo,X=c(()=>{U();Ee();eo=function(o){j(t,o);function t(e,r,i,n,s,a){var h=o.call(this,e)||this;return h.onFinalize=s,h.shouldUnsubscribe=a,h._next=r?function(l){try{r(l)}catch(f){e.error(f)}}:o.prototype._next,h._error=n?function(l){try{n(l)}catch(f){e.error(f)}finally{this.unsubscribe()}}:o.prototype._error,h._complete=i?function(){try{i()}catch(l){e.error(l)}finally{this.unsubscribe()}}:o.prototype._complete,h}return t.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;o.prototype.unsubscribe.call(this),!r&&((e=this.onFinalize)===null||e===void 0||e.call(this))}},t}(dt)});var kr,Ur=c(()=>{ye();kr=Dt(function(o){return function(){o(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})});var v,Wr,Br=c(()=>{U();q();Rt();Ur();be();At();v=function(o){j(t,o);function t(){var e=o.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var r=new Wr(this,this);return r.operator=e,r},t.prototype._throwIfClosed=function(){if(this.closed)throw new kr},t.prototype.next=function(e){var r=this;nt(function(){var i,n;if(r._throwIfClosed(),!r.isStopped){r.currentObservers||(r.currentObservers=Array.from(r.observers));try{for(var s=z(r.currentObservers),a=s.next();!a.done;a=s.next()){var h=a.value;h.next(e)}}catch(l){i={error:l}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}}})},t.prototype.error=function(e){var r=this;nt(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var i=r.observers;i.length;)i.shift().error(e)}})},t.prototype.complete=function(){var e=this;nt(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var r=e.observers;r.length;)r.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),o.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var r=this,i=this,n=i.hasError,s=i.isStopped,a=i.observers;return n||s?xe:(this.currentObservers=null,a.push(e),new it(function(){r.currentObservers=null,ut(a,e)}))},t.prototype._checkFinalizedStatuses=function(e){var r=this,i=r.hasError,n=r.thrownError,s=r.isStopped;i?e.error(n):s&&e.complete()},t.prototype.asObservable=function(){var e=new x;return e.source=this,e},t.create=function(e,r){return new Wr(e,r)},t}(x),Wr=function(o){j(t,o);function t(e,r){var i=o.call(this)||this;return i.destination=e,i.source=r,i}return t.prototype.next=function(e){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.next)===null||i===void 0||i.call(r,e)},t.prototype.error=function(e){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.error)===null||i===void 0||i.call(r,e)},t.prototype.complete=function(){var e,r;(r=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||r===void 0||r.call(e)},t.prototype._subscribe=function(e){var r,i;return(i=(r=this.source)===null||r===void 0?void 0:r.subscribe(e))!==null&&i!==void 0?i:xe},t}(v)});var Hr,$r=c(()=>{q();Hr=new x(function(o){return o.complete()})});function jr(o){return o&&d(o.schedule)}var Vr=c(()=>{w()});function zr(o){return o[o.length-1]}function Yr(o){return jr(zr(o))?o.pop():void 0}function qr(o,t){return typeof zr(o)=="number"?o.pop():t}var Xr=c(()=>{Vr()});var Ut,De=c(()=>{Ut=function(o){return o&&typeof o.length=="number"&&typeof o!="function"}});function Wt(o){return d(o==null?void 0:o.then)}var Le=c(()=>{w()});function Bt(o){return d(o[st])}var Me=c(()=>{Nt();w()});function Ht(o){return Symbol.asyncIterator&&d(o==null?void 0:o[Symbol.asyncIterator])}var Re=c(()=>{w()});function $t(o){return new TypeError("You provided "+(o!==null&&typeof o=="object"?"an invalid object":"'"+o+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var Fe=c(()=>{});function ro(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var jt,Ae=c(()=>{jt=ro()});function Vt(o){return d(o==null?void 0:o[jt])}var Ie=c(()=>{Ae();w()});function zt(o){return wr(this,arguments,function(){var e,r,i,n;return Et(this,function(s){switch(s.label){case 0:e=o.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,_t(e.read())];case 3:return r=s.sent(),i=r.value,n=r.done,n?[4,_t(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,_t(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Yt(o){return d(o==null?void 0:o.getReader)}var qt=c(()=>{U();w()});function L(o){if(o instanceof x)return o;if(o!=null){if(Bt(o))return io(o);if(Ut(o))return oo(o);if(Wt(o))return no(o);if(Ht(o))return Kr(o);if(Vt(o))return so(o);if(Yt(o))return ao(o)}throw $t(o)}function io(o){return new x(function(t){var e=o[st]();if(d(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function oo(o){return new x(function(t){for(var e=0;e<o.length&&!t.closed;e++)t.next(o[e]);t.complete()})}function no(o){return new x(function(t){o.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,Ft)})}function so(o){return new x(function(t){var e,r;try{for(var i=z(o),n=i.next();!n.done;n=i.next()){var s=n.value;if(t.next(s),t.closed)return}}catch(a){e={error:a}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}t.complete()})}function Kr(o){return new x(function(t){ho(o,t).catch(function(e){return t.error(e)})})}function ao(o){return Kr(zt(o))}function ho(o,t){var e,r,i,n;return Or(this,void 0,void 0,function(){var s,a;return Et(this,function(h){switch(h.label){case 0:h.trys.push([0,5,6,11]),e=Er(o),h.label=1;case 1:return[4,e.next()];case 2:if(r=h.sent(),!!r.done)return[3,4];if(s=r.value,t.next(s),t.closed)return[2];h.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=h.sent(),i={error:a},[3,11];case 6:return h.trys.push([6,,9,10]),r&&!r.done&&(n=e.return)?[4,n.call(e)]:[3,8];case 7:h.sent(),h.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}var K=c(()=>{U();De();Le();q();Me();Re();Fe();Ie();qt();w();Te();Nt()});function M(o,t,e,r,i){r===void 0&&(r=0),i===void 0&&(i=!1);var n=t.schedule(function(){e(),i?o.add(this.schedule(null,r)):this.unsubscribe()},r);if(o.add(n),!i)return n}var gt=c(()=>{});function Xt(o,t){return t===void 0&&(t=0),T(function(e,r){e.subscribe(E(r,function(i){return M(r,o,function(){return r.next(i)},t)},function(){return M(r,o,function(){return r.complete()},t)},function(i){return M(r,o,function(){return r.error(i)},t)}))})}var Ge=c(()=>{gt();H();X()});function Kt(o,t){return t===void 0&&(t=0),T(function(e,r){r.add(o.schedule(function(){return e.subscribe(r)},t))})}var Ne=c(()=>{H()});function Zr(o,t){return L(o).pipe(Kt(t),Xt(t))}var Qr=c(()=>{K();Ge();Ne()});function Jr(o,t){return L(o).pipe(Kt(t),Xt(t))}var ti=c(()=>{K();Ge();Ne()});function ei(o,t){return new x(function(e){var r=0;return t.schedule(function(){r===o.length?e.complete():(e.next(o[r++]),e.closed||this.schedule())})})}var ri=c(()=>{q()});function ii(o,t){return new x(function(e){var r;return M(e,t,function(){r=o[jt](),M(e,t,function(){var i,n,s;try{i=r.next(),n=i.value,s=i.done}catch(a){e.error(a);return}s?e.complete():e.next(n)},0,!0)}),function(){return d(r==null?void 0:r.return)&&r.return()}})}var oi=c(()=>{q();Ae();w();gt()});function Zt(o,t){if(!o)throw new Error("Iterable cannot be null");return new x(function(e){M(e,t,function(){var r=o[Symbol.asyncIterator]();M(e,t,function(){r.next().then(function(i){i.done?e.complete():e.next(i.value)})},0,!0)})})}var ke=c(()=>{q();gt()});function ni(o,t){return Zt(zt(o),t)}var si=c(()=>{ke();qt()});function ai(o,t){if(o!=null){if(Bt(o))return Zr(o,t);if(Ut(o))return ei(o,t);if(Wt(o))return Jr(o,t);if(Ht(o))return Zt(o,t);if(Vt(o))return ii(o,t);if(Yt(o))return ni(o,t)}throw $t(o)}var hi=c(()=>{Qr();ti();ri();oi();ke();Me();Le();De();Ie();Re();Fe();qt();si()});function ci(o,t){return t?ai(o,t):L(o)}var pi=c(()=>{hi();K()});function Z(o,t){return T(function(e,r){var i=0;e.subscribe(E(r,function(n){r.next(o.call(t,n,i++))}))})}var Ue=c(()=>{H();X()});function li(o,t,e,r,i,n,s,a){var h=[],l=0,f=0,g=!1,u=function(){g&&!h.length&&!l&&t.complete()},y=function(m){return l<r?S(m):h.push(m)},S=function(m){n&&t.next(m),l++;var D=!1;L(e(m,f++)).subscribe(E(t,function(B){i==null||i(B),n?y(B):t.next(B)},function(){D=!0},void 0,function(){if(D)try{l--;for(var B=function(){var tt=h.shift();s?M(t,s,function(){return S(tt)}):S(tt)};h.length&&l<r;)B();u()}catch(tt){t.error(tt)}}))};return o.subscribe(E(t,y,function(){g=!0,u()})),function(){a==null||a()}}var ui=c(()=>{K();gt();X()});function We(o,t,e){return e===void 0&&(e=1/0),d(t)?We(function(r,i){return Z(function(n,s){return t(r,n,i,s)})(L(o(r,i)))},e):(typeof t=="number"&&(e=t),T(function(r,i){return li(r,i,o,e)}))}var mi=c(()=>{Ue();K();H();ui();w()});function fi(o){return o===void 0&&(o=1/0),We(kt,o)}var di=c(()=>{mi();_e()});function gi(o){return o.length===1&&co(o[0])?o[0]:o}var co,vi=c(()=>{co=Array.isArray});function G(o,t){return T(function(e,r){var i=0;e.subscribe(E(r,function(n){return o.call(t,n,i++)&&r.next(n)}))})}var Be=c(()=>{H();X()});var yi=c(()=>{});function W(o){return o<=0?function(){return Hr}:T(function(t,e){var r=0;t.subscribe(E(e,function(i){++r<=o&&(e.next(i),o<=r&&e.complete())}))})}var He=c(()=>{$r();H();X()});function bi(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];var e=Yr(o),r=qr(o,1/0);return o=gi(o),T(function(i,n){fi(r)(ci(k([i],N(o)),e)).subscribe(n)})}var xi=c(()=>{U();H();vi();di();Xr();pi()});function $e(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return bi.apply(void 0,k([],N(o)))}var Pi=c(()=>{U();xi()});function _(o){return T(function(t,e){L(o).subscribe(E(e,function(){return e.complete()},ft)),!e.closed&&t.subscribe(e)})}var Ti=c(()=>{H();X();K();Ce()});var at=c(()=>{Br();yi();Be();He()});var ht,Qt,je=c(()=>{Ct();O();O();at();A();ht=1e3,Qt=class{constructor(t,e){this.id=t;this.movementDirection="none";this._tilePos={position:new p(0,0),layer:void 0};this.movementStarted$=new v;this.movementStopped$=new v;this.directionChanged$=new v;this.positionChangeStarted$=new v;this.positionChangeFinished$=new v;this.tilePositionSet$=new v;this.autoMovementSet$=new v;this.lastMovementImpulse="none";this.facingDirection="down";this.depthChanged$=new v;this.movementProgress=0;this.tilemap=e.tilemap,this.speed=e.speed,this.collidesWithTilesInternal=e.collidesWithTiles,this._tilePos.layer=e.charLayer,this.collisionGroups=new Set(e.collisionGroups||[]),this.labels=new Set(e.labels||[]),e.facingDirection&&this.turnTowards(e.facingDirection)}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}setMovement(t){this.autoMovementSet$.next(t),this.movement=t}getMovement(){return this.movement}collidesWithTiles(){return this.collidesWithTilesInternal}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.tilePositionSet$.next(F({},t)),this.fire(this.positionChangeStarted$,this.tilePos,t),this.fire(this.positionChangeFinished$,this.tilePos,t),this.movementDirection="none",this.lastMovementImpulse="none",this.tilePos=t,this.movementProgress=0}getTilePos(){return this.tilePos}getNextTilePos(){if(!this.isMoving())return this.tilePos;let t=this.tilePos.layer,e=this.tilePosInDirection(this.tilePos.position,this.movementDirection),r=this.tilemap.getTransition(e,this.tilePos.layer);return r&&(t=r),{position:this.tilePosInDirection(this.tilePos.position,this.movementDirection),layer:t}}move(t){this.lastMovementImpulse=t,t!="none"&&(this.isMoving()||(this.isBlockingDirection(t)?(this.facingDirection=t,this.directionChanged$.next(t)):this.startMoving(t)))}update(t){var e;(e=this.movement)==null||e.update(t),this.isMoving()&&this.updateCharacterPosition(t),this.lastMovementImpulse="none"}getMovementDirection(){return this.movementDirection}isBlockingDirection(t){if(t=="none")return!1;let e=this.tilePosInDirection(this.getNextTilePos().position,t),r=this.tilemap.getTransition(e,this.getNextTilePos().layer)||this.getNextTilePos().layer;return this.collidesWithTilesInternal&&this.tilemap.hasBlockingTile(r,e,rr(t))?!0:this.tilemap.hasBlockingChar(e,r,this.getCollisionGroups())}isMoving(){return this.movementDirection!="none"}turnTowards(t){this.isMoving()||t!="none"&&(this.facingDirection=t)}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.position.add(V(this.facingDirection))}addCollisionGroup(t){this.collisionGroups.add(t)}setCollisionGroups(t){this.collisionGroups=new Set(t)}getCollisionGroups(){return Array.from(this.collisionGroups)}hasCollisionGroup(t){return this.collisionGroups.has(t)}removeCollisionGroup(t){this.collisionGroups.delete(t)}removeAllCollisionGroups(){this.collisionGroups.clear()}addLabels(t){for(let e of t)this.labels.add(e)}getLabels(){return[...this.labels.values()]}hasLabel(t){return this.labels.has(t)}clearLabels(){this.labels.clear()}removeLabels(t){for(let e of t)this.labels.delete(e)}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}tilePositionSet(){return this.tilePositionSet$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}depthChanged(){return this.depthChanged$}getMovementProgress(){return this.movementProgress}hasWalkedHalfATile(){return this.movementProgress>ht/2}updateCharacterPosition(t){let r=t/1e3,i=Math.floor(r*this.speed*ht),n=ht-this.movementProgress<=i&&this.movementProgress<ht,s=n?ht-this.movementProgress:i,a=1-s/i;this.movementProgress=Math.min(this.movementProgress+i,ht),n&&(this.movementProgress=0,this.shouldContinueMoving()&&a>0?(this.fire(this.positionChangeFinished$,this.tilePos,this.getNextTilePos()),this.tilePos=this.getNextTilePos(),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(t*a)):this.stopMoving())}get tilePos(){return b.clone(this._tilePos)}set tilePos(t){b.copyOver(t,this._tilePos)}startMoving(t){t!=="none"&&(t!=this.movementDirection&&this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.fire(this.positionChangeStarted$,this.tilePos,this.getNextTilePos()))}tilePosInDirection(t,e){return t.add(V(this.tilemap.toMapDirection(e)))}shouldContinueMoving(){return this.lastMovementImpulse!=="none"&&!this.isBlockingDirection(this.lastMovementImpulse)}stopMoving(){if(this.movementDirection==="none")return;let t=this.tilePos,e=this.getNextTilePos(),r=this.movementDirection;this.tilePos=this.getNextTilePos(),this.movementDirection="none",this.movementStopped$.next(r),this.fire(this.positionChangeFinished$,t,e)}fire(t,{position:e,layer:r},{position:i,layer:n}){t.next({exitTile:e,enterTile:i,exitLayer:r,enterLayer:n})}}});var vt,J,Ve=c(()=>{O();at();vt=class{constructor(t,e){this.walkingAnimationMapping=t;this.charsInRow=e;this.lastFootLeft=!1;this.directionToFrameRow={["down"]:0,["down-left"]:1,["down-right"]:2,["left"]:1,["right"]:2,["up"]:3,["up-left"]:1,["up-right"]:2};this._isEnabled=!0;this.frameChange$=new v;this.setWalkingAnimationMapping(t)}frameChange(){return this.frameChange$}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e,r){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t,r):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t,this._isEnabled=this.walkingAnimationMapping!==void 0}getWalkingAnimationMapping(){return this.walkingAnimationMapping}getCharsInRow(){return this.charsInRow}setStandingFrameDuringWalk(t,e){this.isCurrentFrameStanding(t,e)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);e&&this.frameChange$.next(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){let e=this.framesOfDirection(t);e&&this.frameChange$.next(e.standing)}isCurrentFrameStanding(t,e){var r;return e===((r=this.framesOfDirection(t))==null?void 0:r.standing)}framesOfDirection(t){return typeof this.walkingAnimationMapping=="number"?this.getFramesForCharIndex(t,this.walkingAnimationMapping):this.getFramesForAnimationMapping(t)}getFramesForAnimationMapping(t){if(!!this.walkingAnimationMapping)return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case"down-left":return"left";case"down-right":return"right";case"up-left":return"left";case"up-right":return"right"}return t}getFramesForCharIndex(t,e){var l;let r=Math.floor(e/this.charsInRow),i=e%this.charsInRow,n=this.charsInRow*vt.FRAMES_CHAR_ROW,s=vt.FRAMES_CHAR_ROW*i,a=((l=this.directionToFrameRow[t])!=null?l:0)+r*vt.FRAMES_CHAR_COL,h=s+a*n;return{rightFoot:h,standing:h+1,leftFoot:h+2}}},J=vt;J.FRAMES_CHAR_ROW=3,J.FRAMES_CHAR_COL=4});var ct,ze=c(()=>{ct=class{static shiftPad(t,e){let r=Math.floor(t),n=`${r}`.padStart(e,"0").length;return r/Math.pow(10,n)}}});var yt=c(()=>{Be();Ue();Pi();He();Ti()});var Jt,Ci=c(()=>{je();A();Ve();ze();at();yt();O();Jt=class{constructor(t,e,r,i){this.charData=t;this.scene=e;this.tilemap=r;this.layerOverlay=i;this.customOffset=new p(0,0);this.engineOffset=new p(0,0);this.newSpriteSet$=new v;this.destroy$=new v;this.gridCharacter=this.createChar(this.charData,this.layerOverlay)}destroy(){this.destroy$.next(),this.destroy$.complete(),this.newSpriteSet$.complete()}getGridCharacter(){return this.gridCharacter}setSprite(t){t?(this.sprite&&(t.x=this.sprite.x,t.y=this.sprite.y),this.sprite=t,this.newSpriteSet$.next(),this.layerOverlaySprite=this.layerOverlaySprite?this.scene.add.sprite(0,0,this.sprite.texture):void 0,this.updateOverlaySprite(),this.resetAnimation(this.gridCharacter,this.sprite),this.updateDepth(this.gridCharacter)):(this.layerOverlaySprite=void 0,this.sprite=void 0)}getSprite(){return this.sprite}getLayerOverlaySprite(){return this.layerOverlaySprite}setContainer(t){this.container=t}getContainer(){return this.container}getEngineOffset(){return this.engineOffset}getOffsetX(){return this.customOffset.x}getOffsetY(){return this.customOffset.y}getWalkingAnimationMapping(){return this.walkingAnimationMapping}turnTowards(t){var e;this.gridCharacter.isMoving()||t!="none"&&(this.gridCharacter.turnTowards(t),(e=this.animation)==null||e.setStandingFrame(t))}getAnimation(){return this.animation}setAnimation(t){this.animation=t}update(t){this.gridCharacter.update(t),this.updateGridChar(this.gridCharacter)}updatePixelPos(t){let e=t.getTilePos().position.clone(),r=t.getMovementProgress()/1e3,n=this.tilemap.tilePosToPixelPos(e).add(this.engineOffset).add(this.customOffset).add(V(t.getMovementDirection()).multiply(this.tilemap.getTileDistance(t.getMovementDirection()).scalarMult(r))),s=this.getGameObj();s&&(s.x=n.x,s.y=n.y)}getGameObj(){return this.container||this.sprite}createChar(t,e){var n,s;this.layerOverlaySprite=e&&t.sprite?this.scene.add.sprite(0,0,t.sprite.texture):void 0,this.walkingAnimationMapping=t.walkingAnimationMapping;let r={speed:t.speed||4,tilemap:this.tilemap,collidesWithTiles:!0,collisionGroups:["geDefault"],charLayer:t.charLayer,facingDirection:t.facingDirection,labels:t.labels};this.customOffset=new p(t.offsetX||0,t.offsetY||0),typeof t.collides=="boolean"?t.collides===!1&&(r.collidesWithTiles=!1,r.collisionGroups=[]):t.collides!==void 0&&(t.collides.collidesWithTiles===!1&&(r.collidesWithTiles=!1),t.collides.collisionGroups&&(r.collisionGroups=t.collides.collisionGroups)),this.sprite=t.sprite,this.container=t.container;let i=new Qt(t.id,r);if(i.directionChanged().subscribe(a=>{var h;(h=this.animation)==null||h.setStandingFrame(a)}),this.sprite){this.sprite.setOrigin(0,0);let a=this.tilemap.getTileWidth()/2-Math.floor(((n=this.sprite.displayWidth)!=null?n:0)/2),h=-((s=this.sprite.displayHeight)!=null?s:0)+this.tilemap.getTileHeight();this.engineOffset=new p(a,h),this.resetAnimation(i,this.sprite),this.updateOverlaySprite(),t.startPosition&&(i.setTilePosition({position:new p(t.startPosition),layer:i.getTilePos().layer}),this.updateGridChar(i))}return i}updateGridChar(t){var e;this.updatePixelPos(t),this.sprite&&t.isMoving()&&((e=this.getAnimation())==null||e.updateCharacterFrame(t.getMovementDirection(),t.hasWalkedHalfATile(),Number(this.sprite.frame.name))),this.updateDepth(t)}resetAnimation(t,e){let r=new J(this.walkingAnimationMapping,e.texture.source[0].width/e.width/J.FRAMES_CHAR_ROW);this.setAnimation(r),r.frameChange().pipe(_(this.newSpriteSet$)).subscribe(i=>{e==null||e.setFrame(i)}),r.setIsEnabled(this.walkingAnimationMapping!==void 0),r.setStandingFrame(t.getFacingDirection())}updateOverlaySprite(){if(!this.layerOverlaySprite||!this.sprite)return;this.layerOverlaySprite.scale=this.sprite.scale;let t=this.tilemap.getTileHeight()/this.layerOverlaySprite.scale;this.layerOverlaySprite.setCrop(0,0,this.layerOverlaySprite.displayWidth,this.sprite.height-t),this.layerOverlaySprite.setOrigin(0,0)}updateDepth(t){let e=this.getGameObj();if(!e)return;this.setDepth(e,t.getNextTilePos());let r=this.getLayerOverlaySprite();if(r){let i=new p(et(F({},t.getNextTilePos().position),{y:t.getNextTilePos().position.y-1}));this.setDepth(r,{position:i,layer:t.getNextTilePos().layer})}}setDepth(t,e){t.setDepth(this.tilemap.getDepthOfCharLayer(this.getTransitionLayer(e))+this.getPaddedPixelDepth(t))}getPaddedPixelDepth(t){return ct.shiftPad(t.y+t.displayHeight,7)}getTransitionLayer(t){return this.tilemap.getTransition(t.position,t.layer)||t.layer}}});var P,te=c(()=>{P=class{static get(){return P.config}static set(t){P.config=t}}});var Ye=c(()=>{});var C,bt=c(()=>{A();C=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return C.vec2str(t)==C.vec2str(e)}static manhattanDistance(t,e){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return r+i}static chebyshevDistance(t,e){let r=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return Math.max(r,i)}static scalarMult(t,e){return t.clone().multiply(new p(e,e))}}});var ee,re,Si=c(()=>{ee=class{constructor(t){this.data=t}},re=class{constructor(){this.sizeInternal=0}dequeue(){if(this.tail===void 0)return;this.sizeInternal--;let t=this.tail.data;return this.tail.prev===void 0?(this.tail=void 0,this.head=void 0,t):(this.tail.prev.next=void 0,this.tail=this.tail.prev,t)}enqueue(t){if(this.sizeInternal++,this.head===void 0){this.head=new ee(t),this.tail=this.head;return}let e=new ee(t);e.next=this.head,this.head.prev=e,this.head=e}peek(){return this.tail?this.tail.data:void 0}size(){return this.sizeInternal}}});var ie,oe,Oi=c(()=>{Ct();bt();Si();ie=class{constructor(){this.previous=new Map;this.visited=new Map;this.queue=new re}step(t,e,r){for(let i of t)this.visited.has(b.toString(i))||(this.previous.set(b.toString(i),e),this.queue.enqueue({node:i,dist:r+1}),this.visited.set(b.toString(i),r+1))}},oe=class{getShortestPath(t,e,r){let i=this.shortestPathBfs(t,e,r);return{path:this.returnPath(i.previous,i.previous2,i.matchingPos,t,e),closestToTarget:i.closestToTarget}}distance(t,e){return C.manhattanDistance(t.position,e.position)}equal(t,e){return C.equal(t.position,e.position)?t.layer===e.layer:!1}shortestPathBfs(t,e,r){var h,l;let i=new ie,n=new ie;i.otherBfs=n,n.otherBfs=i;let s=t,a=this.distance(t,e);for(i.queue.enqueue({node:t,dist:0}),n.queue.enqueue({node:e,dist:0}),i.visited.set(b.toString(t),0),n.visited.set(b.toString(e),0);i.queue.size()>0&&n.queue.size()>0;){let f=i.queue.dequeue();if(!f)break;let{node:g,dist:u}=f,y=this.distance(g,e);if(y<a&&(a=y,s=g),n.visited.has(b.toString(g)))return{shortestDistance:u+((h=n.visited.get(b.toString(g)))!=null?h:0),previous:i.previous,previous2:n.previous,closestToTarget:e,matchingPos:g};i.step(r(g),g,u);let S=n.queue.dequeue();if(!S)break;let{node:m,dist:D}=S;if(i.visited.has(b.toString(m)))return{shortestDistance:D+((l=i.visited.get(b.toString(m)))!=null?l:0),previous:i.previous,previous2:n.previous,closestToTarget:e,matchingPos:m};n.step(r(m),m,D)}return{shortestDistance:-1,previous:i.previous,previous2:n.previous,closestToTarget:s}}returnPath(t,e,r,i,n){if(r){let s=this.getPathFromPrev(t,i,r).reverse(),a=this.getPathFromPrev(e,n,r);return s.pop(),[...s,...a]}else return this.getPathFromPrev(t,i,n).reverse()}getPathFromPrev(t,e,r){let i=[],n=r;for(i.push(n);!this.equal(n,e);){if(n=t.get(b.toString(n)),!n)return[];i.push(n)}return i}}});var xt,ne=c(()=>{xt=(r=>(r.STOP="STOP",r.CLOSEST_REACHABLE="CLOSEST_REACHABLE",r.RETRY="RETRY",r))(xt||{})});var se,wi=c(()=>{bt();O();A();se=class{distance(t,e){return C.manhattanDistance(t,e)}direction(t,e){if(C.equal(t,e))return"none";let r=t.clone().subtract(e);return Math.abs(r.x)>Math.abs(r.y)?r.x>0?"left":"right":r.y>0?"up":"down"}neighbours(t){return[new p(t.x,t.y+1),new p(t.x+1,t.y),new p(t.x-1,t.y),new p(t.x,t.y-1)]}getDirections(){return["up","right","down","left"]}}});var ae,Ei=c(()=>{bt();O();A();ae=class{distance(t,e){return C.chebyshevDistance(t,e)}neighbours(t){let e=[new p(t.x,t.y+1),new p(t.x+1,t.y),new p(t.x-1,t.y),new p(t.x,t.y-1)],r=[new p(t.x+1,t.y+1),new p(t.x+1,t.y-1),new p(t.x-1,t.y+1),new p(t.x-1,t.y-1)];return[...e,...r]}direction(t,e){return e.x>t.x?e.y>t.y?"down-right":e.y<t.y?"up-right":"right":e.x<t.x?e.y>t.y?"down-left":e.y<t.y?"up-left":"left":e.y<t.y?"up":e.y>t.y?"down":"none"}getDirections(){return["up","right","down","left","down-left","down-right","up-right","up-left"]}}});var pt,qe=c(()=>{wi();O();Ei();pt=class{static create(t){switch(t){case 4:return new se;case 8:return new ae}}}});var Pt,_i=c(()=>{Pt=class{constructor(t,e,r){this.backoffMs=t;this.maxRetries=e;this.onFinished=r;this.retries=0;this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}getBackoffMs(){return this.backoffMs}shouldRetry(){return this.maxRetries===-1||this.retries<this.maxRetries}}});var ce,Xe=c(()=>{ce=(r=>(r.WAIT="WAIT",r.RETRY="RETRY",r.STOP="STOP",r))(ce||{})});var lt,Ke=c(()=>{Oi();ne();qe();O();_i();Xe();at();Ct();lt=class{constructor(t,e,r,{numberOfDirections:i=4,config:n,ignoreBlockedTarget:s=!1,distance:a=0}={}){this.character=t;this.tilemap=e;this.targetPos=r;this.shortestPath=[];this.distOffset=0;this.posOnPath=0;this.stopped=!1;this.pathBlockedWaitElapsed=0;this.getNeighbours=t=>this.distanceUtils.neighbours(t.position).map(i=>{let n=this.tilemap.getTransition(i,t.layer);return{position:i,layer:n||t.layer}}).filter(i=>!this.isBlocking(i.position,i.layer)||this.ignoreBlockedTarget&&b.equal(i,this.targetPos));this.isBlocking=(t,e)=>{var r;return!t||!this.tilemap.isInRange(t)?!0:(r=this.character)!=null&&r.collidesWithTiles()?this.tilemap.isBlocking(e,t,this.character.getCollisionGroups()):this.tilemap.hasBlockingChar(t,e,this.character.getCollisionGroups())};this.ignoreBlockedTarget=s,this.distance=a,this.noPathFoundStrategy=(n==null?void 0:n.noPathFoundStrategy)||"STOP",this.pathBlockedStrategy=(n==null?void 0:n.pathBlockedStrategy)||"WAIT",this.noPathFoundRetryable=new Pt((n==null?void 0:n.noPathFoundRetryBackoffMs)||200,(n==null?void 0:n.noPathFoundMaxRetries)||-1,()=>{this.stop("NO_PATH_FOUND_MAX_RETRIES_EXCEEDED")}),this.pathBlockedRetryable=new Pt((n==null?void 0:n.pathBlockedRetryBackoffMs)||200,(n==null?void 0:n.pathBlockedMaxRetries)||-1,()=>{this.stop("PATH_BLOCKED_MAX_RETRIES_EXCEEDED")}),this.distanceUtils=pt.create(i),this.pathBlockedWaitTimeoutMs=(n==null?void 0:n.pathBlockedWaitTimeoutMs)||-1,this.finished$=new v,this.setCharacter(t)}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(W(1),G(e=>e!==this)).subscribe(()=>{this.stop("MOVEMENT_TERMINATED")})}update(t){var e,r,i,n;this.stopped||(this.noPathFound()&&(this.noPathFoundStrategy==="RETRY"?this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()):this.noPathFoundStrategy==="STOP"&&this.stop("NO_PATH_FOUND")),this.updatePosOnPath(),this.isBlocking((e=this.nextTileOnPath())==null?void 0:e.position,(r=this.character)==null?void 0:r.getNextTilePos().layer)?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop("SUCCESS"),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking((i=this.nextTileOnPath())==null?void 0:i.position,(n=this.character)==null?void 0:n.getNextTilePos().layer)||this.moveCharOnPath())}finishedObs(){return this.finished$}getInfo(){return{type:"Target",config:{ignoreBlockedTarget:this.ignoreBlockedTarget,distance:this.distance,targetPos:this.targetPos,noPathFoundStrategy:this.noPathFoundStrategy,pathBlockedStrategy:this.pathBlockedStrategy,noPathFoundRetryBackoffMs:this.noPathFoundRetryable.getBackoffMs(),noPathFoundMaxRetries:this.noPathFoundRetryable.getMaxRetries()}}}resultToReason(t){switch(t){case"SUCCESS":return"Successfully arrived.";case"MOVEMENT_TERMINATED":return"Movement of character has been replaced before destination was reached.";case"PATH_BLOCKED":return"PathBlockedStrategy STOP: Path blocked.";case"NO_PATH_FOUND_MAX_RETRIES_EXCEEDED":return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case"NO_PATH_FOUND":return"NoPathFoundStrategy STOP: No path found.";case"PATH_BLOCKED_MAX_RETRIES_EXCEEDED":return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case"PATH_BLOCKED_WAIT_TIMEOUT":return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`}}applyPathBlockedStrategy(t){this.pathBlockedStrategy==="RETRY"?this.pathBlockedRetryable.retry(t,()=>this.calcShortestPath()):this.pathBlockedStrategy==="STOP"?this.stop("PATH_BLOCKED"):this.pathBlockedStrategy==="WAIT"&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop("PATH_BLOCKED_WAIT_TIMEOUT"))}moveCharOnPath(){let t=this.nextTileOnPath();if(!t)return;let e=this.getDir(this.character.getNextTilePos().position,t.position);this.character.move(e)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(t){this.finished$.next({position:this.character.getTilePos().position,result:t,description:this.resultToReason(t),layer:this.character.getTilePos().layer}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos().position,t.position);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().position.x!=t.position.x||this.character.getNextTilePos().position.y!=t.position.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return this.shortestPath.length===0}calcShortestPath(){let t=this.getShortestPath();this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new oe,{path:e,closestToTarget:r}=t.getShortestPath(this.character.getNextTilePos(),this.targetPos,this.getNeighbours);if(e.length==0&&this.noPathFoundStrategy==="CLOSEST_REACHABLE"){let n=t.getShortestPath(this.character.getNextTilePos(),r,this.getNeighbours).path,s=this.distanceUtils.distance(r.position,this.targetPos.position);return{path:n,distOffset:s}}return{path:e,distOffset:0}}getDir(t,e){return this.distanceUtils.direction(t,e)}}});var pe,Di=c(()=>{yt();O();Ke();A();ne();pe=class{constructor(t,e,r,i=4,n=0,s="STOP"){this.character=t;this.gridTilemap=e;this.charToFollow=r;this.numberOfDirections=i;this.distance=n;this.noPathFoundStrategy=s;this.character=t,this.updateTarget(this.charToFollow.getTilePos().position,this.charToFollow.getTilePos().layer),this.charToFollow.positionChangeStarted().pipe(_(this.character.autoMovementSet().pipe(W(1),G(a=>a!==this)))).subscribe(({enterTile:a,enterLayer:h})=>{this.updateTarget(a,h)})}update(t){var e;(e=this.targetMovement)==null||e.update(t)}getInfo(){return{type:"Follow",config:{charToFollow:this.charToFollow.getId(),distance:this.distance,noPathFoundStrategy:this.noPathFoundStrategy}}}updateTarget(t,e){this.targetMovement=new lt(this.character,this.gridTilemap,{position:new p(t),layer:e},{numberOfDirections:this.numberOfDirections,distance:this.distance+1,config:{noPathFoundStrategy:this.noPathFoundStrategy},ignoreBlockedTarget:!0})}}});var le,Li=c(()=>{te();Ye();le=class{constructor(){this.tilePosToCharacters=new Map;this.positionChangeStartedSubs=new Map;this.tilePosSetSubs=new Map;this.positionChangeFinishedSubs=new Map}isCharBlockingAt(t,e,r){let i=this.posToString(t,e),n=this.tilePosToCharacters.get(i);return!!(n&&n.size>0&&[...n].some(s=>s.getCollisionGroups().some(a=>r.includes(a))))}getCharactersAt(t,e){let r=this.posToString(t,e),i=this.tilePosToCharacters.get(r);return new Set(i)}addCharacter(t){this.add(this.posToString(t.getTilePos().position,t.getTilePos().layer),t),this.add(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer),t),this.addPositionChangeSub(t),this.addPositionChangeFinishedSub(t),this.addTilePosSetSub(t)}removeCharacter(t){var r,i,n,s,a;let e=t.getId();(r=this.positionChangeStartedSubs.get(e))==null||r.unsubscribe(),(i=this.positionChangeFinishedSubs.get(e))==null||i.unsubscribe(),(n=this.tilePosSetSubs.get(e))==null||n.unsubscribe(),(s=this.tilePosToCharacters.get(this.posToString(t.getTilePos().position,t.getTilePos().layer)))==null||s.delete(t),(a=this.tilePosToCharacters.get(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer)))==null||a.delete(t)}add(t,e){var r;this.tilePosToCharacters.has(t)||this.tilePosToCharacters.set(t,new Set),(r=this.tilePosToCharacters.get(t))==null||r.add(e)}addTilePosSetSub(t){let e=t.tilePositionSet().subscribe(r=>{var i;(i=this.tilePosToCharacters.get(this.posToString(t.getNextTilePos().position,t.getNextTilePos().layer)))==null||i.delete(t)});this.tilePosSetSubs.set(t.getId(),e)}addPositionChangeSub(t){let e=t.positionChangeStarted().subscribe(r=>{var i;P.get().characterCollisionStrategy==="BLOCK_ONE_TILE_AHEAD"&&((i=this.tilePosToCharacters.get(this.posToString(r.exitTile,r.exitLayer)))==null||i.delete(t)),this.add(this.posToString(r.enterTile,r.enterLayer),t)});this.positionChangeStartedSubs.set(t.getId(),e)}addPositionChangeFinishedSub(t){let e=t.positionChangeFinished().subscribe(r=>{var i;(i=this.tilePosToCharacters.get(this.posToString(r.exitTile,r.exitLayer)))==null||i.delete(t)});this.positionChangeFinishedSubs.set(t.getId(),e)}posToString(t,e){return`${t.x}#${t.y}#${e}`}}});var ue,Mi=c(()=>{ue=class{constructor(t,e,r,i){this.x=t;this.y=e;this.width=r;this.height=i}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}isInRange(t){return t.x>=this.x&&t.x<this.x+this.width&&t.y>=this.y&&t.y<this.y+this.height}}});var R,$,Ri=c(()=>{te();O();A();Li();Mi();bt();ze();R=class{constructor(t){this.tilemap=t;this.characters=new Map;this.charBlockCache=new le;this.charLayerDepths=new Map;this.transitions=new Map;this.setLayerDepths()}addCharacter(t){this.characters.set(t.getId(),t),t.getNextTilePos().layer===void 0&&t.setTilePosition(et(F({},t.getNextTilePos()),{layer:this.getLowestCharLayer()})),this.charBlockCache.addCharacter(t)}removeCharacter(t){let e=this.characters.get(t);!e||(this.charBlockCache.removeCharacter(e),this.characters.delete(t))}getCharacters(){return[...this.characters.values()]}getCharactersAt(t,e){return this.charBlockCache.getCharactersAt(t,e)}isBlocking(t,e,r,i){return this.hasBlockingTile(t,e,i)||this.hasBlockingChar(e,t,r)}hasBlockingTile(t,e,r){return this.hasNoTile(e,t)?!0:this.getCollisionRelevantLayers(t).some(i=>this.isLayerBlockingAt(i,e,r))}getTransition(t,e){let r=this.transitions.get(t.toString());if(r)return r.get(e)}setTransition(t,e,r){var i;this.transitions.has(t.toString())||this.transitions.set(t.toString(),new Map),(i=this.transitions.get(t.toString()))==null||i.set(e,r)}getTransitions(){return new Map([...this.transitions].map(([t,e])=>[t,new Map(e)]))}hasNoTile(t,e){return!this.getCollisionRelevantLayers(e).some(r=>this.tilemap.hasTileAt(t.x,t.y,r.name))}hasBlockingChar(t,e,r){return this.charBlockCache.isCharBlockingAt(t,e,r)}getTileWidth(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileWidth*t}getTileHeight(){let t=this.tilemap.layers[0].tilemapLayer.scale;return this.tilemap.tileHeight*t}getDepthOfCharLayer(t){var e;return(e=this.charLayerDepths.get(t))!=null?e:0}isInRange(t){return new ue(0,0,this.tilemap.width,this.tilemap.height).isInRange(t)}getTileSize(){return new p(this.getTileWidth(),this.getTileHeight())}tilePosToPixelPos(t){return this.isIsometric()?C.scalarMult(this.getTileSize(),.5).multiply(new p(t.x-t.y,t.x+t.y)):t.clone().multiply(this.getTileSize())}getTileDistance(t){if(this.isIsometric())switch(t){case"down-left":case"down-right":case"up-left":case"up-right":return C.scalarMult(this.getTileSize(),.5);default:return this.getTileSize()}return this.getTileSize()}toMapDirection(t){return this.isIsometric()?er(t):t}isIsometric(){return this.tilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()}isLayerBlockingAt(t,e,r){let i=R.ONE_WAY_COLLIDE_PROP_PREFIX+r,n=this.tilemap.getTileAt(e.x,e.y,!1,t.name);return Boolean((n==null?void 0:n.properties)&&(n.properties[P.get().collisionTilePropertyName]||n.properties[i]))}getCharLayerIndexes(){return this.tilemap.layers.map((t,e)=>({layer:t,index:e})).filter(({layer:t})=>this.isCharLayer(t)).map(({index:t})=>t)}findPrevAndCharLayer(t){let e=this.getCharLayerIndexes(),r=e.findIndex(i=>this.getLayerProp(this.tilemap.layers[i],R.CHAR_LAYER_PROP_NAME)==t);return r==0?{prevIndex:-1,charLayerIndex:e[r]}:{prevIndex:e[r-1],charLayerIndex:e[r]}}getCollisionRelevantLayers(t){if(!t)return this.tilemap.layers;let{prevIndex:e,charLayerIndex:r}=this.findPrevAndCharLayer(t);return this.tilemap.layers.slice(e+1,r+1)}getLowestCharLayer(){let t=this.tilemap.layers.find(e=>this.hasLayerProp(e,R.CHAR_LAYER_PROP_NAME));if(t)return this.getLayerProp(t,R.CHAR_LAYER_PROP_NAME)}getLayerProp(t,e){let i=t.properties.find(n=>n.name==e);return i==null?void 0:i.value}hasLayerProp(t,e){return this.getLayerProp(t,e)!=null}isLayerAlwaysOnTop(t){return this.hasLayerProp(t,R.ALWAYS_TOP_PROP_NAME)}isCharLayer(t){return this.hasLayerProp(t,R.CHAR_LAYER_PROP_NAME)}setLayerDepths(){let t=[],e=-1,r=this.tilemap.layers.filter(n=>this.isLayerAlwaysOnTop(n));this.tilemap.layers.filter(n=>!this.isLayerAlwaysOnTop(n)).forEach(n=>{this.hasLayerProp(n,R.HEIGHT_SHIFT_PROP_NAME)?(this.createHeightShiftLayers(n,e),t.push(n.tilemapLayer)):this.setDepth(n,++e)}),this.charLayerDepths.set(void 0,e),r.forEach((n,s)=>{n.tilemapLayer.setDepth(s+1+e)}),t.forEach(n=>n.destroy())}setDepth(t,e){t.tilemapLayer.setDepth(e),this.isCharLayer(t)&&this.charLayerDepths.set(this.getLayerProp(t,R.CHAR_LAYER_PROP_NAME),e)}createHeightShiftLayers(t,e){let r=this.getLayerProp(t,R.HEIGHT_SHIFT_PROP_NAME),i=1;for(let n=0;n<t.height;n++){let s=this.copyLayer(t,n);s.scale=t.tilemapLayer.scale,s.setDepth(e+ct.shiftPad((n+r)*this.getTileHeight()+i,R.Z_INDEX_PADDING))}}copyLayer(t,e){let r=this.tilemap.createBlankLayer(`${t.name}#${e}`,t.tilemapLayer.tileset);for(let i=0;i<t.width;i++)r.putTileAt(t.data[e][i],i,e);return r}},$=R;$.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",$.CHAR_LAYER_PROP_NAME="ge_charLayer",$.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",$.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_",$.Z_INDEX_PADDING=7});var Tt,Fi=c(()=>{Tt=class{static getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}}});var me,Ai=c(()=>{Fi();qe();O();O();yt();A();me=class{constructor(t,e=4,r=0,i=-1){this.character=t;this.delay=r;this.radius=i;this.stepSize=0;this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().position.y,this.initialCol=t.getNextTilePos().position.x,this.randomizeStepSize(),this.stepsWalked=0,this.currentMovementDirection="none",this.character.positionChangeStarted().pipe(_(this.character.autoMovementSet().pipe(W(1),G(n=>n!==this)))).subscribe(()=>{this.stepsWalked++}),this.distanceUtils=pt.create(e)}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let e=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(e),this.currentMovementDirection=e,this.randomizeStepSize()}}getInfo(){return{type:"Random",config:{delay:this.delay,radius:this.radius}}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&this.currentMovementDirection!=="none"&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return this.distanceUtils.getDirections().filter(e=>!this.character.isBlockingDirection(e)).filter(e=>this.isWithinRadius(e))}isWithinRadius(t){return this.radius==-1?!0:this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().position.add(V(t)),new p(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return t.length==0?"none":t[Tt.getRandomInt(t.length)]}randomizeStepSize(){this.stepSize=Tt.getRandomInt(this.radius)+1}}});function Ii(o,t){return o.filter(e=>{var r,i,n,s,a,h;return(r=t.labels)!=null&&r.withAllLabels?(i=t.labels)==null?void 0:i.withAllLabels.every(l=>e.hasLabel(l)):(n=t.labels)!=null&&n.withOneOfLabels?(s=t.labels)==null?void 0:s.withOneOfLabels.some(l=>e.hasLabel(l)):(a=t.labels)!=null&&a.withNoneLabels?!((h=t.labels)!=null&&h.withNoneLabels.some(l=>e.hasLabel(l))):!0})}var Gi=c(()=>{});var fe,Ni=c(()=>{Ci();te();Ye();Di();Ke();je();O();Ri();Ai();at();yt();A();ne();Xe();Ve();Gi();fe=class{constructor(t){this.scene=t;this.isCreatedInternal=!1;this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this)}getCharLayer(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.getTilePos().layer}getTransition(t,e){var r;return this.initGuard(),(r=this.gridTilemap)==null?void 0:r.getTransition(new p(t),e)}setTransition(t,e,r){var i;return this.initGuard(),(i=this.gridTilemap)==null?void 0:i.setTransition(new p(t),e,r)}create(t,e){this.isCreatedInternal=!0,this.gridCharacters=new Map;let r=this.setConfigDefaults(e);P.set(r),this.movementStopped$=new v,this.movementStarted$=new v,this.directionChanged$=new v,this.positionChangeStarted$=new v,this.positionChangeFinished$=new v,this.charRemoved$=new v,this.charAdded$=new v,this.gridTilemap=new $(t),this.addCharacters()}getPosition(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.getTilePos().position}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,r=-1){var s,a;this.initGuard();let i=(a=(s=this.gridCharacters)==null?void 0:s.get(t))==null?void 0:a.getGridCharacter();if(!i)throw this.createCharUnknownErr(t);let n=new me(i,P.get().numberOfDirections,e,r);i.setMovement(n)}getMovement(t){var i,n;this.initGuard();let e=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);let r=e.getMovement();return r?r.getInfo():{type:"None"}}moveTo(t,e,r){var a,h;let i=this.assembleMoveToConfig(r);this.initGuard();let n=(h=(a=this.gridCharacters)==null?void 0:a.get(t))==null?void 0:h.getGridCharacter();if(!n)throw this.createCharUnknownErr(t);if(!this.gridTilemap)throw this.createUninitializedErr();let s=new lt(n,this.gridTilemap,{position:new p(e),layer:(r==null?void 0:r.targetLayer)||n.getNextTilePos().layer},{numberOfDirections:P.get().numberOfDirections,distance:0,config:i});return n.setMovement(s),s.finishedObs().pipe(Z(l=>({charId:t,position:l.position,result:l.result,description:l.description,layer:l.layer})))}stopMovement(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);e.setMovement(void 0)}setSpeed(t,e){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(t);r.setSpeed(e)}getSpeed(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.getSpeed()}getContainer(t){var r;this.initGuard();let e=(r=this.gridCharacters)==null?void 0:r.get(t);if(!e)throw this.createCharUnknownErr(t);return e.getContainer()}getOffsetX(t){var r;this.initGuard();let e=(r=this.gridCharacters)==null?void 0:r.get(t);if(!e)throw this.createCharUnknownErr(t);return e.getOffsetX()}getOffsetY(t){var r;this.initGuard();let e=(r=this.gridCharacters)==null?void 0:r.get(t);if(!e)throw this.createCharUnknownErr(t);return e.getOffsetY()}collidesWithTiles(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.collidesWithTiles()}getWalkingAnimationMapping(t){var i;this.initGuard();let e=(i=this.gridCharacters)==null?void 0:i.get(t);if(!e)throw this.createCharUnknownErr(t);let r=e.getAnimation();return r==null?void 0:r.getWalkingAnimationMapping()}hasLayerOverlay(){return P.get().layerOverlay}setWalkingAnimationMapping(t,e){var n;this.initGuard();let r=(n=this.gridCharacters)==null?void 0:n.get(t);if(!r)throw this.createCharUnknownErr(t);let i=r.getAnimation();i==null||i.setWalkingAnimationMapping(e)}update(t,e){if(this.isCreatedInternal&&this.gridCharacters)for(let[r,i]of this.gridCharacters)i.update(e)}addCharacter(t){var n,s;if(this.initGuard(),!this.gridTilemap)throw this.createUninitializedErr();let e=new Jt(t,this.scene,this.gridTilemap,P.get().layerOverlay),r=e.getGridCharacter();(n=this.gridCharacters)==null||n.set(t.id,e),this.gridTilemap.addCharacter(r);let i=r.getId();r.movementStopped().pipe(_(this.charRemoved(i))).subscribe(a=>{var h;(h=this.movementStopped$)==null||h.next({charId:i,direction:a})}),r.movementStarted().pipe(_(this.charRemoved(i))).subscribe(a=>{var h;(h=this.movementStarted$)==null||h.next({charId:i,direction:a})}),r.directionChanged().pipe(_(this.charRemoved(i))).subscribe(a=>{var h;(h=this.directionChanged$)==null||h.next({charId:i,direction:a})}),r.positionChangeStarted().pipe(_(this.charRemoved(i))).subscribe(a=>{var h;(h=this.positionChangeStarted$)==null||h.next(F({charId:i},a))}),r.positionChangeFinished().pipe(_(this.charRemoved(i))).subscribe(a=>{var h;(h=this.positionChangeFinished$)==null||h.next(F({charId:i},a))}),(s=this.charAdded$)==null||s.next(i)}hasCharacter(t){var e;return this.initGuard(),!!((e=this.gridCharacters)!=null&&e.has(t))}removeCharacter(t){var r,i,n,s;this.initGuard();let e=(r=this.gridCharacters)==null?void 0:r.get(t);if(!e)throw this.createCharUnknownErr(t);e.destroy(),(i=this.gridTilemap)==null||i.removeCharacter(t),(n=this.gridCharacters)==null||n.delete(t),(s=this.charRemoved$)==null||s.next(t)}removeAllCharacters(){if(this.initGuard(),!!this.gridCharacters)for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(t){if(this.initGuard(),!this.gridCharacters)return[];let e=[...this.gridCharacters.values()].map(i=>i.getGridCharacter());return(t?Ii(e,t):e).map(i=>i.getId())}getLabels(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.getLabels()}addLabels(t,e){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(t);r.addLabels(e)}removeLabels(t,e){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(t);r.removeLabels(e)}clearLabels(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);e.clearLabels()}follow(t,e,r=0,i=!1){var h,l,f,g;this.initGuard();let n=(l=(h=this.gridCharacters)==null?void 0:h.get(t))==null?void 0:l.getGridCharacter(),s=(g=(f=this.gridCharacters)==null?void 0:f.get(e))==null?void 0:g.getGridCharacter();if(!n)throw this.createCharUnknownErr(t);if(!s)throw this.createCharUnknownErr(e);if(!this.gridTilemap)throw this.createUninitializedErr();let a=new pe(n,this.gridTilemap,s,P.get().numberOfDirections,r,i?"CLOSEST_REACHABLE":"STOP");n.setMovement(a)}isMoving(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.isMoving()}getFacingDirection(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.getFacingDirection()}getFacingPosition(t){var i,n;this.initGuard();let e=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);let r=e.getFacingPosition();return{x:r.x,y:r.y}}turnTowards(t,e){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(t);return r.turnTowards(e)}getCharactersAt(t,e){if(this.initGuard(),!this.gridTilemap)return[];let r=this.gridTilemap.getCharactersAt(new p(t),e);return Array.from(r).map(i=>i.getId())}setPosition(t,e,r){var n,s;this.initGuard();let i=(s=(n=this.gridCharacters)==null?void 0:n.get(t))==null?void 0:s.getGridCharacter();if(!i)throw this.createCharUnknownErr(t);r||i.setTilePosition({position:new p(e),layer:i.getTilePos().layer}),i.setTilePosition({position:new p(e),layer:r})}getSprite(t){var i;this.initGuard();let e=(i=this.gridCharacters)==null?void 0:i.get(t);if(!(e==null?void 0:e.getGridCharacter()))throw this.createCharUnknownErr(t);return e==null?void 0:e.getSprite()}setSprite(t,e){var i;this.initGuard();let r=(i=this.gridCharacters)==null?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);e.setOrigin(0,0),this.setCharSprite(e,r)}setCharSprite(t,e){e.setSprite(t)}isBlocked(t,e,r=["geDefault"]){var i;return this.initGuard(),!!((i=this.gridTilemap)!=null&&i.isBlocking(e,new p(t),r))}isTileBlocked(t,e){var r;return this.initGuard(),!!((r=this.gridTilemap)!=null&&r.hasBlockingTile(e,new p(t)))}getCollisionGroups(t){var r,i;this.initGuard();let e=(i=(r=this.gridCharacters)==null?void 0:r.get(t))==null?void 0:i.getGridCharacter();if(!e)throw this.createCharUnknownErr(t);return e.getCollisionGroups()||[]}setCollisionGroups(t,e){var i,n;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(t);r.setCollisionGroups(e)}steppedOn(t,e,r){return this.positionChangeFinished().pipe(G(i=>t.includes(i.charId)&&e.some(n=>n.x===i.enterTile.x&&n.y===i.enterTile.y)&&(r===void 0||r.includes(i.enterLayer))))}characterShifted(){if(!this.charAdded$||!this.charRemoved$)throw this.createUninitializedErr();return this.charAdded$.pipe(Z(t=>({charId:t,action:"ADDED"})),$e(this.charRemoved$.pipe(Z(t=>({charId:t,action:"REMOVED"})))))}movementStarted(){if(!this.movementStarted$)throw this.createUninitializedErr();return this.movementStarted$}movementStopped(){if(!this.movementStopped$)throw this.createUninitializedErr();return this.movementStopped$}directionChanged(){if(!this.directionChanged$)throw this.createUninitializedErr();return this.directionChanged$}positionChangeStarted(){if(!this.positionChangeStarted$)throw this.createUninitializedErr();return this.positionChangeStarted$}positionChangeFinished(){if(!this.positionChangeFinished$)throw this.createUninitializedErr();return this.positionChangeFinished$}setConfigDefaults(t){return F({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES",layerOverlay:!1},t)}charRemoved(t){var e;if(!this.charRemoved$)throw this.createUninitializedErr();return(e=this.charRemoved$)==null?void 0:e.pipe(W(1),G(r=>r==t))}initGuard(){if(!this.isCreatedInternal)throw this.createUninitializedErr()}createUninitializedErr(){throw new Error("Plugin not initialized. You need to call create() first.")}addCharacters(){P.get().characters.forEach(t=>this.addCharacter(t))}moveChar(t,e){var i,n,s,a;this.initGuard();let r=(n=(i=this.gridCharacters)==null?void 0:i.get(t))==null?void 0:n.getGridCharacter();if(!r)throw this.createCharUnknownErr(t);if(P.get().numberOfDirections===4){if(!((s=this.gridTilemap)!=null&&s.isIsometric())&&ge(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}else if(((a=this.gridTilemap)==null?void 0:a.isIsometric())&&!ge(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}r.move(e)}createCharUnknownErr(t){return new Error(`Character unknown: ${t}`)}assembleMoveToConfig(t={}){let e=et(F({},t),{noPathFoundStrategy:"STOP",pathBlockedStrategy:"WAIT"});return t!=null&&t.noPathFoundStrategy&&(Object.values(xt).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to '${"STOP"}'`)),t!=null&&t.pathBlockedStrategy&&(Object.values(ce).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to '${"WAIT"}'`)),e}}});var lo=tr((ap,ki)=>{Ni();ki.exports=fe});return lo();})();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
